{"ast":null,"code":"/**\r\n * Copyright (c) 2017 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\nimport { IntMap, SortedArray } from '../../../../mol-data/int';\nimport { sortArray } from '../../../../mol-data/util';\nimport { StructureSymmetry } from '../symmetry';\nimport { Structure } from '../structure';\nimport { UniqueArray } from '../../../../mol-data/generic';\n\nvar StructureUniqueSubsetBuilder =\n/** @class */\nfunction () {\n  function StructureUniqueSubsetBuilder(parent) {\n    this.parent = parent;\n    this.ids = [];\n    this.unitMap = IntMap.Mutable();\n    this.parentId = -1;\n    this.currentUnit = UniqueArray.create();\n    this.elementCount = 0;\n  }\n\n  StructureUniqueSubsetBuilder.prototype.addToUnit = function (parentId, e) {\n    var unit = this.unitMap.get(parentId);\n\n    if (!!unit) {\n      if (UniqueArray.add(unit, e, e)) this.elementCount++;\n    } else {\n      var arr = UniqueArray.create();\n      UniqueArray.add(arr, e, e);\n      this.unitMap.set(parentId, arr);\n      this.ids[this.ids.length] = parentId;\n      this.elementCount++;\n    }\n  };\n\n  StructureUniqueSubsetBuilder.prototype.has = function (parentId, e) {\n    var unit = this.unitMap.get(parentId);\n    if (!unit) return false;\n    return UniqueArray.has(unit, e);\n  };\n\n  StructureUniqueSubsetBuilder.prototype.beginUnit = function (parentId) {\n    this.parentId = parentId;\n\n    if (this.unitMap.has(parentId)) {\n      this.currentUnit = this.unitMap.get(parentId);\n    } else {\n      this.currentUnit = this.currentUnit.array.length > 0 ? UniqueArray.create() : this.currentUnit;\n    }\n  };\n\n  StructureUniqueSubsetBuilder.prototype.addElement = function (e) {\n    if (UniqueArray.add(this.currentUnit, e, e)) this.elementCount++;\n  };\n\n  StructureUniqueSubsetBuilder.prototype.commitUnit = function () {\n    if (this.currentUnit.array.length === 0 || this.unitMap.has(this.parentId)) return;\n    this.ids[this.ids.length] = this.parentId;\n    this.unitMap.set(this.parentId, this.currentUnit);\n    this.parentId = -1;\n  };\n\n  StructureUniqueSubsetBuilder.prototype.getStructure = function () {\n    if (this.isEmpty) return Structure.Empty;\n    var newUnits = [];\n    sortArray(this.ids);\n    var symmGroups = StructureSymmetry.UnitEquivalenceBuilder();\n\n    for (var i = 0, _i = this.ids.length; i < _i; i++) {\n      var id = this.ids[i];\n      var parent_1 = this.parent.unitMap.get(id);\n      var unit = this.unitMap.get(id).array;\n      var l = unit.length; // if the length is the same, just copy the old unit.\n\n      if (unit.length === parent_1.elements.length) {\n        newUnits[newUnits.length] = parent_1;\n        symmGroups.add(parent_1.id, parent_1);\n        continue;\n      }\n\n      if (l > 1) sortArray(unit);\n      var child = parent_1.getChild(SortedArray.ofSortedArray(unit));\n      var pivot = symmGroups.add(child.id, child);\n      if (child !== pivot) child = pivot.applyOperator(child.id, child.conformation.operator, true);\n      newUnits[newUnits.length] = child;\n    }\n\n    return Structure.create(newUnits, {\n      parent: this.parent\n    });\n  };\n\n  Object.defineProperty(StructureUniqueSubsetBuilder.prototype, \"isEmpty\", {\n    get: function () {\n      return this.elementCount === 0;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  return StructureUniqueSubsetBuilder;\n}();\n\nexport { StructureUniqueSubsetBuilder };","map":{"version":3,"sources":["../../../../../src/mol-model/structure/structure/util/unique-subset-builder.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2017 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\r\nimport { IntMap, SortedArray } from '../../../../mol-data/int';\r\nimport { sortArray } from '../../../../mol-data/util';\r\nimport { StructureSymmetry } from '../symmetry';\r\nimport { Structure } from '../structure';\r\nimport { UniqueArray } from '../../../../mol-data/generic';\r\nvar StructureUniqueSubsetBuilder = /** @class */ (function () {\r\n    function StructureUniqueSubsetBuilder(parent) {\r\n        this.parent = parent;\r\n        this.ids = [];\r\n        this.unitMap = IntMap.Mutable();\r\n        this.parentId = -1;\r\n        this.currentUnit = UniqueArray.create();\r\n        this.elementCount = 0;\r\n    }\r\n    StructureUniqueSubsetBuilder.prototype.addToUnit = function (parentId, e) {\r\n        var unit = this.unitMap.get(parentId);\r\n        if (!!unit) {\r\n            if (UniqueArray.add(unit, e, e))\r\n                this.elementCount++;\r\n        }\r\n        else {\r\n            var arr = UniqueArray.create();\r\n            UniqueArray.add(arr, e, e);\r\n            this.unitMap.set(parentId, arr);\r\n            this.ids[this.ids.length] = parentId;\r\n            this.elementCount++;\r\n        }\r\n    };\r\n    StructureUniqueSubsetBuilder.prototype.has = function (parentId, e) {\r\n        var unit = this.unitMap.get(parentId);\r\n        if (!unit)\r\n            return false;\r\n        return UniqueArray.has(unit, e);\r\n    };\r\n    StructureUniqueSubsetBuilder.prototype.beginUnit = function (parentId) {\r\n        this.parentId = parentId;\r\n        if (this.unitMap.has(parentId)) {\r\n            this.currentUnit = this.unitMap.get(parentId);\r\n        }\r\n        else {\r\n            this.currentUnit = this.currentUnit.array.length > 0 ? UniqueArray.create() : this.currentUnit;\r\n        }\r\n    };\r\n    StructureUniqueSubsetBuilder.prototype.addElement = function (e) {\r\n        if (UniqueArray.add(this.currentUnit, e, e))\r\n            this.elementCount++;\r\n    };\r\n    StructureUniqueSubsetBuilder.prototype.commitUnit = function () {\r\n        if (this.currentUnit.array.length === 0 || this.unitMap.has(this.parentId))\r\n            return;\r\n        this.ids[this.ids.length] = this.parentId;\r\n        this.unitMap.set(this.parentId, this.currentUnit);\r\n        this.parentId = -1;\r\n    };\r\n    StructureUniqueSubsetBuilder.prototype.getStructure = function () {\r\n        if (this.isEmpty)\r\n            return Structure.Empty;\r\n        var newUnits = [];\r\n        sortArray(this.ids);\r\n        var symmGroups = StructureSymmetry.UnitEquivalenceBuilder();\r\n        for (var i = 0, _i = this.ids.length; i < _i; i++) {\r\n            var id = this.ids[i];\r\n            var parent_1 = this.parent.unitMap.get(id);\r\n            var unit = this.unitMap.get(id).array;\r\n            var l = unit.length;\r\n            // if the length is the same, just copy the old unit.\r\n            if (unit.length === parent_1.elements.length) {\r\n                newUnits[newUnits.length] = parent_1;\r\n                symmGroups.add(parent_1.id, parent_1);\r\n                continue;\r\n            }\r\n            if (l > 1)\r\n                sortArray(unit);\r\n            var child = parent_1.getChild(SortedArray.ofSortedArray(unit));\r\n            var pivot = symmGroups.add(child.id, child);\r\n            if (child !== pivot)\r\n                child = pivot.applyOperator(child.id, child.conformation.operator, true);\r\n            newUnits[newUnits.length] = child;\r\n        }\r\n        return Structure.create(newUnits, { parent: this.parent });\r\n    };\r\n    Object.defineProperty(StructureUniqueSubsetBuilder.prototype, \"isEmpty\", {\r\n        get: function () {\r\n            return this.elementCount === 0;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    return StructureUniqueSubsetBuilder;\r\n}());\r\nexport { StructureUniqueSubsetBuilder };\r\n//# sourceMappingURL=unique-subset-builder.js.map"]},"metadata":{},"sourceType":"module"}