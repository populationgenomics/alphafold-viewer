{"ast":null,"code":"/**\r\n * Copyright (c) 2019 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\nimport { PluginStateObject } from '../../mol-plugin-state/objects';\nimport { StateSelection } from '../../mol-state';\nimport { RxEventHelper } from '../../mol-util/rx-event-helper';\nexport { SubstructureParentHelper };\n\nvar SubstructureParentHelper =\n/** @class */\nfunction () {\n  function SubstructureParentHelper(plugin) {\n    var _this = this;\n\n    this.plugin = plugin;\n    this.ev = RxEventHelper.create();\n    this.events = {\n      updated: this.ev(),\n      removed: this.ev()\n    }; // private decorators = new Map<string, string[]>();\n\n    this.root = new Map();\n    this.tracked = new Map();\n    plugin.state.data.events.object.created.subscribe(function (e) {\n      _this.addMapping(e.state, e.ref, e.obj);\n    });\n    plugin.state.data.events.object.removed.subscribe(function (e) {\n      if (_this.removeMapping(e.ref)) {\n        _this.events.removed.next({\n          ref: e.ref,\n          obj: e.obj\n        });\n      }\n    });\n    plugin.state.data.events.object.updated.subscribe(function (e) {\n      if (_this.updateMapping(e.state, e.ref, e.oldObj, e.obj)) {\n        _this.events.updated.next({\n          ref: e.ref,\n          oldObj: e.oldObj,\n          obj: e.obj\n        });\n      }\n    });\n  }\n\n  SubstructureParentHelper.prototype.getDecorator = function (root) {\n    var tree = this.plugin.state.data.tree;\n    var children = tree.children.get(root);\n    if (children.size !== 1) return root;\n    var child = children.first();\n\n    if (tree.transforms.get(child).transformer.definition.isDecorator) {\n      return this.getDecorator(child);\n    }\n\n    return root;\n  };\n  /** Returns the root node of given structure if existing, takes decorators into account */\n\n\n  SubstructureParentHelper.prototype.get = function (s, ignoreDecorators) {\n    if (ignoreDecorators === void 0) {\n      ignoreDecorators = false;\n    }\n\n    var r = this.root.get(s);\n    if (!r) return;\n    if (ignoreDecorators) return this.plugin.state.data.cells.get(r.ref);\n    return this.plugin.state.data.cells.get(this.getDecorator(r.ref));\n  };\n\n  SubstructureParentHelper.prototype.addMapping = function (state, ref, obj) {\n    if (!PluginStateObject.Molecule.Structure.is(obj)) return false;\n    this.tracked.set(ref, obj.data); // if the structure is already present in the tree, do not rewrite the root.\n\n    if (this.root.has(obj.data)) {\n      var e = this.root.get(obj.data);\n      e.count++;\n    } else {\n      var parent_1 = state.select(StateSelection.Generators.byRef(ref).rootOfType([PluginStateObject.Molecule.Structure]))[0];\n\n      if (!parent_1) {\n        this.root.set(obj.data, {\n          ref: ref,\n          count: 1\n        });\n      } else {\n        this.root.set(obj.data, {\n          ref: parent_1.transform.ref,\n          count: 1\n        });\n      }\n    }\n\n    return true;\n  };\n\n  SubstructureParentHelper.prototype.removeMapping = function (ref) {\n    if (!this.tracked.has(ref)) return false;\n    var s = this.tracked.get(ref);\n    this.tracked.delete(ref);\n    var root = this.root.get(s);\n\n    if (root.count > 1) {\n      root.count--;\n    } else {\n      this.root.delete(s);\n    }\n\n    return true;\n  };\n\n  SubstructureParentHelper.prototype.updateMapping = function (state, ref, oldObj, obj) {\n    if (!PluginStateObject.Molecule.Structure.is(obj)) return false;\n    this.removeMapping(ref);\n    this.addMapping(state, ref, obj);\n    return true;\n  };\n\n  SubstructureParentHelper.prototype.dispose = function () {\n    this.ev.dispose();\n  };\n\n  return SubstructureParentHelper;\n}();","map":{"version":3,"sources":["../../../src/mol-plugin/util/substructure-parent-helper.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2019 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\r\nimport { PluginStateObject } from '../../mol-plugin-state/objects';\r\nimport { StateSelection } from '../../mol-state';\r\nimport { RxEventHelper } from '../../mol-util/rx-event-helper';\r\nexport { SubstructureParentHelper };\r\nvar SubstructureParentHelper = /** @class */ (function () {\r\n    function SubstructureParentHelper(plugin) {\r\n        var _this = this;\r\n        this.plugin = plugin;\r\n        this.ev = RxEventHelper.create();\r\n        this.events = {\r\n            updated: this.ev(),\r\n            removed: this.ev(),\r\n        };\r\n        // private decorators = new Map<string, string[]>();\r\n        this.root = new Map();\r\n        this.tracked = new Map();\r\n        plugin.state.data.events.object.created.subscribe(function (e) {\r\n            _this.addMapping(e.state, e.ref, e.obj);\r\n        });\r\n        plugin.state.data.events.object.removed.subscribe(function (e) {\r\n            if (_this.removeMapping(e.ref)) {\r\n                _this.events.removed.next({ ref: e.ref, obj: e.obj });\r\n            }\r\n        });\r\n        plugin.state.data.events.object.updated.subscribe(function (e) {\r\n            if (_this.updateMapping(e.state, e.ref, e.oldObj, e.obj)) {\r\n                _this.events.updated.next({ ref: e.ref, oldObj: e.oldObj, obj: e.obj });\r\n            }\r\n        });\r\n    }\r\n    SubstructureParentHelper.prototype.getDecorator = function (root) {\r\n        var tree = this.plugin.state.data.tree;\r\n        var children = tree.children.get(root);\r\n        if (children.size !== 1)\r\n            return root;\r\n        var child = children.first();\r\n        if (tree.transforms.get(child).transformer.definition.isDecorator) {\r\n            return this.getDecorator(child);\r\n        }\r\n        return root;\r\n    };\r\n    /** Returns the root node of given structure if existing, takes decorators into account */\r\n    SubstructureParentHelper.prototype.get = function (s, ignoreDecorators) {\r\n        if (ignoreDecorators === void 0) { ignoreDecorators = false; }\r\n        var r = this.root.get(s);\r\n        if (!r)\r\n            return;\r\n        if (ignoreDecorators)\r\n            return this.plugin.state.data.cells.get(r.ref);\r\n        return this.plugin.state.data.cells.get(this.getDecorator(r.ref));\r\n    };\r\n    SubstructureParentHelper.prototype.addMapping = function (state, ref, obj) {\r\n        if (!PluginStateObject.Molecule.Structure.is(obj))\r\n            return false;\r\n        this.tracked.set(ref, obj.data);\r\n        // if the structure is already present in the tree, do not rewrite the root.\r\n        if (this.root.has(obj.data)) {\r\n            var e = this.root.get(obj.data);\r\n            e.count++;\r\n        }\r\n        else {\r\n            var parent_1 = state.select(StateSelection.Generators.byRef(ref).rootOfType([PluginStateObject.Molecule.Structure]))[0];\r\n            if (!parent_1) {\r\n                this.root.set(obj.data, { ref: ref, count: 1 });\r\n            }\r\n            else {\r\n                this.root.set(obj.data, { ref: parent_1.transform.ref, count: 1 });\r\n            }\r\n        }\r\n        return true;\r\n    };\r\n    SubstructureParentHelper.prototype.removeMapping = function (ref) {\r\n        if (!this.tracked.has(ref))\r\n            return false;\r\n        var s = this.tracked.get(ref);\r\n        this.tracked.delete(ref);\r\n        var root = this.root.get(s);\r\n        if (root.count > 1) {\r\n            root.count--;\r\n        }\r\n        else {\r\n            this.root.delete(s);\r\n        }\r\n        return true;\r\n    };\r\n    SubstructureParentHelper.prototype.updateMapping = function (state, ref, oldObj, obj) {\r\n        if (!PluginStateObject.Molecule.Structure.is(obj))\r\n            return false;\r\n        this.removeMapping(ref);\r\n        this.addMapping(state, ref, obj);\r\n        return true;\r\n    };\r\n    SubstructureParentHelper.prototype.dispose = function () {\r\n        this.ev.dispose();\r\n    };\r\n    return SubstructureParentHelper;\r\n}());\r\n//# sourceMappingURL=substructure-parent-helper.js.map"]},"metadata":{},"sourceType":"module"}