{"ast":null,"code":"/**\r\n * Copyright (c) 2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\nimport { __awaiter, __generator, __spreadArray } from \"tslib\";\nimport { StateObjectRef } from '../../mol-state';\nimport { PluginStateObject as SO } from '../objects';\nimport { StateTransforms } from '../transforms';\nimport { StructureRepresentationBuilder } from './structure/representation';\nimport { Task } from '../../mol-task';\nimport { StructureElement } from '../../mol-model/structure';\nimport { ModelSymmetry } from '../../mol-model-formats/structure/property/symmetry';\nimport { SpacegroupCell } from '../../mol-math/geometry';\nimport { TrajectoryHierarchyBuilder } from './structure/hierarchy';\n\nvar StructureBuilder =\n/** @class */\nfunction () {\n  function StructureBuilder(plugin) {\n    this.plugin = plugin;\n    this.hierarchy = new TrajectoryHierarchyBuilder(this.plugin);\n    this.representation = new StructureRepresentationBuilder(this.plugin);\n  }\n\n  Object.defineProperty(StructureBuilder.prototype, \"dataState\", {\n    get: function () {\n      return this.plugin.state.data;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  StructureBuilder.prototype.parseTrajectoryData = function (data, format) {\n    return __awaiter(this, void 0, void 0, function () {\n      var provider, trajectory;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            provider = typeof format === 'string' ? this.plugin.dataFormats.get(format) : format;\n            if (!provider) throw new Error(\"'\" + format + \"' is not a supported data format.\");\n            return [4\n            /*yield*/\n            , provider.parse(this.plugin, data)];\n\n          case 1:\n            trajectory = _a.sent().trajectory;\n            return [2\n            /*return*/\n            , trajectory];\n        }\n      });\n    });\n  };\n\n  StructureBuilder.prototype.parseTrajectoryBlob = function (data, params) {\n    var state = this.dataState;\n    var trajectory = state.build().to(data).apply(StateTransforms.Data.ParseBlob, params, {\n      state: {\n        isGhost: true\n      }\n    }).apply(StateTransforms.Model.TrajectoryFromBlob, void 0);\n    return trajectory.commit({\n      revertOnError: true\n    });\n  };\n\n  StructureBuilder.prototype.parseTrajectory = function (data, params) {\n    var cell = StateObjectRef.resolveAndCheck(this.dataState, data);\n    if (!cell) throw new Error('Invalid data cell.');\n\n    if (SO.Data.Blob.is(cell.obj)) {\n      return this.parseTrajectoryBlob(data, params);\n    } else {\n      return this.parseTrajectoryData(data, params);\n    }\n  };\n\n  StructureBuilder.prototype.createModel = function (trajectory, params, initialState) {\n    var state = this.dataState;\n    var model = state.build().to(trajectory).apply(StateTransforms.Model.ModelFromTrajectory, params || {\n      modelIndex: 0\n    }, {\n      state: initialState\n    });\n    return model.commit({\n      revertOnError: true\n    });\n  };\n\n  StructureBuilder.prototype.insertModelProperties = function (model, params, initialState) {\n    var state = this.dataState;\n    var props = state.build().to(model).apply(StateTransforms.Model.CustomModelProperties, params, {\n      state: initialState\n    });\n    return props.commit({\n      revertOnError: true\n    });\n  };\n\n  StructureBuilder.prototype.tryCreateUnitcell = function (model, params, initialState) {\n    var _a, _b, _c;\n\n    var state = this.dataState;\n    var m = (_b = (_a = StateObjectRef.resolveAndCheck(state, model)) === null || _a === void 0 ? void 0 : _a.obj) === null || _b === void 0 ? void 0 : _b.data;\n    if (!m) return;\n    var cell = (_c = ModelSymmetry.Provider.get(m)) === null || _c === void 0 ? void 0 : _c.spacegroup.cell;\n    if (SpacegroupCell.isZero(cell)) return;\n    var unitcell = state.build().to(model).apply(StateTransforms.Representation.ModelUnitcell3D, params, {\n      state: initialState\n    });\n    return unitcell.commit({\n      revertOnError: true\n    });\n  };\n\n  StructureBuilder.prototype.createStructure = function (modelRef, params, initialState) {\n    var _a;\n\n    var state = this.dataState;\n\n    if (!params) {\n      var model = StateObjectRef.resolveAndCheck(state, modelRef);\n\n      if (model) {\n        var symm = ModelSymmetry.Provider.get((_a = model.obj) === null || _a === void 0 ? void 0 : _a.data);\n        if (!symm || (symm === null || symm === void 0 ? void 0 : symm.assemblies.length) === 0) params = {\n          name: 'model',\n          params: {}\n        };\n      }\n    }\n\n    var structure = state.build().to(modelRef).apply(StateTransforms.Model.StructureFromModel, {\n      type: params || {\n        name: 'assembly',\n        params: {}\n      }\n    }, {\n      state: initialState\n    });\n    return structure.commit({\n      revertOnError: true\n    });\n  };\n\n  StructureBuilder.prototype.insertStructureProperties = function (structure, params) {\n    var state = this.dataState;\n    var props = state.build().to(structure).apply(StateTransforms.Model.CustomStructureProperties, params);\n    return props.commit({\n      revertOnError: true\n    });\n  };\n\n  StructureBuilder.prototype.isComponentTransform = function (cell) {\n    return cell.transform.transformer === StateTransforms.Model.StructureComponent;\n  };\n  /** returns undefined if the component is empty/null */\n\n\n  StructureBuilder.prototype.tryCreateComponent = function (structure, params, key, tags) {\n    var _a, _b;\n\n    return __awaiter(this, void 0, void 0, function () {\n      var state, root, keyTag, component, selector;\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            state = this.dataState;\n            root = state.build().to(structure);\n            keyTag = \"structure-component-\" + key;\n            component = root.applyOrUpdateTagged(keyTag, StateTransforms.Model.StructureComponent, params, {\n              tags: tags ? __spreadArray(__spreadArray([], tags, true), [keyTag], false) : [keyTag]\n            });\n            return [4\n            /*yield*/\n            , component.commit()];\n\n          case 1:\n            _c.sent();\n\n            selector = component.selector;\n            if (!(!selector.isOk || ((_b = (_a = selector.cell) === null || _a === void 0 ? void 0 : _a.obj) === null || _b === void 0 ? void 0 : _b.data.elementCount) === 0)) return [3\n            /*break*/\n            , 3];\n            return [4\n            /*yield*/\n            , state.build().delete(selector.ref).commit()];\n\n          case 2:\n            _c.sent();\n\n            return [2\n            /*return*/\n            ];\n\n          case 3:\n            return [2\n            /*return*/\n            , selector];\n        }\n      });\n    });\n  };\n\n  StructureBuilder.prototype.tryCreateComponentFromExpression = function (structure, expression, key, params) {\n    return this.tryCreateComponent(structure, {\n      type: {\n        name: 'expression',\n        params: expression\n      },\n      nullIfEmpty: true,\n      label: ((params === null || params === void 0 ? void 0 : params.label) || '').trim()\n    }, key, params === null || params === void 0 ? void 0 : params.tags);\n  };\n\n  StructureBuilder.prototype.tryCreateComponentStatic = function (structure, type, params) {\n    return this.tryCreateComponent(structure, {\n      type: {\n        name: 'static',\n        params: type\n      },\n      nullIfEmpty: true,\n      label: ((params === null || params === void 0 ? void 0 : params.label) || '').trim()\n    }, \"static-\" + type, params === null || params === void 0 ? void 0 : params.tags);\n  };\n\n  StructureBuilder.prototype.tryCreateComponentFromSelection = function (structure, selection, key, params) {\n    var _this = this;\n\n    return this.plugin.runTask(Task.create('Query Component', function (taskCtx) {\n      return __awaiter(_this, void 0, void 0, function () {\n        var _a, label, tags, structureData, transformParams, _b, _c, _d;\n\n        var _e, _f;\n\n        var _g, _h;\n\n        return __generator(this, function (_j) {\n          switch (_j.label) {\n            case 0:\n              _a = params || {}, label = _a.label, tags = _a.tags;\n              label = (label || '').trim();\n              structureData = (_h = (_g = StateObjectRef.resolveAndCheck(this.dataState, structure)) === null || _g === void 0 ? void 0 : _g.obj) === null || _h === void 0 ? void 0 : _h.data;\n              if (!structureData) return [2\n              /*return*/\n              ];\n              if (!selection.referencesCurrent) return [3\n              /*break*/\n              , 2];\n              _e = {};\n              _f = {\n                name: 'bundle'\n              };\n              _d = (_c = StructureElement.Bundle).fromSelection;\n              return [4\n              /*yield*/\n              , selection.getSelection(this.plugin, taskCtx, structureData)];\n\n            case 1:\n              _b = (_e.type = (_f.params = _d.apply(_c, [_j.sent()]), _f), _e.nullIfEmpty = true, _e.label = label || selection.label, _e);\n              return [3\n              /*break*/\n              , 3];\n\n            case 2:\n              _b = {\n                type: {\n                  name: 'expression',\n                  params: selection.expression\n                },\n                nullIfEmpty: true,\n                label: label || selection.label\n              };\n              _j.label = 3;\n\n            case 3:\n              transformParams = _b;\n              if (!selection.ensureCustomProperties) return [3\n              /*break*/\n              , 5];\n              return [4\n              /*yield*/\n              , selection.ensureCustomProperties({\n                runtime: taskCtx,\n                assetManager: this.plugin.managers.asset\n              }, structureData)];\n\n            case 4:\n              _j.sent();\n\n              _j.label = 5;\n\n            case 5:\n              return [2\n              /*return*/\n              , this.tryCreateComponent(structure, transformParams, key, tags)];\n          }\n        });\n      });\n    }));\n  };\n\n  return StructureBuilder;\n}();\n\nexport { StructureBuilder };","map":{"version":3,"sources":["../../../src/mol-plugin-state/builder/structure.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\r\nimport { __awaiter, __generator, __spreadArray } from \"tslib\";\r\nimport { StateObjectRef } from '../../mol-state';\r\nimport { PluginStateObject as SO } from '../objects';\r\nimport { StateTransforms } from '../transforms';\r\nimport { StructureRepresentationBuilder } from './structure/representation';\r\nimport { Task } from '../../mol-task';\r\nimport { StructureElement } from '../../mol-model/structure';\r\nimport { ModelSymmetry } from '../../mol-model-formats/structure/property/symmetry';\r\nimport { SpacegroupCell } from '../../mol-math/geometry';\r\nimport { TrajectoryHierarchyBuilder } from './structure/hierarchy';\r\nvar StructureBuilder = /** @class */ (function () {\r\n    function StructureBuilder(plugin) {\r\n        this.plugin = plugin;\r\n        this.hierarchy = new TrajectoryHierarchyBuilder(this.plugin);\r\n        this.representation = new StructureRepresentationBuilder(this.plugin);\r\n    }\r\n    Object.defineProperty(StructureBuilder.prototype, \"dataState\", {\r\n        get: function () {\r\n            return this.plugin.state.data;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    StructureBuilder.prototype.parseTrajectoryData = function (data, format) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var provider, trajectory;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        provider = typeof format === 'string' ? this.plugin.dataFormats.get(format) : format;\r\n                        if (!provider)\r\n                            throw new Error(\"'\" + format + \"' is not a supported data format.\");\r\n                        return [4 /*yield*/, provider.parse(this.plugin, data)];\r\n                    case 1:\r\n                        trajectory = (_a.sent()).trajectory;\r\n                        return [2 /*return*/, trajectory];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    StructureBuilder.prototype.parseTrajectoryBlob = function (data, params) {\r\n        var state = this.dataState;\r\n        var trajectory = state.build().to(data)\r\n            .apply(StateTransforms.Data.ParseBlob, params, { state: { isGhost: true } })\r\n            .apply(StateTransforms.Model.TrajectoryFromBlob, void 0);\r\n        return trajectory.commit({ revertOnError: true });\r\n    };\r\n    StructureBuilder.prototype.parseTrajectory = function (data, params) {\r\n        var cell = StateObjectRef.resolveAndCheck(this.dataState, data);\r\n        if (!cell)\r\n            throw new Error('Invalid data cell.');\r\n        if (SO.Data.Blob.is(cell.obj)) {\r\n            return this.parseTrajectoryBlob(data, params);\r\n        }\r\n        else {\r\n            return this.parseTrajectoryData(data, params);\r\n        }\r\n    };\r\n    StructureBuilder.prototype.createModel = function (trajectory, params, initialState) {\r\n        var state = this.dataState;\r\n        var model = state.build().to(trajectory)\r\n            .apply(StateTransforms.Model.ModelFromTrajectory, params || { modelIndex: 0 }, { state: initialState });\r\n        return model.commit({ revertOnError: true });\r\n    };\r\n    StructureBuilder.prototype.insertModelProperties = function (model, params, initialState) {\r\n        var state = this.dataState;\r\n        var props = state.build().to(model)\r\n            .apply(StateTransforms.Model.CustomModelProperties, params, { state: initialState });\r\n        return props.commit({ revertOnError: true });\r\n    };\r\n    StructureBuilder.prototype.tryCreateUnitcell = function (model, params, initialState) {\r\n        var _a, _b, _c;\r\n        var state = this.dataState;\r\n        var m = (_b = (_a = StateObjectRef.resolveAndCheck(state, model)) === null || _a === void 0 ? void 0 : _a.obj) === null || _b === void 0 ? void 0 : _b.data;\r\n        if (!m)\r\n            return;\r\n        var cell = (_c = ModelSymmetry.Provider.get(m)) === null || _c === void 0 ? void 0 : _c.spacegroup.cell;\r\n        if (SpacegroupCell.isZero(cell))\r\n            return;\r\n        var unitcell = state.build().to(model)\r\n            .apply(StateTransforms.Representation.ModelUnitcell3D, params, { state: initialState });\r\n        return unitcell.commit({ revertOnError: true });\r\n    };\r\n    StructureBuilder.prototype.createStructure = function (modelRef, params, initialState) {\r\n        var _a;\r\n        var state = this.dataState;\r\n        if (!params) {\r\n            var model = StateObjectRef.resolveAndCheck(state, modelRef);\r\n            if (model) {\r\n                var symm = ModelSymmetry.Provider.get((_a = model.obj) === null || _a === void 0 ? void 0 : _a.data);\r\n                if (!symm || (symm === null || symm === void 0 ? void 0 : symm.assemblies.length) === 0)\r\n                    params = { name: 'model', params: {} };\r\n            }\r\n        }\r\n        var structure = state.build().to(modelRef)\r\n            .apply(StateTransforms.Model.StructureFromModel, { type: params || { name: 'assembly', params: {} } }, { state: initialState });\r\n        return structure.commit({ revertOnError: true });\r\n    };\r\n    StructureBuilder.prototype.insertStructureProperties = function (structure, params) {\r\n        var state = this.dataState;\r\n        var props = state.build().to(structure)\r\n            .apply(StateTransforms.Model.CustomStructureProperties, params);\r\n        return props.commit({ revertOnError: true });\r\n    };\r\n    StructureBuilder.prototype.isComponentTransform = function (cell) {\r\n        return cell.transform.transformer === StateTransforms.Model.StructureComponent;\r\n    };\r\n    /** returns undefined if the component is empty/null */\r\n    StructureBuilder.prototype.tryCreateComponent = function (structure, params, key, tags) {\r\n        var _a, _b;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var state, root, keyTag, component, selector;\r\n            return __generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        state = this.dataState;\r\n                        root = state.build().to(structure);\r\n                        keyTag = \"structure-component-\" + key;\r\n                        component = root.applyOrUpdateTagged(keyTag, StateTransforms.Model.StructureComponent, params, {\r\n                            tags: tags ? __spreadArray(__spreadArray([], tags, true), [keyTag], false) : [keyTag]\r\n                        });\r\n                        return [4 /*yield*/, component.commit()];\r\n                    case 1:\r\n                        _c.sent();\r\n                        selector = component.selector;\r\n                        if (!(!selector.isOk || ((_b = (_a = selector.cell) === null || _a === void 0 ? void 0 : _a.obj) === null || _b === void 0 ? void 0 : _b.data.elementCount) === 0)) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, state.build().delete(selector.ref).commit()];\r\n                    case 2:\r\n                        _c.sent();\r\n                        return [2 /*return*/];\r\n                    case 3: return [2 /*return*/, selector];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    StructureBuilder.prototype.tryCreateComponentFromExpression = function (structure, expression, key, params) {\r\n        return this.tryCreateComponent(structure, {\r\n            type: { name: 'expression', params: expression },\r\n            nullIfEmpty: true,\r\n            label: ((params === null || params === void 0 ? void 0 : params.label) || '').trim()\r\n        }, key, params === null || params === void 0 ? void 0 : params.tags);\r\n    };\r\n    StructureBuilder.prototype.tryCreateComponentStatic = function (structure, type, params) {\r\n        return this.tryCreateComponent(structure, {\r\n            type: { name: 'static', params: type },\r\n            nullIfEmpty: true,\r\n            label: ((params === null || params === void 0 ? void 0 : params.label) || '').trim()\r\n        }, \"static-\" + type, params === null || params === void 0 ? void 0 : params.tags);\r\n    };\r\n    StructureBuilder.prototype.tryCreateComponentFromSelection = function (structure, selection, key, params) {\r\n        var _this = this;\r\n        return this.plugin.runTask(Task.create('Query Component', function (taskCtx) { return __awaiter(_this, void 0, void 0, function () {\r\n            var _a, label, tags, structureData, transformParams, _b, _c, _d;\r\n            var _e, _f;\r\n            var _g, _h;\r\n            return __generator(this, function (_j) {\r\n                switch (_j.label) {\r\n                    case 0:\r\n                        _a = params || {}, label = _a.label, tags = _a.tags;\r\n                        label = (label || '').trim();\r\n                        structureData = (_h = (_g = StateObjectRef.resolveAndCheck(this.dataState, structure)) === null || _g === void 0 ? void 0 : _g.obj) === null || _h === void 0 ? void 0 : _h.data;\r\n                        if (!structureData)\r\n                            return [2 /*return*/];\r\n                        if (!selection.referencesCurrent) return [3 /*break*/, 2];\r\n                        _e = {};\r\n                        _f = {\r\n                            name: 'bundle'\r\n                        };\r\n                        _d = (_c = StructureElement.Bundle).fromSelection;\r\n                        return [4 /*yield*/, selection.getSelection(this.plugin, taskCtx, structureData)];\r\n                    case 1:\r\n                        _b = (_e.type = (_f.params = _d.apply(_c, [_j.sent()]),\r\n                            _f),\r\n                            _e.nullIfEmpty = true,\r\n                            _e.label = label || selection.label,\r\n                            _e);\r\n                        return [3 /*break*/, 3];\r\n                    case 2:\r\n                        _b = {\r\n                            type: { name: 'expression', params: selection.expression },\r\n                            nullIfEmpty: true,\r\n                            label: label || selection.label\r\n                        };\r\n                        _j.label = 3;\r\n                    case 3:\r\n                        transformParams = _b;\r\n                        if (!selection.ensureCustomProperties) return [3 /*break*/, 5];\r\n                        return [4 /*yield*/, selection.ensureCustomProperties({ runtime: taskCtx, assetManager: this.plugin.managers.asset }, structureData)];\r\n                    case 4:\r\n                        _j.sent();\r\n                        _j.label = 5;\r\n                    case 5: return [2 /*return*/, this.tryCreateComponent(structure, transformParams, key, tags)];\r\n                }\r\n            });\r\n        }); }));\r\n    };\r\n    return StructureBuilder;\r\n}());\r\nexport { StructureBuilder };\r\n//# sourceMappingURL=structure.js.map"]},"metadata":{},"sourceType":"module"}