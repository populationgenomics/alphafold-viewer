{"ast":null,"code":"import { __assign, __extends, __spreadArray } from \"tslib\";\nimport { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from \"react/jsx-runtime\";\n/**\r\n * Copyright (c) 2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\n\nimport { OrderedSet, SortedArray } from '../../mol-data/int';\nimport { StructureElement, StructureProperties, Unit } from '../../mol-model/structure';\nimport { FocusLoci } from '../../mol-plugin/behavior/dynamic/representation';\nimport { lociLabel } from '../../mol-theme/label';\nimport { Binding } from '../../mol-util/binding';\nimport { memoizeLatest } from '../../mol-util/memoize';\nimport { PluginUIComponent } from '../base';\nimport { ActionMenu } from '../controls/action-menu';\nimport { Button, IconButton, ToggleButton } from '../controls/common';\nimport { CancelOutlinedSvg, CenterFocusStrongSvg } from '../controls/icons';\n\nfunction addSymmetryGroupEntries(entries, location, unitSymmetryGroup, granularity) {\n  var idx = SortedArray.indexOf(location.unit.elements, location.element);\n  var base = StructureElement.Loci(location.structure, [{\n    unit: location.unit,\n    indices: OrderedSet.ofSingleton(idx)\n  }]);\n  var extended = granularity === 'residue' ? StructureElement.Loci.extendToWholeResidues(base) : StructureElement.Loci.extendToWholeChains(base);\n  var name = StructureProperties.entity.pdbx_description(location).join(', ');\n\n  for (var _i = 0, _a = unitSymmetryGroup.units; _i < _a.length; _i++) {\n    var u = _a[_i];\n    var loci = StructureElement.Loci(extended.structure, [{\n      unit: u,\n      indices: extended.elements[0].indices\n    }]);\n    var label = lociLabel(loci, {\n      reverse: true,\n      hidePrefix: true,\n      htmlStyling: false,\n      granularity: granularity\n    });\n    if (!label) label = lociLabel(loci, {\n      hidePrefix: false,\n      htmlStyling: false\n    });\n\n    if (unitSymmetryGroup.units.length > 1) {\n      label += \" | \" + loci.elements[0].unit.conformation.operator.name;\n    }\n\n    var item = {\n      label: label,\n      category: name,\n      loci: loci\n    };\n    if (entries.has(name)) entries.get(name).push(item);else entries.set(name, [item]);\n  }\n}\n\nfunction getFocusEntries(structure) {\n  var entityEntries = new Map();\n  var l = StructureElement.Location.create(structure);\n\n  for (var _i = 0, _a = structure.unitSymmetryGroups; _i < _a.length; _i++) {\n    var ug = _a[_i];\n    if (!Unit.isAtomic(ug.units[0])) continue;\n    l.unit = ug.units[0];\n    l.element = ug.elements[0];\n    var isMultiChain = Unit.Traits.is(l.unit.traits, 1\n    /* MultiChain */\n    );\n    var entityType = StructureProperties.entity.type(l);\n    var isNonPolymer = entityType === 'non-polymer';\n    var isBranched = entityType === 'branched';\n    var isBirdMolecule = !!StructureProperties.entity.prd_id(l);\n\n    if (isBirdMolecule) {\n      addSymmetryGroupEntries(entityEntries, l, ug, 'chain');\n    } else if (isNonPolymer && !isMultiChain) {\n      addSymmetryGroupEntries(entityEntries, l, ug, 'residue');\n    } else if (isBranched || isNonPolymer && isMultiChain) {\n      var u = l.unit;\n      var residueIndex = u.model.atomicHierarchy.residueAtomSegments.index;\n      var prev = -1;\n\n      for (var i = 0, il = u.elements.length; i < il; ++i) {\n        var eI = u.elements[i];\n        var rI = residueIndex[eI];\n\n        if (rI !== prev) {\n          l.element = eI;\n          addSymmetryGroupEntries(entityEntries, l, ug, 'residue');\n          prev = rI;\n        }\n      }\n    }\n  }\n\n  var entries = [];\n  entityEntries.forEach(function (e, name) {\n    if (e.length === 1) {\n      entries.push({\n        label: name + \": \" + e[0].label,\n        loci: e[0].loci\n      });\n    } else if (e.length < 2000) {\n      entries.push.apply(entries, e);\n    }\n  });\n  return entries;\n}\n\nvar StructureFocusControls =\n/** @class */\nfunction (_super) {\n  __extends(StructureFocusControls, _super);\n\n  function StructureFocusControls() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    _this.state = {\n      isBusy: false,\n      showAction: false\n    };\n    _this.getSelectionItems = memoizeLatest(function (structures) {\n      var _a;\n\n      var presetItems = [];\n\n      for (var _i = 0, structures_1 = structures; _i < structures_1.length; _i++) {\n        var s = structures_1[_i];\n        var d = (_a = s.cell.obj) === null || _a === void 0 ? void 0 : _a.data;\n\n        if (d) {\n          var entries = getFocusEntries(d);\n\n          if (entries.length > 0) {\n            presetItems.push(__spreadArray([ActionMenu.Header(d.label, {\n              description: d.label\n            })], ActionMenu.createItems(entries, {\n              label: function (f) {\n                return f.label;\n              },\n              category: function (f) {\n                return f.category;\n              },\n              description: function (f) {\n                return f.label;\n              }\n            }), true));\n          }\n        }\n      }\n\n      return presetItems;\n    });\n\n    _this.selectAction = function (item, e) {\n      if (!item || !_this.state.showAction) {\n        _this.setState({\n          showAction: false\n        });\n\n        return;\n      }\n\n      var f = item.value;\n\n      if (e === null || e === void 0 ? void 0 : e.shiftKey) {\n        _this.plugin.managers.structure.focus.addFromLoci(f.loci);\n      } else {\n        _this.plugin.managers.structure.focus.set(f);\n      }\n\n      _this.focusCamera();\n    };\n\n    _this.toggleAction = function () {\n      return _this.setState({\n        showAction: !_this.state.showAction\n      });\n    };\n\n    _this.focusCamera = function () {\n      var current = _this.plugin.managers.structure.focus.current;\n      if (current) _this.plugin.managers.camera.focusLoci(current.loci);\n    };\n\n    _this.clear = function () {\n      _this.plugin.managers.structure.focus.clear();\n\n      _this.plugin.managers.camera.reset();\n    };\n\n    _this.highlightCurrent = function () {\n      var current = _this.plugin.managers.structure.focus.current;\n      if (current) _this.plugin.managers.interactivity.lociHighlights.highlightOnly({\n        loci: current.loci\n      }, false);\n    };\n\n    _this.clearHighlights = function () {\n      _this.plugin.managers.interactivity.lociHighlights.clearHighlights();\n    };\n\n    return _this;\n  }\n\n  StructureFocusControls.prototype.componentDidMount = function () {\n    var _this = this;\n\n    this.subscribe(this.plugin.managers.structure.focus.behaviors.current, function (c) {\n      // clear the memo cache\n      _this.getSelectionItems([]);\n\n      _this.forceUpdate();\n    });\n    this.subscribe(this.plugin.managers.structure.focus.events.historyUpdated, function (c) {\n      _this.forceUpdate();\n    });\n    this.subscribe(this.plugin.behaviors.state.isBusy, function (v) {\n      _this.setState({\n        isBusy: v,\n        showAction: false\n      });\n    });\n  };\n\n  Object.defineProperty(StructureFocusControls.prototype, \"isDisabled\", {\n    get: function () {\n      return this.state.isBusy || this.actionItems.length === 0;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(StructureFocusControls.prototype, \"actionItems\", {\n    get: function () {\n      var historyItems = [];\n      var history = this.plugin.managers.structure.focus.history;\n\n      if (history.length > 0) {\n        historyItems.push(__spreadArray([ActionMenu.Header('History', {\n          description: 'Previously focused on items.'\n        })], ActionMenu.createItems(history, {\n          label: function (f) {\n            return f.label;\n          },\n          description: function (f) {\n            return f.category && f.label !== f.category ? f.category + \" | \" + f.label : f.label;\n          }\n        }), true));\n      }\n\n      var presetItems = this.getSelectionItems(this.plugin.managers.structure.hierarchy.selection.structures);\n\n      if (presetItems.length === 1) {\n        var item = presetItems[0];\n        var header = item[0];\n        header.initiallyExpanded = true;\n      }\n\n      var items = [];\n      if (presetItems.length > 0) items.push.apply(items, presetItems);\n      if (historyItems.length > 0) items.push.apply(items, historyItems);\n      return items;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  StructureFocusControls.prototype.getToggleBindingLabel = function () {\n    var _a;\n\n    var t = this.plugin.state.behaviors.transforms.get(FocusLoci.id);\n    if (!t) return '';\n    var binding = (_a = t.params) === null || _a === void 0 ? void 0 : _a.bindings.clickFocus;\n    if (!binding || Binding.isEmpty(binding)) return '';\n    return Binding.formatTriggers(binding);\n  };\n\n  StructureFocusControls.prototype.render = function () {\n    var current = this.plugin.managers.structure.focus.current;\n    var label = (current === null || current === void 0 ? void 0 : current.label) || 'Nothing Focused';\n    var title = 'Click to Center Camera';\n\n    if (!current) {\n      title = 'Select focus using the menu';\n      var binding = this.getToggleBindingLabel();\n\n      if (binding) {\n        title += \"\\nor use '\" + binding + \"' on element\";\n      }\n    }\n\n    return _jsxs(_Fragment, {\n      children: [_jsxs(\"div\", __assign({\n        className: 'msp-flex-row'\n      }, {\n        children: [_jsx(Button, __assign({\n          noOverflow: true,\n          onClick: this.focusCamera,\n          title: title,\n          onMouseEnter: this.highlightCurrent,\n          onMouseLeave: this.clearHighlights,\n          disabled: this.isDisabled || !current,\n          style: {\n            textAlignLast: current ? 'left' : void 0\n          }\n        }, {\n          children: label\n        }), void 0), current && _jsx(IconButton, {\n          svg: CancelOutlinedSvg,\n          onClick: this.clear,\n          title: 'Clear',\n          className: 'msp-form-control',\n          flex: true,\n          disabled: this.isDisabled\n        }, void 0), _jsx(ToggleButton, {\n          icon: CenterFocusStrongSvg,\n          title: 'Select a focus target to center on an show its surroundings. Hold shift to focus on multiple targets.',\n          toggle: this.toggleAction,\n          isSelected: this.state.showAction,\n          disabled: this.isDisabled,\n          style: {\n            flex: '0 0 40px',\n            padding: 0\n          }\n        }, void 0)]\n      }), void 0), this.state.showAction && _jsx(ActionMenu, {\n        items: this.actionItems,\n        onSelect: this.selectAction\n      }, void 0)]\n    }, void 0);\n  };\n\n  return StructureFocusControls;\n}(PluginUIComponent);\n\nexport { StructureFocusControls };","map":{"version":3,"sources":["../../../src/mol-plugin-ui/structure/focus.tsx"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign, __extends, __spreadArray } from \"tslib\";\r\nimport { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from \"react/jsx-runtime\";\r\n/**\r\n * Copyright (c) 2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { OrderedSet, SortedArray } from '../../mol-data/int';\r\nimport { StructureElement, StructureProperties, Unit } from '../../mol-model/structure';\r\nimport { FocusLoci } from '../../mol-plugin/behavior/dynamic/representation';\r\nimport { lociLabel } from '../../mol-theme/label';\r\nimport { Binding } from '../../mol-util/binding';\r\nimport { memoizeLatest } from '../../mol-util/memoize';\r\nimport { PluginUIComponent } from '../base';\r\nimport { ActionMenu } from '../controls/action-menu';\r\nimport { Button, IconButton, ToggleButton } from '../controls/common';\r\nimport { CancelOutlinedSvg, CenterFocusStrongSvg } from '../controls/icons';\r\nfunction addSymmetryGroupEntries(entries, location, unitSymmetryGroup, granularity) {\r\n    var idx = SortedArray.indexOf(location.unit.elements, location.element);\r\n    var base = StructureElement.Loci(location.structure, [\r\n        { unit: location.unit, indices: OrderedSet.ofSingleton(idx) }\r\n    ]);\r\n    var extended = granularity === 'residue'\r\n        ? StructureElement.Loci.extendToWholeResidues(base)\r\n        : StructureElement.Loci.extendToWholeChains(base);\r\n    var name = StructureProperties.entity.pdbx_description(location).join(', ');\r\n    for (var _i = 0, _a = unitSymmetryGroup.units; _i < _a.length; _i++) {\r\n        var u = _a[_i];\r\n        var loci = StructureElement.Loci(extended.structure, [\r\n            { unit: u, indices: extended.elements[0].indices }\r\n        ]);\r\n        var label = lociLabel(loci, { reverse: true, hidePrefix: true, htmlStyling: false, granularity: granularity });\r\n        if (!label)\r\n            label = lociLabel(loci, { hidePrefix: false, htmlStyling: false });\r\n        if (unitSymmetryGroup.units.length > 1) {\r\n            label += \" | \" + loci.elements[0].unit.conformation.operator.name;\r\n        }\r\n        var item = { label: label, category: name, loci: loci };\r\n        if (entries.has(name))\r\n            entries.get(name).push(item);\r\n        else\r\n            entries.set(name, [item]);\r\n    }\r\n}\r\nfunction getFocusEntries(structure) {\r\n    var entityEntries = new Map();\r\n    var l = StructureElement.Location.create(structure);\r\n    for (var _i = 0, _a = structure.unitSymmetryGroups; _i < _a.length; _i++) {\r\n        var ug = _a[_i];\r\n        if (!Unit.isAtomic(ug.units[0]))\r\n            continue;\r\n        l.unit = ug.units[0];\r\n        l.element = ug.elements[0];\r\n        var isMultiChain = Unit.Traits.is(l.unit.traits, 1 /* MultiChain */);\r\n        var entityType = StructureProperties.entity.type(l);\r\n        var isNonPolymer = entityType === 'non-polymer';\r\n        var isBranched = entityType === 'branched';\r\n        var isBirdMolecule = !!StructureProperties.entity.prd_id(l);\r\n        if (isBirdMolecule) {\r\n            addSymmetryGroupEntries(entityEntries, l, ug, 'chain');\r\n        }\r\n        else if (isNonPolymer && !isMultiChain) {\r\n            addSymmetryGroupEntries(entityEntries, l, ug, 'residue');\r\n        }\r\n        else if (isBranched || (isNonPolymer && isMultiChain)) {\r\n            var u = l.unit;\r\n            var residueIndex = u.model.atomicHierarchy.residueAtomSegments.index;\r\n            var prev = -1;\r\n            for (var i = 0, il = u.elements.length; i < il; ++i) {\r\n                var eI = u.elements[i];\r\n                var rI = residueIndex[eI];\r\n                if (rI !== prev) {\r\n                    l.element = eI;\r\n                    addSymmetryGroupEntries(entityEntries, l, ug, 'residue');\r\n                    prev = rI;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    var entries = [];\r\n    entityEntries.forEach(function (e, name) {\r\n        if (e.length === 1) {\r\n            entries.push({ label: name + \": \" + e[0].label, loci: e[0].loci });\r\n        }\r\n        else if (e.length < 2000) {\r\n            entries.push.apply(entries, e);\r\n        }\r\n    });\r\n    return entries;\r\n}\r\nvar StructureFocusControls = /** @class */ (function (_super) {\r\n    __extends(StructureFocusControls, _super);\r\n    function StructureFocusControls() {\r\n        var _this = _super !== null && _super.apply(this, arguments) || this;\r\n        _this.state = { isBusy: false, showAction: false };\r\n        _this.getSelectionItems = memoizeLatest(function (structures) {\r\n            var _a;\r\n            var presetItems = [];\r\n            for (var _i = 0, structures_1 = structures; _i < structures_1.length; _i++) {\r\n                var s = structures_1[_i];\r\n                var d = (_a = s.cell.obj) === null || _a === void 0 ? void 0 : _a.data;\r\n                if (d) {\r\n                    var entries = getFocusEntries(d);\r\n                    if (entries.length > 0) {\r\n                        presetItems.push(__spreadArray([\r\n                            ActionMenu.Header(d.label, { description: d.label })\r\n                        ], ActionMenu.createItems(entries, {\r\n                            label: function (f) { return f.label; },\r\n                            category: function (f) { return f.category; },\r\n                            description: function (f) { return f.label; }\r\n                        }), true));\r\n                    }\r\n                }\r\n            }\r\n            return presetItems;\r\n        });\r\n        _this.selectAction = function (item, e) {\r\n            if (!item || !_this.state.showAction) {\r\n                _this.setState({ showAction: false });\r\n                return;\r\n            }\r\n            var f = item.value;\r\n            if (e === null || e === void 0 ? void 0 : e.shiftKey) {\r\n                _this.plugin.managers.structure.focus.addFromLoci(f.loci);\r\n            }\r\n            else {\r\n                _this.plugin.managers.structure.focus.set(f);\r\n            }\r\n            _this.focusCamera();\r\n        };\r\n        _this.toggleAction = function () { return _this.setState({ showAction: !_this.state.showAction }); };\r\n        _this.focusCamera = function () {\r\n            var current = _this.plugin.managers.structure.focus.current;\r\n            if (current)\r\n                _this.plugin.managers.camera.focusLoci(current.loci);\r\n        };\r\n        _this.clear = function () {\r\n            _this.plugin.managers.structure.focus.clear();\r\n            _this.plugin.managers.camera.reset();\r\n        };\r\n        _this.highlightCurrent = function () {\r\n            var current = _this.plugin.managers.structure.focus.current;\r\n            if (current)\r\n                _this.plugin.managers.interactivity.lociHighlights.highlightOnly({ loci: current.loci }, false);\r\n        };\r\n        _this.clearHighlights = function () {\r\n            _this.plugin.managers.interactivity.lociHighlights.clearHighlights();\r\n        };\r\n        return _this;\r\n    }\r\n    StructureFocusControls.prototype.componentDidMount = function () {\r\n        var _this = this;\r\n        this.subscribe(this.plugin.managers.structure.focus.behaviors.current, function (c) {\r\n            // clear the memo cache\r\n            _this.getSelectionItems([]);\r\n            _this.forceUpdate();\r\n        });\r\n        this.subscribe(this.plugin.managers.structure.focus.events.historyUpdated, function (c) {\r\n            _this.forceUpdate();\r\n        });\r\n        this.subscribe(this.plugin.behaviors.state.isBusy, function (v) {\r\n            _this.setState({ isBusy: v, showAction: false });\r\n        });\r\n    };\r\n    Object.defineProperty(StructureFocusControls.prototype, \"isDisabled\", {\r\n        get: function () {\r\n            return this.state.isBusy || this.actionItems.length === 0;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(StructureFocusControls.prototype, \"actionItems\", {\r\n        get: function () {\r\n            var historyItems = [];\r\n            var history = this.plugin.managers.structure.focus.history;\r\n            if (history.length > 0) {\r\n                historyItems.push(__spreadArray([\r\n                    ActionMenu.Header('History', { description: 'Previously focused on items.' })\r\n                ], ActionMenu.createItems(history, {\r\n                    label: function (f) { return f.label; },\r\n                    description: function (f) {\r\n                        return f.category && f.label !== f.category\r\n                            ? f.category + \" | \" + f.label\r\n                            : f.label;\r\n                    }\r\n                }), true));\r\n            }\r\n            var presetItems = this.getSelectionItems(this.plugin.managers.structure.hierarchy.selection.structures);\r\n            if (presetItems.length === 1) {\r\n                var item = presetItems[0];\r\n                var header = item[0];\r\n                header.initiallyExpanded = true;\r\n            }\r\n            var items = [];\r\n            if (presetItems.length > 0)\r\n                items.push.apply(items, presetItems);\r\n            if (historyItems.length > 0)\r\n                items.push.apply(items, historyItems);\r\n            return items;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    StructureFocusControls.prototype.getToggleBindingLabel = function () {\r\n        var _a;\r\n        var t = this.plugin.state.behaviors.transforms.get(FocusLoci.id);\r\n        if (!t)\r\n            return '';\r\n        var binding = (_a = t.params) === null || _a === void 0 ? void 0 : _a.bindings.clickFocus;\r\n        if (!binding || Binding.isEmpty(binding))\r\n            return '';\r\n        return Binding.formatTriggers(binding);\r\n    };\r\n    StructureFocusControls.prototype.render = function () {\r\n        var current = this.plugin.managers.structure.focus.current;\r\n        var label = (current === null || current === void 0 ? void 0 : current.label) || 'Nothing Focused';\r\n        var title = 'Click to Center Camera';\r\n        if (!current) {\r\n            title = 'Select focus using the menu';\r\n            var binding = this.getToggleBindingLabel();\r\n            if (binding) {\r\n                title += \"\\nor use '\" + binding + \"' on element\";\r\n            }\r\n        }\r\n        return _jsxs(_Fragment, { children: [_jsxs(\"div\", __assign({ className: 'msp-flex-row' }, { children: [_jsx(Button, __assign({ noOverflow: true, onClick: this.focusCamera, title: title, onMouseEnter: this.highlightCurrent, onMouseLeave: this.clearHighlights, disabled: this.isDisabled || !current, style: { textAlignLast: current ? 'left' : void 0 } }, { children: label }), void 0), current && _jsx(IconButton, { svg: CancelOutlinedSvg, onClick: this.clear, title: 'Clear', className: 'msp-form-control', flex: true, disabled: this.isDisabled }, void 0), _jsx(ToggleButton, { icon: CenterFocusStrongSvg, title: 'Select a focus target to center on an show its surroundings. Hold shift to focus on multiple targets.', toggle: this.toggleAction, isSelected: this.state.showAction, disabled: this.isDisabled, style: { flex: '0 0 40px', padding: 0 } }, void 0)] }), void 0), this.state.showAction && _jsx(ActionMenu, { items: this.actionItems, onSelect: this.selectAction }, void 0)] }, void 0);\r\n    };\r\n    return StructureFocusControls;\r\n}(PluginUIComponent));\r\nexport { StructureFocusControls };\r\n//# sourceMappingURL=focus.js.map"]},"metadata":{},"sourceType":"module"}