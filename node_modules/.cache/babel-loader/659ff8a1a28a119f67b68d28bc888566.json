{"ast":null,"code":"/**\r\n * Copyright (c) 2019-2021 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\nimport { Vec3 } from '../../mol-math/linear-algebra';\nimport { spiral2d } from '../../mol-math/misc';\nimport { decodeFloatRGB, unpackRGBAToDepth } from '../../mol-util/float-packing';\nimport { StereoCamera } from '../camera/stereo';\nimport { cameraUnproject } from '../camera/util';\nimport { Viewport } from '../camera/util';\nvar NullId = Math.pow(2, 24) - 2;\n\nvar PickPass =\n/** @class */\nfunction () {\n  function PickPass(webgl, drawPass, pickBaseScale) {\n    this.webgl = webgl;\n    this.drawPass = drawPass;\n    this.pickBaseScale = pickBaseScale;\n    var pickScale = pickBaseScale / webgl.pixelRatio;\n    this.pickWidth = Math.ceil(drawPass.colorTarget.getWidth() * pickScale);\n    this.pickHeight = Math.ceil(drawPass.colorTarget.getHeight() * pickScale);\n    this.objectPickTarget = webgl.createRenderTarget(this.pickWidth, this.pickHeight);\n    this.instancePickTarget = webgl.createRenderTarget(this.pickWidth, this.pickHeight);\n    this.groupPickTarget = webgl.createRenderTarget(this.pickWidth, this.pickHeight);\n    this.depthPickTarget = webgl.createRenderTarget(this.pickWidth, this.pickHeight);\n  }\n\n  Object.defineProperty(PickPass.prototype, \"drawingBufferHeight\", {\n    get: function () {\n      return this.drawPass.colorTarget.getHeight();\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  PickPass.prototype.syncSize = function () {\n    var pickScale = this.pickBaseScale / this.webgl.pixelRatio;\n    var pickWidth = Math.ceil(this.drawPass.colorTarget.getWidth() * pickScale);\n    var pickHeight = Math.ceil(this.drawPass.colorTarget.getHeight() * pickScale);\n\n    if (pickWidth !== this.pickWidth || pickHeight !== this.pickHeight) {\n      this.pickWidth = pickWidth;\n      this.pickHeight = pickHeight;\n      this.objectPickTarget.setSize(this.pickWidth, this.pickHeight);\n      this.instancePickTarget.setSize(this.pickWidth, this.pickHeight);\n      this.groupPickTarget.setSize(this.pickWidth, this.pickHeight);\n      this.depthPickTarget.setSize(this.pickWidth, this.pickHeight);\n    }\n  };\n\n  PickPass.prototype.renderVariant = function (renderer, camera, scene, helper, variant) {\n    var depth = this.drawPass.depthTexturePrimitives;\n    renderer.clear(false);\n    renderer.update(camera);\n    renderer.renderPick(scene.primitives, camera, variant, null);\n    renderer.renderPick(scene.volumes, camera, variant, depth);\n    renderer.renderPick(helper.handle.scene, camera, variant, null);\n\n    if (helper.camera.isEnabled) {\n      helper.camera.update(camera);\n      renderer.update(helper.camera.camera);\n      renderer.renderPick(helper.camera.scene, helper.camera.camera, variant, null);\n    }\n  };\n\n  PickPass.prototype.render = function (renderer, camera, scene, helper) {\n    this.objectPickTarget.bind();\n    this.renderVariant(renderer, camera, scene, helper, 'pickObject');\n    this.instancePickTarget.bind();\n    this.renderVariant(renderer, camera, scene, helper, 'pickInstance');\n    this.groupPickTarget.bind();\n    this.renderVariant(renderer, camera, scene, helper, 'pickGroup'); // printTexture(this.webgl, this.groupPickTarget.texture, { id: 'group' })\n\n    this.depthPickTarget.bind();\n    this.renderVariant(renderer, camera, scene, helper, 'depth');\n  };\n\n  return PickPass;\n}();\n\nexport { PickPass };\n\nvar PickHelper =\n/** @class */\nfunction () {\n  function PickHelper(webgl, renderer, scene, helper, pickPass, viewport, pickPadding) {\n    if (pickPadding === void 0) {\n      pickPadding = 1;\n    }\n\n    this.webgl = webgl;\n    this.renderer = renderer;\n    this.scene = scene;\n    this.helper = helper;\n    this.pickPass = pickPass;\n    this.pickPadding = pickPadding;\n    this.dirty = true;\n    this.viewport = Viewport();\n    this.setViewport(viewport.x, viewport.y, viewport.width, viewport.height);\n  }\n\n  PickHelper.prototype.setupBuffers = function () {\n    var bufferSize = this.pickWidth * this.pickHeight * 4;\n\n    if (!this.objectBuffer || this.objectBuffer.length !== bufferSize) {\n      this.objectBuffer = new Uint8Array(bufferSize);\n      this.instanceBuffer = new Uint8Array(bufferSize);\n      this.groupBuffer = new Uint8Array(bufferSize);\n      this.depthBuffer = new Uint8Array(bufferSize);\n    }\n  };\n\n  PickHelper.prototype.setViewport = function (x, y, width, height) {\n    Viewport.set(this.viewport, x, y, width, height);\n    this.pickScale = this.pickPass.pickBaseScale / this.webgl.pixelRatio;\n    this.pickX = Math.ceil(x * this.pickScale);\n    this.pickY = Math.ceil(y * this.pickScale);\n    var pickWidth = Math.floor(width * this.pickScale);\n    var pickHeight = Math.floor(height * this.pickScale);\n\n    if (pickWidth !== this.pickWidth || pickHeight !== this.pickHeight) {\n      this.pickWidth = pickWidth;\n      this.pickHeight = pickHeight;\n      this.halfPickWidth = Math.floor(this.pickWidth / 2);\n      this.setupBuffers();\n    }\n\n    this.spiral = spiral2d(Math.round(this.pickScale * this.pickPadding));\n  };\n\n  PickHelper.prototype.syncBuffers = function () {\n    var _a = this,\n        pickX = _a.pickX,\n        pickY = _a.pickY,\n        pickWidth = _a.pickWidth,\n        pickHeight = _a.pickHeight;\n\n    this.pickPass.objectPickTarget.bind();\n    this.webgl.readPixels(pickX, pickY, pickWidth, pickHeight, this.objectBuffer);\n    this.pickPass.instancePickTarget.bind();\n    this.webgl.readPixels(pickX, pickY, pickWidth, pickHeight, this.instanceBuffer);\n    this.pickPass.groupPickTarget.bind();\n    this.webgl.readPixels(pickX, pickY, pickWidth, pickHeight, this.groupBuffer);\n    this.pickPass.depthPickTarget.bind();\n    this.webgl.readPixels(pickX, pickY, pickWidth, pickHeight, this.depthBuffer);\n  };\n\n  PickHelper.prototype.getBufferIdx = function (x, y) {\n    return (y * this.pickWidth + x) * 4;\n  };\n\n  PickHelper.prototype.getDepth = function (x, y) {\n    var idx = this.getBufferIdx(x, y);\n    var b = this.depthBuffer;\n    return unpackRGBAToDepth(b[idx], b[idx + 1], b[idx + 2], b[idx + 3]);\n  };\n\n  PickHelper.prototype.getId = function (x, y, buffer) {\n    var idx = this.getBufferIdx(x, y);\n    return decodeFloatRGB(buffer[idx], buffer[idx + 1], buffer[idx + 2]);\n  };\n\n  PickHelper.prototype.render = function (camera) {\n    var _a = this,\n        pickX = _a.pickX,\n        pickY = _a.pickY,\n        pickWidth = _a.pickWidth,\n        pickHeight = _a.pickHeight,\n        halfPickWidth = _a.halfPickWidth;\n\n    var _b = this,\n        renderer = _b.renderer,\n        scene = _b.scene,\n        helper = _b.helper;\n\n    renderer.setTransparentBackground(false);\n    renderer.setDrawingBufferSize(this.pickPass.objectPickTarget.getWidth(), this.pickPass.objectPickTarget.getHeight());\n    renderer.setPixelRatio(this.pickScale);\n\n    if (StereoCamera.is(camera)) {\n      renderer.setViewport(pickX, pickY, halfPickWidth, pickHeight);\n      this.pickPass.render(renderer, camera.left, scene, helper);\n      renderer.setViewport(pickX + halfPickWidth, pickY, pickWidth - halfPickWidth, pickHeight);\n      this.pickPass.render(renderer, camera.right, scene, helper);\n    } else {\n      renderer.setViewport(pickX, pickY, pickWidth, pickHeight);\n      this.pickPass.render(renderer, camera, scene, helper);\n    }\n\n    this.dirty = false;\n  };\n\n  PickHelper.prototype.identifyInternal = function (x, y, camera) {\n    var _a = this,\n        webgl = _a.webgl,\n        pickScale = _a.pickScale;\n\n    if (webgl.isContextLost) return;\n    x *= webgl.pixelRatio;\n    y *= webgl.pixelRatio;\n    y = this.pickPass.drawingBufferHeight - y; // flip y\n\n    var viewport = this.viewport; // check if within viewport\n\n    if (x < viewport.x || y < viewport.y || x > viewport.x + viewport.width || y > viewport.y + viewport.height) return;\n\n    if (this.dirty) {\n      this.render(camera);\n      this.syncBuffers();\n    }\n\n    var xv = x - viewport.x;\n    var yv = y - viewport.y;\n    var xp = Math.floor(xv * pickScale);\n    var yp = Math.floor(yv * pickScale);\n    var objectId = this.getId(xp, yp, this.objectBuffer); // console.log('objectId', objectId);\n\n    if (objectId === -1 || objectId === NullId) return;\n    var instanceId = this.getId(xp, yp, this.instanceBuffer); // console.log('instanceId', instanceId);\n\n    if (instanceId === -1 || instanceId === NullId) return;\n    var groupId = this.getId(xp, yp, this.groupBuffer); // console.log('groupId', groupId);\n\n    if (groupId === -1 || groupId === NullId) return;\n    var z = this.getDepth(xp, yp);\n    var position = Vec3.create(x, viewport.height - y, z);\n\n    if (StereoCamera.is(camera)) {\n      var halfWidth = Math.floor(viewport.width / 2);\n\n      if (x > viewport.x + halfWidth) {\n        position[0] = viewport.x + (xv - halfWidth) * 2;\n        cameraUnproject(position, position, viewport, camera.right.inverseProjectionView);\n      } else {\n        position[0] = viewport.x + xv * 2;\n        cameraUnproject(position, position, viewport, camera.left.inverseProjectionView);\n      }\n    } else {\n      cameraUnproject(position, position, viewport, camera.inverseProjectionView);\n    } // console.log({ { objectId, instanceId, groupId }, position} );\n\n\n    return {\n      id: {\n        objectId: objectId,\n        instanceId: instanceId,\n        groupId: groupId\n      },\n      position: position\n    };\n  };\n\n  PickHelper.prototype.identify = function (x, y, camera) {\n    for (var _i = 0, _a = this.spiral; _i < _a.length; _i++) {\n      var d = _a[_i];\n      var pickData = this.identifyInternal(x + d[0], y + d[1], camera);\n      if (pickData) return pickData;\n    }\n  };\n\n  return PickHelper;\n}();\n\nexport { PickHelper };","map":{"version":3,"sources":["../../../src/mol-canvas3d/passes/pick.ts"],"names":[],"mappings":"AAAA;;;;AAIG;AAQH,SAAS,IAAT,QAAqB,+BAArB;AACA,SAAS,QAAT,QAAyB,qBAAzB;AACA,SAAS,cAAT,EAAyB,iBAAzB,QAAkD,8BAAlD;AAEA,SAAS,YAAT,QAA6B,kBAA7B;AACA,SAAS,eAAT,QAAgC,gBAAhC;AACA,SAAS,QAAT,QAAyB,gBAAzB;AAIA,IAAM,MAAM,GAAG,IAAI,CAAC,GAAL,CAAS,CAAT,EAAY,EAAZ,IAAkB,CAAjC;;AAIA,IAAA,QAAA;AAAA;AAAA,YAAA;AASI,WAAA,QAAA,CAAoB,KAApB,EAAiD,QAAjD,EAA8E,aAA9E,EAAmG;AAA/E,SAAA,KAAA,GAAA,KAAA;AAA6B,SAAA,QAAA,GAAA,QAAA;AAA6B,SAAA,aAAA,GAAA,aAAA;AAC1E,QAAM,SAAS,GAAG,aAAa,GAAG,KAAK,CAAC,UAAxC;AACA,SAAK,SAAL,GAAiB,IAAI,CAAC,IAAL,CAAU,QAAQ,CAAC,WAAT,CAAqB,QAArB,KAAkC,SAA5C,CAAjB;AACA,SAAK,UAAL,GAAkB,IAAI,CAAC,IAAL,CAAU,QAAQ,CAAC,WAAT,CAAqB,SAArB,KAAmC,SAA7C,CAAlB;AAEA,SAAK,gBAAL,GAAwB,KAAK,CAAC,kBAAN,CAAyB,KAAK,SAA9B,EAAyC,KAAK,UAA9C,CAAxB;AACA,SAAK,kBAAL,GAA0B,KAAK,CAAC,kBAAN,CAAyB,KAAK,SAA9B,EAAyC,KAAK,UAA9C,CAA1B;AACA,SAAK,eAAL,GAAuB,KAAK,CAAC,kBAAN,CAAyB,KAAK,SAA9B,EAAyC,KAAK,UAA9C,CAAvB;AACA,SAAK,eAAL,GAAuB,KAAK,CAAC,kBAAN,CAAyB,KAAK,SAA9B,EAAyC,KAAK,UAA9C,CAAvB;AACH;;AAED,EAAA,MAAA,CAAA,cAAA,CAAI,QAAA,CAAA,SAAJ,EAAI,qBAAJ,EAAuB;SAAvB,YAAA;AACI,aAAO,KAAK,QAAL,CAAc,WAAd,CAA0B,SAA1B,EAAP;AACH,KAFsB;qBAAA;;AAAA,GAAvB;;AAIA,EAAA,QAAA,CAAA,SAAA,CAAA,QAAA,GAAA,YAAA;AACI,QAAM,SAAS,GAAG,KAAK,aAAL,GAAqB,KAAK,KAAL,CAAW,UAAlD;AACA,QAAM,SAAS,GAAG,IAAI,CAAC,IAAL,CAAU,KAAK,QAAL,CAAc,WAAd,CAA0B,QAA1B,KAAuC,SAAjD,CAAlB;AACA,QAAM,UAAU,GAAG,IAAI,CAAC,IAAL,CAAU,KAAK,QAAL,CAAc,WAAd,CAA0B,SAA1B,KAAwC,SAAlD,CAAnB;;AAEA,QAAI,SAAS,KAAK,KAAK,SAAnB,IAAgC,UAAU,KAAK,KAAK,UAAxD,EAAoE;AAChE,WAAK,SAAL,GAAiB,SAAjB;AACA,WAAK,UAAL,GAAkB,UAAlB;AAEA,WAAK,gBAAL,CAAsB,OAAtB,CAA8B,KAAK,SAAnC,EAA8C,KAAK,UAAnD;AACA,WAAK,kBAAL,CAAwB,OAAxB,CAAgC,KAAK,SAArC,EAAgD,KAAK,UAArD;AACA,WAAK,eAAL,CAAqB,OAArB,CAA6B,KAAK,SAAlC,EAA6C,KAAK,UAAlD;AACA,WAAK,eAAL,CAAqB,OAArB,CAA6B,KAAK,SAAlC,EAA6C,KAAK,UAAlD;AACH;AACJ,GAdD;;AAgBQ,EAAA,QAAA,CAAA,SAAA,CAAA,aAAA,GAAR,UAAsB,QAAtB,EAA0C,MAA1C,EAA2D,KAA3D,EAAyE,MAAzE,EAAyF,OAAzF,EAAuH;AACnH,QAAM,KAAK,GAAG,KAAK,QAAL,CAAc,sBAA5B;AACA,IAAA,QAAQ,CAAC,KAAT,CAAe,KAAf;AAEA,IAAA,QAAQ,CAAC,MAAT,CAAgB,MAAhB;AACA,IAAA,QAAQ,CAAC,UAAT,CAAoB,KAAK,CAAC,UAA1B,EAAsC,MAAtC,EAA8C,OAA9C,EAAuD,IAAvD;AACA,IAAA,QAAQ,CAAC,UAAT,CAAoB,KAAK,CAAC,OAA1B,EAAmC,MAAnC,EAA2C,OAA3C,EAAoD,KAApD;AACA,IAAA,QAAQ,CAAC,UAAT,CAAoB,MAAM,CAAC,MAAP,CAAc,KAAlC,EAAyC,MAAzC,EAAiD,OAAjD,EAA0D,IAA1D;;AAEA,QAAI,MAAM,CAAC,MAAP,CAAc,SAAlB,EAA6B;AACzB,MAAA,MAAM,CAAC,MAAP,CAAc,MAAd,CAAqB,MAArB;AACA,MAAA,QAAQ,CAAC,MAAT,CAAgB,MAAM,CAAC,MAAP,CAAc,MAA9B;AACA,MAAA,QAAQ,CAAC,UAAT,CAAoB,MAAM,CAAC,MAAP,CAAc,KAAlC,EAAyC,MAAM,CAAC,MAAP,CAAc,MAAvD,EAA+D,OAA/D,EAAwE,IAAxE;AACH;AACJ,GAdO;;AAgBR,EAAA,QAAA,CAAA,SAAA,CAAA,MAAA,GAAA,UAAO,QAAP,EAA2B,MAA3B,EAA4C,KAA5C,EAA0D,MAA1D,EAAwE;AACpE,SAAK,gBAAL,CAAsB,IAAtB;AACA,SAAK,aAAL,CAAmB,QAAnB,EAA6B,MAA7B,EAAqC,KAArC,EAA4C,MAA5C,EAAoD,YAApD;AAEA,SAAK,kBAAL,CAAwB,IAAxB;AACA,SAAK,aAAL,CAAmB,QAAnB,EAA6B,MAA7B,EAAqC,KAArC,EAA4C,MAA5C,EAAoD,cAApD;AAEA,SAAK,eAAL,CAAqB,IAArB;AACA,SAAK,aAAL,CAAmB,QAAnB,EAA6B,MAA7B,EAAqC,KAArC,EAA4C,MAA5C,EAAoD,WAApD,EARoE,CASpE;;AAEA,SAAK,eAAL,CAAqB,IAArB;AACA,SAAK,aAAL,CAAmB,QAAnB,EAA6B,MAA7B,EAAqC,KAArC,EAA4C,MAA5C,EAAoD,OAApD;AACH,GAbD;;AAcJ,SAAA,QAAA;AAAC,CAtED,EAAA;;;;AAwEA,IAAA,UAAA;AAAA;AAAA,YAAA;AAyKI,WAAA,UAAA,CAAoB,KAApB,EAAiD,QAAjD,EAA6E,KAA7E,EAAmG,MAAnG,EAA2H,QAA3H,EAA+I,QAA/I,EAA4K,WAA5K,EAA2L;AAAf,QAAA,WAAA,KAAA,KAAA,CAAA,EAAA;AAAA,MAAA,WAAA,GAAA,CAAA;AAAe;;AAAvK,SAAA,KAAA,GAAA,KAAA;AAA6B,SAAA,QAAA,GAAA,QAAA;AAA4B,SAAA,KAAA,GAAA,KAAA;AAAsB,SAAA,MAAA,GAAA,MAAA;AAAwB,SAAA,QAAA,GAAA,QAAA;AAAiD,SAAA,WAAA,GAAA,WAAA;AAxK5K,SAAA,KAAA,GAAQ,IAAR;AAOQ,SAAA,QAAA,GAAW,QAAQ,EAAnB;AAkKJ,SAAK,WAAL,CAAiB,QAAQ,CAAC,CAA1B,EAA6B,QAAQ,CAAC,CAAtC,EAAyC,QAAQ,CAAC,KAAlD,EAAyD,QAAQ,CAAC,MAAlE;AACH;;AAxJO,EAAA,UAAA,CAAA,SAAA,CAAA,YAAA,GAAR,YAAA;AACI,QAAM,UAAU,GAAG,KAAK,SAAL,GAAiB,KAAK,UAAtB,GAAmC,CAAtD;;AACA,QAAI,CAAC,KAAK,YAAN,IAAsB,KAAK,YAAL,CAAkB,MAAlB,KAA6B,UAAvD,EAAmE;AAC/D,WAAK,YAAL,GAAoB,IAAI,UAAJ,CAAe,UAAf,CAApB;AACA,WAAK,cAAL,GAAsB,IAAI,UAAJ,CAAe,UAAf,CAAtB;AACA,WAAK,WAAL,GAAmB,IAAI,UAAJ,CAAe,UAAf,CAAnB;AACA,WAAK,WAAL,GAAmB,IAAI,UAAJ,CAAe,UAAf,CAAnB;AACH;AACJ,GARO;;AAUR,EAAA,UAAA,CAAA,SAAA,CAAA,WAAA,GAAA,UAAY,CAAZ,EAAuB,CAAvB,EAAkC,KAAlC,EAAiD,MAAjD,EAA+D;AAC3D,IAAA,QAAQ,CAAC,GAAT,CAAa,KAAK,QAAlB,EAA4B,CAA5B,EAA+B,CAA/B,EAAkC,KAAlC,EAAyC,MAAzC;AAEA,SAAK,SAAL,GAAiB,KAAK,QAAL,CAAc,aAAd,GAA8B,KAAK,KAAL,CAAW,UAA1D;AACA,SAAK,KAAL,GAAa,IAAI,CAAC,IAAL,CAAU,CAAC,GAAG,KAAK,SAAnB,CAAb;AACA,SAAK,KAAL,GAAa,IAAI,CAAC,IAAL,CAAU,CAAC,GAAG,KAAK,SAAnB,CAAb;AAEA,QAAM,SAAS,GAAG,IAAI,CAAC,KAAL,CAAW,KAAK,GAAG,KAAK,SAAxB,CAAlB;AACA,QAAM,UAAU,GAAG,IAAI,CAAC,KAAL,CAAW,MAAM,GAAG,KAAK,SAAzB,CAAnB;;AAEA,QAAI,SAAS,KAAK,KAAK,SAAnB,IAAgC,UAAU,KAAK,KAAK,UAAxD,EAAoE;AAChE,WAAK,SAAL,GAAiB,SAAjB;AACA,WAAK,UAAL,GAAkB,UAAlB;AACA,WAAK,aAAL,GAAqB,IAAI,CAAC,KAAL,CAAW,KAAK,SAAL,GAAiB,CAA5B,CAArB;AAEA,WAAK,YAAL;AACH;;AAED,SAAK,MAAL,GAAc,QAAQ,CAAC,IAAI,CAAC,KAAL,CAAW,KAAK,SAAL,GAAiB,KAAK,WAAjC,CAAD,CAAtB;AACH,GAnBD;;AAqBQ,EAAA,UAAA,CAAA,SAAA,CAAA,WAAA,GAAR,YAAA;AACU,QAAA,EAAA,GAA0C,IAA1C;AAAA,QAAE,KAAK,GAAA,EAAA,CAAA,KAAP;AAAA,QAAS,KAAK,GAAA,EAAA,CAAA,KAAd;AAAA,QAAgB,SAAS,GAAA,EAAA,CAAA,SAAzB;AAAA,QAA2B,UAAU,GAAA,EAAA,CAAA,UAArC;;AAEN,SAAK,QAAL,CAAc,gBAAd,CAA+B,IAA/B;AACA,SAAK,KAAL,CAAW,UAAX,CAAsB,KAAtB,EAA6B,KAA7B,EAAoC,SAApC,EAA+C,UAA/C,EAA2D,KAAK,YAAhE;AAEA,SAAK,QAAL,CAAc,kBAAd,CAAiC,IAAjC;AACA,SAAK,KAAL,CAAW,UAAX,CAAsB,KAAtB,EAA6B,KAA7B,EAAoC,SAApC,EAA+C,UAA/C,EAA2D,KAAK,cAAhE;AAEA,SAAK,QAAL,CAAc,eAAd,CAA8B,IAA9B;AACA,SAAK,KAAL,CAAW,UAAX,CAAsB,KAAtB,EAA6B,KAA7B,EAAoC,SAApC,EAA+C,UAA/C,EAA2D,KAAK,WAAhE;AAEA,SAAK,QAAL,CAAc,eAAd,CAA8B,IAA9B;AACA,SAAK,KAAL,CAAW,UAAX,CAAsB,KAAtB,EAA6B,KAA7B,EAAoC,SAApC,EAA+C,UAA/C,EAA2D,KAAK,WAAhE;AACH,GAdO;;AAgBA,EAAA,UAAA,CAAA,SAAA,CAAA,YAAA,GAAR,UAAqB,CAArB,EAAgC,CAAhC,EAAyC;AACrC,WAAO,CAAC,CAAC,GAAG,KAAK,SAAT,GAAqB,CAAtB,IAA2B,CAAlC;AACH,GAFO;;AAIA,EAAA,UAAA,CAAA,SAAA,CAAA,QAAA,GAAR,UAAiB,CAAjB,EAA4B,CAA5B,EAAqC;AACjC,QAAM,GAAG,GAAG,KAAK,YAAL,CAAkB,CAAlB,EAAqB,CAArB,CAAZ;AACA,QAAM,CAAC,GAAG,KAAK,WAAf;AACA,WAAO,iBAAiB,CAAC,CAAC,CAAC,GAAD,CAAF,EAAS,CAAC,CAAC,GAAG,GAAG,CAAP,CAAV,EAAqB,CAAC,CAAC,GAAG,GAAG,CAAP,CAAtB,EAAiC,CAAC,CAAC,GAAG,GAAG,CAAP,CAAlC,CAAxB;AACH,GAJO;;AAMA,EAAA,UAAA,CAAA,SAAA,CAAA,KAAA,GAAR,UAAc,CAAd,EAAyB,CAAzB,EAAoC,MAApC,EAAsD;AAClD,QAAM,GAAG,GAAG,KAAK,YAAL,CAAkB,CAAlB,EAAqB,CAArB,CAAZ;AACA,WAAO,cAAc,CAAC,MAAM,CAAC,GAAD,CAAP,EAAc,MAAM,CAAC,GAAG,GAAG,CAAP,CAApB,EAA+B,MAAM,CAAC,GAAG,GAAG,CAAP,CAArC,CAArB;AACH,GAHO;;AAKA,EAAA,UAAA,CAAA,SAAA,CAAA,MAAA,GAAR,UAAe,MAAf,EAA4C;AAClC,QAAA,EAAA,GAAyD,IAAzD;AAAA,QAAE,KAAK,GAAA,EAAA,CAAA,KAAP;AAAA,QAAS,KAAK,GAAA,EAAA,CAAA,KAAd;AAAA,QAAgB,SAAS,GAAA,EAAA,CAAA,SAAzB;AAAA,QAA2B,UAAU,GAAA,EAAA,CAAA,UAArC;AAAA,QAAuC,aAAa,GAAA,EAAA,CAAA,aAApD;;AACA,QAAA,EAAA,GAA8B,IAA9B;AAAA,QAAE,QAAQ,GAAA,EAAA,CAAA,QAAV;AAAA,QAAY,KAAK,GAAA,EAAA,CAAA,KAAjB;AAAA,QAAmB,MAAM,GAAA,EAAA,CAAA,MAAzB;;AAEN,IAAA,QAAQ,CAAC,wBAAT,CAAkC,KAAlC;AACA,IAAA,QAAQ,CAAC,oBAAT,CAA8B,KAAK,QAAL,CAAc,gBAAd,CAA+B,QAA/B,EAA9B,EAAyE,KAAK,QAAL,CAAc,gBAAd,CAA+B,SAA/B,EAAzE;AACA,IAAA,QAAQ,CAAC,aAAT,CAAuB,KAAK,SAA5B;;AAEA,QAAI,YAAY,CAAC,EAAb,CAAgB,MAAhB,CAAJ,EAA6B;AACzB,MAAA,QAAQ,CAAC,WAAT,CAAqB,KAArB,EAA4B,KAA5B,EAAmC,aAAnC,EAAkD,UAAlD;AACA,WAAK,QAAL,CAAc,MAAd,CAAqB,QAArB,EAA+B,MAAM,CAAC,IAAtC,EAA4C,KAA5C,EAAmD,MAAnD;AAEA,MAAA,QAAQ,CAAC,WAAT,CAAqB,KAAK,GAAG,aAA7B,EAA4C,KAA5C,EAAmD,SAAS,GAAG,aAA/D,EAA8E,UAA9E;AACA,WAAK,QAAL,CAAc,MAAd,CAAqB,QAArB,EAA+B,MAAM,CAAC,KAAtC,EAA6C,KAA7C,EAAoD,MAApD;AACH,KAND,MAMO;AACH,MAAA,QAAQ,CAAC,WAAT,CAAqB,KAArB,EAA4B,KAA5B,EAAmC,SAAnC,EAA8C,UAA9C;AACA,WAAK,QAAL,CAAc,MAAd,CAAqB,QAArB,EAA+B,MAA/B,EAAuC,KAAvC,EAA8C,MAA9C;AACH;;AAED,SAAK,KAAL,GAAa,KAAb;AACH,GApBO;;AAsBA,EAAA,UAAA,CAAA,SAAA,CAAA,gBAAA,GAAR,UAAyB,CAAzB,EAAoC,CAApC,EAA+C,MAA/C,EAA4E;AAClE,QAAA,EAAA,GAAuB,IAAvB;AAAA,QAAE,KAAK,GAAA,EAAA,CAAA,KAAP;AAAA,QAAS,SAAS,GAAA,EAAA,CAAA,SAAlB;;AACN,QAAI,KAAK,CAAC,aAAV,EAAyB;AAEzB,IAAA,CAAC,IAAI,KAAK,CAAC,UAAX;AACA,IAAA,CAAC,IAAI,KAAK,CAAC,UAAX;AACA,IAAA,CAAC,GAAG,KAAK,QAAL,CAAc,mBAAd,GAAoC,CAAxC,CANwE,CAM7B;;AAEnC,QAAA,QAAQ,GAAK,KAAL,QAAR,CARgE,CAUxE;;AACA,QAAI,CAAC,GAAG,QAAQ,CAAC,CAAb,IACA,CAAC,GAAG,QAAQ,CAAC,CADb,IAEA,CAAC,GAAG,QAAQ,CAAC,CAAT,GAAa,QAAQ,CAAC,KAF1B,IAGA,CAAC,GAAG,QAAQ,CAAC,CAAT,GAAa,QAAQ,CAAC,MAH9B,EAIE;;AAEF,QAAI,KAAK,KAAT,EAAgB;AACZ,WAAK,MAAL,CAAY,MAAZ;AACA,WAAK,WAAL;AACH;;AAED,QAAM,EAAE,GAAG,CAAC,GAAG,QAAQ,CAAC,CAAxB;AACA,QAAM,EAAE,GAAG,CAAC,GAAG,QAAQ,CAAC,CAAxB;AAEA,QAAM,EAAE,GAAG,IAAI,CAAC,KAAL,CAAW,EAAE,GAAG,SAAhB,CAAX;AACA,QAAM,EAAE,GAAG,IAAI,CAAC,KAAL,CAAW,EAAE,GAAG,SAAhB,CAAX;AAEA,QAAM,QAAQ,GAAG,KAAK,KAAL,CAAW,EAAX,EAAe,EAAf,EAAmB,KAAK,YAAxB,CAAjB,CA5BwE,CA6BxE;;AACA,QAAI,QAAQ,KAAK,CAAC,CAAd,IAAmB,QAAQ,KAAK,MAApC,EAA4C;AAE5C,QAAM,UAAU,GAAG,KAAK,KAAL,CAAW,EAAX,EAAe,EAAf,EAAmB,KAAK,cAAxB,CAAnB,CAhCwE,CAiCxE;;AACA,QAAI,UAAU,KAAK,CAAC,CAAhB,IAAqB,UAAU,KAAK,MAAxC,EAAgD;AAEhD,QAAM,OAAO,GAAG,KAAK,KAAL,CAAW,EAAX,EAAe,EAAf,EAAmB,KAAK,WAAxB,CAAhB,CApCwE,CAqCxE;;AACA,QAAI,OAAO,KAAK,CAAC,CAAb,IAAkB,OAAO,KAAK,MAAlC,EAA0C;AAE1C,QAAM,CAAC,GAAG,KAAK,QAAL,CAAc,EAAd,EAAkB,EAAlB,CAAV;AACA,QAAM,QAAQ,GAAG,IAAI,CAAC,MAAL,CAAY,CAAZ,EAAe,QAAQ,CAAC,MAAT,GAAkB,CAAjC,EAAoC,CAApC,CAAjB;;AACA,QAAI,YAAY,CAAC,EAAb,CAAgB,MAAhB,CAAJ,EAA6B;AACzB,UAAM,SAAS,GAAG,IAAI,CAAC,KAAL,CAAW,QAAQ,CAAC,KAAT,GAAiB,CAA5B,CAAlB;;AACA,UAAI,CAAC,GAAG,QAAQ,CAAC,CAAT,GAAa,SAArB,EAAgC;AAC5B,QAAA,QAAQ,CAAC,CAAD,CAAR,GAAc,QAAQ,CAAC,CAAT,GAAa,CAAC,EAAE,GAAG,SAAN,IAAmB,CAA9C;AACA,QAAA,eAAe,CAAC,QAAD,EAAW,QAAX,EAAqB,QAArB,EAA+B,MAAM,CAAC,KAAP,CAAa,qBAA5C,CAAf;AACH,OAHD,MAGO;AACH,QAAA,QAAQ,CAAC,CAAD,CAAR,GAAc,QAAQ,CAAC,CAAT,GAAa,EAAE,GAAG,CAAhC;AACA,QAAA,eAAe,CAAC,QAAD,EAAW,QAAX,EAAqB,QAArB,EAA+B,MAAM,CAAC,IAAP,CAAY,qBAA3C,CAAf;AACH;AACJ,KATD,MASO;AACH,MAAA,eAAe,CAAC,QAAD,EAAW,QAAX,EAAqB,QAArB,EAA+B,MAAM,CAAC,qBAAtC,CAAf;AACH,KArDuE,CAuDxE;;;AACA,WAAO;AAAE,MAAA,EAAE,EAAE;AAAE,QAAA,QAAQ,EAAA,QAAV;AAAY,QAAA,UAAU,EAAA,UAAtB;AAAwB,QAAA,OAAO,EAAA;AAA/B,OAAN;AAAyC,MAAA,QAAQ,EAAA;AAAjD,KAAP;AACH,GAzDO;;AA2DR,EAAA,UAAA,CAAA,SAAA,CAAA,QAAA,GAAA,UAAS,CAAT,EAAoB,CAApB,EAA+B,MAA/B,EAA4D;AACxD,SAAgB,IAAA,EAAA,GAAA,CAAA,EAAA,EAAA,GAAA,KAAK,MAArB,EAAgB,EAAA,GAAA,EAAA,CAAA,MAAhB,EAAgB,EAAA,EAAhB,EAA6B;AAAxB,UAAM,CAAC,GAAA,EAAA,CAAA,EAAA,CAAP;AACD,UAAM,QAAQ,GAAG,KAAK,gBAAL,CAAsB,CAAC,GAAG,CAAC,CAAC,CAAD,CAA3B,EAAgC,CAAC,GAAG,CAAC,CAAC,CAAD,CAArC,EAA0C,MAA1C,CAAjB;AACA,UAAI,QAAJ,EAAc,OAAO,QAAP;AACjB;AACJ,GALD;;AAUJ,SAAA,UAAA;AAAC,CA5KD,EAAA","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2019-2021 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { Vec3 } from '../../mol-math/linear-algebra';\r\nimport { spiral2d } from '../../mol-math/misc';\r\nimport { decodeFloatRGB, unpackRGBAToDepth } from '../../mol-util/float-packing';\r\nimport { StereoCamera } from '../camera/stereo';\r\nimport { cameraUnproject } from '../camera/util';\r\nimport { Viewport } from '../camera/util';\r\nvar NullId = Math.pow(2, 24) - 2;\r\nvar PickPass = /** @class */ (function () {\r\n    function PickPass(webgl, drawPass, pickBaseScale) {\r\n        this.webgl = webgl;\r\n        this.drawPass = drawPass;\r\n        this.pickBaseScale = pickBaseScale;\r\n        var pickScale = pickBaseScale / webgl.pixelRatio;\r\n        this.pickWidth = Math.ceil(drawPass.colorTarget.getWidth() * pickScale);\r\n        this.pickHeight = Math.ceil(drawPass.colorTarget.getHeight() * pickScale);\r\n        this.objectPickTarget = webgl.createRenderTarget(this.pickWidth, this.pickHeight);\r\n        this.instancePickTarget = webgl.createRenderTarget(this.pickWidth, this.pickHeight);\r\n        this.groupPickTarget = webgl.createRenderTarget(this.pickWidth, this.pickHeight);\r\n        this.depthPickTarget = webgl.createRenderTarget(this.pickWidth, this.pickHeight);\r\n    }\r\n    Object.defineProperty(PickPass.prototype, \"drawingBufferHeight\", {\r\n        get: function () {\r\n            return this.drawPass.colorTarget.getHeight();\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    PickPass.prototype.syncSize = function () {\r\n        var pickScale = this.pickBaseScale / this.webgl.pixelRatio;\r\n        var pickWidth = Math.ceil(this.drawPass.colorTarget.getWidth() * pickScale);\r\n        var pickHeight = Math.ceil(this.drawPass.colorTarget.getHeight() * pickScale);\r\n        if (pickWidth !== this.pickWidth || pickHeight !== this.pickHeight) {\r\n            this.pickWidth = pickWidth;\r\n            this.pickHeight = pickHeight;\r\n            this.objectPickTarget.setSize(this.pickWidth, this.pickHeight);\r\n            this.instancePickTarget.setSize(this.pickWidth, this.pickHeight);\r\n            this.groupPickTarget.setSize(this.pickWidth, this.pickHeight);\r\n            this.depthPickTarget.setSize(this.pickWidth, this.pickHeight);\r\n        }\r\n    };\r\n    PickPass.prototype.renderVariant = function (renderer, camera, scene, helper, variant) {\r\n        var depth = this.drawPass.depthTexturePrimitives;\r\n        renderer.clear(false);\r\n        renderer.update(camera);\r\n        renderer.renderPick(scene.primitives, camera, variant, null);\r\n        renderer.renderPick(scene.volumes, camera, variant, depth);\r\n        renderer.renderPick(helper.handle.scene, camera, variant, null);\r\n        if (helper.camera.isEnabled) {\r\n            helper.camera.update(camera);\r\n            renderer.update(helper.camera.camera);\r\n            renderer.renderPick(helper.camera.scene, helper.camera.camera, variant, null);\r\n        }\r\n    };\r\n    PickPass.prototype.render = function (renderer, camera, scene, helper) {\r\n        this.objectPickTarget.bind();\r\n        this.renderVariant(renderer, camera, scene, helper, 'pickObject');\r\n        this.instancePickTarget.bind();\r\n        this.renderVariant(renderer, camera, scene, helper, 'pickInstance');\r\n        this.groupPickTarget.bind();\r\n        this.renderVariant(renderer, camera, scene, helper, 'pickGroup');\r\n        // printTexture(this.webgl, this.groupPickTarget.texture, { id: 'group' })\r\n        this.depthPickTarget.bind();\r\n        this.renderVariant(renderer, camera, scene, helper, 'depth');\r\n    };\r\n    return PickPass;\r\n}());\r\nexport { PickPass };\r\nvar PickHelper = /** @class */ (function () {\r\n    function PickHelper(webgl, renderer, scene, helper, pickPass, viewport, pickPadding) {\r\n        if (pickPadding === void 0) { pickPadding = 1; }\r\n        this.webgl = webgl;\r\n        this.renderer = renderer;\r\n        this.scene = scene;\r\n        this.helper = helper;\r\n        this.pickPass = pickPass;\r\n        this.pickPadding = pickPadding;\r\n        this.dirty = true;\r\n        this.viewport = Viewport();\r\n        this.setViewport(viewport.x, viewport.y, viewport.width, viewport.height);\r\n    }\r\n    PickHelper.prototype.setupBuffers = function () {\r\n        var bufferSize = this.pickWidth * this.pickHeight * 4;\r\n        if (!this.objectBuffer || this.objectBuffer.length !== bufferSize) {\r\n            this.objectBuffer = new Uint8Array(bufferSize);\r\n            this.instanceBuffer = new Uint8Array(bufferSize);\r\n            this.groupBuffer = new Uint8Array(bufferSize);\r\n            this.depthBuffer = new Uint8Array(bufferSize);\r\n        }\r\n    };\r\n    PickHelper.prototype.setViewport = function (x, y, width, height) {\r\n        Viewport.set(this.viewport, x, y, width, height);\r\n        this.pickScale = this.pickPass.pickBaseScale / this.webgl.pixelRatio;\r\n        this.pickX = Math.ceil(x * this.pickScale);\r\n        this.pickY = Math.ceil(y * this.pickScale);\r\n        var pickWidth = Math.floor(width * this.pickScale);\r\n        var pickHeight = Math.floor(height * this.pickScale);\r\n        if (pickWidth !== this.pickWidth || pickHeight !== this.pickHeight) {\r\n            this.pickWidth = pickWidth;\r\n            this.pickHeight = pickHeight;\r\n            this.halfPickWidth = Math.floor(this.pickWidth / 2);\r\n            this.setupBuffers();\r\n        }\r\n        this.spiral = spiral2d(Math.round(this.pickScale * this.pickPadding));\r\n    };\r\n    PickHelper.prototype.syncBuffers = function () {\r\n        var _a = this, pickX = _a.pickX, pickY = _a.pickY, pickWidth = _a.pickWidth, pickHeight = _a.pickHeight;\r\n        this.pickPass.objectPickTarget.bind();\r\n        this.webgl.readPixels(pickX, pickY, pickWidth, pickHeight, this.objectBuffer);\r\n        this.pickPass.instancePickTarget.bind();\r\n        this.webgl.readPixels(pickX, pickY, pickWidth, pickHeight, this.instanceBuffer);\r\n        this.pickPass.groupPickTarget.bind();\r\n        this.webgl.readPixels(pickX, pickY, pickWidth, pickHeight, this.groupBuffer);\r\n        this.pickPass.depthPickTarget.bind();\r\n        this.webgl.readPixels(pickX, pickY, pickWidth, pickHeight, this.depthBuffer);\r\n    };\r\n    PickHelper.prototype.getBufferIdx = function (x, y) {\r\n        return (y * this.pickWidth + x) * 4;\r\n    };\r\n    PickHelper.prototype.getDepth = function (x, y) {\r\n        var idx = this.getBufferIdx(x, y);\r\n        var b = this.depthBuffer;\r\n        return unpackRGBAToDepth(b[idx], b[idx + 1], b[idx + 2], b[idx + 3]);\r\n    };\r\n    PickHelper.prototype.getId = function (x, y, buffer) {\r\n        var idx = this.getBufferIdx(x, y);\r\n        return decodeFloatRGB(buffer[idx], buffer[idx + 1], buffer[idx + 2]);\r\n    };\r\n    PickHelper.prototype.render = function (camera) {\r\n        var _a = this, pickX = _a.pickX, pickY = _a.pickY, pickWidth = _a.pickWidth, pickHeight = _a.pickHeight, halfPickWidth = _a.halfPickWidth;\r\n        var _b = this, renderer = _b.renderer, scene = _b.scene, helper = _b.helper;\r\n        renderer.setTransparentBackground(false);\r\n        renderer.setDrawingBufferSize(this.pickPass.objectPickTarget.getWidth(), this.pickPass.objectPickTarget.getHeight());\r\n        renderer.setPixelRatio(this.pickScale);\r\n        if (StereoCamera.is(camera)) {\r\n            renderer.setViewport(pickX, pickY, halfPickWidth, pickHeight);\r\n            this.pickPass.render(renderer, camera.left, scene, helper);\r\n            renderer.setViewport(pickX + halfPickWidth, pickY, pickWidth - halfPickWidth, pickHeight);\r\n            this.pickPass.render(renderer, camera.right, scene, helper);\r\n        }\r\n        else {\r\n            renderer.setViewport(pickX, pickY, pickWidth, pickHeight);\r\n            this.pickPass.render(renderer, camera, scene, helper);\r\n        }\r\n        this.dirty = false;\r\n    };\r\n    PickHelper.prototype.identifyInternal = function (x, y, camera) {\r\n        var _a = this, webgl = _a.webgl, pickScale = _a.pickScale;\r\n        if (webgl.isContextLost)\r\n            return;\r\n        x *= webgl.pixelRatio;\r\n        y *= webgl.pixelRatio;\r\n        y = this.pickPass.drawingBufferHeight - y; // flip y\r\n        var viewport = this.viewport;\r\n        // check if within viewport\r\n        if (x < viewport.x ||\r\n            y < viewport.y ||\r\n            x > viewport.x + viewport.width ||\r\n            y > viewport.y + viewport.height)\r\n            return;\r\n        if (this.dirty) {\r\n            this.render(camera);\r\n            this.syncBuffers();\r\n        }\r\n        var xv = x - viewport.x;\r\n        var yv = y - viewport.y;\r\n        var xp = Math.floor(xv * pickScale);\r\n        var yp = Math.floor(yv * pickScale);\r\n        var objectId = this.getId(xp, yp, this.objectBuffer);\r\n        // console.log('objectId', objectId);\r\n        if (objectId === -1 || objectId === NullId)\r\n            return;\r\n        var instanceId = this.getId(xp, yp, this.instanceBuffer);\r\n        // console.log('instanceId', instanceId);\r\n        if (instanceId === -1 || instanceId === NullId)\r\n            return;\r\n        var groupId = this.getId(xp, yp, this.groupBuffer);\r\n        // console.log('groupId', groupId);\r\n        if (groupId === -1 || groupId === NullId)\r\n            return;\r\n        var z = this.getDepth(xp, yp);\r\n        var position = Vec3.create(x, viewport.height - y, z);\r\n        if (StereoCamera.is(camera)) {\r\n            var halfWidth = Math.floor(viewport.width / 2);\r\n            if (x > viewport.x + halfWidth) {\r\n                position[0] = viewport.x + (xv - halfWidth) * 2;\r\n                cameraUnproject(position, position, viewport, camera.right.inverseProjectionView);\r\n            }\r\n            else {\r\n                position[0] = viewport.x + xv * 2;\r\n                cameraUnproject(position, position, viewport, camera.left.inverseProjectionView);\r\n            }\r\n        }\r\n        else {\r\n            cameraUnproject(position, position, viewport, camera.inverseProjectionView);\r\n        }\r\n        // console.log({ { objectId, instanceId, groupId }, position} );\r\n        return { id: { objectId: objectId, instanceId: instanceId, groupId: groupId }, position: position };\r\n    };\r\n    PickHelper.prototype.identify = function (x, y, camera) {\r\n        for (var _i = 0, _a = this.spiral; _i < _a.length; _i++) {\r\n            var d = _a[_i];\r\n            var pickData = this.identifyInternal(x + d[0], y + d[1], camera);\r\n            if (pickData)\r\n                return pickData;\r\n        }\r\n    };\r\n    return PickHelper;\r\n}());\r\nexport { PickHelper };\r\n//# sourceMappingURL=pick.js.map"]},"metadata":{},"sourceType":"module"}