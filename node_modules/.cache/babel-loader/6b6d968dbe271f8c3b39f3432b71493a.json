{"ast":null,"code":"/**\r\n * Copyright (c) 2019-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\nimport { __assign } from \"tslib\";\nimport { ParamDefinition as PD } from '../../../mol-util/param-definition';\nimport { StructureElement, StructureProperties } from '../../../mol-model/structure';\nimport { TextBuilder } from '../../../mol-geo/geometry/text/text-builder';\nimport { ComplexTextVisual, ComplexTextParams } from '../complex-visual';\nimport { ElementIterator, getSerialElementLoci, eachSerialElement } from './util/element';\nimport { ColorNames } from '../../../mol-util/color/names';\nimport { Vec3 } from '../../../mol-math/linear-algebra';\nimport { PhysicalSizeTheme } from '../../../mol-theme/size/physical';\nimport { BoundaryHelper } from '../../../mol-math/geometry/boundary-helper';\nexport var LabelTextParams = __assign(__assign({}, ComplexTextParams), {\n  background: PD.Boolean(true),\n  backgroundMargin: PD.Numeric(0, {\n    min: 0,\n    max: 1,\n    step: 0.01\n  }),\n  backgroundColor: PD.Color(ColorNames.black),\n  backgroundOpacity: PD.Numeric(0.5, {\n    min: 0,\n    max: 1,\n    step: 0.01\n  }),\n  level: PD.Select('residue', [['chain', 'Chain'], ['residue', 'Residue'], ['element', 'Element']]),\n  chainScale: PD.Numeric(10, {\n    min: 0,\n    max: 20,\n    step: 0.1\n  }),\n  residueScale: PD.Numeric(1, {\n    min: 0,\n    max: 20,\n    step: 0.1\n  }),\n  elementScale: PD.Numeric(0.5, {\n    min: 0,\n    max: 20,\n    step: 0.1\n  })\n});\nexport function LabelTextVisual(materialId) {\n  return ComplexTextVisual({\n    defaultProps: PD.getDefaultValues(LabelTextParams),\n    createGeometry: createLabelText,\n    createLocationIterator: ElementIterator.fromStructure,\n    getLoci: getSerialElementLoci,\n    eachLocation: eachSerialElement,\n    setUpdateState: function (state, newProps, currentProps) {\n      state.createGeometry = newProps.level !== currentProps.level || newProps.level === 'chain' && newProps.chainScale !== currentProps.chainScale || newProps.level === 'residue' && newProps.residueScale !== currentProps.residueScale || newProps.level === 'element' && newProps.elementScale !== currentProps.elementScale;\n    }\n  }, materialId);\n}\n\nfunction createLabelText(ctx, structure, theme, props, text) {\n  switch (props.level) {\n    case 'chain':\n      return createChainText(ctx, structure, theme, props, text);\n\n    case 'residue':\n      return createResidueText(ctx, structure, theme, props, text);\n\n    case 'element':\n      return createElementText(ctx, structure, theme, props, text);\n  }\n} //\n\n\nvar tmpVec = Vec3();\nvar boundaryHelper = new BoundaryHelper('98');\n\nfunction createChainText(ctx, structure, theme, props, text) {\n  var l = StructureElement.Location.create(structure);\n  var units = structure.units,\n      serialMapping = structure.serialMapping;\n  var _a = StructureProperties.chain,\n      auth_asym_id = _a.auth_asym_id,\n      label_asym_id = _a.label_asym_id;\n  var cumulativeUnitElementCount = serialMapping.cumulativeUnitElementCount;\n  var count = units.length;\n  var chainScale = props.chainScale;\n  var builder = TextBuilder.create(props, count, count / 2, text);\n\n  for (var i = 0, il = units.length; i < il; ++i) {\n    var unit = units[i];\n    l.unit = unit;\n    l.element = unit.elements[0];\n    var _b = unit.lookup3d.boundary.sphere,\n        center = _b.center,\n        radius = _b.radius;\n    Vec3.transformMat4(tmpVec, center, unit.conformation.operator.matrix);\n    var authId = auth_asym_id(l);\n    var labelId = label_asym_id(l);\n    var text_1 = authId === labelId ? labelId : labelId + \" [\" + authId + \"]\";\n    builder.add(text_1, tmpVec[0], tmpVec[1], tmpVec[2], radius, chainScale, cumulativeUnitElementCount[i]);\n  }\n\n  return builder.getText();\n}\n\nfunction createResidueText(ctx, structure, theme, props, text) {\n  var l = StructureElement.Location.create(structure);\n  var units = structure.units,\n      serialMapping = structure.serialMapping;\n  var label_comp_id = StructureProperties.atom.label_comp_id;\n  var auth_seq_id = StructureProperties.residue.auth_seq_id;\n  var cumulativeUnitElementCount = serialMapping.cumulativeUnitElementCount;\n  var count = structure.polymerResidueCount * 2;\n  var residueScale = props.residueScale;\n  var builder = TextBuilder.create(props, count, count / 2, text);\n\n  for (var i = 0, il = units.length; i < il; ++i) {\n    var unit = units[i];\n    var pos = unit.conformation.position;\n    var elements = unit.elements;\n    l.unit = unit;\n    l.element = unit.elements[0];\n    var residueIndex = unit.model.atomicHierarchy.residueAtomSegments.index;\n    var groupOffset = cumulativeUnitElementCount[i];\n    var j = 0;\n    var jl = elements.length;\n\n    while (j < jl) {\n      var start = j,\n          rI = residueIndex[elements[j]];\n      j++;\n\n      while (j < jl && residueIndex[elements[j]] === rI) j++;\n\n      boundaryHelper.reset();\n\n      for (var eI = start; eI < j; eI++) {\n        pos(elements[eI], tmpVec);\n        boundaryHelper.includePosition(tmpVec);\n      }\n\n      boundaryHelper.finishedIncludeStep();\n\n      for (var eI = start; eI < j; eI++) {\n        pos(elements[eI], tmpVec);\n        boundaryHelper.radiusPosition(tmpVec);\n      }\n\n      l.element = elements[start];\n\n      var _a = boundaryHelper.getSphere(),\n          center = _a.center,\n          radius = _a.radius;\n\n      var authSeqId = auth_seq_id(l);\n      var compId = label_comp_id(l);\n      var text_2 = compId + \" \" + authSeqId;\n      builder.add(text_2, center[0], center[1], center[2], radius, residueScale, groupOffset + start);\n    }\n  }\n\n  return builder.getText();\n}\n\nfunction createElementText(ctx, structure, theme, props, text) {\n  var l = StructureElement.Location.create(structure);\n  var units = structure.units,\n      serialMapping = structure.serialMapping;\n  var _a = StructureProperties.atom,\n      label_atom_id = _a.label_atom_id,\n      label_alt_id = _a.label_alt_id;\n  var cumulativeUnitElementCount = serialMapping.cumulativeUnitElementCount;\n  var sizeTheme = PhysicalSizeTheme({}, {\n    scale: 1\n  });\n  var count = structure.elementCount;\n  var elementScale = props.elementScale;\n  var builder = TextBuilder.create(props, count, count / 2, text);\n\n  for (var i = 0, il = units.length; i < il; ++i) {\n    var unit = units[i];\n    var pos = unit.conformation.position;\n    var elements = unit.elements;\n    l.unit = unit;\n    var groupOffset = cumulativeUnitElementCount[i];\n\n    for (var j = 0, _j = elements.length; j < _j; j++) {\n      l.element = elements[j];\n      pos(l.element, tmpVec);\n      var atomId = label_atom_id(l);\n      var altId = label_alt_id(l);\n      var text_3 = altId ? atomId + \"%\" + altId : atomId;\n      builder.add(text_3, tmpVec[0], tmpVec[1], tmpVec[2], sizeTheme.size(l), elementScale, groupOffset + j);\n    }\n  }\n\n  return builder.getText();\n}","map":{"version":3,"sources":["../../../../src/mol-repr/structure/visual/label-text.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2019-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\r\nimport { __assign } from \"tslib\";\r\nimport { ParamDefinition as PD } from '../../../mol-util/param-definition';\r\nimport { StructureElement, StructureProperties } from '../../../mol-model/structure';\r\nimport { TextBuilder } from '../../../mol-geo/geometry/text/text-builder';\r\nimport { ComplexTextVisual, ComplexTextParams } from '../complex-visual';\r\nimport { ElementIterator, getSerialElementLoci, eachSerialElement } from './util/element';\r\nimport { ColorNames } from '../../../mol-util/color/names';\r\nimport { Vec3 } from '../../../mol-math/linear-algebra';\r\nimport { PhysicalSizeTheme } from '../../../mol-theme/size/physical';\r\nimport { BoundaryHelper } from '../../../mol-math/geometry/boundary-helper';\r\nexport var LabelTextParams = __assign(__assign({}, ComplexTextParams), { background: PD.Boolean(true), backgroundMargin: PD.Numeric(0, { min: 0, max: 1, step: 0.01 }), backgroundColor: PD.Color(ColorNames.black), backgroundOpacity: PD.Numeric(0.5, { min: 0, max: 1, step: 0.01 }), level: PD.Select('residue', [['chain', 'Chain'], ['residue', 'Residue'], ['element', 'Element']]), chainScale: PD.Numeric(10, { min: 0, max: 20, step: 0.1 }), residueScale: PD.Numeric(1, { min: 0, max: 20, step: 0.1 }), elementScale: PD.Numeric(0.5, { min: 0, max: 20, step: 0.1 }) });\r\nexport function LabelTextVisual(materialId) {\r\n    return ComplexTextVisual({\r\n        defaultProps: PD.getDefaultValues(LabelTextParams),\r\n        createGeometry: createLabelText,\r\n        createLocationIterator: ElementIterator.fromStructure,\r\n        getLoci: getSerialElementLoci,\r\n        eachLocation: eachSerialElement,\r\n        setUpdateState: function (state, newProps, currentProps) {\r\n            state.createGeometry = (newProps.level !== currentProps.level ||\r\n                (newProps.level === 'chain' && newProps.chainScale !== currentProps.chainScale) ||\r\n                (newProps.level === 'residue' && newProps.residueScale !== currentProps.residueScale) ||\r\n                (newProps.level === 'element' && newProps.elementScale !== currentProps.elementScale));\r\n        }\r\n    }, materialId);\r\n}\r\nfunction createLabelText(ctx, structure, theme, props, text) {\r\n    switch (props.level) {\r\n        case 'chain': return createChainText(ctx, structure, theme, props, text);\r\n        case 'residue': return createResidueText(ctx, structure, theme, props, text);\r\n        case 'element': return createElementText(ctx, structure, theme, props, text);\r\n    }\r\n}\r\n//\r\nvar tmpVec = Vec3();\r\nvar boundaryHelper = new BoundaryHelper('98');\r\nfunction createChainText(ctx, structure, theme, props, text) {\r\n    var l = StructureElement.Location.create(structure);\r\n    var units = structure.units, serialMapping = structure.serialMapping;\r\n    var _a = StructureProperties.chain, auth_asym_id = _a.auth_asym_id, label_asym_id = _a.label_asym_id;\r\n    var cumulativeUnitElementCount = serialMapping.cumulativeUnitElementCount;\r\n    var count = units.length;\r\n    var chainScale = props.chainScale;\r\n    var builder = TextBuilder.create(props, count, count / 2, text);\r\n    for (var i = 0, il = units.length; i < il; ++i) {\r\n        var unit = units[i];\r\n        l.unit = unit;\r\n        l.element = unit.elements[0];\r\n        var _b = unit.lookup3d.boundary.sphere, center = _b.center, radius = _b.radius;\r\n        Vec3.transformMat4(tmpVec, center, unit.conformation.operator.matrix);\r\n        var authId = auth_asym_id(l);\r\n        var labelId = label_asym_id(l);\r\n        var text_1 = authId === labelId ? labelId : labelId + \" [\" + authId + \"]\";\r\n        builder.add(text_1, tmpVec[0], tmpVec[1], tmpVec[2], radius, chainScale, cumulativeUnitElementCount[i]);\r\n    }\r\n    return builder.getText();\r\n}\r\nfunction createResidueText(ctx, structure, theme, props, text) {\r\n    var l = StructureElement.Location.create(structure);\r\n    var units = structure.units, serialMapping = structure.serialMapping;\r\n    var label_comp_id = StructureProperties.atom.label_comp_id;\r\n    var auth_seq_id = StructureProperties.residue.auth_seq_id;\r\n    var cumulativeUnitElementCount = serialMapping.cumulativeUnitElementCount;\r\n    var count = structure.polymerResidueCount * 2;\r\n    var residueScale = props.residueScale;\r\n    var builder = TextBuilder.create(props, count, count / 2, text);\r\n    for (var i = 0, il = units.length; i < il; ++i) {\r\n        var unit = units[i];\r\n        var pos = unit.conformation.position;\r\n        var elements = unit.elements;\r\n        l.unit = unit;\r\n        l.element = unit.elements[0];\r\n        var residueIndex = unit.model.atomicHierarchy.residueAtomSegments.index;\r\n        var groupOffset = cumulativeUnitElementCount[i];\r\n        var j = 0;\r\n        var jl = elements.length;\r\n        while (j < jl) {\r\n            var start = j, rI = residueIndex[elements[j]];\r\n            j++;\r\n            while (j < jl && residueIndex[elements[j]] === rI)\r\n                j++;\r\n            boundaryHelper.reset();\r\n            for (var eI = start; eI < j; eI++) {\r\n                pos(elements[eI], tmpVec);\r\n                boundaryHelper.includePosition(tmpVec);\r\n            }\r\n            boundaryHelper.finishedIncludeStep();\r\n            for (var eI = start; eI < j; eI++) {\r\n                pos(elements[eI], tmpVec);\r\n                boundaryHelper.radiusPosition(tmpVec);\r\n            }\r\n            l.element = elements[start];\r\n            var _a = boundaryHelper.getSphere(), center = _a.center, radius = _a.radius;\r\n            var authSeqId = auth_seq_id(l);\r\n            var compId = label_comp_id(l);\r\n            var text_2 = compId + \" \" + authSeqId;\r\n            builder.add(text_2, center[0], center[1], center[2], radius, residueScale, groupOffset + start);\r\n        }\r\n    }\r\n    return builder.getText();\r\n}\r\nfunction createElementText(ctx, structure, theme, props, text) {\r\n    var l = StructureElement.Location.create(structure);\r\n    var units = structure.units, serialMapping = structure.serialMapping;\r\n    var _a = StructureProperties.atom, label_atom_id = _a.label_atom_id, label_alt_id = _a.label_alt_id;\r\n    var cumulativeUnitElementCount = serialMapping.cumulativeUnitElementCount;\r\n    var sizeTheme = PhysicalSizeTheme({}, { scale: 1 });\r\n    var count = structure.elementCount;\r\n    var elementScale = props.elementScale;\r\n    var builder = TextBuilder.create(props, count, count / 2, text);\r\n    for (var i = 0, il = units.length; i < il; ++i) {\r\n        var unit = units[i];\r\n        var pos = unit.conformation.position;\r\n        var elements = unit.elements;\r\n        l.unit = unit;\r\n        var groupOffset = cumulativeUnitElementCount[i];\r\n        for (var j = 0, _j = elements.length; j < _j; j++) {\r\n            l.element = elements[j];\r\n            pos(l.element, tmpVec);\r\n            var atomId = label_atom_id(l);\r\n            var altId = label_alt_id(l);\r\n            var text_3 = altId ? atomId + \"%\" + altId : atomId;\r\n            builder.add(text_3, tmpVec[0], tmpVec[1], tmpVec[2], sizeTheme.size(l), elementScale, groupOffset + j);\r\n        }\r\n    }\r\n    return builder.getText();\r\n}\r\n//# sourceMappingURL=label-text.js.map"]},"metadata":{},"sourceType":"module"}