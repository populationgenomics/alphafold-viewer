{"ast":null,"code":"/**\r\n * Copyright (c) 2019 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\nimport { Mat4 } from './mat4';\nimport { EVD } from '../matrix/evd';\nimport { CentroidHelper } from '../../../mol-math/geometry/centroid-helper';\nimport { Matrix } from '../matrix/matrix';\nimport { Sphere3D } from '../../geometry/primitives/sphere3d';\nexport { MinimizeRmsd };\nvar MinimizeRmsd;\n\n(function (MinimizeRmsd) {\n  var Positions;\n\n  (function (Positions) {\n    function empty(n) {\n      return {\n        x: new Float64Array(n),\n        y: new Float64Array(n),\n        z: new Float64Array(n)\n      };\n    }\n\n    Positions.empty = empty;\n  })(Positions = MinimizeRmsd.Positions || (MinimizeRmsd.Positions = {}));\n\n  function compute(data, result) {\n    if (typeof result === 'undefined') result = {\n      bTransform: Mat4.zero(),\n      rmsd: 0.0\n    };\n    findMinimalRmsdTransformImpl(new RmsdTransformState(data, result));\n    return result;\n  }\n\n  MinimizeRmsd.compute = compute;\n})(MinimizeRmsd || (MinimizeRmsd = {}));\n\nvar RmsdTransformState =\n/** @class */\nfunction () {\n  function RmsdTransformState(data, into) {\n    this.evdCache = EVD.createCache(4);\n    this.translateB = Mat4.identity();\n    this.rotateB = Mat4.identity();\n    this.tempMatrix = Mat4.identity();\n    this.a = data.a;\n    this.b = data.b;\n    if (data.centerA) this.centerA = data.centerA;else this.centerA = data.centerA = CentroidHelper.fromArrays(data.a, Sphere3D()).center;\n    if (data.centerB) this.centerB = data.centerB;else this.centerB = data.centerB = CentroidHelper.fromArrays(data.b, Sphere3D()).center;\n    this.result = into;\n  }\n\n  return RmsdTransformState;\n}();\n\nfunction computeN(state) {\n  var N = state.evdCache.matrix;\n  Matrix.makeZero(N);\n  var xsA = state.a.x,\n      ysA = state.a.y,\n      zsA = state.a.z;\n  var xsB = state.b.x,\n      ysB = state.b.y,\n      zsB = state.b.z;\n  var cA = state.centerA;\n  var cB = state.centerB;\n  var sizeSq = 0.0;\n\n  for (var i = 0, _l = state.a.x.length; i < _l; i++) {\n    var aX = xsA[i] - cA[0],\n        aY = ysA[i] - cA[1],\n        aZ = zsA[i] - cA[2];\n    var bX = xsB[i] - cB[0],\n        bY = ysB[i] - cB[1],\n        bZ = zsB[i] - cB[2];\n    sizeSq += aX * aX + aY * aY + aZ * aZ + bX * bX + bY * bY + bZ * bZ;\n    Matrix.add(N, 0, 0, aX * bX + aY * bY + aZ * bZ);\n    Matrix.add(N, 0, 1, -(aZ * bY) + aY * bZ);\n    Matrix.add(N, 0, 2, aZ * bX - aX * bZ);\n    Matrix.add(N, 0, 3, -(aY * bX) + aX * bY);\n    Matrix.add(N, 1, 0, -(aZ * bY) + aY * bZ);\n    Matrix.add(N, 1, 1, aX * bX - aY * bY - aZ * bZ);\n    Matrix.add(N, 1, 2, aY * bX + aX * bY);\n    Matrix.add(N, 1, 3, aZ * bX + aX * bZ);\n    Matrix.add(N, 2, 0, aZ * bX - aX * bZ);\n    Matrix.add(N, 2, 1, aY * bX + aX * bY);\n    Matrix.add(N, 2, 2, -(aX * bX) + aY * bY - aZ * bZ);\n    Matrix.add(N, 2, 3, aZ * bY + aY * bZ);\n    Matrix.add(N, 3, 0, -(aY * bX) + aX * bY);\n    Matrix.add(N, 3, 1, aZ * bX + aX * bZ);\n    Matrix.add(N, 3, 2, aZ * bY + aY * bZ);\n    Matrix.add(N, 3, 3, -(aX * bX) - aY * bY + aZ * bZ); // conjugate instead of transpose.\n    // var l = new Quaternion(-a.X, -a.Y, -a.Z, 0).RightMultiplicationToMatrix();\n    // l.Transpose();\n    // var r = new Quaternion(b.X, b.Y, b.Z, 0).LeftMultiplicationToMatrix();\n    // N += l * r;\n  }\n\n  return sizeSq;\n}\n\nfunction makeTransformMatrix(state) {\n  var ev = state.evdCache.matrix;\n  var qX = Matrix.get(ev, 1, 3);\n  var qY = Matrix.get(ev, 2, 3);\n  var qZ = Matrix.get(ev, 3, 3);\n  var qW = Matrix.get(ev, 0, 3);\n  var n1 = 2 * qY * qY;\n  var n2 = 2 * qZ * qZ;\n  var n3 = 2 * qX * qX;\n  var n4 = 2 * qX * qY;\n  var n5 = 2 * qW * qZ;\n  var n6 = 2 * qX * qZ;\n  var n7 = 2 * qW * qY;\n  var n8 = 2 * qY * qZ;\n  var n9 = 2 * qW * qX;\n  var m = state.translateB; // translation to center\n\n  Mat4.setValue(m, 0, 3, -state.centerB[0]);\n  Mat4.setValue(m, 1, 3, -state.centerB[1]);\n  Mat4.setValue(m, 2, 3, -state.centerB[2]);\n  m = state.rotateB; // rotation\n\n  Mat4.setValue(m, 0, 0, 1 - n1 - n2);\n  Mat4.setValue(m, 0, 1, n4 + n5);\n  Mat4.setValue(m, 0, 2, n6 - n7);\n  Mat4.setValue(m, 1, 0, n4 - n5);\n  Mat4.setValue(m, 1, 1, 1 - n3 - n2);\n  Mat4.setValue(m, 1, 2, n8 + n9);\n  Mat4.setValue(m, 2, 0, n6 + n7);\n  Mat4.setValue(m, 2, 1, n8 - n9);\n  Mat4.setValue(m, 2, 2, 1 - n3 - n1);\n  Mat4.setValue(m, 3, 3, 1);\n  Mat4.mul(state.tempMatrix, state.rotateB, state.translateB);\n  m = state.translateB; // translation to center\n\n  Mat4.setValue(m, 0, 3, state.centerA[0]);\n  Mat4.setValue(m, 1, 3, state.centerA[1]);\n  Mat4.setValue(m, 2, 3, state.centerA[2]);\n  Mat4.mul(state.result.bTransform, state.translateB, state.tempMatrix);\n}\n\nfunction findMinimalRmsdTransformImpl(state) {\n  var sizeSq = computeN(state);\n  EVD.compute(state.evdCache);\n  var rmsd = sizeSq - 2.0 * state.evdCache.eigenValues[3];\n  rmsd = rmsd < 0.0 ? 0.0 : Math.sqrt(rmsd / state.a.x.length);\n  makeTransformMatrix(state);\n  state.result.rmsd = rmsd;\n}","map":{"version":3,"sources":["../../../../src/mol-math/linear-algebra/3d/minimize-rmsd.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2019 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\r\nimport { Mat4 } from './mat4';\r\nimport { EVD } from '../matrix/evd';\r\nimport { CentroidHelper } from '../../../mol-math/geometry/centroid-helper';\r\nimport { Matrix } from '../matrix/matrix';\r\nimport { Sphere3D } from '../../geometry/primitives/sphere3d';\r\nexport { MinimizeRmsd };\r\nvar MinimizeRmsd;\r\n(function (MinimizeRmsd) {\r\n    var Positions;\r\n    (function (Positions) {\r\n        function empty(n) {\r\n            return { x: new Float64Array(n), y: new Float64Array(n), z: new Float64Array(n) };\r\n        }\r\n        Positions.empty = empty;\r\n    })(Positions = MinimizeRmsd.Positions || (MinimizeRmsd.Positions = {}));\r\n    function compute(data, result) {\r\n        if (typeof result === 'undefined')\r\n            result = { bTransform: Mat4.zero(), rmsd: 0.0 };\r\n        findMinimalRmsdTransformImpl(new RmsdTransformState(data, result));\r\n        return result;\r\n    }\r\n    MinimizeRmsd.compute = compute;\r\n})(MinimizeRmsd || (MinimizeRmsd = {}));\r\nvar RmsdTransformState = /** @class */ (function () {\r\n    function RmsdTransformState(data, into) {\r\n        this.evdCache = EVD.createCache(4);\r\n        this.translateB = Mat4.identity();\r\n        this.rotateB = Mat4.identity();\r\n        this.tempMatrix = Mat4.identity();\r\n        this.a = data.a;\r\n        this.b = data.b;\r\n        if (data.centerA)\r\n            this.centerA = data.centerA;\r\n        else\r\n            this.centerA = data.centerA = CentroidHelper.fromArrays(data.a, Sphere3D()).center;\r\n        if (data.centerB)\r\n            this.centerB = data.centerB;\r\n        else\r\n            this.centerB = data.centerB = CentroidHelper.fromArrays(data.b, Sphere3D()).center;\r\n        this.result = into;\r\n    }\r\n    return RmsdTransformState;\r\n}());\r\nfunction computeN(state) {\r\n    var N = state.evdCache.matrix;\r\n    Matrix.makeZero(N);\r\n    var xsA = state.a.x, ysA = state.a.y, zsA = state.a.z;\r\n    var xsB = state.b.x, ysB = state.b.y, zsB = state.b.z;\r\n    var cA = state.centerA;\r\n    var cB = state.centerB;\r\n    var sizeSq = 0.0;\r\n    for (var i = 0, _l = state.a.x.length; i < _l; i++) {\r\n        var aX = xsA[i] - cA[0], aY = ysA[i] - cA[1], aZ = zsA[i] - cA[2];\r\n        var bX = xsB[i] - cB[0], bY = ysB[i] - cB[1], bZ = zsB[i] - cB[2];\r\n        sizeSq += aX * aX + aY * aY + aZ * aZ + bX * bX + bY * bY + bZ * bZ;\r\n        Matrix.add(N, 0, 0, aX * bX + aY * bY + aZ * bZ);\r\n        Matrix.add(N, 0, 1, -(aZ * bY) + aY * bZ);\r\n        Matrix.add(N, 0, 2, aZ * bX - aX * bZ);\r\n        Matrix.add(N, 0, 3, -(aY * bX) + aX * bY);\r\n        Matrix.add(N, 1, 0, -(aZ * bY) + aY * bZ);\r\n        Matrix.add(N, 1, 1, aX * bX - aY * bY - aZ * bZ);\r\n        Matrix.add(N, 1, 2, aY * bX + aX * bY);\r\n        Matrix.add(N, 1, 3, aZ * bX + aX * bZ);\r\n        Matrix.add(N, 2, 0, aZ * bX - aX * bZ);\r\n        Matrix.add(N, 2, 1, aY * bX + aX * bY);\r\n        Matrix.add(N, 2, 2, -(aX * bX) + aY * bY - aZ * bZ);\r\n        Matrix.add(N, 2, 3, aZ * bY + aY * bZ);\r\n        Matrix.add(N, 3, 0, -(aY * bX) + aX * bY);\r\n        Matrix.add(N, 3, 1, aZ * bX + aX * bZ);\r\n        Matrix.add(N, 3, 2, aZ * bY + aY * bZ);\r\n        Matrix.add(N, 3, 3, -(aX * bX) - aY * bY + aZ * bZ);\r\n        // conjugate instead of transpose.\r\n        // var l = new Quaternion(-a.X, -a.Y, -a.Z, 0).RightMultiplicationToMatrix();\r\n        // l.Transpose();\r\n        // var r = new Quaternion(b.X, b.Y, b.Z, 0).LeftMultiplicationToMatrix();\r\n        // N += l * r;\r\n    }\r\n    return sizeSq;\r\n}\r\nfunction makeTransformMatrix(state) {\r\n    var ev = state.evdCache.matrix;\r\n    var qX = Matrix.get(ev, 1, 3);\r\n    var qY = Matrix.get(ev, 2, 3);\r\n    var qZ = Matrix.get(ev, 3, 3);\r\n    var qW = Matrix.get(ev, 0, 3);\r\n    var n1 = 2 * qY * qY;\r\n    var n2 = 2 * qZ * qZ;\r\n    var n3 = 2 * qX * qX;\r\n    var n4 = 2 * qX * qY;\r\n    var n5 = 2 * qW * qZ;\r\n    var n6 = 2 * qX * qZ;\r\n    var n7 = 2 * qW * qY;\r\n    var n8 = 2 * qY * qZ;\r\n    var n9 = 2 * qW * qX;\r\n    var m = state.translateB;\r\n    // translation to center\r\n    Mat4.setValue(m, 0, 3, -state.centerB[0]);\r\n    Mat4.setValue(m, 1, 3, -state.centerB[1]);\r\n    Mat4.setValue(m, 2, 3, -state.centerB[2]);\r\n    m = state.rotateB;\r\n    // rotation\r\n    Mat4.setValue(m, 0, 0, 1 - n1 - n2);\r\n    Mat4.setValue(m, 0, 1, n4 + n5);\r\n    Mat4.setValue(m, 0, 2, n6 - n7);\r\n    Mat4.setValue(m, 1, 0, n4 - n5);\r\n    Mat4.setValue(m, 1, 1, 1 - n3 - n2);\r\n    Mat4.setValue(m, 1, 2, n8 + n9);\r\n    Mat4.setValue(m, 2, 0, n6 + n7);\r\n    Mat4.setValue(m, 2, 1, n8 - n9);\r\n    Mat4.setValue(m, 2, 2, 1 - n3 - n1);\r\n    Mat4.setValue(m, 3, 3, 1);\r\n    Mat4.mul(state.tempMatrix, state.rotateB, state.translateB);\r\n    m = state.translateB;\r\n    // translation to center\r\n    Mat4.setValue(m, 0, 3, state.centerA[0]);\r\n    Mat4.setValue(m, 1, 3, state.centerA[1]);\r\n    Mat4.setValue(m, 2, 3, state.centerA[2]);\r\n    Mat4.mul(state.result.bTransform, state.translateB, state.tempMatrix);\r\n}\r\nfunction findMinimalRmsdTransformImpl(state) {\r\n    var sizeSq = computeN(state);\r\n    EVD.compute(state.evdCache);\r\n    var rmsd = sizeSq - 2.0 * state.evdCache.eigenValues[3];\r\n    rmsd = rmsd < 0.0 ? 0.0 : Math.sqrt(rmsd / state.a.x.length);\r\n    makeTransformMatrix(state);\r\n    state.result.rmsd = rmsd;\r\n}\r\n//# sourceMappingURL=minimize-rmsd.js.map"]},"metadata":{},"sourceType":"module"}