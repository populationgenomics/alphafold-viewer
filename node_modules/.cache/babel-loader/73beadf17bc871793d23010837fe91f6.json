{"ast":null,"code":"/**\r\n * Copyright (c) 2018-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\nimport { __awaiter, __generator } from \"tslib\";\nimport { Structure } from '../../../mol-model/structure';\nimport { PluginStateSnapshotManager } from '../../../mol-plugin-state/manager/snapshots';\nimport { PluginStateObject as SO } from '../../../mol-plugin-state/objects';\nimport { StateTree } from '../../../mol-state';\nimport { getFormattedTime } from '../../../mol-util/date';\nimport { download } from '../../../mol-util/download';\nimport { urlCombine } from '../../../mol-util/url';\nimport { PluginCommands } from '../../commands';\nimport { PluginConfig } from '../../config';\nexport function registerDefault(ctx) {\n  SyncBehaviors(ctx);\n  SetCurrentObject(ctx);\n  Update(ctx);\n  ApplyAction(ctx);\n  RemoveObject(ctx);\n  ToggleExpanded(ctx);\n  ToggleVisibility(ctx);\n  Highlight(ctx);\n  ClearHighlights(ctx);\n  Snapshots(ctx);\n}\nexport function SyncBehaviors(ctx) {\n  ctx.state.events.object.created.subscribe(function (o) {\n    if (!SO.isBehavior(o.obj)) return;\n    o.obj.data.register(o.ref);\n  });\n  ctx.state.events.object.removed.subscribe(function (o) {\n    if (!SO.isBehavior(o.obj)) return;\n    o.obj.data.unregister();\n  });\n  ctx.state.events.object.updated.subscribe(function (o) {\n    if (o.action === 'recreate') {\n      if (o.oldObj && SO.isBehavior(o.oldObj)) o.oldObj.data.unregister();\n      if (o.obj && SO.isBehavior(o.obj)) o.obj.data.register(o.ref);\n    }\n  });\n}\nexport function SetCurrentObject(ctx) {\n  PluginCommands.State.SetCurrentObject.subscribe(ctx, function (_a) {\n    var state = _a.state,\n        ref = _a.ref;\n    return state.setCurrent(ref);\n  });\n}\nexport function Update(ctx) {\n  PluginCommands.State.Update.subscribe(ctx, function (_a) {\n    var state = _a.state,\n        tree = _a.tree,\n        options = _a.options;\n    return ctx.runTask(state.updateTree(tree, options));\n  });\n}\nexport function ApplyAction(ctx) {\n  PluginCommands.State.ApplyAction.subscribe(ctx, function (_a) {\n    var state = _a.state,\n        action = _a.action,\n        ref = _a.ref;\n    return ctx.runTask(state.applyAction(action.action, action.params, ref));\n  });\n}\nexport function RemoveObject(ctx) {\n  function remove(state, ref) {\n    var tree = state.build().delete(ref);\n    return ctx.runTask(state.updateTree(tree));\n  }\n\n  PluginCommands.State.RemoveObject.subscribe(ctx, function (_a) {\n    var state = _a.state,\n        ref = _a.ref,\n        removeParentGhosts = _a.removeParentGhosts;\n\n    if (removeParentGhosts) {\n      var tree = state.tree;\n      var curr = tree.transforms.get(ref);\n      if (curr.parent === ref) return remove(state, ref);\n\n      while (true) {\n        var children = tree.children.get(curr.parent);\n        if (curr.parent === curr.ref || children.size > 1) return remove(state, curr.ref);\n        var parent_1 = tree.transforms.get(curr.parent); // TODO: should this use \"cell state\" instead?\n\n        if (!parent_1.state.isGhost) return remove(state, curr.ref);\n        curr = parent_1;\n      }\n    } else {\n      return remove(state, ref);\n    }\n  });\n}\nexport function ToggleExpanded(ctx) {\n  PluginCommands.State.ToggleExpanded.subscribe(ctx, function (_a) {\n    var state = _a.state,\n        ref = _a.ref;\n    return state.updateCellState(ref, function (_a) {\n      var isCollapsed = _a.isCollapsed;\n      return {\n        isCollapsed: !isCollapsed\n      };\n    });\n  });\n}\nexport function ToggleVisibility(ctx) {\n  PluginCommands.State.ToggleVisibility.subscribe(ctx, function (_a) {\n    var state = _a.state,\n        ref = _a.ref;\n    return setSubtreeVisibility(state, ref, !state.cells.get(ref).state.isHidden);\n  });\n}\nexport function setSubtreeVisibility(state, root, value) {\n  StateTree.doPreOrder(state.tree, state.transforms.get(root), {\n    state: state,\n    value: value\n  }, setVisibilityVisitor);\n}\n\nfunction setVisibilityVisitor(t, tree, ctx) {\n  ctx.state.updateCellState(t.ref, {\n    isHidden: ctx.value\n  });\n}\n\nexport function Highlight(ctx) {\n  PluginCommands.Interactivity.Object.Highlight.subscribe(ctx, function (_a) {\n    var state = _a.state,\n        ref = _a.ref;\n    if (!ctx.canvas3d || ctx.isBusy) return;\n    ctx.managers.interactivity.lociHighlights.clearHighlights();\n    var refs = typeof ref === 'string' ? [ref] : ref;\n\n    for (var _i = 0, refs_1 = refs; _i < refs_1.length; _i++) {\n      var r = refs_1[_i];\n      var cell = state.cells.get(r);\n      if (!cell) continue;\n\n      if (SO.Molecule.Structure.is(cell.obj)) {\n        ctx.managers.interactivity.lociHighlights.highlight({\n          loci: Structure.Loci(cell.obj.data)\n        }, false);\n      } else if (cell && SO.isRepresentation3D(cell.obj)) {\n        var repr = cell.obj.data.repr;\n        ctx.managers.interactivity.lociHighlights.highlight({\n          loci: repr.getLoci(),\n          repr: repr\n        }, false);\n      } else if (SO.Molecule.Structure.Selections.is(cell.obj)) {\n        for (var _b = 0, _c = cell.obj.data; _b < _c.length; _b++) {\n          var entry = _c[_b];\n          ctx.managers.interactivity.lociHighlights.highlight({\n            loci: entry.loci\n          }, false);\n        }\n      }\n    } // TODO: highlight volumes?\n    // TODO: select structures of subtree?\n\n  });\n}\nexport function ClearHighlights(ctx) {\n  PluginCommands.Interactivity.ClearHighlights.subscribe(ctx, function () {\n    ctx.managers.interactivity.lociHighlights.clearHighlights();\n  });\n}\nexport function Snapshots(ctx) {\n  var _this = this;\n\n  ctx.config.set(PluginConfig.State.CurrentServer, ctx.config.get(PluginConfig.State.DefaultServer));\n  PluginCommands.State.Snapshots.Clear.subscribe(ctx, function () {\n    ctx.managers.snapshot.clear();\n  });\n  PluginCommands.State.Snapshots.Remove.subscribe(ctx, function (_a) {\n    var id = _a.id;\n    ctx.managers.snapshot.remove(id);\n  });\n  PluginCommands.State.Snapshots.Add.subscribe(ctx, function (_a) {\n    var name = _a.name,\n        description = _a.description,\n        params = _a.params;\n    var entry = PluginStateSnapshotManager.Entry(ctx.state.getSnapshot(params), {\n      name: name,\n      description: description\n    });\n    ctx.managers.snapshot.add(entry);\n  });\n  PluginCommands.State.Snapshots.Replace.subscribe(ctx, function (_a) {\n    var id = _a.id,\n        params = _a.params;\n    ctx.managers.snapshot.replace(id, ctx.state.getSnapshot(params));\n  });\n  PluginCommands.State.Snapshots.Move.subscribe(ctx, function (_a) {\n    var id = _a.id,\n        dir = _a.dir;\n    ctx.managers.snapshot.move(id, dir);\n  });\n  PluginCommands.State.Snapshots.Apply.subscribe(ctx, function (_a) {\n    var id = _a.id;\n    var snapshot = ctx.managers.snapshot.setCurrent(id);\n    if (!snapshot) return;\n    return ctx.state.setSnapshot(snapshot);\n  });\n  PluginCommands.State.Snapshots.Upload.subscribe(ctx, function (_a) {\n    var name = _a.name,\n        description = _a.description,\n        playOnLoad = _a.playOnLoad,\n        serverUrl = _a.serverUrl,\n        params = _a.params;\n    return fetch(urlCombine(serverUrl, \"set?name=\" + encodeURIComponent(name || '') + \"&description=\" + encodeURIComponent(description || '')), {\n      method: 'POST',\n      mode: 'cors',\n      referrer: 'no-referrer',\n      headers: {\n        'Content-Type': 'application/json; charset=utf-8'\n      },\n      body: JSON.stringify(ctx.managers.snapshot.getStateSnapshot({\n        name: name,\n        description: description,\n        playOnLoad: playOnLoad\n      }))\n    });\n  });\n  PluginCommands.State.Snapshots.Fetch.subscribe(ctx, function (_a) {\n    var url = _a.url;\n    return __awaiter(_this, void 0, void 0, function () {\n      var json;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , ctx.runTask(ctx.fetch({\n              url: url,\n              type: 'json'\n            }))];\n\n          case 1:\n            json = _b.sent();\n            return [4\n            /*yield*/\n            , ctx.managers.snapshot.setStateSnapshot(json.data)];\n\n          case 2:\n            _b.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  });\n  PluginCommands.State.Snapshots.DownloadToFile.subscribe(ctx, function (_a) {\n    var name = _a.name,\n        type = _a.type,\n        params = _a.params;\n    return __awaiter(_this, void 0, void 0, function () {\n      var filename, data;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            filename = \"mol-star_state_\" + (name || getFormattedTime()) + \".\" + (type === 'json' ? 'molj' : 'molx');\n            return [4\n            /*yield*/\n            , ctx.managers.snapshot.serialize({\n              type: type,\n              params: params\n            })];\n\n          case 1:\n            data = _b.sent();\n            download(data, \"\" + filename);\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  });\n  PluginCommands.State.Snapshots.OpenFile.subscribe(ctx, function (_a) {\n    var file = _a.file;\n    return ctx.managers.snapshot.open(file);\n  });\n  PluginCommands.State.Snapshots.OpenUrl.subscribe(ctx, function (_a) {\n    var url = _a.url,\n        type = _a.type;\n    return __awaiter(_this, void 0, void 0, function () {\n      var data;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , ctx.runTask(ctx.fetch({\n              url: url,\n              type: 'binary'\n            }))];\n\n          case 1:\n            data = _b.sent();\n            return [2\n            /*return*/\n            , ctx.managers.snapshot.open(new File([data], \"state.\" + type))];\n        }\n      });\n    });\n  });\n}","map":{"version":3,"sources":["../../../../src/mol-plugin/behavior/static/state.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2018-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { __awaiter, __generator } from \"tslib\";\r\nimport { Structure } from '../../../mol-model/structure';\r\nimport { PluginStateSnapshotManager } from '../../../mol-plugin-state/manager/snapshots';\r\nimport { PluginStateObject as SO } from '../../../mol-plugin-state/objects';\r\nimport { StateTree } from '../../../mol-state';\r\nimport { getFormattedTime } from '../../../mol-util/date';\r\nimport { download } from '../../../mol-util/download';\r\nimport { urlCombine } from '../../../mol-util/url';\r\nimport { PluginCommands } from '../../commands';\r\nimport { PluginConfig } from '../../config';\r\nexport function registerDefault(ctx) {\r\n    SyncBehaviors(ctx);\r\n    SetCurrentObject(ctx);\r\n    Update(ctx);\r\n    ApplyAction(ctx);\r\n    RemoveObject(ctx);\r\n    ToggleExpanded(ctx);\r\n    ToggleVisibility(ctx);\r\n    Highlight(ctx);\r\n    ClearHighlights(ctx);\r\n    Snapshots(ctx);\r\n}\r\nexport function SyncBehaviors(ctx) {\r\n    ctx.state.events.object.created.subscribe(function (o) {\r\n        if (!SO.isBehavior(o.obj))\r\n            return;\r\n        o.obj.data.register(o.ref);\r\n    });\r\n    ctx.state.events.object.removed.subscribe(function (o) {\r\n        if (!SO.isBehavior(o.obj))\r\n            return;\r\n        o.obj.data.unregister();\r\n    });\r\n    ctx.state.events.object.updated.subscribe(function (o) {\r\n        if (o.action === 'recreate') {\r\n            if (o.oldObj && SO.isBehavior(o.oldObj))\r\n                o.oldObj.data.unregister();\r\n            if (o.obj && SO.isBehavior(o.obj))\r\n                o.obj.data.register(o.ref);\r\n        }\r\n    });\r\n}\r\nexport function SetCurrentObject(ctx) {\r\n    PluginCommands.State.SetCurrentObject.subscribe(ctx, function (_a) {\r\n        var state = _a.state, ref = _a.ref;\r\n        return state.setCurrent(ref);\r\n    });\r\n}\r\nexport function Update(ctx) {\r\n    PluginCommands.State.Update.subscribe(ctx, function (_a) {\r\n        var state = _a.state, tree = _a.tree, options = _a.options;\r\n        return ctx.runTask(state.updateTree(tree, options));\r\n    });\r\n}\r\nexport function ApplyAction(ctx) {\r\n    PluginCommands.State.ApplyAction.subscribe(ctx, function (_a) {\r\n        var state = _a.state, action = _a.action, ref = _a.ref;\r\n        return ctx.runTask(state.applyAction(action.action, action.params, ref));\r\n    });\r\n}\r\nexport function RemoveObject(ctx) {\r\n    function remove(state, ref) {\r\n        var tree = state.build().delete(ref);\r\n        return ctx.runTask(state.updateTree(tree));\r\n    }\r\n    PluginCommands.State.RemoveObject.subscribe(ctx, function (_a) {\r\n        var state = _a.state, ref = _a.ref, removeParentGhosts = _a.removeParentGhosts;\r\n        if (removeParentGhosts) {\r\n            var tree = state.tree;\r\n            var curr = tree.transforms.get(ref);\r\n            if (curr.parent === ref)\r\n                return remove(state, ref);\r\n            while (true) {\r\n                var children = tree.children.get(curr.parent);\r\n                if (curr.parent === curr.ref || children.size > 1)\r\n                    return remove(state, curr.ref);\r\n                var parent_1 = tree.transforms.get(curr.parent);\r\n                // TODO: should this use \"cell state\" instead?\r\n                if (!parent_1.state.isGhost)\r\n                    return remove(state, curr.ref);\r\n                curr = parent_1;\r\n            }\r\n        }\r\n        else {\r\n            return remove(state, ref);\r\n        }\r\n    });\r\n}\r\nexport function ToggleExpanded(ctx) {\r\n    PluginCommands.State.ToggleExpanded.subscribe(ctx, function (_a) {\r\n        var state = _a.state, ref = _a.ref;\r\n        return state.updateCellState(ref, function (_a) {\r\n            var isCollapsed = _a.isCollapsed;\r\n            return ({ isCollapsed: !isCollapsed });\r\n        });\r\n    });\r\n}\r\nexport function ToggleVisibility(ctx) {\r\n    PluginCommands.State.ToggleVisibility.subscribe(ctx, function (_a) {\r\n        var state = _a.state, ref = _a.ref;\r\n        return setSubtreeVisibility(state, ref, !state.cells.get(ref).state.isHidden);\r\n    });\r\n}\r\nexport function setSubtreeVisibility(state, root, value) {\r\n    StateTree.doPreOrder(state.tree, state.transforms.get(root), { state: state, value: value }, setVisibilityVisitor);\r\n}\r\nfunction setVisibilityVisitor(t, tree, ctx) {\r\n    ctx.state.updateCellState(t.ref, { isHidden: ctx.value });\r\n}\r\nexport function Highlight(ctx) {\r\n    PluginCommands.Interactivity.Object.Highlight.subscribe(ctx, function (_a) {\r\n        var state = _a.state, ref = _a.ref;\r\n        if (!ctx.canvas3d || ctx.isBusy)\r\n            return;\r\n        ctx.managers.interactivity.lociHighlights.clearHighlights();\r\n        var refs = typeof ref === 'string' ? [ref] : ref;\r\n        for (var _i = 0, refs_1 = refs; _i < refs_1.length; _i++) {\r\n            var r = refs_1[_i];\r\n            var cell = state.cells.get(r);\r\n            if (!cell)\r\n                continue;\r\n            if (SO.Molecule.Structure.is(cell.obj)) {\r\n                ctx.managers.interactivity.lociHighlights.highlight({ loci: Structure.Loci(cell.obj.data) }, false);\r\n            }\r\n            else if (cell && SO.isRepresentation3D(cell.obj)) {\r\n                var repr = cell.obj.data.repr;\r\n                ctx.managers.interactivity.lociHighlights.highlight({ loci: repr.getLoci(), repr: repr }, false);\r\n            }\r\n            else if (SO.Molecule.Structure.Selections.is(cell.obj)) {\r\n                for (var _b = 0, _c = cell.obj.data; _b < _c.length; _b++) {\r\n                    var entry = _c[_b];\r\n                    ctx.managers.interactivity.lociHighlights.highlight({ loci: entry.loci }, false);\r\n                }\r\n            }\r\n        }\r\n        // TODO: highlight volumes?\r\n        // TODO: select structures of subtree?\r\n    });\r\n}\r\nexport function ClearHighlights(ctx) {\r\n    PluginCommands.Interactivity.ClearHighlights.subscribe(ctx, function () {\r\n        ctx.managers.interactivity.lociHighlights.clearHighlights();\r\n    });\r\n}\r\nexport function Snapshots(ctx) {\r\n    var _this = this;\r\n    ctx.config.set(PluginConfig.State.CurrentServer, ctx.config.get(PluginConfig.State.DefaultServer));\r\n    PluginCommands.State.Snapshots.Clear.subscribe(ctx, function () {\r\n        ctx.managers.snapshot.clear();\r\n    });\r\n    PluginCommands.State.Snapshots.Remove.subscribe(ctx, function (_a) {\r\n        var id = _a.id;\r\n        ctx.managers.snapshot.remove(id);\r\n    });\r\n    PluginCommands.State.Snapshots.Add.subscribe(ctx, function (_a) {\r\n        var name = _a.name, description = _a.description, params = _a.params;\r\n        var entry = PluginStateSnapshotManager.Entry(ctx.state.getSnapshot(params), { name: name, description: description });\r\n        ctx.managers.snapshot.add(entry);\r\n    });\r\n    PluginCommands.State.Snapshots.Replace.subscribe(ctx, function (_a) {\r\n        var id = _a.id, params = _a.params;\r\n        ctx.managers.snapshot.replace(id, ctx.state.getSnapshot(params));\r\n    });\r\n    PluginCommands.State.Snapshots.Move.subscribe(ctx, function (_a) {\r\n        var id = _a.id, dir = _a.dir;\r\n        ctx.managers.snapshot.move(id, dir);\r\n    });\r\n    PluginCommands.State.Snapshots.Apply.subscribe(ctx, function (_a) {\r\n        var id = _a.id;\r\n        var snapshot = ctx.managers.snapshot.setCurrent(id);\r\n        if (!snapshot)\r\n            return;\r\n        return ctx.state.setSnapshot(snapshot);\r\n    });\r\n    PluginCommands.State.Snapshots.Upload.subscribe(ctx, function (_a) {\r\n        var name = _a.name, description = _a.description, playOnLoad = _a.playOnLoad, serverUrl = _a.serverUrl, params = _a.params;\r\n        return fetch(urlCombine(serverUrl, \"set?name=\" + encodeURIComponent(name || '') + \"&description=\" + encodeURIComponent(description || '')), {\r\n            method: 'POST',\r\n            mode: 'cors',\r\n            referrer: 'no-referrer',\r\n            headers: { 'Content-Type': 'application/json; charset=utf-8' },\r\n            body: JSON.stringify(ctx.managers.snapshot.getStateSnapshot({ name: name, description: description, playOnLoad: playOnLoad }))\r\n        });\r\n    });\r\n    PluginCommands.State.Snapshots.Fetch.subscribe(ctx, function (_a) {\r\n        var url = _a.url;\r\n        return __awaiter(_this, void 0, void 0, function () {\r\n            var json;\r\n            return __generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0: return [4 /*yield*/, ctx.runTask(ctx.fetch({ url: url, type: 'json' }))];\r\n                    case 1:\r\n                        json = _b.sent();\r\n                        return [4 /*yield*/, ctx.managers.snapshot.setStateSnapshot(json.data)];\r\n                    case 2:\r\n                        _b.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    });\r\n    PluginCommands.State.Snapshots.DownloadToFile.subscribe(ctx, function (_a) {\r\n        var name = _a.name, type = _a.type, params = _a.params;\r\n        return __awaiter(_this, void 0, void 0, function () {\r\n            var filename, data;\r\n            return __generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        filename = \"mol-star_state_\" + (name || getFormattedTime()) + \".\" + (type === 'json' ? 'molj' : 'molx');\r\n                        return [4 /*yield*/, ctx.managers.snapshot.serialize({ type: type, params: params })];\r\n                    case 1:\r\n                        data = _b.sent();\r\n                        download(data, \"\" + filename);\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    });\r\n    PluginCommands.State.Snapshots.OpenFile.subscribe(ctx, function (_a) {\r\n        var file = _a.file;\r\n        return ctx.managers.snapshot.open(file);\r\n    });\r\n    PluginCommands.State.Snapshots.OpenUrl.subscribe(ctx, function (_a) {\r\n        var url = _a.url, type = _a.type;\r\n        return __awaiter(_this, void 0, void 0, function () {\r\n            var data;\r\n            return __generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0: return [4 /*yield*/, ctx.runTask(ctx.fetch({ url: url, type: 'binary' }))];\r\n                    case 1:\r\n                        data = _b.sent();\r\n                        return [2 /*return*/, ctx.managers.snapshot.open(new File([data], \"state.\" + type))];\r\n                }\r\n            });\r\n        });\r\n    });\r\n}\r\n//# sourceMappingURL=state.js.map"]},"metadata":{},"sourceType":"module"}