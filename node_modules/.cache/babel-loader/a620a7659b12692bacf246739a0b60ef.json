{"ast":null,"code":"/**\r\n * Copyright (c) 2018-2021 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\nimport { Loci } from '../../mol-model/loci';\nimport { Representation } from '../../mol-repr/representation';\nimport { MarkerAction } from '../../mol-util/marker-action';\nimport { arrayRemoveAtInPlace } from '../../mol-util/array';\n\nvar LociLabelManager =\n/** @class */\nfunction () {\n  function LociLabelManager(ctx) {\n    var _this = this;\n\n    this.ctx = ctx;\n    this.providers = [];\n    this.locis = [];\n    this.isDirty = false;\n    this.labels = [];\n    this.groupedLabels = new Map();\n    ctx.managers.interactivity.lociHighlights.addProvider(function (loci, action, noRender) {\n      _this.mark(loci, action);\n\n      if (!noRender) _this.showLabels();\n    });\n  }\n\n  LociLabelManager.prototype.clearProviders = function () {\n    this.providers = [];\n    this.isDirty = true;\n    this.showLabels();\n  };\n\n  LociLabelManager.prototype.addProvider = function (provider) {\n    this.providers.push(provider);\n    this.providers.sort(function (a, b) {\n      return (b.priority || 0) - (a.priority || 0);\n    });\n    this.isDirty = true;\n    this.showLabels();\n  };\n\n  LociLabelManager.prototype.removeProvider = function (provider) {\n    this.providers = this.providers.filter(function (p) {\n      return p !== provider;\n    });\n    this.isDirty = true;\n    this.showLabels();\n  };\n\n  LociLabelManager.prototype.mark = function (loci, action) {\n    var idx = this.locis.findIndex(function (l) {\n      return Representation.Loci.areEqual(loci, l);\n    });\n\n    if (idx === -1 && action === MarkerAction.Highlight) {\n      this.locis.push(loci);\n      this.isDirty = true;\n    } else if (idx !== -1 && action === MarkerAction.RemoveHighlight) {\n      arrayRemoveAtInPlace(this.locis, idx);\n      this.isDirty = true;\n    }\n  };\n\n  LociLabelManager.prototype.showLabels = function () {\n    this.ctx.behaviors.labels.highlight.next({\n      labels: this.getLabels()\n    });\n  };\n\n  LociLabelManager.prototype.getLabels = function () {\n    var _this = this;\n\n    if (this.isDirty) {\n      this.groupedLabels.clear();\n      this.labels.length = 0;\n\n      for (var _i = 0, _a = this.providers; _i < _a.length; _i++) {\n        var provider = _a[_i];\n\n        for (var _b = 0, _c = this.locis; _b < _c.length; _b++) {\n          var loci = _c[_b];\n          if (Loci.isEmpty(loci.loci)) continue;\n          var label = provider.label(loci.loci, loci.repr);\n\n          if (label) {\n            var hash = provider.group ? provider.group(label) : label.toString();\n            var group = this.groupedLabels.get(hash);\n            if (group) group.push(label);else this.groupedLabels.set(hash, [label]);\n          }\n        }\n      }\n\n      this.labels.length = 0;\n      this.groupedLabels.forEach(function (group, hash) {\n        var count = group.length;\n        var entry = count > 1 && group[0] !== group[1] ? hash : group[0];\n\n        _this.labels.push(count === 1 ? entry : entry + \" <small>|| \\u00D7 \" + count + \"</small>\");\n      });\n      this.isDirty = false;\n    }\n\n    return this.labels;\n  };\n\n  return LociLabelManager;\n}();\n\nexport { LociLabelManager };","map":{"version":3,"sources":["../../../src/mol-plugin-state/manager/loci-label.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2018-2021 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { Loci } from '../../mol-model/loci';\r\nimport { Representation } from '../../mol-repr/representation';\r\nimport { MarkerAction } from '../../mol-util/marker-action';\r\nimport { arrayRemoveAtInPlace } from '../../mol-util/array';\r\nvar LociLabelManager = /** @class */ (function () {\r\n    function LociLabelManager(ctx) {\r\n        var _this = this;\r\n        this.ctx = ctx;\r\n        this.providers = [];\r\n        this.locis = [];\r\n        this.isDirty = false;\r\n        this.labels = [];\r\n        this.groupedLabels = new Map();\r\n        ctx.managers.interactivity.lociHighlights.addProvider(function (loci, action, noRender) {\r\n            _this.mark(loci, action);\r\n            if (!noRender)\r\n                _this.showLabels();\r\n        });\r\n    }\r\n    LociLabelManager.prototype.clearProviders = function () {\r\n        this.providers = [];\r\n        this.isDirty = true;\r\n        this.showLabels();\r\n    };\r\n    LociLabelManager.prototype.addProvider = function (provider) {\r\n        this.providers.push(provider);\r\n        this.providers.sort(function (a, b) { return (b.priority || 0) - (a.priority || 0); });\r\n        this.isDirty = true;\r\n        this.showLabels();\r\n    };\r\n    LociLabelManager.prototype.removeProvider = function (provider) {\r\n        this.providers = this.providers.filter(function (p) { return p !== provider; });\r\n        this.isDirty = true;\r\n        this.showLabels();\r\n    };\r\n    LociLabelManager.prototype.mark = function (loci, action) {\r\n        var idx = this.locis.findIndex(function (l) { return Representation.Loci.areEqual(loci, l); });\r\n        if (idx === -1 && action === MarkerAction.Highlight) {\r\n            this.locis.push(loci);\r\n            this.isDirty = true;\r\n        }\r\n        else if (idx !== -1 && action === MarkerAction.RemoveHighlight) {\r\n            arrayRemoveAtInPlace(this.locis, idx);\r\n            this.isDirty = true;\r\n        }\r\n    };\r\n    LociLabelManager.prototype.showLabels = function () {\r\n        this.ctx.behaviors.labels.highlight.next({ labels: this.getLabels() });\r\n    };\r\n    LociLabelManager.prototype.getLabels = function () {\r\n        var _this = this;\r\n        if (this.isDirty) {\r\n            this.groupedLabels.clear();\r\n            this.labels.length = 0;\r\n            for (var _i = 0, _a = this.providers; _i < _a.length; _i++) {\r\n                var provider = _a[_i];\r\n                for (var _b = 0, _c = this.locis; _b < _c.length; _b++) {\r\n                    var loci = _c[_b];\r\n                    if (Loci.isEmpty(loci.loci))\r\n                        continue;\r\n                    var label = provider.label(loci.loci, loci.repr);\r\n                    if (label) {\r\n                        var hash = provider.group ? provider.group(label) : label.toString();\r\n                        var group = this.groupedLabels.get(hash);\r\n                        if (group)\r\n                            group.push(label);\r\n                        else\r\n                            this.groupedLabels.set(hash, [label]);\r\n                    }\r\n                }\r\n            }\r\n            this.labels.length = 0;\r\n            this.groupedLabels.forEach(function (group, hash) {\r\n                var count = group.length;\r\n                var entry = count > 1 && group[0] !== group[1]\r\n                    ? hash : group[0];\r\n                _this.labels.push(count === 1 ? entry : entry + \" <small>|| \\u00D7 \" + count + \"</small>\");\r\n            });\r\n            this.isDirty = false;\r\n        }\r\n        return this.labels;\r\n    };\r\n    return LociLabelManager;\r\n}());\r\nexport { LociLabelManager };\r\n//# sourceMappingURL=loci-label.js.map"]},"metadata":{},"sourceType":"module"}