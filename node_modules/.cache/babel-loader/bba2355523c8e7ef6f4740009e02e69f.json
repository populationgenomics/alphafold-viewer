{"ast":null,"code":"/**\r\n * Copyright (c) 2018-2021 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\nimport { __awaiter, __generator } from \"tslib\";\nimport produce, { setAutoFreeze } from 'immer';\nimport { List } from 'immutable';\nimport { merge } from 'rxjs';\nimport { filter, take } from 'rxjs/operators';\nimport { Canvas3D, Canvas3DContext, DefaultCanvas3DParams } from '../mol-canvas3d/canvas3d';\nimport { resizeCanvas } from '../mol-canvas3d/util';\nimport { Vec2 } from '../mol-math/linear-algebra';\nimport { CustomProperty } from '../mol-model-props/common/custom-property';\nimport { DataBuilder } from '../mol-plugin-state/builder/data';\nimport { StructureBuilder } from '../mol-plugin-state/builder/structure';\nimport { DataFormatRegistry } from '../mol-plugin-state/formats/registry';\nimport { StructureSelectionQueryRegistry } from '../mol-plugin-state/helpers/structure-selection-query';\nimport { PluginAnimationManager } from '../mol-plugin-state/manager/animation';\nimport { CameraManager } from '../mol-plugin-state/manager/camera';\nimport { InteractivityManager } from '../mol-plugin-state/manager/interactivity';\nimport { LociLabelManager } from '../mol-plugin-state/manager/loci-label';\nimport { PluginStateSnapshotManager } from '../mol-plugin-state/manager/snapshots';\nimport { StructureComponentManager } from '../mol-plugin-state/manager/structure/component';\nimport { StructureFocusManager } from '../mol-plugin-state/manager/structure/focus';\nimport { StructureHierarchyManager } from '../mol-plugin-state/manager/structure/hierarchy';\nimport { StructureMeasurementManager } from '../mol-plugin-state/manager/structure/measurement';\nimport { StructureSelectionManager } from '../mol-plugin-state/manager/structure/selection';\nimport { VolumeHierarchyManager } from '../mol-plugin-state/manager/volume/hierarchy';\nimport { PluginLayout } from './layout';\nimport { Representation } from '../mol-repr/representation';\nimport { StructureRepresentationRegistry } from '../mol-repr/structure/registry';\nimport { VolumeRepresentationRegistry } from '../mol-repr/volume/registry';\nimport { StateTransform } from '../mol-state';\nimport { Task } from '../mol-task';\nimport { ColorTheme } from '../mol-theme/color';\nimport { SizeTheme } from '../mol-theme/size';\nimport { AssetManager } from '../mol-util/assets';\nimport { Color } from '../mol-util/color';\nimport { ajaxGet } from '../mol-util/data-source';\nimport { isDebugMode, isProductionMode } from '../mol-util/debug';\nimport { ModifiersKeys } from '../mol-util/input/input-observer';\nimport { LogEntry } from '../mol-util/log-entry';\nimport { objectForEach } from '../mol-util/object';\nimport { RxEventHelper } from '../mol-util/rx-event-helper';\nimport { PluginAnimationLoop } from './animation-loop';\nimport { BuiltInPluginBehaviors } from './behavior';\nimport { PluginBehavior } from './behavior/behavior';\nimport { PluginCommandManager } from './command';\nimport { PluginCommands } from './commands';\nimport { PluginConfig, PluginConfigManager } from './config';\nimport { PluginState } from './state';\nimport { SubstructureParentHelper } from './util/substructure-parent-helper';\nimport { TaskManager } from './util/task-manager';\nimport { PluginToastManager } from './util/toast';\nimport { ViewportScreenshotHelper } from './util/viewport-screenshot';\nimport { PLUGIN_VERSION, PLUGIN_VERSION_DATE } from './version';\n\nvar PluginContext =\n/** @class */\nfunction () {\n  function PluginContext(spec) {\n    var _this = this;\n\n    this.spec = spec;\n\n    this.runTask = function (task, params) {\n      return _this.managers.task.run(task, params);\n    };\n\n    this.resolveTask = function (object) {\n      if (!object) return void 0;\n      if (Task.is(object)) return _this.runTask(object);\n      return object;\n    };\n\n    this.subs = [];\n    this.disposed = false;\n    this.ev = RxEventHelper.create();\n    this.config = new PluginConfigManager(this.spec.config); // needed to init state\n\n    this.state = new PluginState(this);\n    this.commands = new PluginCommandManager();\n    this.canvas3dInit = this.ev.behavior(false);\n    this.behaviors = {\n      state: {\n        isAnimating: this.ev.behavior(false),\n        isUpdating: this.ev.behavior(false),\n        // TODO: should there be separate \"updated\" event?\n        //   Often, this is used to indicate that the state has updated\n        //   and it might not be the best way to react to state updates.\n        isBusy: this.ev.behavior(false)\n      },\n      interaction: {\n        hover: this.ev.behavior({\n          current: Representation.Loci.Empty,\n          modifiers: ModifiersKeys.None,\n          buttons: 0,\n          button: 0\n        }),\n        click: this.ev.behavior({\n          current: Representation.Loci.Empty,\n          modifiers: ModifiersKeys.None,\n          buttons: 0,\n          button: 0\n        }),\n        drag: this.ev.behavior({\n          current: Representation.Loci.Empty,\n          modifiers: ModifiersKeys.None,\n          buttons: 0,\n          button: 0,\n          pageStart: Vec2(),\n          pageEnd: Vec2()\n        }),\n        selectionMode: this.ev.behavior(false)\n      },\n      labels: {\n        highlight: this.ev.behavior({\n          labels: []\n        })\n      },\n      layout: {\n        leftPanelTabName: this.ev.behavior('root')\n      },\n      canvas3d: {\n        initialized: this.canvas3dInit.pipe(filter(function (v) {\n          return !!v;\n        }), take(1))\n      }\n    };\n    this.layout = new PluginLayout(this);\n    this.animationLoop = new PluginAnimationLoop(this);\n    this.representation = {\n      structure: {\n        registry: new StructureRepresentationRegistry(),\n        themes: {\n          colorThemeRegistry: ColorTheme.createRegistry(),\n          sizeThemeRegistry: SizeTheme.createRegistry()\n        }\n      },\n      volume: {\n        registry: new VolumeRepresentationRegistry(),\n        themes: {\n          colorThemeRegistry: ColorTheme.createRegistry(),\n          sizeThemeRegistry: SizeTheme.createRegistry()\n        }\n      }\n    };\n    this.query = {\n      structure: {\n        registry: new StructureSelectionQueryRegistry()\n      }\n    };\n    this.dataFormats = new DataFormatRegistry();\n    this.builders = {\n      data: new DataBuilder(this),\n      structure: void 0\n    };\n    this.helpers = {\n      substructureParent: new SubstructureParentHelper(this),\n      viewportScreenshot: void 0\n    };\n    this.managers = {\n      structure: {\n        hierarchy: new StructureHierarchyManager(this),\n        component: new StructureComponentManager(this),\n        measurement: new StructureMeasurementManager(this),\n        selection: new StructureSelectionManager(this),\n        focus: new StructureFocusManager(this)\n      },\n      volume: {\n        hierarchy: new VolumeHierarchyManager(this)\n      },\n      interactivity: void 0,\n      camera: new CameraManager(this),\n      animation: new PluginAnimationManager(this),\n      snapshot: new PluginStateSnapshotManager(this),\n      lociLabels: void 0,\n      toast: new PluginToastManager(this),\n      asset: new AssetManager(),\n      task: new TaskManager()\n    };\n    this.events = {\n      log: this.ev(),\n      task: this.managers.task.events,\n      canvas3d: {\n        settingsUpdated: this.ev()\n      }\n    };\n    this.customModelProperties = new CustomProperty.Registry();\n    this.customStructureProperties = new CustomProperty.Registry();\n    this.customStructureControls = new Map();\n    this.genericRepresentationControls = new Map();\n    /**\r\n     * Used to store application specific custom state which is then available\r\n     * to State Actions and similar constructs via the PluginContext.\r\n     */\n\n    this.customState = Object.create(null);\n    this.log = {\n      entries: List(),\n      entry: function (e) {\n        return _this.events.log.next(e);\n      },\n      error: function (msg) {\n        return _this.events.log.next(LogEntry.error(msg));\n      },\n      message: function (msg) {\n        return _this.events.log.next(LogEntry.message(msg));\n      },\n      info: function (msg) {\n        return _this.events.log.next(LogEntry.info(msg));\n      },\n      warn: function (msg) {\n        return _this.events.log.next(LogEntry.warning(msg));\n      }\n    };\n    /**\r\n     * This should be used in all transform related request so that it could be \"spoofed\" to allow\r\n     * \"static\" access to resources.\r\n     */\n\n    this.fetch = ajaxGet; // the reason for this is that sometimes, transform params get modified inline (i.e. palette.valueLabel)\n    // and freezing the params object causes \"read-only exception\"\n    // TODO: is this the best place to do it?\n\n    setAutoFreeze(false);\n  }\n\n  PluginContext.prototype.build = function () {\n    return this.state.data.build();\n  };\n\n  PluginContext.prototype.initViewer = function (canvas, container, canvas3dContext) {\n    var _this = this;\n\n    var _a, _b, _c, _d, _e, _f;\n\n    try {\n      this.layout.setRoot(container);\n      if (this.spec.layout && this.spec.layout.initial) this.layout.setProps(this.spec.layout.initial);\n\n      if (canvas3dContext) {\n        this.canvas3dContext = canvas3dContext;\n      } else {\n        var antialias = !((_a = this.config.get(PluginConfig.General.DisableAntialiasing)) !== null && _a !== void 0 ? _a : false);\n        var preserveDrawingBuffer = !((_b = this.config.get(PluginConfig.General.DisablePreserveDrawingBuffer)) !== null && _b !== void 0 ? _b : false);\n        var pixelScale = this.config.get(PluginConfig.General.PixelScale) || 1;\n        var pickScale = this.config.get(PluginConfig.General.PickScale) || 0.25;\n        var pickPadding = (_c = this.config.get(PluginConfig.General.PickPadding)) !== null && _c !== void 0 ? _c : 1;\n        var enableWboit = this.config.get(PluginConfig.General.EnableWboit) || false;\n        var preferWebGl1 = this.config.get(PluginConfig.General.PreferWebGl1) || false;\n        this.canvas3dContext = Canvas3DContext.fromCanvas(canvas, {\n          antialias: antialias,\n          preserveDrawingBuffer: preserveDrawingBuffer,\n          pixelScale: pixelScale,\n          pickScale: pickScale,\n          enableWboit: enableWboit,\n          preferWebGl1: preferWebGl1\n        });\n        this.canvas3dContext = Canvas3DContext.fromCanvas(canvas, {\n          antialias: antialias,\n          preserveDrawingBuffer: preserveDrawingBuffer,\n          pixelScale: pixelScale,\n          pickScale: pickScale,\n          pickPadding: pickPadding,\n          enableWboit: enableWboit\n        });\n      }\n\n      this.canvas3d = Canvas3D.create(this.canvas3dContext);\n      this.canvas3dInit.next(true);\n      var props = this.spec.canvas3d;\n      var backgroundColor_1 = Color(0xFCFBF9);\n\n      if (!props) {\n        (_d = this.canvas3d) === null || _d === void 0 ? void 0 : _d.setProps({\n          renderer: {\n            backgroundColor: backgroundColor_1\n          }\n        });\n      } else {\n        if (((_e = props.renderer) === null || _e === void 0 ? void 0 : _e.backgroundColor) === void 0) {\n          props = produce(props, function (p) {\n            if (p.renderer) p.renderer.backgroundColor = backgroundColor_1;else p.renderer = {\n              backgroundColor: backgroundColor_1\n            };\n          });\n        }\n\n        (_f = this.canvas3d) === null || _f === void 0 ? void 0 : _f.setProps(props);\n      }\n\n      this.animationLoop.start();\n      this.helpers.viewportScreenshot = new ViewportScreenshotHelper(this);\n      this.subs.push(this.canvas3d.interaction.click.subscribe(function (e) {\n        return _this.behaviors.interaction.click.next(e);\n      }));\n      this.subs.push(this.canvas3d.interaction.drag.subscribe(function (e) {\n        return _this.behaviors.interaction.drag.next(e);\n      }));\n      this.subs.push(this.canvas3d.interaction.hover.subscribe(function (e) {\n        return _this.behaviors.interaction.hover.next(e);\n      }));\n      this.subs.push(this.canvas3d.input.resize.subscribe(function () {\n        return _this.handleResize();\n      }));\n      this.subs.push(this.layout.events.updated.subscribe(function () {\n        return requestAnimationFrame(function () {\n          return _this.handleResize();\n        });\n      }));\n      this.handleResize();\n      return true;\n    } catch (e) {\n      this.log.error('' + e);\n      console.error(e);\n      return false;\n    }\n  };\n\n  PluginContext.prototype.handleResize = function () {\n    var _a, _b;\n\n    var canvas = (_a = this.canvas3dContext) === null || _a === void 0 ? void 0 : _a.canvas;\n    var container = this.layout.root;\n\n    if (container && canvas) {\n      var pixelScale = this.config.get(PluginConfig.General.PixelScale) || 1;\n      resizeCanvas(canvas, container, pixelScale);\n      (_b = this.canvas3d) === null || _b === void 0 ? void 0 : _b.requestResize();\n    }\n  };\n\n  Object.defineProperty(PluginContext.prototype, \"isBusy\", {\n    /** return true is animating or updating */\n    get: function () {\n      return this.behaviors.state.isAnimating.value || this.behaviors.state.isUpdating.value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(PluginContext.prototype, \"selectionMode\", {\n    get: function () {\n      return this.behaviors.interaction.selectionMode.value;\n    },\n    set: function (mode) {\n      this.behaviors.interaction.selectionMode.next(mode);\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  PluginContext.prototype.dataTransaction = function (f, options) {\n    return this.runTask(this.state.data.transaction(f, options));\n  };\n\n  PluginContext.prototype.clear = function (resetViewportSettings) {\n    var _a;\n\n    if (resetViewportSettings === void 0) {\n      resetViewportSettings = false;\n    }\n\n    if (resetViewportSettings) (_a = this.canvas3d) === null || _a === void 0 ? void 0 : _a.setProps(DefaultCanvas3DParams);\n    return PluginCommands.State.RemoveObject(this, {\n      state: this.state.data,\n      ref: StateTransform.RootRef\n    });\n  };\n\n  PluginContext.prototype.dispose = function (options) {\n    var _a, _b;\n\n    if (this.disposed) return;\n\n    for (var _i = 0, _c = this.subs; _i < _c.length; _i++) {\n      var s = _c[_i];\n      s.unsubscribe();\n    }\n\n    this.subs = [];\n    this.commands.dispose();\n    (_a = this.canvas3d) === null || _a === void 0 ? void 0 : _a.dispose();\n    (_b = this.canvas3dContext) === null || _b === void 0 ? void 0 : _b.dispose(options);\n    this.ev.dispose();\n    this.state.dispose();\n    this.managers.task.dispose();\n    this.helpers.substructureParent.dispose();\n    objectForEach(this.managers, function (m) {\n      var _a, _b;\n\n      return (_b = (_a = m) === null || _a === void 0 ? void 0 : _a.dispose) === null || _b === void 0 ? void 0 : _b.call(_a);\n    });\n    objectForEach(this.managers.structure, function (m) {\n      var _a, _b;\n\n      return (_b = (_a = m) === null || _a === void 0 ? void 0 : _a.dispose) === null || _b === void 0 ? void 0 : _b.call(_a);\n    });\n    this.disposed = true;\n  };\n\n  PluginContext.prototype.initBehaviorEvents = function () {\n    var _this = this;\n\n    this.subs.push(merge(this.state.data.behaviors.isUpdating, this.state.behaviors.behaviors.isUpdating).subscribe(function (u) {\n      if (_this.behaviors.state.isUpdating.value !== u) _this.behaviors.state.isUpdating.next(u);\n    }));\n    var timeoutMs = this.config.get(PluginConfig.General.IsBusyTimeoutMs) || 750;\n    var isBusy = this.behaviors.state.isBusy;\n    var timeout = void 0;\n\n    var setBusy = function () {\n      if (!isBusy.value) isBusy.next(true);\n    };\n\n    var reset = function () {\n      if (timeout !== void 0) clearTimeout(timeout);\n      timeout = void 0;\n    };\n\n    this.subs.push(merge(this.behaviors.state.isUpdating, this.behaviors.state.isAnimating).subscribe(function (v) {\n      var isUpdating = _this.behaviors.state.isUpdating.value;\n      var isAnimating = _this.behaviors.state.isAnimating.value;\n\n      if (isUpdating || isAnimating) {\n        if (!isBusy.value) {\n          reset();\n          timeout = setTimeout(setBusy, timeoutMs);\n        }\n      } else {\n        reset();\n        isBusy.next(false);\n      }\n    }));\n    this.subs.push(this.behaviors.interaction.selectionMode.subscribe(function (v) {\n      var _a;\n\n      if (!v) {\n        (_a = _this.managers.interactivity) === null || _a === void 0 ? void 0 : _a.lociSelects.deselectAll();\n      }\n    }));\n  };\n\n  PluginContext.prototype.initBuiltInBehavior = function () {\n    var _this = this;\n\n    BuiltInPluginBehaviors.State.registerDefault(this);\n    BuiltInPluginBehaviors.Representation.registerDefault(this);\n    BuiltInPluginBehaviors.Camera.registerDefault(this);\n    BuiltInPluginBehaviors.Misc.registerDefault(this);\n    this.subs.push(merge(this.state.data.events.log, this.state.behaviors.events.log).subscribe(function (e) {\n      return _this.events.log.next(e);\n    }));\n  };\n\n  PluginContext.prototype.initBehaviors = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var tree, _i, _a, cat, _b, _c, b, cat, _d, _e, b, cat;\n\n      return __generator(this, function (_f) {\n        switch (_f.label) {\n          case 0:\n            tree = this.state.behaviors.build();\n\n            for (_i = 0, _a = Object.keys(PluginBehavior.Categories); _i < _a.length; _i++) {\n              cat = _a[_i];\n              tree.toRoot().apply(PluginBehavior.CreateCategory, {\n                label: PluginBehavior.Categories[cat]\n              }, {\n                ref: cat,\n                state: {\n                  isLocked: true\n                }\n              });\n            } // Init custom properties 1st\n\n\n            for (_b = 0, _c = this.spec.behaviors; _b < _c.length; _b++) {\n              b = _c[_b];\n              cat = PluginBehavior.getCategoryId(b.transformer);\n              if (cat !== 'custom-props') continue;\n              tree.to(PluginBehavior.getCategoryId(b.transformer)).apply(b.transformer, b.defaultParams, {\n                ref: b.transformer.id\n              });\n            }\n\n            return [4\n            /*yield*/\n            , this.runTask(this.state.behaviors.updateTree(tree, {\n              doNotUpdateCurrent: true,\n              doNotLogTiming: true\n            }))];\n\n          case 1:\n            _f.sent();\n\n            tree = this.state.behaviors.build();\n\n            for (_d = 0, _e = this.spec.behaviors; _d < _e.length; _d++) {\n              b = _e[_d];\n              cat = PluginBehavior.getCategoryId(b.transformer);\n              if (cat === 'custom-props') continue;\n              tree.to(PluginBehavior.getCategoryId(b.transformer)).apply(b.transformer, b.defaultParams, {\n                ref: b.transformer.id\n              });\n            }\n\n            return [4\n            /*yield*/\n            , this.runTask(this.state.behaviors.updateTree(tree, {\n              doNotUpdateCurrent: true,\n              doNotLogTiming: true\n            }))];\n\n          case 2:\n            _f.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  PluginContext.prototype.initCustomFormats = function () {\n    if (!this.spec.customFormats) return;\n\n    for (var _i = 0, _a = this.spec.customFormats; _i < _a.length; _i++) {\n      var f = _a[_i];\n      this.dataFormats.add(f[0], f[1]);\n    }\n  };\n\n  PluginContext.prototype.initAnimations = function () {\n    if (!this.spec.animations) return;\n\n    for (var _i = 0, _a = this.spec.animations; _i < _a.length; _i++) {\n      var anim = _a[_i];\n      this.managers.animation.register(anim);\n    }\n  };\n\n  PluginContext.prototype.initDataActions = function () {\n    if (!this.spec.actions) return;\n\n    for (var _i = 0, _a = this.spec.actions; _i < _a.length; _i++) {\n      var a = _a[_i];\n      this.state.data.actions.add(a.action);\n    }\n  };\n\n  PluginContext.prototype.init = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.subs.push(this.events.log.subscribe(function (e) {\n              return _this.log.entries = _this.log.entries.push(e);\n            }));\n            this.initCustomFormats();\n            this.initBehaviorEvents();\n            this.initBuiltInBehavior();\n            this.managers.interactivity = new InteractivityManager(this);\n            this.managers.lociLabels = new LociLabelManager(this);\n            this.builders.structure = new StructureBuilder(this);\n            this.initAnimations();\n            this.initDataActions();\n            return [4\n            /*yield*/\n            , this.initBehaviors()];\n\n          case 1:\n            _a.sent();\n\n            this.log.message(\"Mol* Plugin \" + PLUGIN_VERSION + \" [\" + PLUGIN_VERSION_DATE.toLocaleString() + \"]\");\n            if (!isProductionMode) this.log.message(\"Development mode enabled\");\n            if (isDebugMode) this.log.message(\"Debug mode enabled\");\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  return PluginContext;\n}();\n\nexport { PluginContext };","map":{"version":3,"sources":["../../src/mol-plugin/context.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2018-2021 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { __awaiter, __generator } from \"tslib\";\r\nimport produce, { setAutoFreeze } from 'immer';\r\nimport { List } from 'immutable';\r\nimport { merge } from 'rxjs';\r\nimport { filter, take } from 'rxjs/operators';\r\nimport { Canvas3D, Canvas3DContext, DefaultCanvas3DParams } from '../mol-canvas3d/canvas3d';\r\nimport { resizeCanvas } from '../mol-canvas3d/util';\r\nimport { Vec2 } from '../mol-math/linear-algebra';\r\nimport { CustomProperty } from '../mol-model-props/common/custom-property';\r\nimport { DataBuilder } from '../mol-plugin-state/builder/data';\r\nimport { StructureBuilder } from '../mol-plugin-state/builder/structure';\r\nimport { DataFormatRegistry } from '../mol-plugin-state/formats/registry';\r\nimport { StructureSelectionQueryRegistry } from '../mol-plugin-state/helpers/structure-selection-query';\r\nimport { PluginAnimationManager } from '../mol-plugin-state/manager/animation';\r\nimport { CameraManager } from '../mol-plugin-state/manager/camera';\r\nimport { InteractivityManager } from '../mol-plugin-state/manager/interactivity';\r\nimport { LociLabelManager } from '../mol-plugin-state/manager/loci-label';\r\nimport { PluginStateSnapshotManager } from '../mol-plugin-state/manager/snapshots';\r\nimport { StructureComponentManager } from '../mol-plugin-state/manager/structure/component';\r\nimport { StructureFocusManager } from '../mol-plugin-state/manager/structure/focus';\r\nimport { StructureHierarchyManager } from '../mol-plugin-state/manager/structure/hierarchy';\r\nimport { StructureMeasurementManager } from '../mol-plugin-state/manager/structure/measurement';\r\nimport { StructureSelectionManager } from '../mol-plugin-state/manager/structure/selection';\r\nimport { VolumeHierarchyManager } from '../mol-plugin-state/manager/volume/hierarchy';\r\nimport { PluginLayout } from './layout';\r\nimport { Representation } from '../mol-repr/representation';\r\nimport { StructureRepresentationRegistry } from '../mol-repr/structure/registry';\r\nimport { VolumeRepresentationRegistry } from '../mol-repr/volume/registry';\r\nimport { StateTransform } from '../mol-state';\r\nimport { Task } from '../mol-task';\r\nimport { ColorTheme } from '../mol-theme/color';\r\nimport { SizeTheme } from '../mol-theme/size';\r\nimport { AssetManager } from '../mol-util/assets';\r\nimport { Color } from '../mol-util/color';\r\nimport { ajaxGet } from '../mol-util/data-source';\r\nimport { isDebugMode, isProductionMode } from '../mol-util/debug';\r\nimport { ModifiersKeys } from '../mol-util/input/input-observer';\r\nimport { LogEntry } from '../mol-util/log-entry';\r\nimport { objectForEach } from '../mol-util/object';\r\nimport { RxEventHelper } from '../mol-util/rx-event-helper';\r\nimport { PluginAnimationLoop } from './animation-loop';\r\nimport { BuiltInPluginBehaviors } from './behavior';\r\nimport { PluginBehavior } from './behavior/behavior';\r\nimport { PluginCommandManager } from './command';\r\nimport { PluginCommands } from './commands';\r\nimport { PluginConfig, PluginConfigManager } from './config';\r\nimport { PluginState } from './state';\r\nimport { SubstructureParentHelper } from './util/substructure-parent-helper';\r\nimport { TaskManager } from './util/task-manager';\r\nimport { PluginToastManager } from './util/toast';\r\nimport { ViewportScreenshotHelper } from './util/viewport-screenshot';\r\nimport { PLUGIN_VERSION, PLUGIN_VERSION_DATE } from './version';\r\nvar PluginContext = /** @class */ (function () {\r\n    function PluginContext(spec) {\r\n        var _this = this;\r\n        this.spec = spec;\r\n        this.runTask = function (task, params) { return _this.managers.task.run(task, params); };\r\n        this.resolveTask = function (object) {\r\n            if (!object)\r\n                return void 0;\r\n            if (Task.is(object))\r\n                return _this.runTask(object);\r\n            return object;\r\n        };\r\n        this.subs = [];\r\n        this.disposed = false;\r\n        this.ev = RxEventHelper.create();\r\n        this.config = new PluginConfigManager(this.spec.config); // needed to init state\r\n        this.state = new PluginState(this);\r\n        this.commands = new PluginCommandManager();\r\n        this.canvas3dInit = this.ev.behavior(false);\r\n        this.behaviors = {\r\n            state: {\r\n                isAnimating: this.ev.behavior(false),\r\n                isUpdating: this.ev.behavior(false),\r\n                // TODO: should there be separate \"updated\" event?\r\n                //   Often, this is used to indicate that the state has updated\r\n                //   and it might not be the best way to react to state updates.\r\n                isBusy: this.ev.behavior(false)\r\n            },\r\n            interaction: {\r\n                hover: this.ev.behavior({ current: Representation.Loci.Empty, modifiers: ModifiersKeys.None, buttons: 0, button: 0 }),\r\n                click: this.ev.behavior({ current: Representation.Loci.Empty, modifiers: ModifiersKeys.None, buttons: 0, button: 0 }),\r\n                drag: this.ev.behavior({ current: Representation.Loci.Empty, modifiers: ModifiersKeys.None, buttons: 0, button: 0, pageStart: Vec2(), pageEnd: Vec2() }),\r\n                selectionMode: this.ev.behavior(false)\r\n            },\r\n            labels: {\r\n                highlight: this.ev.behavior({ labels: [] })\r\n            },\r\n            layout: {\r\n                leftPanelTabName: this.ev.behavior('root')\r\n            },\r\n            canvas3d: {\r\n                initialized: this.canvas3dInit.pipe(filter(function (v) { return !!v; }), take(1))\r\n            }\r\n        };\r\n        this.layout = new PluginLayout(this);\r\n        this.animationLoop = new PluginAnimationLoop(this);\r\n        this.representation = {\r\n            structure: {\r\n                registry: new StructureRepresentationRegistry(),\r\n                themes: { colorThemeRegistry: ColorTheme.createRegistry(), sizeThemeRegistry: SizeTheme.createRegistry() },\r\n            },\r\n            volume: {\r\n                registry: new VolumeRepresentationRegistry(),\r\n                themes: { colorThemeRegistry: ColorTheme.createRegistry(), sizeThemeRegistry: SizeTheme.createRegistry() }\r\n            }\r\n        };\r\n        this.query = {\r\n            structure: {\r\n                registry: new StructureSelectionQueryRegistry()\r\n            }\r\n        };\r\n        this.dataFormats = new DataFormatRegistry();\r\n        this.builders = {\r\n            data: new DataBuilder(this),\r\n            structure: void 0\r\n        };\r\n        this.helpers = {\r\n            substructureParent: new SubstructureParentHelper(this),\r\n            viewportScreenshot: void 0\r\n        };\r\n        this.managers = {\r\n            structure: {\r\n                hierarchy: new StructureHierarchyManager(this),\r\n                component: new StructureComponentManager(this),\r\n                measurement: new StructureMeasurementManager(this),\r\n                selection: new StructureSelectionManager(this),\r\n                focus: new StructureFocusManager(this),\r\n            },\r\n            volume: {\r\n                hierarchy: new VolumeHierarchyManager(this)\r\n            },\r\n            interactivity: void 0,\r\n            camera: new CameraManager(this),\r\n            animation: new PluginAnimationManager(this),\r\n            snapshot: new PluginStateSnapshotManager(this),\r\n            lociLabels: void 0,\r\n            toast: new PluginToastManager(this),\r\n            asset: new AssetManager(),\r\n            task: new TaskManager()\r\n        };\r\n        this.events = {\r\n            log: this.ev(),\r\n            task: this.managers.task.events,\r\n            canvas3d: {\r\n                settingsUpdated: this.ev(),\r\n            }\r\n        };\r\n        this.customModelProperties = new CustomProperty.Registry();\r\n        this.customStructureProperties = new CustomProperty.Registry();\r\n        this.customStructureControls = new Map();\r\n        this.genericRepresentationControls = new Map();\r\n        /**\r\n         * Used to store application specific custom state which is then available\r\n         * to State Actions and similar constructs via the PluginContext.\r\n         */\r\n        this.customState = Object.create(null);\r\n        this.log = {\r\n            entries: List(),\r\n            entry: function (e) { return _this.events.log.next(e); },\r\n            error: function (msg) { return _this.events.log.next(LogEntry.error(msg)); },\r\n            message: function (msg) { return _this.events.log.next(LogEntry.message(msg)); },\r\n            info: function (msg) { return _this.events.log.next(LogEntry.info(msg)); },\r\n            warn: function (msg) { return _this.events.log.next(LogEntry.warning(msg)); },\r\n        };\r\n        /**\r\n         * This should be used in all transform related request so that it could be \"spoofed\" to allow\r\n         * \"static\" access to resources.\r\n         */\r\n        this.fetch = ajaxGet;\r\n        // the reason for this is that sometimes, transform params get modified inline (i.e. palette.valueLabel)\r\n        // and freezing the params object causes \"read-only exception\"\r\n        // TODO: is this the best place to do it?\r\n        setAutoFreeze(false);\r\n    }\r\n    PluginContext.prototype.build = function () {\r\n        return this.state.data.build();\r\n    };\r\n    PluginContext.prototype.initViewer = function (canvas, container, canvas3dContext) {\r\n        var _this = this;\r\n        var _a, _b, _c, _d, _e, _f;\r\n        try {\r\n            this.layout.setRoot(container);\r\n            if (this.spec.layout && this.spec.layout.initial)\r\n                this.layout.setProps(this.spec.layout.initial);\r\n            if (canvas3dContext) {\r\n                this.canvas3dContext = canvas3dContext;\r\n            }\r\n            else {\r\n                var antialias = !((_a = this.config.get(PluginConfig.General.DisableAntialiasing)) !== null && _a !== void 0 ? _a : false);\r\n                var preserveDrawingBuffer = !((_b = this.config.get(PluginConfig.General.DisablePreserveDrawingBuffer)) !== null && _b !== void 0 ? _b : false);\r\n                var pixelScale = this.config.get(PluginConfig.General.PixelScale) || 1;\r\n                var pickScale = this.config.get(PluginConfig.General.PickScale) || 0.25;\r\n                var pickPadding = (_c = this.config.get(PluginConfig.General.PickPadding)) !== null && _c !== void 0 ? _c : 1;\r\n                var enableWboit = this.config.get(PluginConfig.General.EnableWboit) || false;\r\n                var preferWebGl1 = this.config.get(PluginConfig.General.PreferWebGl1) || false;\r\n                this.canvas3dContext = Canvas3DContext.fromCanvas(canvas, { antialias: antialias, preserveDrawingBuffer: preserveDrawingBuffer, pixelScale: pixelScale, pickScale: pickScale, enableWboit: enableWboit, preferWebGl1: preferWebGl1 });\r\n                this.canvas3dContext = Canvas3DContext.fromCanvas(canvas, { antialias: antialias, preserveDrawingBuffer: preserveDrawingBuffer, pixelScale: pixelScale, pickScale: pickScale, pickPadding: pickPadding, enableWboit: enableWboit });\r\n            }\r\n            this.canvas3d = Canvas3D.create(this.canvas3dContext);\r\n            this.canvas3dInit.next(true);\r\n            var props = this.spec.canvas3d;\r\n            var backgroundColor_1 = Color(0xFCFBF9);\r\n            if (!props) {\r\n                (_d = this.canvas3d) === null || _d === void 0 ? void 0 : _d.setProps({ renderer: { backgroundColor: backgroundColor_1 } });\r\n            }\r\n            else {\r\n                if (((_e = props.renderer) === null || _e === void 0 ? void 0 : _e.backgroundColor) === void 0) {\r\n                    props = produce(props, function (p) {\r\n                        if (p.renderer)\r\n                            p.renderer.backgroundColor = backgroundColor_1;\r\n                        else\r\n                            p.renderer = { backgroundColor: backgroundColor_1 };\r\n                    });\r\n                }\r\n                (_f = this.canvas3d) === null || _f === void 0 ? void 0 : _f.setProps(props);\r\n            }\r\n            this.animationLoop.start();\r\n            this.helpers.viewportScreenshot = new ViewportScreenshotHelper(this);\r\n            this.subs.push(this.canvas3d.interaction.click.subscribe(function (e) { return _this.behaviors.interaction.click.next(e); }));\r\n            this.subs.push(this.canvas3d.interaction.drag.subscribe(function (e) { return _this.behaviors.interaction.drag.next(e); }));\r\n            this.subs.push(this.canvas3d.interaction.hover.subscribe(function (e) { return _this.behaviors.interaction.hover.next(e); }));\r\n            this.subs.push(this.canvas3d.input.resize.subscribe(function () { return _this.handleResize(); }));\r\n            this.subs.push(this.layout.events.updated.subscribe(function () { return requestAnimationFrame(function () { return _this.handleResize(); }); }));\r\n            this.handleResize();\r\n            return true;\r\n        }\r\n        catch (e) {\r\n            this.log.error('' + e);\r\n            console.error(e);\r\n            return false;\r\n        }\r\n    };\r\n    PluginContext.prototype.handleResize = function () {\r\n        var _a, _b;\r\n        var canvas = (_a = this.canvas3dContext) === null || _a === void 0 ? void 0 : _a.canvas;\r\n        var container = this.layout.root;\r\n        if (container && canvas) {\r\n            var pixelScale = this.config.get(PluginConfig.General.PixelScale) || 1;\r\n            resizeCanvas(canvas, container, pixelScale);\r\n            (_b = this.canvas3d) === null || _b === void 0 ? void 0 : _b.requestResize();\r\n        }\r\n    };\r\n    Object.defineProperty(PluginContext.prototype, \"isBusy\", {\r\n        /** return true is animating or updating */\r\n        get: function () {\r\n            return this.behaviors.state.isAnimating.value || this.behaviors.state.isUpdating.value;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(PluginContext.prototype, \"selectionMode\", {\r\n        get: function () {\r\n            return this.behaviors.interaction.selectionMode.value;\r\n        },\r\n        set: function (mode) {\r\n            this.behaviors.interaction.selectionMode.next(mode);\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    PluginContext.prototype.dataTransaction = function (f, options) {\r\n        return this.runTask(this.state.data.transaction(f, options));\r\n    };\r\n    PluginContext.prototype.clear = function (resetViewportSettings) {\r\n        var _a;\r\n        if (resetViewportSettings === void 0) { resetViewportSettings = false; }\r\n        if (resetViewportSettings)\r\n            (_a = this.canvas3d) === null || _a === void 0 ? void 0 : _a.setProps(DefaultCanvas3DParams);\r\n        return PluginCommands.State.RemoveObject(this, { state: this.state.data, ref: StateTransform.RootRef });\r\n    };\r\n    PluginContext.prototype.dispose = function (options) {\r\n        var _a, _b;\r\n        if (this.disposed)\r\n            return;\r\n        for (var _i = 0, _c = this.subs; _i < _c.length; _i++) {\r\n            var s = _c[_i];\r\n            s.unsubscribe();\r\n        }\r\n        this.subs = [];\r\n        this.commands.dispose();\r\n        (_a = this.canvas3d) === null || _a === void 0 ? void 0 : _a.dispose();\r\n        (_b = this.canvas3dContext) === null || _b === void 0 ? void 0 : _b.dispose(options);\r\n        this.ev.dispose();\r\n        this.state.dispose();\r\n        this.managers.task.dispose();\r\n        this.helpers.substructureParent.dispose();\r\n        objectForEach(this.managers, function (m) { var _a, _b; return (_b = (_a = m) === null || _a === void 0 ? void 0 : _a.dispose) === null || _b === void 0 ? void 0 : _b.call(_a); });\r\n        objectForEach(this.managers.structure, function (m) { var _a, _b; return (_b = (_a = m) === null || _a === void 0 ? void 0 : _a.dispose) === null || _b === void 0 ? void 0 : _b.call(_a); });\r\n        this.disposed = true;\r\n    };\r\n    PluginContext.prototype.initBehaviorEvents = function () {\r\n        var _this = this;\r\n        this.subs.push(merge(this.state.data.behaviors.isUpdating, this.state.behaviors.behaviors.isUpdating).subscribe(function (u) {\r\n            if (_this.behaviors.state.isUpdating.value !== u)\r\n                _this.behaviors.state.isUpdating.next(u);\r\n        }));\r\n        var timeoutMs = this.config.get(PluginConfig.General.IsBusyTimeoutMs) || 750;\r\n        var isBusy = this.behaviors.state.isBusy;\r\n        var timeout = void 0;\r\n        var setBusy = function () {\r\n            if (!isBusy.value)\r\n                isBusy.next(true);\r\n        };\r\n        var reset = function () {\r\n            if (timeout !== void 0)\r\n                clearTimeout(timeout);\r\n            timeout = void 0;\r\n        };\r\n        this.subs.push(merge(this.behaviors.state.isUpdating, this.behaviors.state.isAnimating).subscribe(function (v) {\r\n            var isUpdating = _this.behaviors.state.isUpdating.value;\r\n            var isAnimating = _this.behaviors.state.isAnimating.value;\r\n            if (isUpdating || isAnimating) {\r\n                if (!isBusy.value) {\r\n                    reset();\r\n                    timeout = setTimeout(setBusy, timeoutMs);\r\n                }\r\n            }\r\n            else {\r\n                reset();\r\n                isBusy.next(false);\r\n            }\r\n        }));\r\n        this.subs.push(this.behaviors.interaction.selectionMode.subscribe(function (v) {\r\n            var _a;\r\n            if (!v) {\r\n                (_a = _this.managers.interactivity) === null || _a === void 0 ? void 0 : _a.lociSelects.deselectAll();\r\n            }\r\n        }));\r\n    };\r\n    PluginContext.prototype.initBuiltInBehavior = function () {\r\n        var _this = this;\r\n        BuiltInPluginBehaviors.State.registerDefault(this);\r\n        BuiltInPluginBehaviors.Representation.registerDefault(this);\r\n        BuiltInPluginBehaviors.Camera.registerDefault(this);\r\n        BuiltInPluginBehaviors.Misc.registerDefault(this);\r\n        this.subs.push(merge(this.state.data.events.log, this.state.behaviors.events.log).subscribe(function (e) { return _this.events.log.next(e); }));\r\n    };\r\n    PluginContext.prototype.initBehaviors = function () {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var tree, _i, _a, cat, _b, _c, b, cat, _d, _e, b, cat;\r\n            return __generator(this, function (_f) {\r\n                switch (_f.label) {\r\n                    case 0:\r\n                        tree = this.state.behaviors.build();\r\n                        for (_i = 0, _a = Object.keys(PluginBehavior.Categories); _i < _a.length; _i++) {\r\n                            cat = _a[_i];\r\n                            tree.toRoot().apply(PluginBehavior.CreateCategory, { label: PluginBehavior.Categories[cat] }, { ref: cat, state: { isLocked: true } });\r\n                        }\r\n                        // Init custom properties 1st\r\n                        for (_b = 0, _c = this.spec.behaviors; _b < _c.length; _b++) {\r\n                            b = _c[_b];\r\n                            cat = PluginBehavior.getCategoryId(b.transformer);\r\n                            if (cat !== 'custom-props')\r\n                                continue;\r\n                            tree.to(PluginBehavior.getCategoryId(b.transformer)).apply(b.transformer, b.defaultParams, { ref: b.transformer.id });\r\n                        }\r\n                        return [4 /*yield*/, this.runTask(this.state.behaviors.updateTree(tree, { doNotUpdateCurrent: true, doNotLogTiming: true }))];\r\n                    case 1:\r\n                        _f.sent();\r\n                        tree = this.state.behaviors.build();\r\n                        for (_d = 0, _e = this.spec.behaviors; _d < _e.length; _d++) {\r\n                            b = _e[_d];\r\n                            cat = PluginBehavior.getCategoryId(b.transformer);\r\n                            if (cat === 'custom-props')\r\n                                continue;\r\n                            tree.to(PluginBehavior.getCategoryId(b.transformer)).apply(b.transformer, b.defaultParams, { ref: b.transformer.id });\r\n                        }\r\n                        return [4 /*yield*/, this.runTask(this.state.behaviors.updateTree(tree, { doNotUpdateCurrent: true, doNotLogTiming: true }))];\r\n                    case 2:\r\n                        _f.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    PluginContext.prototype.initCustomFormats = function () {\r\n        if (!this.spec.customFormats)\r\n            return;\r\n        for (var _i = 0, _a = this.spec.customFormats; _i < _a.length; _i++) {\r\n            var f = _a[_i];\r\n            this.dataFormats.add(f[0], f[1]);\r\n        }\r\n    };\r\n    PluginContext.prototype.initAnimations = function () {\r\n        if (!this.spec.animations)\r\n            return;\r\n        for (var _i = 0, _a = this.spec.animations; _i < _a.length; _i++) {\r\n            var anim = _a[_i];\r\n            this.managers.animation.register(anim);\r\n        }\r\n    };\r\n    PluginContext.prototype.initDataActions = function () {\r\n        if (!this.spec.actions)\r\n            return;\r\n        for (var _i = 0, _a = this.spec.actions; _i < _a.length; _i++) {\r\n            var a = _a[_i];\r\n            this.state.data.actions.add(a.action);\r\n        }\r\n    };\r\n    PluginContext.prototype.init = function () {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var _this = this;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        this.subs.push(this.events.log.subscribe(function (e) { return _this.log.entries = _this.log.entries.push(e); }));\r\n                        this.initCustomFormats();\r\n                        this.initBehaviorEvents();\r\n                        this.initBuiltInBehavior();\r\n                        this.managers.interactivity = new InteractivityManager(this);\r\n                        this.managers.lociLabels = new LociLabelManager(this);\r\n                        this.builders.structure = new StructureBuilder(this);\r\n                        this.initAnimations();\r\n                        this.initDataActions();\r\n                        return [4 /*yield*/, this.initBehaviors()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        this.log.message(\"Mol* Plugin \" + PLUGIN_VERSION + \" [\" + PLUGIN_VERSION_DATE.toLocaleString() + \"]\");\r\n                        if (!isProductionMode)\r\n                            this.log.message(\"Development mode enabled\");\r\n                        if (isDebugMode)\r\n                            this.log.message(\"Debug mode enabled\");\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return PluginContext;\r\n}());\r\nexport { PluginContext };\r\n//# sourceMappingURL=context.js.map"]},"metadata":{},"sourceType":"module"}