{"ast":null,"code":"/**\r\n * Copyright (c) 2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\nimport { arrayFind } from '../../../mol-data/util';\nimport { StateObjectRef } from '../../../mol-state';\nimport { Task } from '../../../mol-task';\nimport { isProductionMode } from '../../../mol-util/debug';\nimport { objectForEach } from '../../../mol-util/object';\nimport { ParamDefinition as PD } from '../../../mol-util/param-definition';\nimport { PresetTrajectoryHierarchy } from './hierarchy-preset';\nimport { arrayRemoveInPlace } from '../../../mol-util/array';\n\nvar TrajectoryHierarchyBuilder =\n/** @class */\nfunction () {\n  function TrajectoryHierarchyBuilder(plugin) {\n    var _this = this;\n\n    this.plugin = plugin;\n    this._providers = [];\n    this.providerMap = new Map();\n    this.defaultProvider = PresetTrajectoryHierarchy.default;\n    objectForEach(PresetTrajectoryHierarchy, function (r) {\n      return _this.registerPreset(r);\n    });\n  }\n\n  TrajectoryHierarchyBuilder.prototype.resolveProvider = function (ref) {\n    var _a;\n\n    return typeof ref === 'string' ? (_a = PresetTrajectoryHierarchy[ref]) !== null && _a !== void 0 ? _a : arrayFind(this._providers, function (p) {\n      return p.id === ref;\n    }) : ref;\n  };\n\n  TrajectoryHierarchyBuilder.prototype.hasPreset = function (t) {\n    for (var _i = 0, _a = this._providers; _i < _a.length; _i++) {\n      var p = _a[_i];\n      if (!p.isApplicable || p.isApplicable(t, this.plugin)) return true;\n    }\n\n    return false;\n  };\n\n  Object.defineProperty(TrajectoryHierarchyBuilder.prototype, \"providers\", {\n    get: function () {\n      return this._providers;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  TrajectoryHierarchyBuilder.prototype.getPresets = function (t) {\n    if (!t) return this.providers;\n    var ret = [];\n\n    for (var _i = 0, _a = this._providers; _i < _a.length; _i++) {\n      var p = _a[_i];\n      if (p.isApplicable && !p.isApplicable(t, this.plugin)) continue;\n      ret.push(p);\n    }\n\n    return ret;\n  };\n\n  TrajectoryHierarchyBuilder.prototype.getPresetSelect = function (t) {\n    var options = [];\n\n    for (var _i = 0, _a = this._providers; _i < _a.length; _i++) {\n      var p = _a[_i];\n      if (t && p.isApplicable && !p.isApplicable(t, this.plugin)) continue;\n      options.push([p.id, p.display.name]);\n    }\n\n    return PD.Select('auto', options);\n  };\n\n  TrajectoryHierarchyBuilder.prototype.getPresetsWithOptions = function (t) {\n    var options = [];\n    var map = Object.create(null);\n\n    for (var _i = 0, _a = this._providers; _i < _a.length; _i++) {\n      var p = _a[_i];\n      if (p.isApplicable && !p.isApplicable(t, this.plugin)) continue;\n      options.push([p.id, p.display.name]);\n      map[p.id] = p.params ? PD.Group(p.params(t, this.plugin)) : PD.EmptyGroup();\n    }\n\n    if (options.length === 0) return PD.MappedStatic('', {\n      '': PD.EmptyGroup()\n    });\n    return PD.MappedStatic(options[0][0], map, {\n      options: options\n    });\n  };\n\n  TrajectoryHierarchyBuilder.prototype.registerPreset = function (provider) {\n    if (this.providerMap.has(provider.id)) {\n      throw new Error(\"Hierarchy provider with id '\" + provider.id + \"' already registered.\");\n    }\n\n    this._providers.push(provider);\n\n    this.providerMap.set(provider.id, provider);\n  };\n\n  TrajectoryHierarchyBuilder.prototype.unregisterPreset = function (provider) {\n    this.providerMap.delete(provider.id);\n    arrayRemoveInPlace(this._providers, provider);\n  };\n\n  TrajectoryHierarchyBuilder.prototype.applyPreset = function (parent, providerRef, params) {\n    var _this = this;\n\n    var provider = this.resolveProvider(providerRef);\n    if (!provider) return;\n    var state = this.plugin.state.data;\n    var cell = StateObjectRef.resolveAndCheck(state, parent);\n\n    if (!cell) {\n      if (!isProductionMode) console.warn(\"Applying hierarchy preset provider to bad cell.\");\n      return;\n    }\n\n    var prms = params || (provider.params ? PD.getDefaultValues(provider.params(cell.obj, this.plugin)) : {});\n    var task = Task.create(\"\" + provider.display.name, function () {\n      return provider.apply(cell, prms, _this.plugin);\n    });\n    return this.plugin.runTask(task);\n  };\n\n  return TrajectoryHierarchyBuilder;\n}();\n\nexport { TrajectoryHierarchyBuilder };","map":{"version":3,"sources":["../../../../src/mol-plugin-state/builder/structure/hierarchy.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { arrayFind } from '../../../mol-data/util';\r\nimport { StateObjectRef } from '../../../mol-state';\r\nimport { Task } from '../../../mol-task';\r\nimport { isProductionMode } from '../../../mol-util/debug';\r\nimport { objectForEach } from '../../../mol-util/object';\r\nimport { ParamDefinition as PD } from '../../../mol-util/param-definition';\r\nimport { PresetTrajectoryHierarchy } from './hierarchy-preset';\r\nimport { arrayRemoveInPlace } from '../../../mol-util/array';\r\nvar TrajectoryHierarchyBuilder = /** @class */ (function () {\r\n    function TrajectoryHierarchyBuilder(plugin) {\r\n        var _this = this;\r\n        this.plugin = plugin;\r\n        this._providers = [];\r\n        this.providerMap = new Map();\r\n        this.defaultProvider = PresetTrajectoryHierarchy.default;\r\n        objectForEach(PresetTrajectoryHierarchy, function (r) { return _this.registerPreset(r); });\r\n    }\r\n    TrajectoryHierarchyBuilder.prototype.resolveProvider = function (ref) {\r\n        var _a;\r\n        return typeof ref === 'string'\r\n            ? (_a = PresetTrajectoryHierarchy[ref]) !== null && _a !== void 0 ? _a : arrayFind(this._providers, function (p) { return p.id === ref; })\r\n            : ref;\r\n    };\r\n    TrajectoryHierarchyBuilder.prototype.hasPreset = function (t) {\r\n        for (var _i = 0, _a = this._providers; _i < _a.length; _i++) {\r\n            var p = _a[_i];\r\n            if (!p.isApplicable || p.isApplicable(t, this.plugin))\r\n                return true;\r\n        }\r\n        return false;\r\n    };\r\n    Object.defineProperty(TrajectoryHierarchyBuilder.prototype, \"providers\", {\r\n        get: function () { return this._providers; },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    TrajectoryHierarchyBuilder.prototype.getPresets = function (t) {\r\n        if (!t)\r\n            return this.providers;\r\n        var ret = [];\r\n        for (var _i = 0, _a = this._providers; _i < _a.length; _i++) {\r\n            var p = _a[_i];\r\n            if (p.isApplicable && !p.isApplicable(t, this.plugin))\r\n                continue;\r\n            ret.push(p);\r\n        }\r\n        return ret;\r\n    };\r\n    TrajectoryHierarchyBuilder.prototype.getPresetSelect = function (t) {\r\n        var options = [];\r\n        for (var _i = 0, _a = this._providers; _i < _a.length; _i++) {\r\n            var p = _a[_i];\r\n            if (t && p.isApplicable && !p.isApplicable(t, this.plugin))\r\n                continue;\r\n            options.push([p.id, p.display.name]);\r\n        }\r\n        return PD.Select('auto', options);\r\n    };\r\n    TrajectoryHierarchyBuilder.prototype.getPresetsWithOptions = function (t) {\r\n        var options = [];\r\n        var map = Object.create(null);\r\n        for (var _i = 0, _a = this._providers; _i < _a.length; _i++) {\r\n            var p = _a[_i];\r\n            if (p.isApplicable && !p.isApplicable(t, this.plugin))\r\n                continue;\r\n            options.push([p.id, p.display.name]);\r\n            map[p.id] = p.params ? PD.Group(p.params(t, this.plugin)) : PD.EmptyGroup();\r\n        }\r\n        if (options.length === 0)\r\n            return PD.MappedStatic('', { '': PD.EmptyGroup() });\r\n        return PD.MappedStatic(options[0][0], map, { options: options });\r\n    };\r\n    TrajectoryHierarchyBuilder.prototype.registerPreset = function (provider) {\r\n        if (this.providerMap.has(provider.id)) {\r\n            throw new Error(\"Hierarchy provider with id '\" + provider.id + \"' already registered.\");\r\n        }\r\n        this._providers.push(provider);\r\n        this.providerMap.set(provider.id, provider);\r\n    };\r\n    TrajectoryHierarchyBuilder.prototype.unregisterPreset = function (provider) {\r\n        this.providerMap.delete(provider.id);\r\n        arrayRemoveInPlace(this._providers, provider);\r\n    };\r\n    TrajectoryHierarchyBuilder.prototype.applyPreset = function (parent, providerRef, params) {\r\n        var _this = this;\r\n        var provider = this.resolveProvider(providerRef);\r\n        if (!provider)\r\n            return;\r\n        var state = this.plugin.state.data;\r\n        var cell = StateObjectRef.resolveAndCheck(state, parent);\r\n        if (!cell) {\r\n            if (!isProductionMode)\r\n                console.warn(\"Applying hierarchy preset provider to bad cell.\");\r\n            return;\r\n        }\r\n        var prms = params || (provider.params\r\n            ? PD.getDefaultValues(provider.params(cell.obj, this.plugin))\r\n            : {});\r\n        var task = Task.create(\"\" + provider.display.name, function () { return provider.apply(cell, prms, _this.plugin); });\r\n        return this.plugin.runTask(task);\r\n    };\r\n    return TrajectoryHierarchyBuilder;\r\n}());\r\nexport { TrajectoryHierarchyBuilder };\r\n//# sourceMappingURL=hierarchy.js.map"]},"metadata":{},"sourceType":"module"}