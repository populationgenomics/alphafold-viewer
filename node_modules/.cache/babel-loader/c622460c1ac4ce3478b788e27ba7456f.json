{"ast":null,"code":"/**\r\n * Copyright (c) 2018 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\nimport { StructureElement } from '../structure';\nimport { now } from '../../../mol-util/now';\nimport { defaultBondTest } from './queries/internal';\n\nvar QueryContext =\n/** @class */\nfunction () {\n  function QueryContext(structure, options) {\n    this.currentElementStack = [];\n    this.currentAtomicBondStack = [];\n    this.currentStructureStack = [];\n    this.inputStructureStack = [];\n    this.timeCreated = now();\n    /** Current element */\n\n    this.element = StructureElement.Location.create(void 0);\n    this.currentStructure = void 0;\n    /** Current bond between atoms */\n\n    this.atomicBond = new QueryContextBondInfo();\n    /** Supply this from the outside. Used by the internal.generator.current symbol */\n\n    this.currentSelection = void 0;\n    this.inputStructure = structure;\n    this.timeoutMs = options && options.timeoutMs || 0;\n    this.currentSelection = options && options.currentSelection;\n  }\n\n  QueryContext.prototype.pushCurrentElement = function () {\n    this.currentElementStack[this.currentElementStack.length] = this.element;\n    this.element = StructureElement.Location.create(void 0);\n    return this.element;\n  };\n\n  QueryContext.prototype.popCurrentElement = function () {\n    this.element = this.currentElementStack.pop();\n  };\n\n  QueryContext.prototype.pushCurrentBond = function () {\n    if (this.atomicBond) this.currentAtomicBondStack.push(this.atomicBond);\n    this.atomicBond = new QueryContextBondInfo();\n    return this.atomicBond;\n  };\n\n  QueryContext.prototype.popCurrentBond = function () {\n    if (this.currentAtomicBondStack.length > 0) {\n      this.atomicBond = this.currentAtomicBondStack.pop();\n    } else {\n      this.atomicBond = void 0;\n    }\n  };\n\n  QueryContext.prototype.pushCurrentStructure = function () {\n    if (this.currentStructure) this.currentStructureStack.push(this.currentStructure);\n  };\n\n  QueryContext.prototype.popCurrentStructure = function () {\n    if (this.currentStructureStack.length) this.currentStructure = this.currentStructureStack.pop();else this.currentStructure = void 0;\n  };\n\n  QueryContext.prototype.pushInputStructure = function (structure) {\n    this.inputStructureStack.push(this.inputStructure);\n    this.inputStructure = structure;\n  };\n\n  QueryContext.prototype.popInputStructure = function () {\n    if (this.inputStructureStack.length === 0) throw new Error('Must push before pop.');\n    this.inputStructure = this.inputStructureStack.pop();\n  };\n\n  QueryContext.prototype.throwIfTimedOut = function () {\n    if (this.timeoutMs === 0) return;\n\n    if (now() - this.timeCreated > this.timeoutMs) {\n      throw new Error(\"The query took too long to execute (> \" + this.timeoutMs / 1000 + \"s).\");\n    }\n  };\n\n  QueryContext.prototype.tryGetCurrentSelection = function () {\n    if (!this.currentSelection) throw new Error('The current selection is not assigned.');\n    return this.currentSelection;\n  };\n\n  return QueryContext;\n}();\n\nexport { QueryContext };\n\nvar QueryContextBondInfo =\n/** @class */\nfunction () {\n  function QueryContextBondInfo() {\n    this.a = StructureElement.Location.create(void 0);\n    this.aIndex = 0;\n    this.b = StructureElement.Location.create(void 0);\n    this.bIndex = 0;\n    this.type = 0\n    /* None */\n    ;\n    this.order = 0;\n    this.testFn = defaultBondTest;\n  }\n\n  QueryContextBondInfo.prototype.setStructure = function (s) {\n    this.a.structure = s;\n    this.b.structure = s;\n  };\n\n  QueryContextBondInfo.prototype.setTestFn = function (fn) {\n    this.testFn = fn || defaultBondTest;\n  };\n\n  QueryContextBondInfo.prototype.test = function (ctx, trySwap) {\n    if (this.testFn(ctx)) return true;\n\n    if (trySwap) {\n      this.swap();\n      return this.testFn(ctx);\n    }\n\n    return false;\n  };\n\n  QueryContextBondInfo.prototype.swap = function () {\n    // const sA = this.a.structure;\n    // this.a.structure = this.b.structure;\n    // this.b.structure = sA;\n    var idxA = this.aIndex;\n    this.aIndex = this.bIndex;\n    this.bIndex = idxA;\n    var unitA = this.a.unit;\n    this.a.unit = this.b.unit;\n    this.b.unit = unitA;\n    var eA = this.a.element;\n    this.a.element = this.b.element;\n    this.b.element = eA;\n  };\n\n  Object.defineProperty(QueryContextBondInfo.prototype, \"length\", {\n    get: function () {\n      return StructureElement.Location.distance(this.a, this.b);\n    },\n    enumerable: false,\n    configurable: true\n  });\n  return QueryContextBondInfo;\n}();","map":{"version":3,"sources":["../../../../src/mol-model/structure/query/context.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2018 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\r\nimport { StructureElement } from '../structure';\r\nimport { now } from '../../../mol-util/now';\r\nimport { defaultBondTest } from './queries/internal';\r\nvar QueryContext = /** @class */ (function () {\r\n    function QueryContext(structure, options) {\r\n        this.currentElementStack = [];\r\n        this.currentAtomicBondStack = [];\r\n        this.currentStructureStack = [];\r\n        this.inputStructureStack = [];\r\n        this.timeCreated = now();\r\n        /** Current element */\r\n        this.element = StructureElement.Location.create(void 0);\r\n        this.currentStructure = void 0;\r\n        /** Current bond between atoms */\r\n        this.atomicBond = new QueryContextBondInfo();\r\n        /** Supply this from the outside. Used by the internal.generator.current symbol */\r\n        this.currentSelection = void 0;\r\n        this.inputStructure = structure;\r\n        this.timeoutMs = (options && options.timeoutMs) || 0;\r\n        this.currentSelection = options && options.currentSelection;\r\n    }\r\n    QueryContext.prototype.pushCurrentElement = function () {\r\n        this.currentElementStack[this.currentElementStack.length] = this.element;\r\n        this.element = StructureElement.Location.create(void 0);\r\n        return this.element;\r\n    };\r\n    QueryContext.prototype.popCurrentElement = function () {\r\n        this.element = this.currentElementStack.pop();\r\n    };\r\n    QueryContext.prototype.pushCurrentBond = function () {\r\n        if (this.atomicBond)\r\n            this.currentAtomicBondStack.push(this.atomicBond);\r\n        this.atomicBond = new QueryContextBondInfo();\r\n        return this.atomicBond;\r\n    };\r\n    QueryContext.prototype.popCurrentBond = function () {\r\n        if (this.currentAtomicBondStack.length > 0) {\r\n            this.atomicBond = this.currentAtomicBondStack.pop();\r\n        }\r\n        else {\r\n            this.atomicBond = void 0;\r\n        }\r\n    };\r\n    QueryContext.prototype.pushCurrentStructure = function () {\r\n        if (this.currentStructure)\r\n            this.currentStructureStack.push(this.currentStructure);\r\n    };\r\n    QueryContext.prototype.popCurrentStructure = function () {\r\n        if (this.currentStructureStack.length)\r\n            this.currentStructure = this.currentStructureStack.pop();\r\n        else\r\n            this.currentStructure = void 0;\r\n    };\r\n    QueryContext.prototype.pushInputStructure = function (structure) {\r\n        this.inputStructureStack.push(this.inputStructure);\r\n        this.inputStructure = structure;\r\n    };\r\n    QueryContext.prototype.popInputStructure = function () {\r\n        if (this.inputStructureStack.length === 0)\r\n            throw new Error('Must push before pop.');\r\n        this.inputStructure = this.inputStructureStack.pop();\r\n    };\r\n    QueryContext.prototype.throwIfTimedOut = function () {\r\n        if (this.timeoutMs === 0)\r\n            return;\r\n        if (now() - this.timeCreated > this.timeoutMs) {\r\n            throw new Error(\"The query took too long to execute (> \" + this.timeoutMs / 1000 + \"s).\");\r\n        }\r\n    };\r\n    QueryContext.prototype.tryGetCurrentSelection = function () {\r\n        if (!this.currentSelection)\r\n            throw new Error('The current selection is not assigned.');\r\n        return this.currentSelection;\r\n    };\r\n    return QueryContext;\r\n}());\r\nexport { QueryContext };\r\nvar QueryContextBondInfo = /** @class */ (function () {\r\n    function QueryContextBondInfo() {\r\n        this.a = StructureElement.Location.create(void 0);\r\n        this.aIndex = 0;\r\n        this.b = StructureElement.Location.create(void 0);\r\n        this.bIndex = 0;\r\n        this.type = 0 /* None */;\r\n        this.order = 0;\r\n        this.testFn = defaultBondTest;\r\n    }\r\n    QueryContextBondInfo.prototype.setStructure = function (s) {\r\n        this.a.structure = s;\r\n        this.b.structure = s;\r\n    };\r\n    QueryContextBondInfo.prototype.setTestFn = function (fn) {\r\n        this.testFn = fn || defaultBondTest;\r\n    };\r\n    QueryContextBondInfo.prototype.test = function (ctx, trySwap) {\r\n        if (this.testFn(ctx))\r\n            return true;\r\n        if (trySwap) {\r\n            this.swap();\r\n            return this.testFn(ctx);\r\n        }\r\n        return false;\r\n    };\r\n    QueryContextBondInfo.prototype.swap = function () {\r\n        // const sA = this.a.structure;\r\n        // this.a.structure = this.b.structure;\r\n        // this.b.structure = sA;\r\n        var idxA = this.aIndex;\r\n        this.aIndex = this.bIndex;\r\n        this.bIndex = idxA;\r\n        var unitA = this.a.unit;\r\n        this.a.unit = this.b.unit;\r\n        this.b.unit = unitA;\r\n        var eA = this.a.element;\r\n        this.a.element = this.b.element;\r\n        this.b.element = eA;\r\n    };\r\n    Object.defineProperty(QueryContextBondInfo.prototype, \"length\", {\r\n        get: function () {\r\n            return StructureElement.Location.distance(this.a, this.b);\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    return QueryContextBondInfo;\r\n}());\r\n//# sourceMappingURL=context.js.map"]},"metadata":{},"sourceType":"module"}