{"ast":null,"code":"/**\r\n * Copyright (c) 2020-2021 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\nimport { __assign } from \"tslib\";\nimport { ParamDefinition as PD } from '../../../mol-util/param-definition';\nimport { Unit, StructureElement } from '../../../mol-model/structure';\nimport { Vec3 } from '../../../mol-math/linear-algebra';\nimport { arrayEqual } from '../../../mol-util';\nimport { createLinkLines } from './util/link';\nimport { UnitsLinesParams, UnitsLinesVisual } from '../units-visual';\nimport { BondType } from '../../../mol-model/structure/model/types';\nimport { BondIterator, BondLineParams, getIntraBondLoci, eachIntraBond, makeIntraBondIgnoreTest, ignoreBondType } from './util/bond';\nimport { Sphere3D } from '../../../mol-math/geometry';\nimport { Lines } from '../../../mol-geo/geometry/lines/lines';\nimport { IntAdjacencyGraph } from '../../../mol-math/graph';\nimport { arrayIntersectionSize } from '../../../mol-util/array'; // avoiding namespace lookup improved performance in Chrome (Aug 2020)\n\nvar isBondType = BondType.is;\n\nfunction createIntraUnitBondLines(ctx, unit, structure, theme, props, lines) {\n  if (!Unit.isAtomic(unit)) return Lines.createEmpty(lines);\n  var child = structure.child;\n  var childUnit = child === null || child === void 0 ? void 0 : child.unitMap.get(unit.id);\n  if (child && !childUnit) return Lines.createEmpty(lines);\n  var location = StructureElement.Location.create(structure, unit);\n  var elements = unit.elements;\n  var bonds = unit.bonds;\n  var edgeCount = bonds.edgeCount,\n      a = bonds.a,\n      b = bonds.b,\n      edgeProps = bonds.edgeProps,\n      offset = bonds.offset;\n  if (!edgeCount) return Lines.createEmpty(lines);\n  var _order = edgeProps.order,\n      _flags = edgeProps.flags;\n  var sizeFactor = props.sizeFactor,\n      aromaticBonds = props.aromaticBonds,\n      includeTypes = props.includeTypes,\n      excludeTypes = props.excludeTypes,\n      multipleBonds = props.multipleBonds;\n  var mbOff = multipleBonds === 'off';\n  var mbSymmetric = multipleBonds === 'symmetric';\n  var include = BondType.fromNames(includeTypes);\n  var exclude = BondType.fromNames(excludeTypes);\n  var ignoreComputedAromatic = ignoreBondType(include, exclude, 32\n  /* Computed */\n  );\n  var vRef = Vec3();\n  var pos = unit.conformation.invariantPosition;\n  var _a = unit.rings,\n      elementRingIndices = _a.elementRingIndices,\n      elementAromaticRingIndices = _a.elementAromaticRingIndices;\n  var builderProps = {\n    linkCount: edgeCount * 2,\n    referencePosition: function (edgeIndex) {\n      var _a, _b;\n\n      var aI = a[edgeIndex],\n          bI = b[edgeIndex];\n      if (aI > bI) _a = [bI, aI], aI = _a[0], bI = _a[1];\n      if (offset[aI + 1] - offset[aI] === 1) _b = [bI, aI], aI = _b[0], bI = _b[1];\n      var aR = elementRingIndices.get(aI);\n      var maxSize = 0;\n\n      for (var i = offset[aI], il = offset[aI + 1]; i < il; ++i) {\n        var _bI = b[i];\n\n        if (_bI !== bI && _bI !== aI) {\n          if (aR) {\n            var _bR = elementRingIndices.get(_bI);\n\n            if (!_bR) continue;\n            var size = arrayIntersectionSize(aR, _bR);\n\n            if (size > maxSize) {\n              maxSize = size;\n              pos(elements[_bI], vRef);\n            }\n          } else {\n            return pos(elements[_bI], vRef);\n          }\n        }\n      }\n\n      return maxSize > 0 ? vRef : null;\n    },\n    position: function (posA, posB, edgeIndex) {\n      pos(elements[a[edgeIndex]], posA);\n      pos(elements[b[edgeIndex]], posB);\n    },\n    style: function (edgeIndex) {\n      var o = _order[edgeIndex];\n      var f = _flags[edgeIndex];\n\n      if (isBondType(f, 2\n      /* MetallicCoordination */\n      ) || isBondType(f, 4\n      /* HydrogenBond */\n      )) {\n        // show metallic coordinations and hydrogen bonds with dashed cylinders\n        return 1\n        /* Dashed */\n        ;\n      } else if (o === 3) {\n        return mbOff ? 0\n        /* Solid */\n        : mbSymmetric ? 4\n        /* Triple */\n        : 5\n        /* OffsetTriple */\n        ;\n      } else if (aromaticBonds) {\n        var aI = a[edgeIndex],\n            bI = b[edgeIndex];\n        var aR = elementAromaticRingIndices.get(aI);\n        var bR = elementAromaticRingIndices.get(bI);\n        var arCount = aR && bR ? arrayIntersectionSize(aR, bR) : 0;\n\n        if (isBondType(f, 16\n        /* Aromatic */\n        ) || arCount && !ignoreComputedAromatic) {\n          if (arCount === 2) {\n            return 8\n            /* MirroredAromatic */\n            ;\n          } else {\n            return 7\n            /* Aromatic */\n            ;\n          }\n        }\n      }\n\n      return o !== 2 || mbOff ? 0\n      /* Solid */\n      : mbSymmetric ? 2\n      /* Double */\n      : 3\n      /* OffsetDouble */\n      ;\n    },\n    radius: function (edgeIndex) {\n      location.element = elements[a[edgeIndex]];\n      var sizeA = theme.size.size(location);\n      location.element = elements[b[edgeIndex]];\n      var sizeB = theme.size.size(location);\n      return Math.min(sizeA, sizeB) * sizeFactor;\n    },\n    ignore: makeIntraBondIgnoreTest(structure, unit, props)\n  };\n  var l = createLinkLines(ctx, builderProps, props, lines);\n  var sphere = Sphere3D.expand(Sphere3D(), (childUnit !== null && childUnit !== void 0 ? childUnit : unit).boundary.sphere, 1 * sizeFactor);\n  l.setBoundingSphere(sphere);\n  return l;\n}\n\nexport var IntraUnitBondLineParams = __assign(__assign(__assign({}, UnitsLinesParams), BondLineParams), {\n  includeParent: PD.Boolean(false)\n});\nexport function IntraUnitBondLineVisual(materialId) {\n  return UnitsLinesVisual({\n    defaultProps: PD.getDefaultValues(IntraUnitBondLineParams),\n    createGeometry: createIntraUnitBondLines,\n    createLocationIterator: BondIterator.fromGroup,\n    getLoci: getIntraBondLoci,\n    eachLocation: eachIntraBond,\n    setUpdateState: function (state, newProps, currentProps, newTheme, currentTheme, newStructureGroup, currentStructureGroup) {\n      state.createGeometry = newProps.sizeFactor !== currentProps.sizeFactor || newProps.linkScale !== currentProps.linkScale || newProps.linkSpacing !== currentProps.linkSpacing || newProps.dashCount !== currentProps.dashCount || newProps.ignoreHydrogens !== currentProps.ignoreHydrogens || !arrayEqual(newProps.includeTypes, currentProps.includeTypes) || !arrayEqual(newProps.excludeTypes, currentProps.excludeTypes) || newProps.aromaticBonds !== currentProps.aromaticBonds || newProps.multipleBonds !== currentProps.multipleBonds;\n      var newUnit = newStructureGroup.group.units[0];\n      var currentUnit = currentStructureGroup.group.units[0];\n\n      if (Unit.isAtomic(newUnit) && Unit.isAtomic(currentUnit)) {\n        if (!IntAdjacencyGraph.areEqual(newUnit.bonds, currentUnit.bonds)) {\n          state.createGeometry = true;\n          state.updateTransform = true;\n          state.updateColor = true;\n          state.updateSize = true;\n        }\n      }\n    }\n  }, materialId);\n}","map":{"version":3,"sources":["../../../../src/mol-repr/structure/visual/bond-intra-unit-line.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2020-2021 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { __assign } from \"tslib\";\r\nimport { ParamDefinition as PD } from '../../../mol-util/param-definition';\r\nimport { Unit, StructureElement } from '../../../mol-model/structure';\r\nimport { Vec3 } from '../../../mol-math/linear-algebra';\r\nimport { arrayEqual } from '../../../mol-util';\r\nimport { createLinkLines } from './util/link';\r\nimport { UnitsLinesParams, UnitsLinesVisual } from '../units-visual';\r\nimport { BondType } from '../../../mol-model/structure/model/types';\r\nimport { BondIterator, BondLineParams, getIntraBondLoci, eachIntraBond, makeIntraBondIgnoreTest, ignoreBondType } from './util/bond';\r\nimport { Sphere3D } from '../../../mol-math/geometry';\r\nimport { Lines } from '../../../mol-geo/geometry/lines/lines';\r\nimport { IntAdjacencyGraph } from '../../../mol-math/graph';\r\nimport { arrayIntersectionSize } from '../../../mol-util/array';\r\n// avoiding namespace lookup improved performance in Chrome (Aug 2020)\r\nvar isBondType = BondType.is;\r\nfunction createIntraUnitBondLines(ctx, unit, structure, theme, props, lines) {\r\n    if (!Unit.isAtomic(unit))\r\n        return Lines.createEmpty(lines);\r\n    var child = structure.child;\r\n    var childUnit = child === null || child === void 0 ? void 0 : child.unitMap.get(unit.id);\r\n    if (child && !childUnit)\r\n        return Lines.createEmpty(lines);\r\n    var location = StructureElement.Location.create(structure, unit);\r\n    var elements = unit.elements;\r\n    var bonds = unit.bonds;\r\n    var edgeCount = bonds.edgeCount, a = bonds.a, b = bonds.b, edgeProps = bonds.edgeProps, offset = bonds.offset;\r\n    if (!edgeCount)\r\n        return Lines.createEmpty(lines);\r\n    var _order = edgeProps.order, _flags = edgeProps.flags;\r\n    var sizeFactor = props.sizeFactor, aromaticBonds = props.aromaticBonds, includeTypes = props.includeTypes, excludeTypes = props.excludeTypes, multipleBonds = props.multipleBonds;\r\n    var mbOff = multipleBonds === 'off';\r\n    var mbSymmetric = multipleBonds === 'symmetric';\r\n    var include = BondType.fromNames(includeTypes);\r\n    var exclude = BondType.fromNames(excludeTypes);\r\n    var ignoreComputedAromatic = ignoreBondType(include, exclude, 32 /* Computed */);\r\n    var vRef = Vec3();\r\n    var pos = unit.conformation.invariantPosition;\r\n    var _a = unit.rings, elementRingIndices = _a.elementRingIndices, elementAromaticRingIndices = _a.elementAromaticRingIndices;\r\n    var builderProps = {\r\n        linkCount: edgeCount * 2,\r\n        referencePosition: function (edgeIndex) {\r\n            var _a, _b;\r\n            var aI = a[edgeIndex], bI = b[edgeIndex];\r\n            if (aI > bI)\r\n                _a = [bI, aI], aI = _a[0], bI = _a[1];\r\n            if (offset[aI + 1] - offset[aI] === 1)\r\n                _b = [bI, aI], aI = _b[0], bI = _b[1];\r\n            var aR = elementRingIndices.get(aI);\r\n            var maxSize = 0;\r\n            for (var i = offset[aI], il = offset[aI + 1]; i < il; ++i) {\r\n                var _bI = b[i];\r\n                if (_bI !== bI && _bI !== aI) {\r\n                    if (aR) {\r\n                        var _bR = elementRingIndices.get(_bI);\r\n                        if (!_bR)\r\n                            continue;\r\n                        var size = arrayIntersectionSize(aR, _bR);\r\n                        if (size > maxSize) {\r\n                            maxSize = size;\r\n                            pos(elements[_bI], vRef);\r\n                        }\r\n                    }\r\n                    else {\r\n                        return pos(elements[_bI], vRef);\r\n                    }\r\n                }\r\n            }\r\n            return maxSize > 0 ? vRef : null;\r\n        },\r\n        position: function (posA, posB, edgeIndex) {\r\n            pos(elements[a[edgeIndex]], posA);\r\n            pos(elements[b[edgeIndex]], posB);\r\n        },\r\n        style: function (edgeIndex) {\r\n            var o = _order[edgeIndex];\r\n            var f = _flags[edgeIndex];\r\n            if (isBondType(f, 2 /* MetallicCoordination */) || isBondType(f, 4 /* HydrogenBond */)) {\r\n                // show metallic coordinations and hydrogen bonds with dashed cylinders\r\n                return 1 /* Dashed */;\r\n            }\r\n            else if (o === 3) {\r\n                return mbOff ? 0 /* Solid */ :\r\n                    mbSymmetric ? 4 /* Triple */ :\r\n                        5 /* OffsetTriple */;\r\n            }\r\n            else if (aromaticBonds) {\r\n                var aI = a[edgeIndex], bI = b[edgeIndex];\r\n                var aR = elementAromaticRingIndices.get(aI);\r\n                var bR = elementAromaticRingIndices.get(bI);\r\n                var arCount = (aR && bR) ? arrayIntersectionSize(aR, bR) : 0;\r\n                if (isBondType(f, 16 /* Aromatic */) || (arCount && !ignoreComputedAromatic)) {\r\n                    if (arCount === 2) {\r\n                        return 8 /* MirroredAromatic */;\r\n                    }\r\n                    else {\r\n                        return 7 /* Aromatic */;\r\n                    }\r\n                }\r\n            }\r\n            return (o !== 2 || mbOff) ? 0 /* Solid */ :\r\n                mbSymmetric ? 2 /* Double */ :\r\n                    3 /* OffsetDouble */;\r\n        },\r\n        radius: function (edgeIndex) {\r\n            location.element = elements[a[edgeIndex]];\r\n            var sizeA = theme.size.size(location);\r\n            location.element = elements[b[edgeIndex]];\r\n            var sizeB = theme.size.size(location);\r\n            return Math.min(sizeA, sizeB) * sizeFactor;\r\n        },\r\n        ignore: makeIntraBondIgnoreTest(structure, unit, props)\r\n    };\r\n    var l = createLinkLines(ctx, builderProps, props, lines);\r\n    var sphere = Sphere3D.expand(Sphere3D(), (childUnit !== null && childUnit !== void 0 ? childUnit : unit).boundary.sphere, 1 * sizeFactor);\r\n    l.setBoundingSphere(sphere);\r\n    return l;\r\n}\r\nexport var IntraUnitBondLineParams = __assign(__assign(__assign({}, UnitsLinesParams), BondLineParams), { includeParent: PD.Boolean(false) });\r\nexport function IntraUnitBondLineVisual(materialId) {\r\n    return UnitsLinesVisual({\r\n        defaultProps: PD.getDefaultValues(IntraUnitBondLineParams),\r\n        createGeometry: createIntraUnitBondLines,\r\n        createLocationIterator: BondIterator.fromGroup,\r\n        getLoci: getIntraBondLoci,\r\n        eachLocation: eachIntraBond,\r\n        setUpdateState: function (state, newProps, currentProps, newTheme, currentTheme, newStructureGroup, currentStructureGroup) {\r\n            state.createGeometry = (newProps.sizeFactor !== currentProps.sizeFactor ||\r\n                newProps.linkScale !== currentProps.linkScale ||\r\n                newProps.linkSpacing !== currentProps.linkSpacing ||\r\n                newProps.dashCount !== currentProps.dashCount ||\r\n                newProps.ignoreHydrogens !== currentProps.ignoreHydrogens ||\r\n                !arrayEqual(newProps.includeTypes, currentProps.includeTypes) ||\r\n                !arrayEqual(newProps.excludeTypes, currentProps.excludeTypes) ||\r\n                newProps.aromaticBonds !== currentProps.aromaticBonds ||\r\n                newProps.multipleBonds !== currentProps.multipleBonds);\r\n            var newUnit = newStructureGroup.group.units[0];\r\n            var currentUnit = currentStructureGroup.group.units[0];\r\n            if (Unit.isAtomic(newUnit) && Unit.isAtomic(currentUnit)) {\r\n                if (!IntAdjacencyGraph.areEqual(newUnit.bonds, currentUnit.bonds)) {\r\n                    state.createGeometry = true;\r\n                    state.updateTransform = true;\r\n                    state.updateColor = true;\r\n                    state.updateSize = true;\r\n                }\r\n            }\r\n        }\r\n    }, materialId);\r\n}\r\n//# sourceMappingURL=bond-intra-unit-line.js.map"]},"metadata":{},"sourceType":"module"}