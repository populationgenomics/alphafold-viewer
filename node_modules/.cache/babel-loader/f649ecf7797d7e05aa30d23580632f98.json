{"ast":null,"code":"/**\r\n * Copyright (c) 2018-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\nimport { __awaiter, __generator } from \"tslib\";\nimport { ModelCrossLinkRestraint } from './format';\nimport { Bond } from '../../../mol-model/structure';\nimport { PairRestraints } from '../pair-restraints';\nimport { CustomStructureProperty } from '../../common/custom-structure-property';\nimport { DataLocation } from '../../../mol-model/location';\nimport { DataLoci } from '../../../mol-model/loci';\nimport { CentroidHelper } from '../../../mol-math/geometry/centroid-helper';\nimport { bondLabel } from '../../../mol-theme/label';\nimport { Vec3 } from '../../../mol-math/linear-algebra';\nimport { CustomPropertyDescriptor } from '../../../mol-model/custom-property';\nexport var CrossLinkRestraintProvider = CustomStructureProperty.createProvider({\n  label: 'Cross Link Restraint',\n  descriptor: CustomPropertyDescriptor({\n    name: 'integrative-cross-link-restraint' // TODO `cifExport` and `symbol`\n\n  }),\n  type: 'local',\n  defaultParams: {},\n  getParams: function (data) {\n    return {};\n  },\n  isApplicable: function (data) {\n    return data.models.some(function (m) {\n      return !!ModelCrossLinkRestraint.Provider.get(m);\n    });\n  },\n  obtain: function (ctx, data, props) {\n    return __awaiter(void 0, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2\n        /*return*/\n        , {\n          value: extractCrossLinkRestraints(data)\n        }];\n      });\n    });\n  }\n});\nexport { CrossLinkRestraint };\nvar CrossLinkRestraint;\n\n(function (CrossLinkRestraint) {\n  var Tag;\n\n  (function (Tag) {\n    Tag[\"CrossLinkRestraint\"] = \"cross-link-restraint\";\n  })(Tag = CrossLinkRestraint.Tag || (CrossLinkRestraint.Tag = {}));\n\n  function isApplicable(structure) {\n    return structure.models.some(function (m) {\n      return !!ModelCrossLinkRestraint.Provider.get(m);\n    });\n  }\n\n  CrossLinkRestraint.isApplicable = isApplicable;\n  var distVecA = Vec3(),\n      distVecB = Vec3();\n\n  function distance(pair) {\n    pair.unitA.conformation.position(pair.unitA.elements[pair.indexA], distVecA);\n    pair.unitB.conformation.position(pair.unitB.elements[pair.indexB], distVecB);\n    return Vec3.distance(distVecA, distVecB);\n  }\n\n  CrossLinkRestraint.distance = distance;\n\n  function Location(crossLinkRestraints, structure, index) {\n    return DataLocation('cross-link-restraints', {\n      structure: structure,\n      crossLinkRestraints: crossLinkRestraints\n    }, index);\n  }\n\n  CrossLinkRestraint.Location = Location;\n\n  function isLocation(x) {\n    return !!x && x.kind === 'data-location' && x.tag === 'cross-link-restraints';\n  }\n\n  CrossLinkRestraint.isLocation = isLocation;\n\n  function areLocationsEqual(locA, locB) {\n    return locA.data.structure === locB.data.structure && locA.data.crossLinkRestraints === locB.data.crossLinkRestraints && locA.element === locB.element;\n  }\n\n  CrossLinkRestraint.areLocationsEqual = areLocationsEqual;\n\n  function _label(crossLinkRestraints, element) {\n    var p = crossLinkRestraints.pairs[element];\n    return \"Cross Link Restraint | Type: \" + p.restraintType + \" | Threshold: \" + p.distanceThreshold + \" \\u212B | Psi: \" + p.psi + \" | Sigma 1: \" + p.sigma1 + \" | Sigma 2: \" + p.sigma2 + \" | Distance: \" + distance(p).toFixed(2) + \" \\u212B\";\n  }\n\n  function locationLabel(location) {\n    return _label(location.data.crossLinkRestraints, location.element);\n  }\n\n  CrossLinkRestraint.locationLabel = locationLabel;\n\n  function Loci(structure, crossLinkRestraints, elements) {\n    return DataLoci('cross-link-restraints', {\n      structure: structure,\n      crossLinkRestraints: crossLinkRestraints\n    }, elements, function (boundingSphere) {\n      return getBoundingSphere(crossLinkRestraints, elements, boundingSphere);\n    }, function () {\n      return getLabel(structure, crossLinkRestraints, elements);\n    });\n  }\n\n  CrossLinkRestraint.Loci = Loci;\n\n  function isLoci(x) {\n    return !!x && x.kind === 'data-loci' && x.tag === 'interactions';\n  }\n\n  CrossLinkRestraint.isLoci = isLoci;\n\n  function getBoundingSphere(crossLinkRestraints, elements, boundingSphere) {\n    return CentroidHelper.fromPairProvider(elements.length, function (i, pA, pB) {\n      var p = crossLinkRestraints.pairs[elements[i]];\n      p.unitA.conformation.position(p.unitA.elements[p.indexA], pA);\n      p.unitB.conformation.position(p.unitB.elements[p.indexB], pB);\n    }, boundingSphere);\n  }\n\n  CrossLinkRestraint.getBoundingSphere = getBoundingSphere;\n\n  function getLabel(structure, crossLinkRestraints, elements) {\n    var element = elements[0];\n    if (element === undefined) return '';\n    var p = crossLinkRestraints.pairs[element];\n    return [_label(crossLinkRestraints, element), bondLabel(Bond.Location(structure, p.unitA, p.indexA, structure, p.unitB, p.indexB))].join('</br>');\n  }\n\n  CrossLinkRestraint.getLabel = getLabel;\n})(CrossLinkRestraint || (CrossLinkRestraint = {})); //\n\n\nfunction _addRestraints(map, unit, restraints) {\n  var elements = unit.elements;\n  var elementCount = elements.length;\n  var kind = unit.kind;\n\n  var _loop_1 = function (i) {\n    var e = elements[i];\n    restraints.getIndicesByElement(e, kind).forEach(function (ri) {\n      return map.set(ri, i);\n    });\n  };\n\n  for (var i = 0; i < elementCount; i++) {\n    _loop_1(i);\n  }\n}\n\nfunction extractInter(pairs, unitA, unitB) {\n  if (unitA.model !== unitB.model) return;\n  if (unitA.model.sourceData.kind !== 'mmCIF') return;\n  var restraints = ModelCrossLinkRestraint.Provider.get(unitA.model);\n  if (!restraints) return;\n  var rA = new Map();\n  var rB = new Map();\n\n  _addRestraints(rA, unitA, restraints);\n\n  _addRestraints(rB, unitB, restraints);\n\n  rA.forEach(function (indexA, ri) {\n    var indexB = rB.get(ri);\n\n    if (indexB !== undefined) {\n      pairs.push(createCrossLinkRestraint(unitA, indexA, unitB, indexB, restraints, ri), createCrossLinkRestraint(unitB, indexB, unitA, indexA, restraints, ri));\n    }\n  });\n}\n\nfunction extractIntra(pairs, unit) {\n  if (unit.model.sourceData.kind !== 'mmCIF') return;\n  var restraints = ModelCrossLinkRestraint.Provider.get(unit.model);\n  if (!restraints) return;\n  var elements = unit.elements;\n  var elementCount = elements.length;\n  var kind = unit.kind;\n  var r = new Map();\n\n  var _loop_2 = function (i) {\n    var e = elements[i];\n    restraints.getIndicesByElement(e, kind).forEach(function (ri) {\n      var il = r.get(ri);\n      if (il) il.push(i);else r.set(ri, [i]);\n    });\n  };\n\n  for (var i = 0; i < elementCount; i++) {\n    _loop_2(i);\n  }\n\n  r.forEach(function (il, ri) {\n    if (il.length < 2) return;\n    var indexA = il[0],\n        indexB = il[1];\n    pairs.push(createCrossLinkRestraint(unit, indexA, unit, indexB, restraints, ri), createCrossLinkRestraint(unit, indexB, unit, indexA, restraints, ri));\n  });\n}\n\nfunction createCrossLinkRestraint(unitA, indexA, unitB, indexB, restraints, row) {\n  return {\n    unitA: unitA,\n    indexA: indexA,\n    unitB: unitB,\n    indexB: indexB,\n    restraintType: restraints.data.restraint_type.value(row),\n    distanceThreshold: restraints.data.distance_threshold.value(row),\n    psi: restraints.data.psi.value(row),\n    sigma1: restraints.data.sigma_1.value(row),\n    sigma2: restraints.data.sigma_2.value(row)\n  };\n}\n\nfunction extractCrossLinkRestraints(structure) {\n  var pairs = [];\n\n  if (!structure.models.some(function (m) {\n    return ModelCrossLinkRestraint.Provider.get(m);\n  })) {\n    return new PairRestraints(pairs);\n  }\n\n  var n = structure.units.length;\n\n  for (var i = 0; i < n; ++i) {\n    var unitA = structure.units[i];\n    extractIntra(pairs, unitA);\n\n    for (var j = i + 1; j < n; ++j) {\n      var unitB = structure.units[j];\n\n      if (unitA.model === unitB.model) {\n        extractInter(pairs, unitA, unitB);\n      }\n    }\n  }\n\n  return new PairRestraints(pairs);\n}","map":{"version":3,"sources":["../../../../src/mol-model-props/integrative/cross-link-restraint/property.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2018-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { __awaiter, __generator } from \"tslib\";\r\nimport { ModelCrossLinkRestraint } from './format';\r\nimport { Bond } from '../../../mol-model/structure';\r\nimport { PairRestraints } from '../pair-restraints';\r\nimport { CustomStructureProperty } from '../../common/custom-structure-property';\r\nimport { DataLocation } from '../../../mol-model/location';\r\nimport { DataLoci } from '../../../mol-model/loci';\r\nimport { CentroidHelper } from '../../../mol-math/geometry/centroid-helper';\r\nimport { bondLabel } from '../../../mol-theme/label';\r\nimport { Vec3 } from '../../../mol-math/linear-algebra';\r\nimport { CustomPropertyDescriptor } from '../../../mol-model/custom-property';\r\nexport var CrossLinkRestraintProvider = CustomStructureProperty.createProvider({\r\n    label: 'Cross Link Restraint',\r\n    descriptor: CustomPropertyDescriptor({\r\n        name: 'integrative-cross-link-restraint',\r\n        // TODO `cifExport` and `symbol`\r\n    }),\r\n    type: 'local',\r\n    defaultParams: {},\r\n    getParams: function (data) { return ({}); },\r\n    isApplicable: function (data) { return data.models.some(function (m) { return !!ModelCrossLinkRestraint.Provider.get(m); }); },\r\n    obtain: function (ctx, data, props) { return __awaiter(void 0, void 0, void 0, function () {\r\n        return __generator(this, function (_a) {\r\n            return [2 /*return*/, { value: extractCrossLinkRestraints(data) }];\r\n        });\r\n    }); }\r\n});\r\nexport { CrossLinkRestraint };\r\nvar CrossLinkRestraint;\r\n(function (CrossLinkRestraint) {\r\n    var Tag;\r\n    (function (Tag) {\r\n        Tag[\"CrossLinkRestraint\"] = \"cross-link-restraint\";\r\n    })(Tag = CrossLinkRestraint.Tag || (CrossLinkRestraint.Tag = {}));\r\n    function isApplicable(structure) {\r\n        return structure.models.some(function (m) { return !!ModelCrossLinkRestraint.Provider.get(m); });\r\n    }\r\n    CrossLinkRestraint.isApplicable = isApplicable;\r\n    var distVecA = Vec3(), distVecB = Vec3();\r\n    function distance(pair) {\r\n        pair.unitA.conformation.position(pair.unitA.elements[pair.indexA], distVecA);\r\n        pair.unitB.conformation.position(pair.unitB.elements[pair.indexB], distVecB);\r\n        return Vec3.distance(distVecA, distVecB);\r\n    }\r\n    CrossLinkRestraint.distance = distance;\r\n    function Location(crossLinkRestraints, structure, index) {\r\n        return DataLocation('cross-link-restraints', { structure: structure, crossLinkRestraints: crossLinkRestraints }, index);\r\n    }\r\n    CrossLinkRestraint.Location = Location;\r\n    function isLocation(x) {\r\n        return !!x && x.kind === 'data-location' && x.tag === 'cross-link-restraints';\r\n    }\r\n    CrossLinkRestraint.isLocation = isLocation;\r\n    function areLocationsEqual(locA, locB) {\r\n        return (locA.data.structure === locB.data.structure &&\r\n            locA.data.crossLinkRestraints === locB.data.crossLinkRestraints &&\r\n            locA.element === locB.element);\r\n    }\r\n    CrossLinkRestraint.areLocationsEqual = areLocationsEqual;\r\n    function _label(crossLinkRestraints, element) {\r\n        var p = crossLinkRestraints.pairs[element];\r\n        return \"Cross Link Restraint | Type: \" + p.restraintType + \" | Threshold: \" + p.distanceThreshold + \" \\u212B | Psi: \" + p.psi + \" | Sigma 1: \" + p.sigma1 + \" | Sigma 2: \" + p.sigma2 + \" | Distance: \" + distance(p).toFixed(2) + \" \\u212B\";\r\n    }\r\n    function locationLabel(location) {\r\n        return _label(location.data.crossLinkRestraints, location.element);\r\n    }\r\n    CrossLinkRestraint.locationLabel = locationLabel;\r\n    function Loci(structure, crossLinkRestraints, elements) {\r\n        return DataLoci('cross-link-restraints', { structure: structure, crossLinkRestraints: crossLinkRestraints }, elements, function (boundingSphere) { return getBoundingSphere(crossLinkRestraints, elements, boundingSphere); }, function () { return getLabel(structure, crossLinkRestraints, elements); });\r\n    }\r\n    CrossLinkRestraint.Loci = Loci;\r\n    function isLoci(x) {\r\n        return !!x && x.kind === 'data-loci' && x.tag === 'interactions';\r\n    }\r\n    CrossLinkRestraint.isLoci = isLoci;\r\n    function getBoundingSphere(crossLinkRestraints, elements, boundingSphere) {\r\n        return CentroidHelper.fromPairProvider(elements.length, function (i, pA, pB) {\r\n            var p = crossLinkRestraints.pairs[elements[i]];\r\n            p.unitA.conformation.position(p.unitA.elements[p.indexA], pA);\r\n            p.unitB.conformation.position(p.unitB.elements[p.indexB], pB);\r\n        }, boundingSphere);\r\n    }\r\n    CrossLinkRestraint.getBoundingSphere = getBoundingSphere;\r\n    function getLabel(structure, crossLinkRestraints, elements) {\r\n        var element = elements[0];\r\n        if (element === undefined)\r\n            return '';\r\n        var p = crossLinkRestraints.pairs[element];\r\n        return [\r\n            _label(crossLinkRestraints, element),\r\n            bondLabel(Bond.Location(structure, p.unitA, p.indexA, structure, p.unitB, p.indexB))\r\n        ].join('</br>');\r\n    }\r\n    CrossLinkRestraint.getLabel = getLabel;\r\n})(CrossLinkRestraint || (CrossLinkRestraint = {}));\r\n//\r\nfunction _addRestraints(map, unit, restraints) {\r\n    var elements = unit.elements;\r\n    var elementCount = elements.length;\r\n    var kind = unit.kind;\r\n    var _loop_1 = function (i) {\r\n        var e = elements[i];\r\n        restraints.getIndicesByElement(e, kind).forEach(function (ri) { return map.set(ri, i); });\r\n    };\r\n    for (var i = 0; i < elementCount; i++) {\r\n        _loop_1(i);\r\n    }\r\n}\r\nfunction extractInter(pairs, unitA, unitB) {\r\n    if (unitA.model !== unitB.model)\r\n        return;\r\n    if (unitA.model.sourceData.kind !== 'mmCIF')\r\n        return;\r\n    var restraints = ModelCrossLinkRestraint.Provider.get(unitA.model);\r\n    if (!restraints)\r\n        return;\r\n    var rA = new Map();\r\n    var rB = new Map();\r\n    _addRestraints(rA, unitA, restraints);\r\n    _addRestraints(rB, unitB, restraints);\r\n    rA.forEach(function (indexA, ri) {\r\n        var indexB = rB.get(ri);\r\n        if (indexB !== undefined) {\r\n            pairs.push(createCrossLinkRestraint(unitA, indexA, unitB, indexB, restraints, ri), createCrossLinkRestraint(unitB, indexB, unitA, indexA, restraints, ri));\r\n        }\r\n    });\r\n}\r\nfunction extractIntra(pairs, unit) {\r\n    if (unit.model.sourceData.kind !== 'mmCIF')\r\n        return;\r\n    var restraints = ModelCrossLinkRestraint.Provider.get(unit.model);\r\n    if (!restraints)\r\n        return;\r\n    var elements = unit.elements;\r\n    var elementCount = elements.length;\r\n    var kind = unit.kind;\r\n    var r = new Map();\r\n    var _loop_2 = function (i) {\r\n        var e = elements[i];\r\n        restraints.getIndicesByElement(e, kind).forEach(function (ri) {\r\n            var il = r.get(ri);\r\n            if (il)\r\n                il.push(i);\r\n            else\r\n                r.set(ri, [i]);\r\n        });\r\n    };\r\n    for (var i = 0; i < elementCount; i++) {\r\n        _loop_2(i);\r\n    }\r\n    r.forEach(function (il, ri) {\r\n        if (il.length < 2)\r\n            return;\r\n        var indexA = il[0], indexB = il[1];\r\n        pairs.push(createCrossLinkRestraint(unit, indexA, unit, indexB, restraints, ri), createCrossLinkRestraint(unit, indexB, unit, indexA, restraints, ri));\r\n    });\r\n}\r\nfunction createCrossLinkRestraint(unitA, indexA, unitB, indexB, restraints, row) {\r\n    return {\r\n        unitA: unitA,\r\n        indexA: indexA,\r\n        unitB: unitB,\r\n        indexB: indexB,\r\n        restraintType: restraints.data.restraint_type.value(row),\r\n        distanceThreshold: restraints.data.distance_threshold.value(row),\r\n        psi: restraints.data.psi.value(row),\r\n        sigma1: restraints.data.sigma_1.value(row),\r\n        sigma2: restraints.data.sigma_2.value(row),\r\n    };\r\n}\r\nfunction extractCrossLinkRestraints(structure) {\r\n    var pairs = [];\r\n    if (!structure.models.some(function (m) { return ModelCrossLinkRestraint.Provider.get(m); })) {\r\n        return new PairRestraints(pairs);\r\n    }\r\n    var n = structure.units.length;\r\n    for (var i = 0; i < n; ++i) {\r\n        var unitA = structure.units[i];\r\n        extractIntra(pairs, unitA);\r\n        for (var j = i + 1; j < n; ++j) {\r\n            var unitB = structure.units[j];\r\n            if (unitA.model === unitB.model) {\r\n                extractInter(pairs, unitA, unitB);\r\n            }\r\n        }\r\n    }\r\n    return new PairRestraints(pairs);\r\n}\r\n//# sourceMappingURL=property.js.map"]},"metadata":{},"sourceType":"module"}