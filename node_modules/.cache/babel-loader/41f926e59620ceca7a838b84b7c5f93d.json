{"ast":null,"code":"/**\r\n * Copyright (c) 2019-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\nimport { __assign } from \"tslib\";\nimport { Loci } from '../../../mol-model/loci';\nimport { Lines } from '../../../mol-geo/geometry/lines/lines';\nimport { Text } from '../../../mol-geo/geometry/text/text';\nimport { ParamDefinition as PD } from '../../../mol-util/param-definition';\nimport { ColorNames } from '../../../mol-util/color/names';\nimport { ShapeRepresentation } from '../representation';\nimport { Representation } from '../../representation';\nimport { Shape } from '../../../mol-model/shape';\nimport { LinesBuilder } from '../../../mol-geo/geometry/lines/lines-builder';\nimport { TextBuilder } from '../../../mol-geo/geometry/text/text-builder';\nimport { Vec3, Mat4 } from '../../../mol-math/linear-algebra';\nimport { Mesh } from '../../../mol-geo/geometry/mesh/mesh';\nimport { MeshBuilder } from '../../../mol-geo/geometry/mesh/mesh-builder';\nimport { radToDeg, arcLength } from '../../../mol-math/misc';\nimport { Circle } from '../../../mol-geo/primitive/circle';\nimport { transformPrimitive } from '../../../mol-geo/primitive/primitive';\nimport { MarkerActions, MarkerAction } from '../../../mol-util/marker-action';\nimport { angleLabel } from '../../../mol-theme/label';\nimport { Sphere3D } from '../../../mol-math/geometry';\nimport { LociLabelTextParams } from './common';\nvar SharedParams = {\n  color: PD.Color(ColorNames.lightgreen),\n  arcScale: PD.Numeric(0.7, {\n    min: 0.01,\n    max: 1,\n    step: 0.01\n  })\n};\n\nvar LinesParams = __assign(__assign(__assign({}, Lines.Params), SharedParams), {\n  lineSizeAttenuation: PD.Boolean(true),\n  linesSize: PD.Numeric(0.04, {\n    min: 0.01,\n    max: 5,\n    step: 0.01\n  }),\n  dashLength: PD.Numeric(0.04, {\n    min: 0.01,\n    max: 0.2,\n    step: 0.01\n  })\n});\n\nvar VectorsParams = __assign({}, LinesParams);\n\nvar ArcParams = __assign({}, LinesParams);\n\nvar SectorParams = __assign(__assign(__assign({}, Mesh.Params), SharedParams), {\n  ignoreLight: PD.Boolean(true),\n  sectorOpacity: PD.Numeric(0.75, {\n    min: 0,\n    max: 1,\n    step: 0.01\n  })\n});\n\nvar AngleVisuals = {\n  'vectors': function (ctx, getParams) {\n    return ShapeRepresentation(getVectorsShape, Lines.Utils, {\n      modifyState: function (s) {\n        return __assign(__assign({}, s), {\n          pickable: false\n        });\n      }\n    });\n  },\n  'arc': function (ctx, getParams) {\n    return ShapeRepresentation(getArcShape, Lines.Utils, {\n      modifyState: function (s) {\n        return __assign(__assign({}, s), {\n          pickable: false\n        });\n      }\n    });\n  },\n  'sector': function (ctx, getParams) {\n    return ShapeRepresentation(getSectorShape, Mesh.Utils, {\n      modifyProps: function (p) {\n        return __assign(__assign({}, p), {\n          alpha: p.sectorOpacity\n        });\n      },\n      modifyState: function (s) {\n        return __assign(__assign({}, s), {\n          markerActions: MarkerActions.Highlighting\n        });\n      }\n    });\n  },\n  'text': function (ctx, getParams) {\n    return ShapeRepresentation(getTextShape, Text.Utils, {\n      modifyState: function (s) {\n        return __assign(__assign({}, s), {\n          markerActions: MarkerAction.None\n        });\n      }\n    });\n  }\n};\nexport var AngleParams = __assign(__assign(__assign(__assign(__assign({}, VectorsParams), ArcParams), SectorParams), LociLabelTextParams), {\n  visuals: PD.MultiSelect(['vectors', 'sector', 'text'], PD.objectToOptions(AngleVisuals))\n}); //\n\nfunction getAngleState() {\n  return {\n    sphereA: Sphere3D(),\n    sphereB: Sphere3D(),\n    sphereC: Sphere3D(),\n    arcDirA: Vec3(),\n    arcDirC: Vec3(),\n    arcNormal: Vec3(),\n    radius: 0,\n    angle: 0\n  };\n}\n\nvar tmpVec = Vec3();\nvar tmpMat = Mat4();\n\nfunction setAngleState(triple, state, arcScale) {\n  var sphereA = state.sphereA,\n      sphereB = state.sphereB,\n      sphereC = state.sphereC;\n  var arcDirA = state.arcDirA,\n      arcDirC = state.arcDirC,\n      arcNormal = state.arcNormal;\n  var _a = triple.loci,\n      lociA = _a[0],\n      lociB = _a[1],\n      lociC = _a[2];\n  Loci.getBoundingSphere(lociA, sphereA);\n  Loci.getBoundingSphere(lociB, sphereB);\n  Loci.getBoundingSphere(lociC, sphereC);\n  Vec3.sub(arcDirA, sphereA.center, sphereB.center);\n  Vec3.sub(arcDirC, sphereC.center, sphereB.center);\n  Vec3.cross(arcNormal, arcDirA, arcDirC);\n  var len = Math.min(Vec3.magnitude(arcDirA), Vec3.magnitude(arcDirC));\n  var radius = len * arcScale;\n  state.radius = radius;\n  state.angle = Vec3.angle(arcDirA, arcDirC);\n  return state;\n}\n\nfunction getCircle(state, segmentLength) {\n  var radius = state.radius,\n      angle = state.angle;\n  var segments = segmentLength ? arcLength(angle, radius) / segmentLength : 32;\n  Mat4.targetTo(tmpMat, state.sphereB.center, state.sphereA.center, state.arcNormal);\n  Mat4.setTranslation(tmpMat, state.sphereB.center);\n  Mat4.mul(tmpMat, tmpMat, Mat4.rotY180);\n  var circle = Circle({\n    radius: radius,\n    thetaLength: angle,\n    segments: segments\n  });\n  return transformPrimitive(circle, tmpMat);\n}\n\nvar tmpState = getAngleState();\n\nfunction getAngleName(data) {\n  return data.triples.length === 1 ? \"Angle \" + angleLabel(data.triples[0], {\n    measureOnly: true\n  }) : data.triples.length + \" Angles\";\n} //\n\n\nfunction buildVectorsLines(data, props, lines) {\n  var builder = LinesBuilder.create(128, 64, lines);\n\n  for (var i = 0, il = data.triples.length; i < il; ++i) {\n    setAngleState(data.triples[i], tmpState, props.arcScale);\n    builder.addFixedLengthDashes(tmpState.sphereB.center, tmpState.sphereA.center, props.dashLength, i);\n    builder.addFixedLengthDashes(tmpState.sphereB.center, tmpState.sphereC.center, props.dashLength, i);\n  }\n\n  return builder.getLines();\n}\n\nfunction getVectorsShape(ctx, data, props, shape) {\n  var lines = buildVectorsLines(data, props, shape && shape.geometry);\n  var name = getAngleName(data);\n  return Shape.create(name, data, lines, function () {\n    return props.color;\n  }, function () {\n    return props.linesSize;\n  }, function () {\n    return '';\n  });\n} //\n\n\nfunction buildArcLines(data, props, lines) {\n  var builder = LinesBuilder.create(128, 64, lines);\n\n  for (var i = 0, il = data.triples.length; i < il; ++i) {\n    setAngleState(data.triples[i], tmpState, props.arcScale);\n    var circle = getCircle(tmpState, props.dashLength);\n    var indices = circle.indices,\n        vertices = circle.vertices;\n\n    for (var j = 0, jl = indices.length; j < jl; j += 3) {\n      if (j % 2 === 1) continue; // draw every other segment to get dashes\n\n      var start = indices[j] * 3;\n      var end = indices[j + 1] * 3;\n      var startX = vertices[start];\n      var startY = vertices[start + 1];\n      var startZ = vertices[start + 2];\n      var endX = vertices[end];\n      var endY = vertices[end + 1];\n      var endZ = vertices[end + 2];\n      builder.add(startX, startY, startZ, endX, endY, endZ, i);\n    }\n  }\n\n  return builder.getLines();\n}\n\nfunction getArcShape(ctx, data, props, shape) {\n  var lines = buildArcLines(data, props, shape && shape.geometry);\n  var name = getAngleName(data);\n  return Shape.create(name, data, lines, function () {\n    return props.color;\n  }, function () {\n    return props.linesSize;\n  }, function () {\n    return '';\n  });\n} //\n\n\nfunction buildSectorMesh(data, props, mesh) {\n  var state = MeshBuilder.createState(128, 64, mesh);\n\n  for (var i = 0, il = data.triples.length; i < il; ++i) {\n    setAngleState(data.triples[i], tmpState, props.arcScale);\n    var circle = getCircle(tmpState);\n    state.currentGroup = i;\n    MeshBuilder.addPrimitive(state, Mat4.id, circle);\n    MeshBuilder.addPrimitiveFlipped(state, Mat4.id, circle);\n  }\n\n  return MeshBuilder.getMesh(state);\n}\n\nfunction getSectorShape(ctx, data, props, shape) {\n  var mesh = buildSectorMesh(data, props, shape && shape.geometry);\n  var name = getAngleName(data);\n\n  var getLabel = function (groupId) {\n    return angleLabel(data.triples[groupId]);\n  };\n\n  return Shape.create(name, data, mesh, function () {\n    return props.color;\n  }, function () {\n    return 1;\n  }, getLabel);\n} //\n\n\nfunction buildText(data, props, text) {\n  var builder = TextBuilder.create(props, 128, 64, text);\n\n  for (var i = 0, il = data.triples.length; i < il; ++i) {\n    setAngleState(data.triples[i], tmpState, props.arcScale);\n    Vec3.add(tmpVec, tmpState.arcDirA, tmpState.arcDirC);\n    Vec3.setMagnitude(tmpVec, tmpVec, tmpState.radius);\n    Vec3.add(tmpVec, tmpState.sphereB.center, tmpVec);\n    var angle = radToDeg(tmpState.angle).toFixed(2);\n    var label = props.customText || angle + \"\\u00B0\";\n    var radius = Math.max(2, tmpState.sphereA.radius, tmpState.sphereB.radius, tmpState.sphereC.radius);\n    var scale = radius / 2;\n    builder.add(label, tmpVec[0], tmpVec[1], tmpVec[2], 0.1, scale, i);\n  }\n\n  return builder.getText();\n}\n\nfunction getTextShape(ctx, data, props, shape) {\n  var text = buildText(data, props, shape && shape.geometry);\n  var name = getAngleName(data);\n\n  var getLabel = function (groupId) {\n    return angleLabel(data.triples[groupId]);\n  };\n\n  return Shape.create(name, data, text, function () {\n    return props.textColor;\n  }, function () {\n    return props.textSize;\n  }, getLabel);\n}\n\nexport function AngleRepresentation(ctx, getParams) {\n  return Representation.createMulti('Angle', ctx, getParams, Representation.StateBuilder, AngleVisuals);\n}","map":{"version":3,"sources":["../../../../src/mol-repr/shape/loci/angle.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2019-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { __assign } from \"tslib\";\r\nimport { Loci } from '../../../mol-model/loci';\r\nimport { Lines } from '../../../mol-geo/geometry/lines/lines';\r\nimport { Text } from '../../../mol-geo/geometry/text/text';\r\nimport { ParamDefinition as PD } from '../../../mol-util/param-definition';\r\nimport { ColorNames } from '../../../mol-util/color/names';\r\nimport { ShapeRepresentation } from '../representation';\r\nimport { Representation } from '../../representation';\r\nimport { Shape } from '../../../mol-model/shape';\r\nimport { LinesBuilder } from '../../../mol-geo/geometry/lines/lines-builder';\r\nimport { TextBuilder } from '../../../mol-geo/geometry/text/text-builder';\r\nimport { Vec3, Mat4 } from '../../../mol-math/linear-algebra';\r\nimport { Mesh } from '../../../mol-geo/geometry/mesh/mesh';\r\nimport { MeshBuilder } from '../../../mol-geo/geometry/mesh/mesh-builder';\r\nimport { radToDeg, arcLength } from '../../../mol-math/misc';\r\nimport { Circle } from '../../../mol-geo/primitive/circle';\r\nimport { transformPrimitive } from '../../../mol-geo/primitive/primitive';\r\nimport { MarkerActions, MarkerAction } from '../../../mol-util/marker-action';\r\nimport { angleLabel } from '../../../mol-theme/label';\r\nimport { Sphere3D } from '../../../mol-math/geometry';\r\nimport { LociLabelTextParams } from './common';\r\nvar SharedParams = {\r\n    color: PD.Color(ColorNames.lightgreen),\r\n    arcScale: PD.Numeric(0.7, { min: 0.01, max: 1, step: 0.01 })\r\n};\r\nvar LinesParams = __assign(__assign(__assign({}, Lines.Params), SharedParams), { lineSizeAttenuation: PD.Boolean(true), linesSize: PD.Numeric(0.04, { min: 0.01, max: 5, step: 0.01 }), dashLength: PD.Numeric(0.04, { min: 0.01, max: 0.2, step: 0.01 }) });\r\nvar VectorsParams = __assign({}, LinesParams);\r\nvar ArcParams = __assign({}, LinesParams);\r\nvar SectorParams = __assign(__assign(__assign({}, Mesh.Params), SharedParams), { ignoreLight: PD.Boolean(true), sectorOpacity: PD.Numeric(0.75, { min: 0, max: 1, step: 0.01 }) });\r\nvar AngleVisuals = {\r\n    'vectors': function (ctx, getParams) { return ShapeRepresentation(getVectorsShape, Lines.Utils, { modifyState: function (s) { return (__assign(__assign({}, s), { pickable: false })); } }); },\r\n    'arc': function (ctx, getParams) { return ShapeRepresentation(getArcShape, Lines.Utils, { modifyState: function (s) { return (__assign(__assign({}, s), { pickable: false })); } }); },\r\n    'sector': function (ctx, getParams) { return ShapeRepresentation(getSectorShape, Mesh.Utils, { modifyProps: function (p) { return (__assign(__assign({}, p), { alpha: p.sectorOpacity })); }, modifyState: function (s) { return (__assign(__assign({}, s), { markerActions: MarkerActions.Highlighting })); } }); },\r\n    'text': function (ctx, getParams) { return ShapeRepresentation(getTextShape, Text.Utils, { modifyState: function (s) { return (__assign(__assign({}, s), { markerActions: MarkerAction.None })); } }); },\r\n};\r\nexport var AngleParams = __assign(__assign(__assign(__assign(__assign({}, VectorsParams), ArcParams), SectorParams), LociLabelTextParams), { visuals: PD.MultiSelect(['vectors', 'sector', 'text'], PD.objectToOptions(AngleVisuals)) });\r\n//\r\nfunction getAngleState() {\r\n    return {\r\n        sphereA: Sphere3D(),\r\n        sphereB: Sphere3D(),\r\n        sphereC: Sphere3D(),\r\n        arcDirA: Vec3(),\r\n        arcDirC: Vec3(),\r\n        arcNormal: Vec3(),\r\n        radius: 0,\r\n        angle: 0,\r\n    };\r\n}\r\nvar tmpVec = Vec3();\r\nvar tmpMat = Mat4();\r\nfunction setAngleState(triple, state, arcScale) {\r\n    var sphereA = state.sphereA, sphereB = state.sphereB, sphereC = state.sphereC;\r\n    var arcDirA = state.arcDirA, arcDirC = state.arcDirC, arcNormal = state.arcNormal;\r\n    var _a = triple.loci, lociA = _a[0], lociB = _a[1], lociC = _a[2];\r\n    Loci.getBoundingSphere(lociA, sphereA);\r\n    Loci.getBoundingSphere(lociB, sphereB);\r\n    Loci.getBoundingSphere(lociC, sphereC);\r\n    Vec3.sub(arcDirA, sphereA.center, sphereB.center);\r\n    Vec3.sub(arcDirC, sphereC.center, sphereB.center);\r\n    Vec3.cross(arcNormal, arcDirA, arcDirC);\r\n    var len = Math.min(Vec3.magnitude(arcDirA), Vec3.magnitude(arcDirC));\r\n    var radius = len * arcScale;\r\n    state.radius = radius;\r\n    state.angle = Vec3.angle(arcDirA, arcDirC);\r\n    return state;\r\n}\r\nfunction getCircle(state, segmentLength) {\r\n    var radius = state.radius, angle = state.angle;\r\n    var segments = segmentLength ? arcLength(angle, radius) / segmentLength : 32;\r\n    Mat4.targetTo(tmpMat, state.sphereB.center, state.sphereA.center, state.arcNormal);\r\n    Mat4.setTranslation(tmpMat, state.sphereB.center);\r\n    Mat4.mul(tmpMat, tmpMat, Mat4.rotY180);\r\n    var circle = Circle({ radius: radius, thetaLength: angle, segments: segments });\r\n    return transformPrimitive(circle, tmpMat);\r\n}\r\nvar tmpState = getAngleState();\r\nfunction getAngleName(data) {\r\n    return data.triples.length === 1 ? \"Angle \" + angleLabel(data.triples[0], { measureOnly: true }) : data.triples.length + \" Angles\";\r\n}\r\n//\r\nfunction buildVectorsLines(data, props, lines) {\r\n    var builder = LinesBuilder.create(128, 64, lines);\r\n    for (var i = 0, il = data.triples.length; i < il; ++i) {\r\n        setAngleState(data.triples[i], tmpState, props.arcScale);\r\n        builder.addFixedLengthDashes(tmpState.sphereB.center, tmpState.sphereA.center, props.dashLength, i);\r\n        builder.addFixedLengthDashes(tmpState.sphereB.center, tmpState.sphereC.center, props.dashLength, i);\r\n    }\r\n    return builder.getLines();\r\n}\r\nfunction getVectorsShape(ctx, data, props, shape) {\r\n    var lines = buildVectorsLines(data, props, shape && shape.geometry);\r\n    var name = getAngleName(data);\r\n    return Shape.create(name, data, lines, function () { return props.color; }, function () { return props.linesSize; }, function () { return ''; });\r\n}\r\n//\r\nfunction buildArcLines(data, props, lines) {\r\n    var builder = LinesBuilder.create(128, 64, lines);\r\n    for (var i = 0, il = data.triples.length; i < il; ++i) {\r\n        setAngleState(data.triples[i], tmpState, props.arcScale);\r\n        var circle = getCircle(tmpState, props.dashLength);\r\n        var indices = circle.indices, vertices = circle.vertices;\r\n        for (var j = 0, jl = indices.length; j < jl; j += 3) {\r\n            if (j % 2 === 1)\r\n                continue; // draw every other segment to get dashes\r\n            var start = indices[j] * 3;\r\n            var end = indices[j + 1] * 3;\r\n            var startX = vertices[start];\r\n            var startY = vertices[start + 1];\r\n            var startZ = vertices[start + 2];\r\n            var endX = vertices[end];\r\n            var endY = vertices[end + 1];\r\n            var endZ = vertices[end + 2];\r\n            builder.add(startX, startY, startZ, endX, endY, endZ, i);\r\n        }\r\n    }\r\n    return builder.getLines();\r\n}\r\nfunction getArcShape(ctx, data, props, shape) {\r\n    var lines = buildArcLines(data, props, shape && shape.geometry);\r\n    var name = getAngleName(data);\r\n    return Shape.create(name, data, lines, function () { return props.color; }, function () { return props.linesSize; }, function () { return ''; });\r\n}\r\n//\r\nfunction buildSectorMesh(data, props, mesh) {\r\n    var state = MeshBuilder.createState(128, 64, mesh);\r\n    for (var i = 0, il = data.triples.length; i < il; ++i) {\r\n        setAngleState(data.triples[i], tmpState, props.arcScale);\r\n        var circle = getCircle(tmpState);\r\n        state.currentGroup = i;\r\n        MeshBuilder.addPrimitive(state, Mat4.id, circle);\r\n        MeshBuilder.addPrimitiveFlipped(state, Mat4.id, circle);\r\n    }\r\n    return MeshBuilder.getMesh(state);\r\n}\r\nfunction getSectorShape(ctx, data, props, shape) {\r\n    var mesh = buildSectorMesh(data, props, shape && shape.geometry);\r\n    var name = getAngleName(data);\r\n    var getLabel = function (groupId) { return angleLabel(data.triples[groupId]); };\r\n    return Shape.create(name, data, mesh, function () { return props.color; }, function () { return 1; }, getLabel);\r\n}\r\n//\r\nfunction buildText(data, props, text) {\r\n    var builder = TextBuilder.create(props, 128, 64, text);\r\n    for (var i = 0, il = data.triples.length; i < il; ++i) {\r\n        setAngleState(data.triples[i], tmpState, props.arcScale);\r\n        Vec3.add(tmpVec, tmpState.arcDirA, tmpState.arcDirC);\r\n        Vec3.setMagnitude(tmpVec, tmpVec, tmpState.radius);\r\n        Vec3.add(tmpVec, tmpState.sphereB.center, tmpVec);\r\n        var angle = radToDeg(tmpState.angle).toFixed(2);\r\n        var label = props.customText || angle + \"\\u00B0\";\r\n        var radius = Math.max(2, tmpState.sphereA.radius, tmpState.sphereB.radius, tmpState.sphereC.radius);\r\n        var scale = radius / 2;\r\n        builder.add(label, tmpVec[0], tmpVec[1], tmpVec[2], 0.1, scale, i);\r\n    }\r\n    return builder.getText();\r\n}\r\nfunction getTextShape(ctx, data, props, shape) {\r\n    var text = buildText(data, props, shape && shape.geometry);\r\n    var name = getAngleName(data);\r\n    var getLabel = function (groupId) { return angleLabel(data.triples[groupId]); };\r\n    return Shape.create(name, data, text, function () { return props.textColor; }, function () { return props.textSize; }, getLabel);\r\n}\r\nexport function AngleRepresentation(ctx, getParams) {\r\n    return Representation.createMulti('Angle', ctx, getParams, Representation.StateBuilder, AngleVisuals);\r\n}\r\n//# sourceMappingURL=angle.js.map"]},"metadata":{},"sourceType":"module"}