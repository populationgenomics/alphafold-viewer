{"ast":null,"code":"import { __assign, __awaiter, __extends, __generator } from \"tslib\";\nimport { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from \"react/jsx-runtime\";\n/**\r\n * Copyright (c) 2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\n\nimport { CollapsableControls, PurePluginUIComponent } from '../base';\nimport { Icon, ArrowUpwardSvg, ArrowDownwardSvg, DeleteOutlinedSvg, HelpOutlineSvg, TuneSvg, SuperposeAtomsSvg, SuperposeChainsSvg, SuperpositionSvg } from '../controls/icons';\nimport { Button, ToggleButton, IconButton } from '../controls/common';\nimport { StructureElement, StructureSelection, QueryContext, StructureProperties } from '../../mol-model/structure';\nimport { ParamDefinition as PD } from '../../mol-util/param-definition';\nimport { StateObjectRef, StateSelection } from '../../mol-state';\nimport { StateTransforms } from '../../mol-plugin-state/transforms';\nimport { alignAndSuperpose, superpose } from '../../mol-model/structure/structure/util/superposition';\nimport { StructureSelectionQueries } from '../../mol-plugin-state/helpers/structure-selection-query';\nimport { structureElementStatsLabel, elementLabel } from '../../mol-theme/label';\nimport { ParameterControls } from '../controls/parameters';\nimport { stripTags } from '../../mol-util/string';\nimport { ToggleSelectionModeButton } from './selection';\nimport { alignAndSuperposeWithBestDatabaseMapping } from '../../mol-model/structure/structure/util/superposition-db-mapping';\nimport { PluginCommands } from '../../mol-plugin/commands';\nimport { BestDatabaseSequenceMapping } from '../../mol-model-props/sequence/best-database-mapping';\n\nvar StructureSuperpositionControls =\n/** @class */\nfunction (_super) {\n  __extends(StructureSuperpositionControls, _super);\n\n  function StructureSuperpositionControls() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n\n  StructureSuperpositionControls.prototype.defaultState = function () {\n    return {\n      isCollapsed: false,\n      header: 'Superposition',\n      brand: {\n        accent: 'gray',\n        svg: SuperpositionSvg\n      },\n      isHidden: true\n    };\n  };\n\n  StructureSuperpositionControls.prototype.componentDidMount = function () {\n    var _this = this;\n\n    this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection, function (sel) {\n      _this.setState({\n        isHidden: sel.structures.length < 2\n      });\n    });\n  };\n\n  StructureSuperpositionControls.prototype.renderControls = function () {\n    return _jsx(_Fragment, {\n      children: _jsx(SuperpositionControls, {}, void 0)\n    }, void 0);\n  };\n\n  return StructureSuperpositionControls;\n}(CollapsableControls);\n\nexport { StructureSuperpositionControls };\nexport var StructureSuperpositionParams = {\n  alignSequences: PD.Boolean(true, {\n    isEssential: true,\n    description: 'Perform a sequence alignment and use the aligned residue pairs to guide the 3D superposition.'\n  })\n};\nvar DefaultStructureSuperpositionOptions = PD.getDefaultValues(StructureSuperpositionParams);\nvar SuperpositionTag = 'SuperpositionTransform';\n;\n;\n\nvar SuperpositionControls =\n/** @class */\nfunction (_super) {\n  __extends(SuperpositionControls, _super);\n\n  function SuperpositionControls() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    _this.state = {\n      isBusy: false,\n      canUseDb: false,\n      action: undefined,\n      options: DefaultStructureSuperpositionOptions\n    };\n\n    _this.superposeChains = function () {\n      return __awaiter(_this, void 0, void 0, function () {\n        var query, entries, traceLocis, transforms, eA, i, il, eB, _a, bTransform, rmsd, labelA, labelB;\n\n        var _this = this;\n\n        return __generator(this, function (_b) {\n          switch (_b.label) {\n            case 0:\n              query = StructureSelectionQueries.trace.query;\n              entries = this.chainEntries;\n              traceLocis = entries.map(function (e, i) {\n                var s = StructureElement.Loci.toStructure(e.loci);\n                var loci = StructureSelection.toLociWithSourceUnits(query(new QueryContext(s)));\n                return StructureElement.Loci.remap(loci, i === 0 ? _this.plugin.helpers.substructureParent.get(e.loci.structure.root).obj.data : loci.structure.root);\n              });\n              transforms = this.state.options.alignSequences ? alignAndSuperpose(traceLocis) : superpose(traceLocis);\n              eA = entries[0];\n              i = 1, il = traceLocis.length;\n              _b.label = 1;\n\n            case 1:\n              if (!(i < il)) return [3\n              /*break*/\n              , 4];\n              eB = entries[i];\n              _a = transforms[i - 1], bTransform = _a.bTransform, rmsd = _a.rmsd;\n              return [4\n              /*yield*/\n              , this.transform(eB.cell, bTransform)];\n\n            case 2:\n              _b.sent();\n\n              labelA = stripTags(eA.label);\n              labelB = stripTags(eB.label);\n              this.plugin.log.info(\"Superposed [\" + labelA + \"] and [\" + labelB + \"] with RMSD \" + rmsd.toFixed(2) + \".\");\n              _b.label = 3;\n\n            case 3:\n              ++i;\n              return [3\n              /*break*/\n              , 1];\n\n            case 4:\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.superposeAtoms = function () {\n      return __awaiter(_this, void 0, void 0, function () {\n        var entries, atomLocis, transforms, eA, i, il, eB, _a, bTransform, rmsd, labelA, labelB, count;\n\n        var _this = this;\n\n        return __generator(this, function (_b) {\n          switch (_b.label) {\n            case 0:\n              entries = this.atomEntries;\n              atomLocis = entries.map(function (e, i) {\n                return StructureElement.Loci.remap(e.loci, i === 0 ? _this.plugin.helpers.substructureParent.get(e.loci.structure.root).obj.data : e.loci.structure.root);\n              });\n              transforms = superpose(atomLocis);\n              eA = entries[0];\n              i = 1, il = atomLocis.length;\n              _b.label = 1;\n\n            case 1:\n              if (!(i < il)) return [3\n              /*break*/\n              , 4];\n              eB = entries[i];\n              _a = transforms[i - 1], bTransform = _a.bTransform, rmsd = _a.rmsd;\n              return [4\n              /*yield*/\n              , this.transform(eB.cell, bTransform)];\n\n            case 2:\n              _b.sent();\n\n              labelA = stripTags(eA.label);\n              labelB = stripTags(eB.label);\n              count = entries[i].atoms.length;\n              this.plugin.log.info(\"Superposed \" + count + \" \" + (count === 1 ? 'atom' : 'atoms') + \" of [\" + labelA + \"] and [\" + labelB + \"] with RMSD \" + rmsd.toFixed(2) + \".\");\n              _b.label = 3;\n\n            case 3:\n              ++i;\n              return [3\n              /*break*/\n              , 1];\n\n            case 4:\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.superposeDb = function () {\n      return __awaiter(_this, void 0, void 0, function () {\n        var input, transforms, rmsd, _i, transforms_1, xform;\n\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              input = this.plugin.managers.structure.hierarchy.behaviors.selection.value.structures;\n              transforms = alignAndSuperposeWithBestDatabaseMapping(input.map(function (s) {\n                var _a;\n\n                return (_a = s.cell.obj) === null || _a === void 0 ? void 0 : _a.data;\n              }));\n              rmsd = 0;\n              _i = 0, transforms_1 = transforms;\n              _a.label = 1;\n\n            case 1:\n              if (!(_i < transforms_1.length)) return [3\n              /*break*/\n              , 4];\n              xform = transforms_1[_i];\n              return [4\n              /*yield*/\n              , this.transform(input[xform.other].cell, xform.transform.bTransform)];\n\n            case 2:\n              _a.sent();\n\n              rmsd += xform.transform.rmsd;\n              _a.label = 3;\n\n            case 3:\n              _i++;\n              return [3\n              /*break*/\n              , 1];\n\n            case 4:\n              rmsd /= transforms.length - 1;\n              this.plugin.log.info(\"Superposed \" + input.length + \" structures with avg. RMSD \" + rmsd.toFixed(2) + \".\");\n              return [4\n              /*yield*/\n              , new Promise(function (res) {\n                return requestAnimationFrame(res);\n              })];\n\n            case 5:\n              _a.sent();\n\n              PluginCommands.Camera.Reset(this.plugin);\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    };\n\n    _this.toggleByChains = function () {\n      return _this.setState({\n        action: _this.state.action === 'byChains' ? void 0 : 'byChains'\n      });\n    };\n\n    _this.toggleByAtoms = function () {\n      return _this.setState({\n        action: _this.state.action === 'byAtoms' ? void 0 : 'byAtoms'\n      });\n    };\n\n    _this.toggleOptions = function () {\n      return _this.setState({\n        action: _this.state.action === 'options' ? void 0 : 'options'\n      });\n    };\n\n    _this.setOptions = function (values) {\n      _this.setState({\n        options: values\n      });\n    };\n\n    return _this;\n  }\n\n  SuperpositionControls.prototype.componentDidMount = function () {\n    var _this = this;\n\n    this.subscribe(this.selection.events.changed, function () {\n      _this.forceUpdate();\n    });\n    this.subscribe(this.selection.events.additionsHistoryUpdated, function () {\n      _this.forceUpdate();\n    });\n    this.subscribe(this.plugin.behaviors.state.isBusy, function (v) {\n      _this.setState({\n        isBusy: v\n      });\n    });\n    this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection, function (sel) {\n      _this.setState({\n        canUseDb: sel.structures.every(function (s) {\n          var _a;\n\n          return !!((_a = s.cell.obj) === null || _a === void 0 ? void 0 : _a.data) && s.cell.obj.data.models.some(function (m) {\n            return BestDatabaseSequenceMapping.Provider.isApplicable(m);\n          });\n        })\n      });\n    });\n  };\n\n  Object.defineProperty(SuperpositionControls.prototype, \"selection\", {\n    get: function () {\n      return this.plugin.managers.structure.selection;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  SuperpositionControls.prototype.transform = function (s, matrix) {\n    return __awaiter(this, void 0, void 0, function () {\n      var r, o, params, b;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            r = StateObjectRef.resolveAndCheck(this.plugin.state.data, s);\n            if (!r) return [2\n            /*return*/\n            ];\n            o = StateSelection.findTagInSubtree(this.plugin.state.data.tree, r.transform.ref, SuperpositionTag);\n            params = {\n              transform: {\n                name: 'matrix',\n                params: {\n                  data: matrix,\n                  transpose: false\n                }\n              }\n            };\n            b = o ? this.plugin.state.data.build().to(o).update(params) : this.plugin.state.data.build().to(s).insert(StateTransforms.Model.TransformStructureConformation, params, {\n              tags: SuperpositionTag\n            });\n            return [4\n            /*yield*/\n            , this.plugin.runTask(this.plugin.state.data.updateTree(b))];\n\n          case 1:\n            _a.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  SuperpositionControls.prototype.highlight = function (loci) {\n    this.plugin.managers.interactivity.lociHighlights.highlightOnly({\n      loci: loci\n    }, false);\n  };\n\n  SuperpositionControls.prototype.moveHistory = function (e, direction) {\n    this.plugin.managers.structure.selection.modifyHistory(e, direction, void 0, true);\n  };\n\n  SuperpositionControls.prototype.focusLoci = function (loci) {\n    this.plugin.managers.camera.focusLoci(loci);\n  };\n\n  SuperpositionControls.prototype.lociEntry = function (e, idx) {\n    var _this = this;\n\n    return _jsx(\"div\", __assign({\n      className: 'msp-flex-row'\n    }, {\n      children: _jsx(Button, __assign({\n        noOverflow: true,\n        title: 'Click to focus. Hover to highlight.',\n        onClick: function () {\n          return _this.focusLoci(e.loci);\n        },\n        style: {\n          width: 'auto',\n          textAlign: 'left'\n        },\n        onMouseEnter: function () {\n          return _this.highlight(e.loci);\n        },\n        onMouseLeave: function () {\n          return _this.plugin.managers.interactivity.lociHighlights.clearHighlights();\n        }\n      }, {\n        children: _jsx(\"span\", {\n          dangerouslySetInnerHTML: {\n            __html: e.label\n          }\n        }, void 0)\n      }), void 0)\n    }), idx);\n  };\n\n  SuperpositionControls.prototype.historyEntry = function (e, idx) {\n    var _this = this;\n\n    var history = this.plugin.managers.structure.selection.additionsHistory;\n    return _jsxs(\"div\", __assign({\n      className: 'msp-flex-row'\n    }, {\n      children: [_jsxs(Button, __assign({\n        noOverflow: true,\n        title: 'Click to focus. Hover to highlight.',\n        onClick: function () {\n          return _this.focusLoci(e.loci);\n        },\n        style: {\n          width: 'auto',\n          textAlign: 'left'\n        },\n        onMouseEnter: function () {\n          return _this.highlight(e.loci);\n        },\n        onMouseLeave: function () {\n          return _this.plugin.managers.interactivity.lociHighlights.clearHighlights();\n        }\n      }, {\n        children: [idx, \". \", _jsx(\"span\", {\n          dangerouslySetInnerHTML: {\n            __html: e.label\n          }\n        }, void 0)]\n      }), void 0), history.length > 1 && _jsx(IconButton, {\n        svg: ArrowUpwardSvg,\n        small: true,\n        className: 'msp-form-control',\n        onClick: function () {\n          return _this.moveHistory(e, 'up');\n        },\n        flex: '20px',\n        title: 'Move up'\n      }, void 0), history.length > 1 && _jsx(IconButton, {\n        svg: ArrowDownwardSvg,\n        small: true,\n        className: 'msp-form-control',\n        onClick: function () {\n          return _this.moveHistory(e, 'down');\n        },\n        flex: '20px',\n        title: 'Move down'\n      }, void 0), _jsx(IconButton, {\n        svg: DeleteOutlinedSvg,\n        small: true,\n        className: 'msp-form-control',\n        onClick: function () {\n          return _this.plugin.managers.structure.selection.modifyHistory(e, 'remove');\n        },\n        flex: true,\n        title: 'Remove'\n      }, void 0)]\n    }), e.id);\n  };\n\n  SuperpositionControls.prototype.atomsLociEntry = function (e, idx) {\n    var _this = this;\n\n    return _jsxs(\"div\", {\n      children: [_jsx(\"div\", __assign({\n        className: 'msp-control-group-header'\n      }, {\n        children: _jsx(\"div\", __assign({\n          className: 'msp-no-overflow',\n          title: e.label\n        }, {\n          children: e.label\n        }), void 0)\n      }), void 0), _jsx(\"div\", __assign({\n        className: 'msp-control-offset'\n      }, {\n        children: e.atoms.map(function (h, i) {\n          return _this.historyEntry(h, i);\n        })\n      }), void 0)]\n    }, idx);\n  };\n\n  Object.defineProperty(SuperpositionControls.prototype, \"chainEntries\", {\n    get: function () {\n      var _this = this;\n\n      var location = StructureElement.Location.create();\n      var entries = [];\n      this.plugin.managers.structure.selection.entries.forEach(function (_a, ref) {\n        var selection = _a.selection;\n        var cell = StateObjectRef.resolveAndCheck(_this.plugin.state.data, ref);\n        if (!cell || StructureElement.Loci.isEmpty(selection)) return; // only single polymer chain selections\n\n        var l = StructureElement.Loci.getFirstLocation(selection, location);\n        if (selection.elements.length > 1 || StructureProperties.entity.type(l) !== 'polymer') return;\n        var stats = StructureElement.Stats.ofLoci(selection);\n        var counts = structureElementStatsLabel(stats, {\n          countsOnly: true\n        });\n        var chain = elementLabel(l, {\n          reverse: true,\n          granularity: 'chain'\n        }).split('|');\n        var label = counts + \" | \" + chain[0] + \" | \" + chain[chain.length - 1];\n        entries.push({\n          loci: selection,\n          label: label,\n          cell: cell\n        });\n      });\n      return entries;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(SuperpositionControls.prototype, \"atomEntries\", {\n    get: function () {\n      var _this = this;\n\n      var structureEntries = new Map();\n      var history = this.plugin.managers.structure.selection.additionsHistory;\n\n      for (var i = 0, il = history.length; i < il; ++i) {\n        var e = history[i];\n        if (StructureElement.Loci.size(e.loci) !== 1) continue;\n        var k = e.loci.structure;\n        if (structureEntries.has(k)) structureEntries.get(k).push(e);else structureEntries.set(k, [e]);\n      }\n\n      var entries = [];\n      structureEntries.forEach(function (atoms, structure) {\n        var cell = _this.plugin.helpers.substructureParent.get(structure);\n\n        var elements = [];\n\n        for (var i = 0, il = atoms.length; i < il; ++i) {\n          // note, we don't do loci union here to keep order of selected atoms\n          // for atom pairing during superposition\n          elements.push(atoms[i].loci.elements[0]);\n        }\n\n        var loci = StructureElement.Loci(atoms[0].loci.structure, elements);\n        var label = loci.structure.label.split(' | ')[0];\n        entries.push({\n          loci: loci,\n          label: label,\n          cell: cell,\n          atoms: atoms\n        });\n      });\n      return entries;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  SuperpositionControls.prototype.addByChains = function () {\n    var _this = this;\n\n    var entries = this.chainEntries;\n    return _jsxs(_Fragment, {\n      children: [entries.length > 0 && _jsx(\"div\", __assign({\n        className: 'msp-control-offset'\n      }, {\n        children: entries.map(function (e, i) {\n          return _this.lociEntry(e, i);\n        })\n      }), void 0), entries.length < 2 && _jsx(\"div\", __assign({\n        className: 'msp-control-offset msp-help-text'\n      }, {\n        children: _jsxs(\"div\", __assign({\n          className: 'msp-help-description'\n        }, {\n          children: [_jsx(Icon, {\n            svg: HelpOutlineSvg,\n            inline: true\n          }, void 0), \"Add 2 or more selections (toggle \", _jsx(ToggleSelectionModeButton, {\n            inline: true\n          }, void 0), \" mode) from separate structures. Selections must be limited to single polymer chains or residues therein.\"]\n        }), void 0)\n      }), void 0), entries.length > 1 && _jsx(Button, __assign({\n        title: 'Superpose structures by selected chains.',\n        className: 'msp-btn-commit msp-btn-commit-on',\n        onClick: this.superposeChains,\n        style: {\n          marginTop: '1px'\n        }\n      }, {\n        children: \"Superpose\"\n      }), void 0)]\n    }, void 0);\n  };\n\n  SuperpositionControls.prototype.addByAtoms = function () {\n    var _this = this;\n\n    var entries = this.atomEntries;\n    return _jsxs(_Fragment, {\n      children: [entries.length > 0 && _jsx(\"div\", __assign({\n        className: 'msp-control-offset'\n      }, {\n        children: entries.map(function (e, i) {\n          return _this.atomsLociEntry(e, i);\n        })\n      }), void 0), entries.length < 2 && _jsx(\"div\", __assign({\n        className: 'msp-control-offset msp-help-text'\n      }, {\n        children: _jsxs(\"div\", __assign({\n          className: 'msp-help-description'\n        }, {\n          children: [_jsx(Icon, {\n            svg: HelpOutlineSvg,\n            inline: true\n          }, void 0), \"Add 1 or more selections (toggle \", _jsx(ToggleSelectionModeButton, {\n            inline: true\n          }, void 0), \" mode) from separate structures. Selections must be limited to single atoms.\"]\n        }), void 0)\n      }), void 0), entries.length > 1 && _jsx(Button, __assign({\n        title: 'Superpose structures by selected atoms.',\n        className: 'msp-btn-commit msp-btn-commit-on',\n        onClick: this.superposeAtoms,\n        style: {\n          marginTop: '1px'\n        }\n      }, {\n        children: \"Superpose\"\n      }), void 0)]\n    }, void 0);\n  };\n\n  SuperpositionControls.prototype.superposeByDbMapping = function () {\n    return _jsx(_Fragment, {\n      children: _jsx(Button, __assign({\n        icon: SuperposeChainsSvg,\n        title: 'Superpose structures using database mapping.',\n        className: 'msp-btn msp-btn-block',\n        onClick: this.superposeDb,\n        style: {\n          marginTop: '1px'\n        },\n        disabled: this.state.isBusy\n      }, {\n        children: \"DB\"\n      }), void 0)\n    }, void 0);\n  };\n\n  SuperpositionControls.prototype.render = function () {\n    return _jsxs(_Fragment, {\n      children: [_jsxs(\"div\", __assign({\n        className: 'msp-flex-row'\n      }, {\n        children: [_jsx(ToggleButton, {\n          icon: SuperposeChainsSvg,\n          label: 'Chains',\n          toggle: this.toggleByChains,\n          isSelected: this.state.action === 'byChains',\n          disabled: this.state.isBusy\n        }, void 0), _jsx(ToggleButton, {\n          icon: SuperposeAtomsSvg,\n          label: 'Atoms',\n          toggle: this.toggleByAtoms,\n          isSelected: this.state.action === 'byAtoms',\n          disabled: this.state.isBusy\n        }, void 0), this.state.canUseDb && this.superposeByDbMapping(), _jsx(ToggleButton, {\n          icon: TuneSvg,\n          label: '',\n          title: 'Options',\n          toggle: this.toggleOptions,\n          isSelected: this.state.action === 'options',\n          disabled: this.state.isBusy,\n          style: {\n            flex: '0 0 40px',\n            padding: 0\n          }\n        }, void 0)]\n      }), void 0), this.state.action === 'byChains' && this.addByChains(), this.state.action === 'byAtoms' && this.addByAtoms(), this.state.action === 'options' && _jsx(\"div\", __assign({\n        className: 'msp-control-offset'\n      }, {\n        children: _jsx(ParameterControls, {\n          params: StructureSuperpositionParams,\n          values: this.state.options,\n          onChangeValues: this.setOptions,\n          isDisabled: this.state.isBusy\n        }, void 0)\n      }), void 0)]\n    }, void 0);\n  };\n\n  return SuperpositionControls;\n}(PurePluginUIComponent);\n\nexport { SuperpositionControls };","map":{"version":3,"sources":["../../../src/mol-plugin-ui/structure/superposition.tsx"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign, __awaiter, __extends, __generator } from \"tslib\";\r\nimport { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from \"react/jsx-runtime\";\r\n/**\r\n * Copyright (c) 2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { CollapsableControls, PurePluginUIComponent } from '../base';\r\nimport { Icon, ArrowUpwardSvg, ArrowDownwardSvg, DeleteOutlinedSvg, HelpOutlineSvg, TuneSvg, SuperposeAtomsSvg, SuperposeChainsSvg, SuperpositionSvg } from '../controls/icons';\r\nimport { Button, ToggleButton, IconButton } from '../controls/common';\r\nimport { StructureElement, StructureSelection, QueryContext, StructureProperties } from '../../mol-model/structure';\r\nimport { ParamDefinition as PD } from '../../mol-util/param-definition';\r\nimport { StateObjectRef, StateSelection } from '../../mol-state';\r\nimport { StateTransforms } from '../../mol-plugin-state/transforms';\r\nimport { alignAndSuperpose, superpose } from '../../mol-model/structure/structure/util/superposition';\r\nimport { StructureSelectionQueries } from '../../mol-plugin-state/helpers/structure-selection-query';\r\nimport { structureElementStatsLabel, elementLabel } from '../../mol-theme/label';\r\nimport { ParameterControls } from '../controls/parameters';\r\nimport { stripTags } from '../../mol-util/string';\r\nimport { ToggleSelectionModeButton } from './selection';\r\nimport { alignAndSuperposeWithBestDatabaseMapping } from '../../mol-model/structure/structure/util/superposition-db-mapping';\r\nimport { PluginCommands } from '../../mol-plugin/commands';\r\nimport { BestDatabaseSequenceMapping } from '../../mol-model-props/sequence/best-database-mapping';\r\nvar StructureSuperpositionControls = /** @class */ (function (_super) {\r\n    __extends(StructureSuperpositionControls, _super);\r\n    function StructureSuperpositionControls() {\r\n        return _super !== null && _super.apply(this, arguments) || this;\r\n    }\r\n    StructureSuperpositionControls.prototype.defaultState = function () {\r\n        return {\r\n            isCollapsed: false,\r\n            header: 'Superposition',\r\n            brand: { accent: 'gray', svg: SuperpositionSvg },\r\n            isHidden: true\r\n        };\r\n    };\r\n    StructureSuperpositionControls.prototype.componentDidMount = function () {\r\n        var _this = this;\r\n        this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection, function (sel) {\r\n            _this.setState({ isHidden: sel.structures.length < 2 });\r\n        });\r\n    };\r\n    StructureSuperpositionControls.prototype.renderControls = function () {\r\n        return _jsx(_Fragment, { children: _jsx(SuperpositionControls, {}, void 0) }, void 0);\r\n    };\r\n    return StructureSuperpositionControls;\r\n}(CollapsableControls));\r\nexport { StructureSuperpositionControls };\r\nexport var StructureSuperpositionParams = {\r\n    alignSequences: PD.Boolean(true, { isEssential: true, description: 'Perform a sequence alignment and use the aligned residue pairs to guide the 3D superposition.' }),\r\n};\r\nvar DefaultStructureSuperpositionOptions = PD.getDefaultValues(StructureSuperpositionParams);\r\nvar SuperpositionTag = 'SuperpositionTransform';\r\n;\r\n;\r\nvar SuperpositionControls = /** @class */ (function (_super) {\r\n    __extends(SuperpositionControls, _super);\r\n    function SuperpositionControls() {\r\n        var _this = _super !== null && _super.apply(this, arguments) || this;\r\n        _this.state = {\r\n            isBusy: false,\r\n            canUseDb: false,\r\n            action: undefined,\r\n            options: DefaultStructureSuperpositionOptions\r\n        };\r\n        _this.superposeChains = function () { return __awaiter(_this, void 0, void 0, function () {\r\n            var query, entries, traceLocis, transforms, eA, i, il, eB, _a, bTransform, rmsd, labelA, labelB;\r\n            var _this = this;\r\n            return __generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        query = StructureSelectionQueries.trace.query;\r\n                        entries = this.chainEntries;\r\n                        traceLocis = entries.map(function (e, i) {\r\n                            var s = StructureElement.Loci.toStructure(e.loci);\r\n                            var loci = StructureSelection.toLociWithSourceUnits(query(new QueryContext(s)));\r\n                            return StructureElement.Loci.remap(loci, i === 0\r\n                                ? _this.plugin.helpers.substructureParent.get(e.loci.structure.root).obj.data\r\n                                : loci.structure.root);\r\n                        });\r\n                        transforms = this.state.options.alignSequences\r\n                            ? alignAndSuperpose(traceLocis)\r\n                            : superpose(traceLocis);\r\n                        eA = entries[0];\r\n                        i = 1, il = traceLocis.length;\r\n                        _b.label = 1;\r\n                    case 1:\r\n                        if (!(i < il)) return [3 /*break*/, 4];\r\n                        eB = entries[i];\r\n                        _a = transforms[i - 1], bTransform = _a.bTransform, rmsd = _a.rmsd;\r\n                        return [4 /*yield*/, this.transform(eB.cell, bTransform)];\r\n                    case 2:\r\n                        _b.sent();\r\n                        labelA = stripTags(eA.label);\r\n                        labelB = stripTags(eB.label);\r\n                        this.plugin.log.info(\"Superposed [\" + labelA + \"] and [\" + labelB + \"] with RMSD \" + rmsd.toFixed(2) + \".\");\r\n                        _b.label = 3;\r\n                    case 3:\r\n                        ++i;\r\n                        return [3 /*break*/, 1];\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        }); };\r\n        _this.superposeAtoms = function () { return __awaiter(_this, void 0, void 0, function () {\r\n            var entries, atomLocis, transforms, eA, i, il, eB, _a, bTransform, rmsd, labelA, labelB, count;\r\n            var _this = this;\r\n            return __generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        entries = this.atomEntries;\r\n                        atomLocis = entries.map(function (e, i) {\r\n                            return StructureElement.Loci.remap(e.loci, i === 0\r\n                                ? _this.plugin.helpers.substructureParent.get(e.loci.structure.root).obj.data\r\n                                : e.loci.structure.root);\r\n                        });\r\n                        transforms = superpose(atomLocis);\r\n                        eA = entries[0];\r\n                        i = 1, il = atomLocis.length;\r\n                        _b.label = 1;\r\n                    case 1:\r\n                        if (!(i < il)) return [3 /*break*/, 4];\r\n                        eB = entries[i];\r\n                        _a = transforms[i - 1], bTransform = _a.bTransform, rmsd = _a.rmsd;\r\n                        return [4 /*yield*/, this.transform(eB.cell, bTransform)];\r\n                    case 2:\r\n                        _b.sent();\r\n                        labelA = stripTags(eA.label);\r\n                        labelB = stripTags(eB.label);\r\n                        count = entries[i].atoms.length;\r\n                        this.plugin.log.info(\"Superposed \" + count + \" \" + (count === 1 ? 'atom' : 'atoms') + \" of [\" + labelA + \"] and [\" + labelB + \"] with RMSD \" + rmsd.toFixed(2) + \".\");\r\n                        _b.label = 3;\r\n                    case 3:\r\n                        ++i;\r\n                        return [3 /*break*/, 1];\r\n                    case 4: return [2 /*return*/];\r\n                }\r\n            });\r\n        }); };\r\n        _this.superposeDb = function () { return __awaiter(_this, void 0, void 0, function () {\r\n            var input, transforms, rmsd, _i, transforms_1, xform;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        input = this.plugin.managers.structure.hierarchy.behaviors.selection.value.structures;\r\n                        transforms = alignAndSuperposeWithBestDatabaseMapping(input.map(function (s) { var _a; return (_a = s.cell.obj) === null || _a === void 0 ? void 0 : _a.data; }));\r\n                        rmsd = 0;\r\n                        _i = 0, transforms_1 = transforms;\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        if (!(_i < transforms_1.length)) return [3 /*break*/, 4];\r\n                        xform = transforms_1[_i];\r\n                        return [4 /*yield*/, this.transform(input[xform.other].cell, xform.transform.bTransform)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        rmsd += xform.transform.rmsd;\r\n                        _a.label = 3;\r\n                    case 3:\r\n                        _i++;\r\n                        return [3 /*break*/, 1];\r\n                    case 4:\r\n                        rmsd /= transforms.length - 1;\r\n                        this.plugin.log.info(\"Superposed \" + input.length + \" structures with avg. RMSD \" + rmsd.toFixed(2) + \".\");\r\n                        return [4 /*yield*/, new Promise(function (res) { return requestAnimationFrame(res); })];\r\n                    case 5:\r\n                        _a.sent();\r\n                        PluginCommands.Camera.Reset(this.plugin);\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        }); };\r\n        _this.toggleByChains = function () { return _this.setState({ action: _this.state.action === 'byChains' ? void 0 : 'byChains' }); };\r\n        _this.toggleByAtoms = function () { return _this.setState({ action: _this.state.action === 'byAtoms' ? void 0 : 'byAtoms' }); };\r\n        _this.toggleOptions = function () { return _this.setState({ action: _this.state.action === 'options' ? void 0 : 'options' }); };\r\n        _this.setOptions = function (values) {\r\n            _this.setState({ options: values });\r\n        };\r\n        return _this;\r\n    }\r\n    SuperpositionControls.prototype.componentDidMount = function () {\r\n        var _this = this;\r\n        this.subscribe(this.selection.events.changed, function () {\r\n            _this.forceUpdate();\r\n        });\r\n        this.subscribe(this.selection.events.additionsHistoryUpdated, function () {\r\n            _this.forceUpdate();\r\n        });\r\n        this.subscribe(this.plugin.behaviors.state.isBusy, function (v) {\r\n            _this.setState({ isBusy: v });\r\n        });\r\n        this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection, function (sel) {\r\n            _this.setState({ canUseDb: sel.structures.every(function (s) { var _a; return !!((_a = s.cell.obj) === null || _a === void 0 ? void 0 : _a.data) && s.cell.obj.data.models.some(function (m) { return BestDatabaseSequenceMapping.Provider.isApplicable(m); }); }) });\r\n        });\r\n    };\r\n    Object.defineProperty(SuperpositionControls.prototype, \"selection\", {\r\n        get: function () {\r\n            return this.plugin.managers.structure.selection;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    SuperpositionControls.prototype.transform = function (s, matrix) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var r, o, params, b;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        r = StateObjectRef.resolveAndCheck(this.plugin.state.data, s);\r\n                        if (!r)\r\n                            return [2 /*return*/];\r\n                        o = StateSelection.findTagInSubtree(this.plugin.state.data.tree, r.transform.ref, SuperpositionTag);\r\n                        params = {\r\n                            transform: {\r\n                                name: 'matrix',\r\n                                params: { data: matrix, transpose: false }\r\n                            }\r\n                        };\r\n                        b = o\r\n                            ? this.plugin.state.data.build().to(o).update(params)\r\n                            : this.plugin.state.data.build().to(s)\r\n                                .insert(StateTransforms.Model.TransformStructureConformation, params, { tags: SuperpositionTag });\r\n                        return [4 /*yield*/, this.plugin.runTask(this.plugin.state.data.updateTree(b))];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    SuperpositionControls.prototype.highlight = function (loci) {\r\n        this.plugin.managers.interactivity.lociHighlights.highlightOnly({ loci: loci }, false);\r\n    };\r\n    SuperpositionControls.prototype.moveHistory = function (e, direction) {\r\n        this.plugin.managers.structure.selection.modifyHistory(e, direction, void 0, true);\r\n    };\r\n    SuperpositionControls.prototype.focusLoci = function (loci) {\r\n        this.plugin.managers.camera.focusLoci(loci);\r\n    };\r\n    SuperpositionControls.prototype.lociEntry = function (e, idx) {\r\n        var _this = this;\r\n        return _jsx(\"div\", __assign({ className: 'msp-flex-row' }, { children: _jsx(Button, __assign({ noOverflow: true, title: 'Click to focus. Hover to highlight.', onClick: function () { return _this.focusLoci(e.loci); }, style: { width: 'auto', textAlign: 'left' }, onMouseEnter: function () { return _this.highlight(e.loci); }, onMouseLeave: function () { return _this.plugin.managers.interactivity.lociHighlights.clearHighlights(); } }, { children: _jsx(\"span\", { dangerouslySetInnerHTML: { __html: e.label } }, void 0) }), void 0) }), idx);\r\n    };\r\n    SuperpositionControls.prototype.historyEntry = function (e, idx) {\r\n        var _this = this;\r\n        var history = this.plugin.managers.structure.selection.additionsHistory;\r\n        return _jsxs(\"div\", __assign({ className: 'msp-flex-row' }, { children: [_jsxs(Button, __assign({ noOverflow: true, title: 'Click to focus. Hover to highlight.', onClick: function () { return _this.focusLoci(e.loci); }, style: { width: 'auto', textAlign: 'left' }, onMouseEnter: function () { return _this.highlight(e.loci); }, onMouseLeave: function () { return _this.plugin.managers.interactivity.lociHighlights.clearHighlights(); } }, { children: [idx, \". \", _jsx(\"span\", { dangerouslySetInnerHTML: { __html: e.label } }, void 0)] }), void 0), history.length > 1 && _jsx(IconButton, { svg: ArrowUpwardSvg, small: true, className: 'msp-form-control', onClick: function () { return _this.moveHistory(e, 'up'); }, flex: '20px', title: 'Move up' }, void 0), history.length > 1 && _jsx(IconButton, { svg: ArrowDownwardSvg, small: true, className: 'msp-form-control', onClick: function () { return _this.moveHistory(e, 'down'); }, flex: '20px', title: 'Move down' }, void 0), _jsx(IconButton, { svg: DeleteOutlinedSvg, small: true, className: 'msp-form-control', onClick: function () { return _this.plugin.managers.structure.selection.modifyHistory(e, 'remove'); }, flex: true, title: 'Remove' }, void 0)] }), e.id);\r\n    };\r\n    SuperpositionControls.prototype.atomsLociEntry = function (e, idx) {\r\n        var _this = this;\r\n        return _jsxs(\"div\", { children: [_jsx(\"div\", __assign({ className: 'msp-control-group-header' }, { children: _jsx(\"div\", __assign({ className: 'msp-no-overflow', title: e.label }, { children: e.label }), void 0) }), void 0), _jsx(\"div\", __assign({ className: 'msp-control-offset' }, { children: e.atoms.map(function (h, i) { return _this.historyEntry(h, i); }) }), void 0)] }, idx);\r\n    };\r\n    Object.defineProperty(SuperpositionControls.prototype, \"chainEntries\", {\r\n        get: function () {\r\n            var _this = this;\r\n            var location = StructureElement.Location.create();\r\n            var entries = [];\r\n            this.plugin.managers.structure.selection.entries.forEach(function (_a, ref) {\r\n                var selection = _a.selection;\r\n                var cell = StateObjectRef.resolveAndCheck(_this.plugin.state.data, ref);\r\n                if (!cell || StructureElement.Loci.isEmpty(selection))\r\n                    return;\r\n                // only single polymer chain selections\r\n                var l = StructureElement.Loci.getFirstLocation(selection, location);\r\n                if (selection.elements.length > 1 || StructureProperties.entity.type(l) !== 'polymer')\r\n                    return;\r\n                var stats = StructureElement.Stats.ofLoci(selection);\r\n                var counts = structureElementStatsLabel(stats, { countsOnly: true });\r\n                var chain = elementLabel(l, { reverse: true, granularity: 'chain' }).split('|');\r\n                var label = counts + \" | \" + chain[0] + \" | \" + chain[chain.length - 1];\r\n                entries.push({ loci: selection, label: label, cell: cell });\r\n            });\r\n            return entries;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(SuperpositionControls.prototype, \"atomEntries\", {\r\n        get: function () {\r\n            var _this = this;\r\n            var structureEntries = new Map();\r\n            var history = this.plugin.managers.structure.selection.additionsHistory;\r\n            for (var i = 0, il = history.length; i < il; ++i) {\r\n                var e = history[i];\r\n                if (StructureElement.Loci.size(e.loci) !== 1)\r\n                    continue;\r\n                var k = e.loci.structure;\r\n                if (structureEntries.has(k))\r\n                    structureEntries.get(k).push(e);\r\n                else\r\n                    structureEntries.set(k, [e]);\r\n            }\r\n            var entries = [];\r\n            structureEntries.forEach(function (atoms, structure) {\r\n                var cell = _this.plugin.helpers.substructureParent.get(structure);\r\n                var elements = [];\r\n                for (var i = 0, il = atoms.length; i < il; ++i) {\r\n                    // note, we don't do loci union here to keep order of selected atoms\r\n                    // for atom pairing during superposition\r\n                    elements.push(atoms[i].loci.elements[0]);\r\n                }\r\n                var loci = StructureElement.Loci(atoms[0].loci.structure, elements);\r\n                var label = loci.structure.label.split(' | ')[0];\r\n                entries.push({ loci: loci, label: label, cell: cell, atoms: atoms });\r\n            });\r\n            return entries;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    SuperpositionControls.prototype.addByChains = function () {\r\n        var _this = this;\r\n        var entries = this.chainEntries;\r\n        return _jsxs(_Fragment, { children: [entries.length > 0 && _jsx(\"div\", __assign({ className: 'msp-control-offset' }, { children: entries.map(function (e, i) { return _this.lociEntry(e, i); }) }), void 0), entries.length < 2 && _jsx(\"div\", __assign({ className: 'msp-control-offset msp-help-text' }, { children: _jsxs(\"div\", __assign({ className: 'msp-help-description' }, { children: [_jsx(Icon, { svg: HelpOutlineSvg, inline: true }, void 0), \"Add 2 or more selections (toggle \", _jsx(ToggleSelectionModeButton, { inline: true }, void 0), \" mode) from separate structures. Selections must be limited to single polymer chains or residues therein.\"] }), void 0) }), void 0), entries.length > 1 && _jsx(Button, __assign({ title: 'Superpose structures by selected chains.', className: 'msp-btn-commit msp-btn-commit-on', onClick: this.superposeChains, style: { marginTop: '1px' } }, { children: \"Superpose\" }), void 0)] }, void 0);\r\n    };\r\n    SuperpositionControls.prototype.addByAtoms = function () {\r\n        var _this = this;\r\n        var entries = this.atomEntries;\r\n        return _jsxs(_Fragment, { children: [entries.length > 0 && _jsx(\"div\", __assign({ className: 'msp-control-offset' }, { children: entries.map(function (e, i) { return _this.atomsLociEntry(e, i); }) }), void 0), entries.length < 2 && _jsx(\"div\", __assign({ className: 'msp-control-offset msp-help-text' }, { children: _jsxs(\"div\", __assign({ className: 'msp-help-description' }, { children: [_jsx(Icon, { svg: HelpOutlineSvg, inline: true }, void 0), \"Add 1 or more selections (toggle \", _jsx(ToggleSelectionModeButton, { inline: true }, void 0), \" mode) from separate structures. Selections must be limited to single atoms.\"] }), void 0) }), void 0), entries.length > 1 && _jsx(Button, __assign({ title: 'Superpose structures by selected atoms.', className: 'msp-btn-commit msp-btn-commit-on', onClick: this.superposeAtoms, style: { marginTop: '1px' } }, { children: \"Superpose\" }), void 0)] }, void 0);\r\n    };\r\n    SuperpositionControls.prototype.superposeByDbMapping = function () {\r\n        return _jsx(_Fragment, { children: _jsx(Button, __assign({ icon: SuperposeChainsSvg, title: 'Superpose structures using database mapping.', className: 'msp-btn msp-btn-block', onClick: this.superposeDb, style: { marginTop: '1px' }, disabled: this.state.isBusy }, { children: \"DB\" }), void 0) }, void 0);\r\n    };\r\n    SuperpositionControls.prototype.render = function () {\r\n        return _jsxs(_Fragment, { children: [_jsxs(\"div\", __assign({ className: 'msp-flex-row' }, { children: [_jsx(ToggleButton, { icon: SuperposeChainsSvg, label: 'Chains', toggle: this.toggleByChains, isSelected: this.state.action === 'byChains', disabled: this.state.isBusy }, void 0), _jsx(ToggleButton, { icon: SuperposeAtomsSvg, label: 'Atoms', toggle: this.toggleByAtoms, isSelected: this.state.action === 'byAtoms', disabled: this.state.isBusy }, void 0), this.state.canUseDb && this.superposeByDbMapping(), _jsx(ToggleButton, { icon: TuneSvg, label: '', title: 'Options', toggle: this.toggleOptions, isSelected: this.state.action === 'options', disabled: this.state.isBusy, style: { flex: '0 0 40px', padding: 0 } }, void 0)] }), void 0), this.state.action === 'byChains' && this.addByChains(), this.state.action === 'byAtoms' && this.addByAtoms(), this.state.action === 'options' && _jsx(\"div\", __assign({ className: 'msp-control-offset' }, { children: _jsx(ParameterControls, { params: StructureSuperpositionParams, values: this.state.options, onChangeValues: this.setOptions, isDisabled: this.state.isBusy }, void 0) }), void 0)] }, void 0);\r\n    };\r\n    return SuperpositionControls;\r\n}(PurePluginUIComponent));\r\nexport { SuperpositionControls };\r\n//# sourceMappingURL=superposition.js.map"]},"metadata":{},"sourceType":"module"}