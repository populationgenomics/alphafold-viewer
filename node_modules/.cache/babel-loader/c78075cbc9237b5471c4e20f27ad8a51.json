{"ast":null,"code":"/**\r\n * Copyright (c) 2018-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\nimport { __assign, __awaiter, __extends, __generator } from \"tslib\";\nimport { State } from '../mol-state';\nimport { PluginStateObject as SO } from '../mol-plugin-state/objects';\nimport { PluginBehavior } from './behavior';\nimport { Canvas3DParams } from '../mol-canvas3d/canvas3d';\nimport { PluginCommands } from './commands';\nimport { ParamDefinition as PD } from '../mol-util/param-definition';\nimport { UUID } from '../mol-util';\nimport { produce } from 'immer';\nimport { merge } from 'rxjs';\nimport { PluginComponent } from '../mol-plugin-state/component';\nimport { PluginConfig } from './config';\nexport { PluginState };\n\nvar PluginState =\n/** @class */\nfunction (_super) {\n  __extends(PluginState, _super);\n\n  function PluginState(plugin) {\n    var _this = _super.call(this) || this;\n\n    _this.plugin = plugin;\n    _this.data = State.create(new SO.Root({}), {\n      runTask: _this.plugin.runTask,\n      globalContext: _this.plugin,\n      historyCapacity: _this.plugin.config.get(PluginConfig.State.HistoryCapacity)\n    });\n    _this.behaviors = State.create(new PluginBehavior.Root({}), {\n      runTask: _this.plugin.runTask,\n      globalContext: _this.plugin,\n      rootState: {\n        isLocked: true\n      }\n    });\n    _this.events = {\n      cell: {\n        stateUpdated: merge(_this.data.events.cell.stateUpdated, _this.behaviors.events.cell.stateUpdated),\n        created: merge(_this.data.events.cell.created, _this.behaviors.events.cell.created),\n        removed: merge(_this.data.events.cell.removed, _this.behaviors.events.cell.removed)\n      },\n      object: {\n        created: merge(_this.data.events.object.created, _this.behaviors.events.object.created),\n        removed: merge(_this.data.events.object.removed, _this.behaviors.events.object.removed),\n        updated: merge(_this.data.events.object.updated, _this.behaviors.events.object.updated)\n      }\n    };\n    _this.snapshotParams = _this.ev.behavior(PluginState.DefaultSnapshotParams);\n\n    _this.setSnapshotParams = function (params) {\n      _this.snapshotParams.next(__assign(__assign({}, PluginState.DefaultSnapshotParams), params));\n    };\n\n    return _this;\n  }\n\n  Object.defineProperty(PluginState.prototype, \"animation\", {\n    get: function () {\n      return this.plugin.managers.animation;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  PluginState.prototype.getSnapshot = function (params) {\n    var _a, _b;\n\n    var p = __assign(__assign({}, this.snapshotParams.value), params);\n\n    return {\n      id: UUID.create22(),\n      data: p.data ? this.data.getSnapshot() : void 0,\n      behaviour: p.behavior ? this.behaviors.getSnapshot() : void 0,\n      animation: p.animation ? this.animation.getSnapshot() : void 0,\n      startAnimation: p.startAnimation ? !!p.startAnimation : void 0,\n      camera: p.camera ? {\n        current: this.plugin.canvas3d.camera.getSnapshot(),\n        transitionStyle: p.cameraTransition.name,\n        transitionDurationInMs: ((_a = p === null || p === void 0 ? void 0 : p.cameraTransition) === null || _a === void 0 ? void 0 : _a.name) === 'animate' ? p.cameraTransition.params.durationInMs : void 0\n      } : void 0,\n      canvas3d: p.canvas3d ? {\n        props: (_b = this.plugin.canvas3d) === null || _b === void 0 ? void 0 : _b.props\n      } : void 0,\n      interactivity: p.interactivity ? {\n        props: this.plugin.managers.interactivity.props\n      } : void 0,\n      structureFocus: this.plugin.managers.structure.focus.getSnapshot(),\n      durationInMs: p === null || p === void 0 ? void 0 : p.durationInMs\n    };\n  };\n\n  PluginState.prototype.setSnapshot = function (snapshot) {\n    var _a;\n\n    return __awaiter(this, void 0, void 0, function () {\n      var settings;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.animation.stop()];\n\n          case 1:\n            _b.sent();\n\n            if (!snapshot.behaviour) return [3\n            /*break*/\n            , 3];\n            return [4\n            /*yield*/\n            , this.plugin.runTask(this.behaviors.setSnapshot(snapshot.behaviour))];\n\n          case 2:\n            _b.sent();\n\n            _b.label = 3;\n\n          case 3:\n            if (!snapshot.data) return [3\n            /*break*/\n            , 5];\n            return [4\n            /*yield*/\n            , this.plugin.runTask(this.data.setSnapshot(snapshot.data))];\n\n          case 4:\n            _b.sent();\n\n            _b.label = 5;\n\n          case 5:\n            if (!((_a = snapshot.canvas3d) === null || _a === void 0 ? void 0 : _a.props)) return [3\n            /*break*/\n            , 7];\n            settings = PD.normalizeParams(Canvas3DParams, snapshot.canvas3d.props, 'children');\n            return [4\n            /*yield*/\n            , PluginCommands.Canvas3D.SetSettings(this.plugin, {\n              settings: settings\n            })];\n\n          case 6:\n            _b.sent();\n\n            _b.label = 7;\n\n          case 7:\n            if (snapshot.interactivity) {\n              if (snapshot.interactivity.props) this.plugin.managers.interactivity.setProps(snapshot.interactivity.props);\n            }\n\n            if (snapshot.structureFocus) {\n              this.plugin.managers.structure.focus.setSnapshot(snapshot.structureFocus);\n            }\n\n            if (snapshot.animation) {\n              this.animation.setSnapshot(snapshot.animation);\n            }\n\n            if (snapshot.camera) {\n              PluginCommands.Camera.Reset(this.plugin, {\n                snapshot: snapshot.camera.current,\n                durationMs: snapshot.camera.transitionStyle === 'animate' ? snapshot.camera.transitionDurationInMs : void 0\n              });\n            }\n\n            if (snapshot.startAnimation) {\n              this.animation.start();\n            }\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  PluginState.prototype.updateTransform = function (state, a, params, canUndo) {\n    var tree = state.build().to(a).update(params);\n    return PluginCommands.State.Update(this.plugin, {\n      state: state,\n      tree: tree,\n      options: {\n        canUndo: canUndo\n      }\n    });\n  };\n\n  PluginState.prototype.updateBehavior = function (behavior, params) {\n    var tree = this.behaviors.build();\n\n    if (!this.behaviors.tree.transforms.has(behavior.id)) {\n      var defaultParams = behavior.createDefaultParams(void 0, this.plugin);\n      tree.to(PluginBehavior.getCategoryId(behavior)).apply(behavior, produce(defaultParams, params), {\n        ref: behavior.id\n      });\n    } else {\n      tree.to(behavior.id).update(params);\n    }\n\n    return this.plugin.runTask(this.behaviors.updateTree(tree));\n  };\n\n  PluginState.prototype.dispose = function () {\n    this.behaviors.cells.forEach(function (cell) {\n      if (PluginBehavior.Behavior.is(cell.obj)) {\n        cell.obj.data.unregister();\n      }\n    });\n\n    _super.prototype.dispose.call(this);\n\n    this.data.dispose();\n    this.behaviors.dispose();\n    this.animation.dispose();\n  };\n\n  return PluginState;\n}(PluginComponent);\n\n(function (PluginState) {\n  PluginState.SnapshotParams = {\n    durationInMs: PD.Numeric(1500, {\n      min: 100,\n      max: 15000,\n      step: 100\n    }, {\n      label: 'Duration in ms'\n    }),\n    data: PD.Boolean(true),\n    behavior: PD.Boolean(false),\n    animation: PD.Boolean(true),\n    startAnimation: PD.Boolean(false),\n    canvas3d: PD.Boolean(true),\n    interactivity: PD.Boolean(true),\n    camera: PD.Boolean(true),\n    cameraTransition: PD.MappedStatic('animate', {\n      animate: PD.Group({\n        durationInMs: PD.Numeric(250, {\n          min: 100,\n          max: 5000,\n          step: 500\n        }, {\n          label: 'Duration in ms'\n        })\n      }),\n      instant: PD.Group({})\n    }, {\n      options: [['animate', 'Animate'], ['instant', 'Instant']]\n    })\n  };\n  PluginState.DefaultSnapshotParams = PD.getDefaultValues(PluginState.SnapshotParams);\n})(PluginState || (PluginState = {}));","map":{"version":3,"sources":["../../src/mol-plugin/state.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2018-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\r\nimport { __assign, __awaiter, __extends, __generator } from \"tslib\";\r\nimport { State } from '../mol-state';\r\nimport { PluginStateObject as SO } from '../mol-plugin-state/objects';\r\nimport { PluginBehavior } from './behavior';\r\nimport { Canvas3DParams } from '../mol-canvas3d/canvas3d';\r\nimport { PluginCommands } from './commands';\r\nimport { ParamDefinition as PD } from '../mol-util/param-definition';\r\nimport { UUID } from '../mol-util';\r\nimport { produce } from 'immer';\r\nimport { merge } from 'rxjs';\r\nimport { PluginComponent } from '../mol-plugin-state/component';\r\nimport { PluginConfig } from './config';\r\nexport { PluginState };\r\nvar PluginState = /** @class */ (function (_super) {\r\n    __extends(PluginState, _super);\r\n    function PluginState(plugin) {\r\n        var _this = _super.call(this) || this;\r\n        _this.plugin = plugin;\r\n        _this.data = State.create(new SO.Root({}), { runTask: _this.plugin.runTask, globalContext: _this.plugin, historyCapacity: _this.plugin.config.get(PluginConfig.State.HistoryCapacity) });\r\n        _this.behaviors = State.create(new PluginBehavior.Root({}), { runTask: _this.plugin.runTask, globalContext: _this.plugin, rootState: { isLocked: true } });\r\n        _this.events = {\r\n            cell: {\r\n                stateUpdated: merge(_this.data.events.cell.stateUpdated, _this.behaviors.events.cell.stateUpdated),\r\n                created: merge(_this.data.events.cell.created, _this.behaviors.events.cell.created),\r\n                removed: merge(_this.data.events.cell.removed, _this.behaviors.events.cell.removed),\r\n            },\r\n            object: {\r\n                created: merge(_this.data.events.object.created, _this.behaviors.events.object.created),\r\n                removed: merge(_this.data.events.object.removed, _this.behaviors.events.object.removed),\r\n                updated: merge(_this.data.events.object.updated, _this.behaviors.events.object.updated)\r\n            }\r\n        };\r\n        _this.snapshotParams = _this.ev.behavior(PluginState.DefaultSnapshotParams);\r\n        _this.setSnapshotParams = function (params) {\r\n            _this.snapshotParams.next(__assign(__assign({}, PluginState.DefaultSnapshotParams), params));\r\n        };\r\n        return _this;\r\n    }\r\n    Object.defineProperty(PluginState.prototype, \"animation\", {\r\n        get: function () { return this.plugin.managers.animation; },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    PluginState.prototype.getSnapshot = function (params) {\r\n        var _a, _b;\r\n        var p = __assign(__assign({}, this.snapshotParams.value), params);\r\n        return {\r\n            id: UUID.create22(),\r\n            data: p.data ? this.data.getSnapshot() : void 0,\r\n            behaviour: p.behavior ? this.behaviors.getSnapshot() : void 0,\r\n            animation: p.animation ? this.animation.getSnapshot() : void 0,\r\n            startAnimation: p.startAnimation ? !!p.startAnimation : void 0,\r\n            camera: p.camera ? {\r\n                current: this.plugin.canvas3d.camera.getSnapshot(),\r\n                transitionStyle: p.cameraTransition.name,\r\n                transitionDurationInMs: ((_a = p === null || p === void 0 ? void 0 : p.cameraTransition) === null || _a === void 0 ? void 0 : _a.name) === 'animate' ? p.cameraTransition.params.durationInMs : void 0\r\n            } : void 0,\r\n            canvas3d: p.canvas3d ? { props: (_b = this.plugin.canvas3d) === null || _b === void 0 ? void 0 : _b.props } : void 0,\r\n            interactivity: p.interactivity ? { props: this.plugin.managers.interactivity.props } : void 0,\r\n            structureFocus: this.plugin.managers.structure.focus.getSnapshot(),\r\n            durationInMs: p === null || p === void 0 ? void 0 : p.durationInMs\r\n        };\r\n    };\r\n    PluginState.prototype.setSnapshot = function (snapshot) {\r\n        var _a;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var settings;\r\n            return __generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0: return [4 /*yield*/, this.animation.stop()];\r\n                    case 1:\r\n                        _b.sent();\r\n                        if (!snapshot.behaviour) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, this.plugin.runTask(this.behaviors.setSnapshot(snapshot.behaviour))];\r\n                    case 2:\r\n                        _b.sent();\r\n                        _b.label = 3;\r\n                    case 3:\r\n                        if (!snapshot.data) return [3 /*break*/, 5];\r\n                        return [4 /*yield*/, this.plugin.runTask(this.data.setSnapshot(snapshot.data))];\r\n                    case 4:\r\n                        _b.sent();\r\n                        _b.label = 5;\r\n                    case 5:\r\n                        if (!((_a = snapshot.canvas3d) === null || _a === void 0 ? void 0 : _a.props)) return [3 /*break*/, 7];\r\n                        settings = PD.normalizeParams(Canvas3DParams, snapshot.canvas3d.props, 'children');\r\n                        return [4 /*yield*/, PluginCommands.Canvas3D.SetSettings(this.plugin, { settings: settings })];\r\n                    case 6:\r\n                        _b.sent();\r\n                        _b.label = 7;\r\n                    case 7:\r\n                        if (snapshot.interactivity) {\r\n                            if (snapshot.interactivity.props)\r\n                                this.plugin.managers.interactivity.setProps(snapshot.interactivity.props);\r\n                        }\r\n                        if (snapshot.structureFocus) {\r\n                            this.plugin.managers.structure.focus.setSnapshot(snapshot.structureFocus);\r\n                        }\r\n                        if (snapshot.animation) {\r\n                            this.animation.setSnapshot(snapshot.animation);\r\n                        }\r\n                        if (snapshot.camera) {\r\n                            PluginCommands.Camera.Reset(this.plugin, {\r\n                                snapshot: snapshot.camera.current,\r\n                                durationMs: snapshot.camera.transitionStyle === 'animate'\r\n                                    ? snapshot.camera.transitionDurationInMs\r\n                                    : void 0\r\n                            });\r\n                        }\r\n                        if (snapshot.startAnimation) {\r\n                            this.animation.start();\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    PluginState.prototype.updateTransform = function (state, a, params, canUndo) {\r\n        var tree = state.build().to(a).update(params);\r\n        return PluginCommands.State.Update(this.plugin, { state: state, tree: tree, options: { canUndo: canUndo } });\r\n    };\r\n    PluginState.prototype.updateBehavior = function (behavior, params) {\r\n        var tree = this.behaviors.build();\r\n        if (!this.behaviors.tree.transforms.has(behavior.id)) {\r\n            var defaultParams = behavior.createDefaultParams(void 0, this.plugin);\r\n            tree.to(PluginBehavior.getCategoryId(behavior)).apply(behavior, produce(defaultParams, params), { ref: behavior.id });\r\n        }\r\n        else {\r\n            tree.to(behavior.id).update(params);\r\n        }\r\n        return this.plugin.runTask(this.behaviors.updateTree(tree));\r\n    };\r\n    PluginState.prototype.dispose = function () {\r\n        this.behaviors.cells.forEach(function (cell) {\r\n            if (PluginBehavior.Behavior.is(cell.obj)) {\r\n                cell.obj.data.unregister();\r\n            }\r\n        });\r\n        _super.prototype.dispose.call(this);\r\n        this.data.dispose();\r\n        this.behaviors.dispose();\r\n        this.animation.dispose();\r\n    };\r\n    return PluginState;\r\n}(PluginComponent));\r\n(function (PluginState) {\r\n    PluginState.SnapshotParams = {\r\n        durationInMs: PD.Numeric(1500, { min: 100, max: 15000, step: 100 }, { label: 'Duration in ms' }),\r\n        data: PD.Boolean(true),\r\n        behavior: PD.Boolean(false),\r\n        animation: PD.Boolean(true),\r\n        startAnimation: PD.Boolean(false),\r\n        canvas3d: PD.Boolean(true),\r\n        interactivity: PD.Boolean(true),\r\n        camera: PD.Boolean(true),\r\n        cameraTransition: PD.MappedStatic('animate', {\r\n            animate: PD.Group({\r\n                durationInMs: PD.Numeric(250, { min: 100, max: 5000, step: 500 }, { label: 'Duration in ms' }),\r\n            }),\r\n            instant: PD.Group({})\r\n        }, { options: [['animate', 'Animate'], ['instant', 'Instant']] })\r\n    };\r\n    PluginState.DefaultSnapshotParams = PD.getDefaultValues(PluginState.SnapshotParams);\r\n})(PluginState || (PluginState = {}));\r\n//# sourceMappingURL=state.js.map"]},"metadata":{},"sourceType":"module"}