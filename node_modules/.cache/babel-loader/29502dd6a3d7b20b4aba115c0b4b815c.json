{"ast":null,"code":"/**\r\n * Copyright (c) 2017-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\nimport { Interval, Segmentation, SortedArray } from '../../../../../mol-data/int';\nimport { AtomicIndex, AtomicHierarchy } from '../atomic/hierarchy';\nimport { cantorPairing } from '../../../../../mol-data/util';\n\nfunction getResidueId(seq_id, ins_code) {\n  if (!ins_code) return seq_id;\n  if (ins_code.length === 1) return cantorPairing(ins_code.charCodeAt(0), seq_id);\n  if (ins_code.length === 2) return cantorPairing(ins_code.charCodeAt(0), cantorPairing(ins_code.charCodeAt(1), seq_id));\n  return seq_id + \" \" + ins_code;\n}\n\nfunction updateMapMapIndex(map, key0, key1, index) {\n  if (map.has(key0)) {\n    var submap = map.get(key0);\n\n    if (!submap.has(key1)) {\n      submap.set(key1, index);\n    }\n  } else {\n    var submap = new Map();\n    map.set(key0, submap);\n    submap.set(key1, index);\n  }\n}\n\nfunction missingEntity(k) {\n  throw new Error(\"Missing entity entry for entity id '\" + k + \"'.\");\n}\n\nfunction createMapping(entities, data, segments) {\n  return {\n    entities: entities,\n    segments: segments,\n    label_seq_id: SortedArray.ofSortedArray(data.residues.label_seq_id.toArray({\n      array: Int32Array\n    })),\n    label_atom_id: data.atoms.label_atom_id,\n    auth_atom_id: data.atoms.auth_atom_id,\n    label_alt_id: data.atoms.label_alt_id,\n    chain_index_entity_index: new Int32Array(data.chains._rowCount),\n    entity_index_label_asym_id: new Map(),\n    chain_index_label_seq_id: new Map(),\n    auth_asym_id_auth_seq_id: new Map(),\n    chain_index_auth_seq_id: new Map(),\n    label_asym_id: new Map()\n  };\n}\n\nvar _tempResidueKey = AtomicIndex.EmptyResidueKey();\n\nvar Index =\n/** @class */\nfunction () {\n  function Index(map) {\n    this.map = map;\n    this.entityIndex = map.entities.getEntityIndex;\n    this.residueOffsets = this.map.segments.residueAtomSegments.offsets;\n  }\n\n  Index.prototype.getEntityFromChain = function (cI) {\n    return this.map.chain_index_entity_index[cI];\n  };\n\n  Index.prototype.findEntity = function (label_asym_id) {\n    var entityIndex = this.map.label_asym_id.get(label_asym_id);\n    return entityIndex !== undefined ? entityIndex : -1;\n  };\n\n  Index.prototype.findChainLabel = function (key) {\n    var eI = this.entityIndex(key.label_entity_id);\n    if (eI < 0 || !this.map.entity_index_label_asym_id.has(eI)) return -1;\n    var cm = this.map.entity_index_label_asym_id.get(eI);\n    if (!cm) return -1;\n    return cm.has(key.label_asym_id) ? cm.get(key.label_asym_id) : -1;\n  };\n\n  Index.prototype.findChainAuth = function (key) {\n    if (!this.map.auth_asym_id_auth_seq_id.has(key.auth_asym_id)) return -1;\n    var rm = this.map.auth_asym_id_auth_seq_id.get(key.auth_asym_id);\n    return rm.has(key.auth_seq_id) ? rm.get(key.auth_seq_id) : -1;\n  };\n\n  Index.prototype.findResidue = function (label_entity_id_or_key, label_asym_id, auth_seq_id, pdbx_PDB_ins_code) {\n    var key;\n\n    if (arguments.length === 1) {\n      key = label_entity_id_or_key;\n    } else {\n      _tempResidueKey.label_entity_id = label_entity_id_or_key;\n      _tempResidueKey.label_asym_id = label_asym_id;\n      _tempResidueKey.auth_seq_id = auth_seq_id;\n      _tempResidueKey.pdbx_PDB_ins_code = pdbx_PDB_ins_code;\n      key = _tempResidueKey;\n    }\n\n    var cI = this.findChainLabel(key);\n    if (cI < 0) return -1;\n    var rm = this.map.chain_index_auth_seq_id.get(cI);\n    var id = getResidueId(key.auth_seq_id, key.pdbx_PDB_ins_code || '');\n    return rm.has(id) ? rm.get(id) : -1;\n  };\n\n  Index.prototype.findResidueAuth = function (key) {\n    var cI = this.findChainAuth(key);\n    if (cI < 0) return -1;\n    var rm = this.map.chain_index_auth_seq_id.get(cI);\n    var id = getResidueId(key.auth_seq_id, key.pdbx_PDB_ins_code || '');\n    return rm.has(id) ? rm.get(id) : -1;\n  };\n\n  Index.prototype.findResidueInsertion = function (key) {\n    var cI = this.findChainLabel(key);\n    if (cI < 0) return -1;\n    var rm = this.map.chain_index_label_seq_id.get(cI);\n    var id = getResidueId(key.label_seq_id, key.pdbx_PDB_ins_code || '');\n    if (rm.has(id)) return rm.get(id);\n    var idx = SortedArray.findPredecessorIndex(this.map.label_seq_id, key.label_seq_id);\n    var start = AtomicHierarchy.chainStartResidueIndex(this.map.segments, cI);\n    if (idx < start) return start;\n    var end = AtomicHierarchy.chainEndResidueIndexExcl(this.map.segments, cI) - 1;\n    if (idx >= end) return end;\n    return idx;\n  };\n\n  Index.prototype.findAtom = function (key) {\n    var rI = this.findResidue(key);\n    if (rI < 0) return -1;\n\n    if (typeof key.label_alt_id === 'undefined') {\n      return findAtomByName(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.label_atom_id, key.label_atom_id);\n    }\n\n    return findAtomByNameAndAltLoc(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.label_atom_id, this.map.label_alt_id, key.label_atom_id, key.label_alt_id);\n  };\n\n  Index.prototype.findAtomAuth = function (key) {\n    var rI = this.findResidueAuth(key);\n    if (rI < 0) return -1;\n\n    if (typeof key.label_alt_id === 'undefined') {\n      return findAtomByName(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.auth_atom_id, key.auth_atom_id);\n    }\n\n    return findAtomByNameAndAltLoc(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.auth_atom_id, this.map.label_alt_id, key.auth_atom_id, key.label_alt_id);\n  };\n\n  Index.prototype.findAtomOnResidue = function (rI, label_atom_id, label_alt_id) {\n    if (typeof label_alt_id === 'undefined') {\n      return findAtomByName(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.label_atom_id, label_atom_id);\n    }\n\n    return findAtomByNameAndAltLoc(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.label_atom_id, this.map.label_alt_id, label_atom_id, label_alt_id);\n  };\n\n  Index.prototype.findAtomsOnResidue = function (rI, label_atom_ids) {\n    return findAtomByNames(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.label_atom_id, label_atom_ids);\n  };\n\n  return Index;\n}();\n\nfunction findAtomByName(start, end, data, atomName) {\n  for (var i = start; i < end; i++) {\n    if (data.value(i) === atomName) return i;\n  }\n\n  return -1;\n}\n\nfunction findAtomByNames(start, end, data, atomNames) {\n  for (var i = start; i < end; i++) {\n    if (atomNames.has(data.value(i))) return i;\n  }\n\n  return -1;\n}\n\nfunction findAtomByNameAndAltLoc(start, end, nameData, altLocData, atomName, altLoc) {\n  for (var i = start; i < end; i++) {\n    if (nameData.value(i) === atomName && altLocData.value(i) === altLoc) return i;\n  }\n\n  return -1;\n}\n\nexport function getAtomicIndex(data, entities, segments) {\n  var map = createMapping(entities, data, segments);\n  var _a = data.residues,\n      label_seq_id = _a.label_seq_id,\n      auth_seq_id = _a.auth_seq_id,\n      pdbx_PDB_ins_code = _a.pdbx_PDB_ins_code;\n  var _b = data.chains,\n      label_entity_id = _b.label_entity_id,\n      label_asym_id = _b.label_asym_id,\n      auth_asym_id = _b.auth_asym_id;\n  var atomSet = Interval.ofBounds(0, data.atoms._rowCount);\n  var chainsIt = Segmentation.transientSegments(segments.chainAtomSegments, atomSet);\n\n  while (chainsIt.hasNext) {\n    var chainSegment = chainsIt.move();\n    var chainIndex = chainSegment.index;\n    var entityIndex = entities.getEntityIndex(label_entity_id.value(chainIndex));\n    if (entityIndex < 0) missingEntity(label_entity_id.value(chainIndex));\n    map.chain_index_entity_index[chainIndex] = entityIndex;\n    var authAsymId = auth_asym_id.value(chainIndex);\n    var auth_asym_id_auth_seq_id = map.auth_asym_id_auth_seq_id.get(authAsymId);\n\n    if (!auth_asym_id_auth_seq_id) {\n      auth_asym_id_auth_seq_id = new Map();\n      map.auth_asym_id_auth_seq_id.set(authAsymId, auth_asym_id_auth_seq_id);\n    }\n\n    var labelAsymId = label_asym_id.value(chainIndex);\n    if (!map.label_asym_id.has(labelAsymId)) map.label_asym_id.set(labelAsymId, entityIndex);\n    updateMapMapIndex(map.entity_index_label_asym_id, entityIndex, labelAsymId, chainIndex);\n    var chain_index_label_seq_id = new Map();\n    var chain_index_auth_seq_id = new Map();\n    map.chain_index_label_seq_id.set(chainIndex, chain_index_label_seq_id);\n    map.chain_index_auth_seq_id.set(chainIndex, chain_index_auth_seq_id);\n    var residuesIt = Segmentation.transientSegments(segments.residueAtomSegments, atomSet, chainSegment);\n\n    while (residuesIt.hasNext) {\n      var residueSegment = residuesIt.move();\n      var rI = residueSegment.index;\n      var authSeqId = auth_seq_id.value(rI);\n      var insCode = pdbx_PDB_ins_code.value(rI);\n      chain_index_label_seq_id.set(getResidueId(label_seq_id.value(rI), insCode), rI);\n      chain_index_auth_seq_id.set(getResidueId(authSeqId, insCode), rI);\n      auth_asym_id_auth_seq_id.set(authSeqId, chainIndex);\n    }\n  }\n\n  return new Index(map);\n}","map":{"version":3,"sources":["../../../../../../src/mol-model/structure/model/properties/utils/atomic-index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2017-2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { Interval, Segmentation, SortedArray } from '../../../../../mol-data/int';\r\nimport { AtomicIndex, AtomicHierarchy } from '../atomic/hierarchy';\r\nimport { cantorPairing } from '../../../../../mol-data/util';\r\nfunction getResidueId(seq_id, ins_code) {\r\n    if (!ins_code)\r\n        return seq_id;\r\n    if (ins_code.length === 1)\r\n        return cantorPairing(ins_code.charCodeAt(0), seq_id);\r\n    if (ins_code.length === 2)\r\n        return cantorPairing(ins_code.charCodeAt(0), cantorPairing(ins_code.charCodeAt(1), seq_id));\r\n    return seq_id + \" \" + ins_code;\r\n}\r\nfunction updateMapMapIndex(map, key0, key1, index) {\r\n    if (map.has(key0)) {\r\n        var submap = map.get(key0);\r\n        if (!submap.has(key1)) {\r\n            submap.set(key1, index);\r\n        }\r\n    }\r\n    else {\r\n        var submap = new Map();\r\n        map.set(key0, submap);\r\n        submap.set(key1, index);\r\n    }\r\n}\r\nfunction missingEntity(k) {\r\n    throw new Error(\"Missing entity entry for entity id '\" + k + \"'.\");\r\n}\r\nfunction createMapping(entities, data, segments) {\r\n    return {\r\n        entities: entities,\r\n        segments: segments,\r\n        label_seq_id: SortedArray.ofSortedArray(data.residues.label_seq_id.toArray({ array: Int32Array })),\r\n        label_atom_id: data.atoms.label_atom_id,\r\n        auth_atom_id: data.atoms.auth_atom_id,\r\n        label_alt_id: data.atoms.label_alt_id,\r\n        chain_index_entity_index: new Int32Array(data.chains._rowCount),\r\n        entity_index_label_asym_id: new Map(),\r\n        chain_index_label_seq_id: new Map(),\r\n        auth_asym_id_auth_seq_id: new Map(),\r\n        chain_index_auth_seq_id: new Map(),\r\n        label_asym_id: new Map(),\r\n    };\r\n}\r\nvar _tempResidueKey = AtomicIndex.EmptyResidueKey();\r\nvar Index = /** @class */ (function () {\r\n    function Index(map) {\r\n        this.map = map;\r\n        this.entityIndex = map.entities.getEntityIndex;\r\n        this.residueOffsets = this.map.segments.residueAtomSegments.offsets;\r\n    }\r\n    Index.prototype.getEntityFromChain = function (cI) {\r\n        return this.map.chain_index_entity_index[cI];\r\n    };\r\n    Index.prototype.findEntity = function (label_asym_id) {\r\n        var entityIndex = this.map.label_asym_id.get(label_asym_id);\r\n        return entityIndex !== undefined ? entityIndex : -1;\r\n    };\r\n    Index.prototype.findChainLabel = function (key) {\r\n        var eI = this.entityIndex(key.label_entity_id);\r\n        if (eI < 0 || !this.map.entity_index_label_asym_id.has(eI))\r\n            return -1;\r\n        var cm = this.map.entity_index_label_asym_id.get(eI);\r\n        if (!cm)\r\n            return -1;\r\n        return cm.has(key.label_asym_id) ? cm.get(key.label_asym_id) : -1;\r\n    };\r\n    Index.prototype.findChainAuth = function (key) {\r\n        if (!this.map.auth_asym_id_auth_seq_id.has(key.auth_asym_id))\r\n            return -1;\r\n        var rm = this.map.auth_asym_id_auth_seq_id.get(key.auth_asym_id);\r\n        return rm.has(key.auth_seq_id) ? rm.get(key.auth_seq_id) : -1;\r\n    };\r\n    Index.prototype.findResidue = function (label_entity_id_or_key, label_asym_id, auth_seq_id, pdbx_PDB_ins_code) {\r\n        var key;\r\n        if (arguments.length === 1) {\r\n            key = label_entity_id_or_key;\r\n        }\r\n        else {\r\n            _tempResidueKey.label_entity_id = label_entity_id_or_key;\r\n            _tempResidueKey.label_asym_id = label_asym_id;\r\n            _tempResidueKey.auth_seq_id = auth_seq_id;\r\n            _tempResidueKey.pdbx_PDB_ins_code = pdbx_PDB_ins_code;\r\n            key = _tempResidueKey;\r\n        }\r\n        var cI = this.findChainLabel(key);\r\n        if (cI < 0)\r\n            return -1;\r\n        var rm = this.map.chain_index_auth_seq_id.get(cI);\r\n        var id = getResidueId(key.auth_seq_id, key.pdbx_PDB_ins_code || '');\r\n        return rm.has(id) ? rm.get(id) : -1;\r\n    };\r\n    Index.prototype.findResidueAuth = function (key) {\r\n        var cI = this.findChainAuth(key);\r\n        if (cI < 0)\r\n            return -1;\r\n        var rm = this.map.chain_index_auth_seq_id.get(cI);\r\n        var id = getResidueId(key.auth_seq_id, key.pdbx_PDB_ins_code || '');\r\n        return rm.has(id) ? rm.get(id) : -1;\r\n    };\r\n    Index.prototype.findResidueInsertion = function (key) {\r\n        var cI = this.findChainLabel(key);\r\n        if (cI < 0)\r\n            return -1;\r\n        var rm = this.map.chain_index_label_seq_id.get(cI);\r\n        var id = getResidueId(key.label_seq_id, key.pdbx_PDB_ins_code || '');\r\n        if (rm.has(id))\r\n            return rm.get(id);\r\n        var idx = SortedArray.findPredecessorIndex(this.map.label_seq_id, key.label_seq_id);\r\n        var start = AtomicHierarchy.chainStartResidueIndex(this.map.segments, cI);\r\n        if (idx < start)\r\n            return start;\r\n        var end = AtomicHierarchy.chainEndResidueIndexExcl(this.map.segments, cI) - 1;\r\n        if (idx >= end)\r\n            return end;\r\n        return idx;\r\n    };\r\n    Index.prototype.findAtom = function (key) {\r\n        var rI = this.findResidue(key);\r\n        if (rI < 0)\r\n            return -1;\r\n        if (typeof key.label_alt_id === 'undefined') {\r\n            return findAtomByName(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.label_atom_id, key.label_atom_id);\r\n        }\r\n        return findAtomByNameAndAltLoc(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.label_atom_id, this.map.label_alt_id, key.label_atom_id, key.label_alt_id);\r\n    };\r\n    Index.prototype.findAtomAuth = function (key) {\r\n        var rI = this.findResidueAuth(key);\r\n        if (rI < 0)\r\n            return -1;\r\n        if (typeof key.label_alt_id === 'undefined') {\r\n            return findAtomByName(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.auth_atom_id, key.auth_atom_id);\r\n        }\r\n        return findAtomByNameAndAltLoc(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.auth_atom_id, this.map.label_alt_id, key.auth_atom_id, key.label_alt_id);\r\n    };\r\n    Index.prototype.findAtomOnResidue = function (rI, label_atom_id, label_alt_id) {\r\n        if (typeof label_alt_id === 'undefined') {\r\n            return findAtomByName(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.label_atom_id, label_atom_id);\r\n        }\r\n        return findAtomByNameAndAltLoc(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.label_atom_id, this.map.label_alt_id, label_atom_id, label_alt_id);\r\n    };\r\n    Index.prototype.findAtomsOnResidue = function (rI, label_atom_ids) {\r\n        return findAtomByNames(this.residueOffsets[rI], this.residueOffsets[rI + 1], this.map.label_atom_id, label_atom_ids);\r\n    };\r\n    return Index;\r\n}());\r\nfunction findAtomByName(start, end, data, atomName) {\r\n    for (var i = start; i < end; i++) {\r\n        if (data.value(i) === atomName)\r\n            return i;\r\n    }\r\n    return -1;\r\n}\r\nfunction findAtomByNames(start, end, data, atomNames) {\r\n    for (var i = start; i < end; i++) {\r\n        if (atomNames.has(data.value(i)))\r\n            return i;\r\n    }\r\n    return -1;\r\n}\r\nfunction findAtomByNameAndAltLoc(start, end, nameData, altLocData, atomName, altLoc) {\r\n    for (var i = start; i < end; i++) {\r\n        if (nameData.value(i) === atomName && altLocData.value(i) === altLoc)\r\n            return i;\r\n    }\r\n    return -1;\r\n}\r\nexport function getAtomicIndex(data, entities, segments) {\r\n    var map = createMapping(entities, data, segments);\r\n    var _a = data.residues, label_seq_id = _a.label_seq_id, auth_seq_id = _a.auth_seq_id, pdbx_PDB_ins_code = _a.pdbx_PDB_ins_code;\r\n    var _b = data.chains, label_entity_id = _b.label_entity_id, label_asym_id = _b.label_asym_id, auth_asym_id = _b.auth_asym_id;\r\n    var atomSet = Interval.ofBounds(0, data.atoms._rowCount);\r\n    var chainsIt = Segmentation.transientSegments(segments.chainAtomSegments, atomSet);\r\n    while (chainsIt.hasNext) {\r\n        var chainSegment = chainsIt.move();\r\n        var chainIndex = chainSegment.index;\r\n        var entityIndex = entities.getEntityIndex(label_entity_id.value(chainIndex));\r\n        if (entityIndex < 0)\r\n            missingEntity(label_entity_id.value(chainIndex));\r\n        map.chain_index_entity_index[chainIndex] = entityIndex;\r\n        var authAsymId = auth_asym_id.value(chainIndex);\r\n        var auth_asym_id_auth_seq_id = map.auth_asym_id_auth_seq_id.get(authAsymId);\r\n        if (!auth_asym_id_auth_seq_id) {\r\n            auth_asym_id_auth_seq_id = new Map();\r\n            map.auth_asym_id_auth_seq_id.set(authAsymId, auth_asym_id_auth_seq_id);\r\n        }\r\n        var labelAsymId = label_asym_id.value(chainIndex);\r\n        if (!map.label_asym_id.has(labelAsymId))\r\n            map.label_asym_id.set(labelAsymId, entityIndex);\r\n        updateMapMapIndex(map.entity_index_label_asym_id, entityIndex, labelAsymId, chainIndex);\r\n        var chain_index_label_seq_id = new Map();\r\n        var chain_index_auth_seq_id = new Map();\r\n        map.chain_index_label_seq_id.set(chainIndex, chain_index_label_seq_id);\r\n        map.chain_index_auth_seq_id.set(chainIndex, chain_index_auth_seq_id);\r\n        var residuesIt = Segmentation.transientSegments(segments.residueAtomSegments, atomSet, chainSegment);\r\n        while (residuesIt.hasNext) {\r\n            var residueSegment = residuesIt.move();\r\n            var rI = residueSegment.index;\r\n            var authSeqId = auth_seq_id.value(rI);\r\n            var insCode = pdbx_PDB_ins_code.value(rI);\r\n            chain_index_label_seq_id.set(getResidueId(label_seq_id.value(rI), insCode), rI);\r\n            chain_index_auth_seq_id.set(getResidueId(authSeqId, insCode), rI);\r\n            auth_asym_id_auth_seq_id.set(authSeqId, chainIndex);\r\n        }\r\n    }\r\n    return new Index(map);\r\n}\r\n//# sourceMappingURL=atomic-index.js.map"]},"metadata":{},"sourceType":"module"}