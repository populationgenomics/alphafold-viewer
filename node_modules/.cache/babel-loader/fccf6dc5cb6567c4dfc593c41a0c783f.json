{"ast":null,"code":"/**\r\n * Copyright (c) 2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\nimport { __assign, __extends } from \"tslib\";\nimport { StatefulPluginComponent } from '../../component';\nimport { arrayRemoveAtInPlace } from '../../../mol-util/array';\nimport { StructureElement } from '../../../mol-model/structure';\nimport { Loci } from '../../../mol-model/loci';\nimport { lociLabel } from '../../../mol-theme/label';\nimport { PluginStateObject } from '../../objects';\nimport { StateSelection } from '../../../mol-state';\nimport { Vec3 } from '../../../mol-math/linear-algebra';\nimport { Sphere3D } from '../../../mol-math/geometry';\nvar HISTORY_CAPACITY = 8;\n\nvar StructureFocusManager =\n/** @class */\nfunction (_super) {\n  __extends(StructureFocusManager, _super);\n\n  function StructureFocusManager(plugin) {\n    var _this = _super.call(this, {\n      history: []\n    }) || this;\n\n    _this.plugin = plugin;\n    _this.events = {\n      historyUpdated: _this.ev()\n    };\n    _this.behaviors = {\n      current: _this.ev.behavior(void 0)\n    };\n    plugin.state.data.events.object.removed.subscribe(function (_a) {\n      var _b;\n\n      var _c;\n\n      var obj = _a.obj;\n      if (!PluginStateObject.Molecule.Structure.is(obj)) return;\n\n      if (((_c = _this.current) === null || _c === void 0 ? void 0 : _c.loci.structure) === obj.data) {\n        _this.clear();\n      }\n\n      var keep = [];\n\n      for (var _i = 0, _d = _this.history; _i < _d.length; _i++) {\n        var e = _d[_i];\n        if (e.loci.structure === obj.data) keep.push(e);\n      }\n\n      if (keep.length !== _this.history.length) {\n        _this.history.length = 0;\n\n        (_b = _this.history).push.apply(_b, keep);\n\n        _this.events.historyUpdated.next(void 0);\n      }\n    });\n    var sphere = Sphere3D();\n    plugin.state.data.events.object.updated.subscribe(function (_a) {\n      var _b;\n\n      var oldData = _a.oldData,\n          obj = _a.obj,\n          action = _a.action;\n      if (!PluginStateObject.Molecule.Structure.is(obj)) return; // structure NOT changed, keep everything as is; fixes #123\n\n      if (oldData === obj.data) return; // structure changed (e.g. coordinates), try to remap and re-focus\n\n      if (action === 'in-place') {\n        var current = _this.state.current;\n        var structure = obj.data;\n\n        if (current && current.loci.structure === oldData) {\n          var loci = StructureElement.Loci.remap(current.loci, structure);\n          _this.state.current = __assign(__assign({}, current), {\n            loci: loci\n          });\n\n          _this.behaviors.current.next(_this.state.current);\n\n          Loci.getBoundingSphere(loci, sphere);\n          var camera = (_b = _this.plugin.canvas3d) === null || _b === void 0 ? void 0 : _b.camera;\n          var d = camera.getTargetDistance(sphere.radius + 4); // default extraRadius\n\n          if (Vec3.distance(camera.target, sphere.center) > sphere.radius || d > camera.viewport.height / camera.zoom) {\n            _this.plugin.managers.camera.focusSphere(sphere, {\n              durationMs: 0\n            });\n          }\n        } // TODO remap history as well\n\n      }\n    });\n    return _this;\n  }\n\n  Object.defineProperty(StructureFocusManager.prototype, \"current\", {\n    get: function () {\n      return this.state.current;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(StructureFocusManager.prototype, \"history\", {\n    get: function () {\n      return this.state.history;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  StructureFocusManager.prototype.tryAddHistory = function (entry) {\n    if (StructureElement.Loci.isEmpty(entry.loci)) return;\n    var idx = 0,\n        existingEntry = void 0;\n\n    for (var _i = 0, _a = this.state.history; _i < _a.length; _i++) {\n      var e = _a[_i];\n\n      if (StructureElement.Loci.areEqual(e.loci, entry.loci)) {\n        existingEntry = e;\n        break;\n      }\n\n      idx++;\n    }\n\n    if (existingEntry) {\n      // move to top, use new\n      arrayRemoveAtInPlace(this.state.history, idx);\n      this.state.history.unshift(entry);\n      this.events.historyUpdated.next(void 0);\n      return;\n    }\n\n    this.state.history.unshift(entry);\n    if (this.state.history.length > HISTORY_CAPACITY) this.state.history.pop();\n    this.events.historyUpdated.next(void 0);\n  };\n\n  StructureFocusManager.prototype.set = function (entry) {\n    this.tryAddHistory(entry);\n\n    if (!this.state.current || !StructureElement.Loci.areEqual(this.state.current.loci, entry.loci)) {\n      this.state.current = entry;\n      this.behaviors.current.next(entry);\n    }\n  };\n\n  StructureFocusManager.prototype.setFromLoci = function (anyLoci) {\n    var loci = Loci.normalize(anyLoci);\n\n    if (!StructureElement.Loci.is(loci) || StructureElement.Loci.isEmpty(loci)) {\n      this.clear();\n      return;\n    }\n\n    this.set({\n      loci: loci,\n      label: lociLabel(loci, {\n        reverse: true,\n        hidePrefix: true,\n        htmlStyling: false\n      })\n    });\n  };\n\n  StructureFocusManager.prototype.addFromLoci = function (anyLoci) {\n    var union = this.state.current && StructureElement.Loci.is(anyLoci) && anyLoci.structure === this.state.current.loci.structure ? StructureElement.Loci.union(anyLoci, this.state.current.loci) : anyLoci;\n    this.setFromLoci(union);\n  };\n\n  StructureFocusManager.prototype.clear = function () {\n    if (this.state.current) {\n      this.state.current = undefined;\n      this.behaviors.current.next(void 0);\n    }\n  };\n\n  StructureFocusManager.prototype.getSnapshot = function () {\n    if (!this.current) return {};\n    var node = this.plugin.helpers.substructureParent.get(this.current.loci.structure);\n    var ref = node === null || node === void 0 ? void 0 : node.transform.ref;\n    if (!ref) return {};\n    return {\n      current: {\n        label: this.current.label,\n        ref: ref,\n        bundle: StructureElement.Bundle.fromLoci(this.current.loci),\n        category: this.current.category\n      }\n    };\n  };\n\n  StructureFocusManager.prototype.setSnapshot = function (snapshot) {\n    var _a, _b;\n\n    if (!snapshot.current) {\n      this.clear();\n      return;\n    }\n\n    var _c = snapshot.current,\n        label = _c.label,\n        ref = _c.ref,\n        bundle = _c.bundle,\n        category = _c.category;\n    var structure = (_b = (_a = this.plugin.state.data.select(StateSelection.Generators.byRef(ref))[0]) === null || _a === void 0 ? void 0 : _a.obj) === null || _b === void 0 ? void 0 : _b.data;\n    if (!structure) return;\n    var loci = StructureElement.Bundle.toLoci(bundle, structure);\n    this.set({\n      label: label,\n      loci: loci,\n      category: category\n    });\n  };\n\n  return StructureFocusManager;\n}(StatefulPluginComponent);\n\nexport { StructureFocusManager };","map":{"version":3,"sources":["../../../../src/mol-plugin-state/manager/structure/focus.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2020 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\r\nimport { __assign, __extends } from \"tslib\";\r\nimport { StatefulPluginComponent } from '../../component';\r\nimport { arrayRemoveAtInPlace } from '../../../mol-util/array';\r\nimport { StructureElement } from '../../../mol-model/structure';\r\nimport { Loci } from '../../../mol-model/loci';\r\nimport { lociLabel } from '../../../mol-theme/label';\r\nimport { PluginStateObject } from '../../objects';\r\nimport { StateSelection } from '../../../mol-state';\r\nimport { Vec3 } from '../../../mol-math/linear-algebra';\r\nimport { Sphere3D } from '../../../mol-math/geometry';\r\nvar HISTORY_CAPACITY = 8;\r\nvar StructureFocusManager = /** @class */ (function (_super) {\r\n    __extends(StructureFocusManager, _super);\r\n    function StructureFocusManager(plugin) {\r\n        var _this = _super.call(this, { history: [] }) || this;\r\n        _this.plugin = plugin;\r\n        _this.events = {\r\n            historyUpdated: _this.ev()\r\n        };\r\n        _this.behaviors = {\r\n            current: _this.ev.behavior(void 0)\r\n        };\r\n        plugin.state.data.events.object.removed.subscribe(function (_a) {\r\n            var _b;\r\n            var _c;\r\n            var obj = _a.obj;\r\n            if (!PluginStateObject.Molecule.Structure.is(obj))\r\n                return;\r\n            if (((_c = _this.current) === null || _c === void 0 ? void 0 : _c.loci.structure) === obj.data) {\r\n                _this.clear();\r\n            }\r\n            var keep = [];\r\n            for (var _i = 0, _d = _this.history; _i < _d.length; _i++) {\r\n                var e = _d[_i];\r\n                if (e.loci.structure === obj.data)\r\n                    keep.push(e);\r\n            }\r\n            if (keep.length !== _this.history.length) {\r\n                _this.history.length = 0;\r\n                (_b = _this.history).push.apply(_b, keep);\r\n                _this.events.historyUpdated.next(void 0);\r\n            }\r\n        });\r\n        var sphere = Sphere3D();\r\n        plugin.state.data.events.object.updated.subscribe(function (_a) {\r\n            var _b;\r\n            var oldData = _a.oldData, obj = _a.obj, action = _a.action;\r\n            if (!PluginStateObject.Molecule.Structure.is(obj))\r\n                return;\r\n            // structure NOT changed, keep everything as is; fixes #123\r\n            if (oldData === obj.data)\r\n                return;\r\n            // structure changed (e.g. coordinates), try to remap and re-focus\r\n            if (action === 'in-place') {\r\n                var current = _this.state.current;\r\n                var structure = obj.data;\r\n                if (current && current.loci.structure === oldData) {\r\n                    var loci = StructureElement.Loci.remap(current.loci, structure);\r\n                    _this.state.current = __assign(__assign({}, current), { loci: loci });\r\n                    _this.behaviors.current.next(_this.state.current);\r\n                    Loci.getBoundingSphere(loci, sphere);\r\n                    var camera = (_b = _this.plugin.canvas3d) === null || _b === void 0 ? void 0 : _b.camera;\r\n                    var d = camera.getTargetDistance(sphere.radius + 4); // default extraRadius\r\n                    if (Vec3.distance(camera.target, sphere.center) > sphere.radius ||\r\n                        d > camera.viewport.height / camera.zoom) {\r\n                        _this.plugin.managers.camera.focusSphere(sphere, { durationMs: 0 });\r\n                    }\r\n                }\r\n                // TODO remap history as well\r\n            }\r\n        });\r\n        return _this;\r\n    }\r\n    Object.defineProperty(StructureFocusManager.prototype, \"current\", {\r\n        get: function () { return this.state.current; },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(StructureFocusManager.prototype, \"history\", {\r\n        get: function () { return this.state.history; },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    StructureFocusManager.prototype.tryAddHistory = function (entry) {\r\n        if (StructureElement.Loci.isEmpty(entry.loci))\r\n            return;\r\n        var idx = 0, existingEntry = void 0;\r\n        for (var _i = 0, _a = this.state.history; _i < _a.length; _i++) {\r\n            var e = _a[_i];\r\n            if (StructureElement.Loci.areEqual(e.loci, entry.loci)) {\r\n                existingEntry = e;\r\n                break;\r\n            }\r\n            idx++;\r\n        }\r\n        if (existingEntry) {\r\n            // move to top, use new\r\n            arrayRemoveAtInPlace(this.state.history, idx);\r\n            this.state.history.unshift(entry);\r\n            this.events.historyUpdated.next(void 0);\r\n            return;\r\n        }\r\n        this.state.history.unshift(entry);\r\n        if (this.state.history.length > HISTORY_CAPACITY)\r\n            this.state.history.pop();\r\n        this.events.historyUpdated.next(void 0);\r\n    };\r\n    StructureFocusManager.prototype.set = function (entry) {\r\n        this.tryAddHistory(entry);\r\n        if (!this.state.current || !StructureElement.Loci.areEqual(this.state.current.loci, entry.loci)) {\r\n            this.state.current = entry;\r\n            this.behaviors.current.next(entry);\r\n        }\r\n    };\r\n    StructureFocusManager.prototype.setFromLoci = function (anyLoci) {\r\n        var loci = Loci.normalize(anyLoci);\r\n        if (!StructureElement.Loci.is(loci) || StructureElement.Loci.isEmpty(loci)) {\r\n            this.clear();\r\n            return;\r\n        }\r\n        this.set({ loci: loci, label: lociLabel(loci, { reverse: true, hidePrefix: true, htmlStyling: false }) });\r\n    };\r\n    StructureFocusManager.prototype.addFromLoci = function (anyLoci) {\r\n        var union = this.state.current && StructureElement.Loci.is(anyLoci) && anyLoci.structure === this.state.current.loci.structure\r\n            ? StructureElement.Loci.union(anyLoci, this.state.current.loci)\r\n            : anyLoci;\r\n        this.setFromLoci(union);\r\n    };\r\n    StructureFocusManager.prototype.clear = function () {\r\n        if (this.state.current) {\r\n            this.state.current = undefined;\r\n            this.behaviors.current.next(void 0);\r\n        }\r\n    };\r\n    StructureFocusManager.prototype.getSnapshot = function () {\r\n        if (!this.current)\r\n            return {};\r\n        var node = this.plugin.helpers.substructureParent.get(this.current.loci.structure);\r\n        var ref = node === null || node === void 0 ? void 0 : node.transform.ref;\r\n        if (!ref)\r\n            return {};\r\n        return {\r\n            current: {\r\n                label: this.current.label,\r\n                ref: ref,\r\n                bundle: StructureElement.Bundle.fromLoci(this.current.loci),\r\n                category: this.current.category\r\n            }\r\n        };\r\n    };\r\n    StructureFocusManager.prototype.setSnapshot = function (snapshot) {\r\n        var _a, _b;\r\n        if (!snapshot.current) {\r\n            this.clear();\r\n            return;\r\n        }\r\n        var _c = snapshot.current, label = _c.label, ref = _c.ref, bundle = _c.bundle, category = _c.category;\r\n        var structure = (_b = (_a = this.plugin.state.data.select(StateSelection.Generators.byRef(ref))[0]) === null || _a === void 0 ? void 0 : _a.obj) === null || _b === void 0 ? void 0 : _b.data;\r\n        if (!structure)\r\n            return;\r\n        var loci = StructureElement.Bundle.toLoci(bundle, structure);\r\n        this.set({ label: label, loci: loci, category: category });\r\n    };\r\n    return StructureFocusManager;\r\n}(StatefulPluginComponent));\r\nexport { StructureFocusManager };\r\n//# sourceMappingURL=focus.js.map"]},"metadata":{},"sourceType":"module"}