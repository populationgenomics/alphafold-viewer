{"ast":null,"code":"/**\r\n * Copyright (c) 2018-2021 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\nimport { __assign } from \"tslib\";\nimport { Representation } from '../../mol-repr/representation';\nimport { ModifiersKeys, ButtonsType } from '../../mol-util/input/input-observer';\nimport { RxEventHelper } from '../../mol-util/rx-event-helper';\nimport { Vec2, Vec3 } from '../../mol-math/linear-algebra';\nimport { ParamDefinition as PD } from '../../mol-util/param-definition';\nimport { Bond } from '../../mol-model/structure';\nvar tmpPosA = Vec3();\nvar tmpPos = Vec3();\nvar tmpNorm = Vec3();\nexport var Canvas3dInteractionHelperParams = {\n  maxFps: PD.Numeric(30, {\n    min: 10,\n    max: 60,\n    step: 10\n  }),\n  preferAtomPixelPadding: PD.Numeric(3, {\n    min: 0,\n    max: 20,\n    step: 1\n  }, {\n    description: 'Number of extra pixels at which to prefer atoms over bonds.'\n  })\n};\n\nvar Canvas3dInteractionHelper =\n/** @class */\nfunction () {\n  function Canvas3dInteractionHelper(canvasIdentify, lociGetter, input, camera, props) {\n    var _this = this;\n\n    if (props === void 0) {\n      props = {};\n    }\n\n    this.canvasIdentify = canvasIdentify;\n    this.lociGetter = lociGetter;\n    this.input = input;\n    this.camera = camera;\n    this.ev = RxEventHelper.create();\n    this.events = {\n      hover: this.ev(),\n      drag: this.ev(),\n      click: this.ev()\n    };\n    this.startX = -1;\n    this.startY = -1;\n    this.endX = -1;\n    this.endY = -1;\n    this.id = void 0;\n    this.position = void 0;\n    this.currentIdentifyT = 0;\n    this.isInteracting = false;\n    this.prevLoci = Representation.Loci.Empty;\n    this.prevT = 0;\n    this.inside = false;\n    this.buttons = ButtonsType.create(0);\n    this.button = ButtonsType.create(0);\n    this.modifiers = ModifiersKeys.None;\n    this.props = __assign(__assign({}, PD.getDefaultValues(Canvas3dInteractionHelperParams)), props);\n    input.drag.subscribe(function (_a) {\n      var x = _a.x,\n          y = _a.y,\n          buttons = _a.buttons,\n          button = _a.button,\n          modifiers = _a.modifiers;\n      _this.isInteracting = true; // console.log('drag');\n\n      _this.drag(x, y, buttons, button, modifiers);\n    });\n    input.move.subscribe(function (_a) {\n      var x = _a.x,\n          y = _a.y,\n          inside = _a.inside,\n          buttons = _a.buttons,\n          button = _a.button,\n          modifiers = _a.modifiers;\n      if (!inside || _this.isInteracting) return; // console.log('move');\n\n      _this.move(x, y, buttons, button, modifiers);\n    });\n    input.leave.subscribe(function () {\n      // console.log('leave');\n      _this.leave();\n    });\n    input.click.subscribe(function (_a) {\n      var x = _a.x,\n          y = _a.y,\n          buttons = _a.buttons,\n          button = _a.button,\n          modifiers = _a.modifiers;\n      if (_this.outsideViewport(x, y)) return; // console.log('click');\n\n      _this.click(x, y, buttons, button, modifiers);\n    });\n    input.interactionEnd.subscribe(function () {\n      // console.log('interactionEnd');\n      _this.isInteracting = false;\n    });\n    input.modifiers.subscribe(function (modifiers) {\n      // console.log('modifiers');\n      _this.modify(modifiers);\n    });\n  }\n\n  Canvas3dInteractionHelper.prototype.setProps = function (props) {\n    Object.assign(this.props, props);\n  };\n\n  Canvas3dInteractionHelper.prototype.identify = function (e, t) {\n    var xyChanged = this.startX !== this.endX || this.startY !== this.endY;\n\n    if (e === 2\n    /* Drag */\n    ) {\n      if (xyChanged && !Representation.Loci.isEmpty(this.prevLoci)) {\n        this.events.drag.next({\n          current: this.prevLoci,\n          buttons: this.buttons,\n          button: this.button,\n          modifiers: this.modifiers,\n          pageStart: Vec2.create(this.startX, this.startY),\n          pageEnd: Vec2.create(this.endX, this.endY)\n        });\n        this.startX = this.endX;\n        this.startY = this.endY;\n      }\n\n      return;\n    }\n\n    if (xyChanged) {\n      var pickData = this.canvasIdentify(this.endX, this.endY);\n      this.id = pickData === null || pickData === void 0 ? void 0 : pickData.id;\n      this.position = pickData === null || pickData === void 0 ? void 0 : pickData.position;\n      this.startX = this.endX;\n      this.startY = this.endY;\n    }\n\n    if (e === 1\n    /* Click */\n    ) {\n      var loci_1 = this.getLoci(this.id, this.position);\n      this.events.click.next({\n        current: loci_1,\n        buttons: this.buttons,\n        button: this.button,\n        modifiers: this.modifiers,\n        page: Vec2.create(this.endX, this.endY),\n        position: this.position\n      });\n      this.prevLoci = loci_1;\n      return;\n    }\n\n    if (!this.inside || this.currentIdentifyT !== t || !xyChanged || this.outsideViewport(this.endX, this.endY)) return;\n    var loci = this.getLoci(this.id, this.position);\n    this.events.hover.next({\n      current: loci,\n      buttons: this.buttons,\n      button: this.button,\n      modifiers: this.modifiers,\n      page: Vec2.create(this.endX, this.endY),\n      position: this.position\n    });\n    this.prevLoci = loci;\n  };\n\n  Canvas3dInteractionHelper.prototype.tick = function (t) {\n    if (this.inside && t - this.prevT > 1000 / this.props.maxFps) {\n      this.prevT = t;\n      this.currentIdentifyT = t;\n      this.identify(this.isInteracting ? 2\n      /* Drag */\n      : 0\n      /* Move */\n      , t);\n    }\n  };\n\n  Canvas3dInteractionHelper.prototype.leave = function () {\n    this.inside = false;\n\n    if (!Representation.Loci.isEmpty(this.prevLoci)) {\n      this.prevLoci = Representation.Loci.Empty;\n      this.events.hover.next({\n        current: this.prevLoci,\n        buttons: this.buttons,\n        button: this.button,\n        modifiers: this.modifiers\n      });\n    }\n  };\n\n  Canvas3dInteractionHelper.prototype.move = function (x, y, buttons, button, modifiers) {\n    this.inside = true;\n    this.buttons = buttons;\n    this.button = button;\n    this.modifiers = modifiers;\n    this.endX = x;\n    this.endY = y;\n  };\n\n  Canvas3dInteractionHelper.prototype.click = function (x, y, buttons, button, modifiers) {\n    this.endX = x;\n    this.endY = y;\n    this.buttons = buttons;\n    this.button = button;\n    this.modifiers = modifiers;\n    this.identify(1\n    /* Click */\n    , 0);\n  };\n\n  Canvas3dInteractionHelper.prototype.drag = function (x, y, buttons, button, modifiers) {\n    this.endX = x;\n    this.endY = y;\n    this.buttons = buttons;\n    this.button = button;\n    this.modifiers = modifiers;\n    this.identify(2\n    /* Drag */\n    , 0);\n  };\n\n  Canvas3dInteractionHelper.prototype.modify = function (modifiers) {\n    if (ModifiersKeys.areEqual(modifiers, this.modifiers)) return;\n    this.modifiers = modifiers;\n    this.events.hover.next({\n      current: this.prevLoci,\n      buttons: this.buttons,\n      button: this.button,\n      modifiers: this.modifiers,\n      page: Vec2.create(this.endX, this.endY),\n      position: this.position\n    });\n  };\n\n  Canvas3dInteractionHelper.prototype.outsideViewport = function (x, y) {\n    var _a = this,\n        input = _a.input,\n        viewport = _a.camera.viewport;\n\n    x *= input.pixelRatio;\n    y *= input.pixelRatio;\n    return x > viewport.x + viewport.width || input.height - y > viewport.y + viewport.height || x < viewport.x || input.height - y < viewport.y;\n  };\n\n  Canvas3dInteractionHelper.prototype.getLoci = function (pickingId, position) {\n    var _a;\n\n    var _b = this.lociGetter(pickingId),\n        repr = _b.repr,\n        loci = _b.loci;\n\n    if (position && repr && Bond.isLoci(loci) && loci.bonds.length === 2) {\n      var _c = loci.bonds[0],\n          aUnit = _c.aUnit,\n          aIndex = _c.aIndex;\n      aUnit.conformation.position(aUnit.elements[aIndex], tmpPosA);\n      Vec3.sub(tmpNorm, this.camera.state.position, this.camera.state.target);\n      Vec3.projectPointOnPlane(tmpPos, position, tmpNorm, tmpPosA);\n      var pixelSize = this.camera.getPixelSize(tmpPos);\n      var radius = repr.theme.size.size(loci.bonds[0]) * ((_a = repr.props.sizeFactor) !== null && _a !== void 0 ? _a : 1);\n\n      if (repr.props.lineSizeAttenuation === false) {\n        // divide by two to get radius\n        radius *= pixelSize / 2;\n      }\n\n      radius += this.props.preferAtomPixelPadding * pixelSize;\n\n      if (Vec3.distance(tmpPos, tmpPosA) < radius) {\n        return {\n          repr: repr,\n          loci: Bond.toFirstStructureElementLoci(loci)\n        };\n      }\n    }\n\n    return {\n      repr: repr,\n      loci: loci\n    };\n  };\n\n  Canvas3dInteractionHelper.prototype.dispose = function () {\n    this.ev.dispose();\n  };\n\n  return Canvas3dInteractionHelper;\n}();\n\nexport { Canvas3dInteractionHelper };","map":{"version":3,"sources":["../../../src/mol-canvas3d/helper/interaction-events.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2018-2021 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n * @author Alexander Rose <alexander.rose@weirdbyte.de>\r\n */\r\nimport { __assign } from \"tslib\";\r\nimport { Representation } from '../../mol-repr/representation';\r\nimport { ModifiersKeys, ButtonsType } from '../../mol-util/input/input-observer';\r\nimport { RxEventHelper } from '../../mol-util/rx-event-helper';\r\nimport { Vec2, Vec3 } from '../../mol-math/linear-algebra';\r\nimport { ParamDefinition as PD } from '../../mol-util/param-definition';\r\nimport { Bond } from '../../mol-model/structure';\r\nvar tmpPosA = Vec3();\r\nvar tmpPos = Vec3();\r\nvar tmpNorm = Vec3();\r\nexport var Canvas3dInteractionHelperParams = {\r\n    maxFps: PD.Numeric(30, { min: 10, max: 60, step: 10 }),\r\n    preferAtomPixelPadding: PD.Numeric(3, { min: 0, max: 20, step: 1 }, { description: 'Number of extra pixels at which to prefer atoms over bonds.' }),\r\n};\r\nvar Canvas3dInteractionHelper = /** @class */ (function () {\r\n    function Canvas3dInteractionHelper(canvasIdentify, lociGetter, input, camera, props) {\r\n        var _this = this;\r\n        if (props === void 0) { props = {}; }\r\n        this.canvasIdentify = canvasIdentify;\r\n        this.lociGetter = lociGetter;\r\n        this.input = input;\r\n        this.camera = camera;\r\n        this.ev = RxEventHelper.create();\r\n        this.events = {\r\n            hover: this.ev(),\r\n            drag: this.ev(),\r\n            click: this.ev(),\r\n        };\r\n        this.startX = -1;\r\n        this.startY = -1;\r\n        this.endX = -1;\r\n        this.endY = -1;\r\n        this.id = void 0;\r\n        this.position = void 0;\r\n        this.currentIdentifyT = 0;\r\n        this.isInteracting = false;\r\n        this.prevLoci = Representation.Loci.Empty;\r\n        this.prevT = 0;\r\n        this.inside = false;\r\n        this.buttons = ButtonsType.create(0);\r\n        this.button = ButtonsType.create(0);\r\n        this.modifiers = ModifiersKeys.None;\r\n        this.props = __assign(__assign({}, PD.getDefaultValues(Canvas3dInteractionHelperParams)), props);\r\n        input.drag.subscribe(function (_a) {\r\n            var x = _a.x, y = _a.y, buttons = _a.buttons, button = _a.button, modifiers = _a.modifiers;\r\n            _this.isInteracting = true;\r\n            // console.log('drag');\r\n            _this.drag(x, y, buttons, button, modifiers);\r\n        });\r\n        input.move.subscribe(function (_a) {\r\n            var x = _a.x, y = _a.y, inside = _a.inside, buttons = _a.buttons, button = _a.button, modifiers = _a.modifiers;\r\n            if (!inside || _this.isInteracting)\r\n                return;\r\n            // console.log('move');\r\n            _this.move(x, y, buttons, button, modifiers);\r\n        });\r\n        input.leave.subscribe(function () {\r\n            // console.log('leave');\r\n            _this.leave();\r\n        });\r\n        input.click.subscribe(function (_a) {\r\n            var x = _a.x, y = _a.y, buttons = _a.buttons, button = _a.button, modifiers = _a.modifiers;\r\n            if (_this.outsideViewport(x, y))\r\n                return;\r\n            // console.log('click');\r\n            _this.click(x, y, buttons, button, modifiers);\r\n        });\r\n        input.interactionEnd.subscribe(function () {\r\n            // console.log('interactionEnd');\r\n            _this.isInteracting = false;\r\n        });\r\n        input.modifiers.subscribe(function (modifiers) {\r\n            // console.log('modifiers');\r\n            _this.modify(modifiers);\r\n        });\r\n    }\r\n    Canvas3dInteractionHelper.prototype.setProps = function (props) {\r\n        Object.assign(this.props, props);\r\n    };\r\n    Canvas3dInteractionHelper.prototype.identify = function (e, t) {\r\n        var xyChanged = this.startX !== this.endX || this.startY !== this.endY;\r\n        if (e === 2 /* Drag */) {\r\n            if (xyChanged && !Representation.Loci.isEmpty(this.prevLoci)) {\r\n                this.events.drag.next({ current: this.prevLoci, buttons: this.buttons, button: this.button, modifiers: this.modifiers, pageStart: Vec2.create(this.startX, this.startY), pageEnd: Vec2.create(this.endX, this.endY) });\r\n                this.startX = this.endX;\r\n                this.startY = this.endY;\r\n            }\r\n            return;\r\n        }\r\n        if (xyChanged) {\r\n            var pickData = this.canvasIdentify(this.endX, this.endY);\r\n            this.id = pickData === null || pickData === void 0 ? void 0 : pickData.id;\r\n            this.position = pickData === null || pickData === void 0 ? void 0 : pickData.position;\r\n            this.startX = this.endX;\r\n            this.startY = this.endY;\r\n        }\r\n        if (e === 1 /* Click */) {\r\n            var loci_1 = this.getLoci(this.id, this.position);\r\n            this.events.click.next({ current: loci_1, buttons: this.buttons, button: this.button, modifiers: this.modifiers, page: Vec2.create(this.endX, this.endY), position: this.position });\r\n            this.prevLoci = loci_1;\r\n            return;\r\n        }\r\n        if (!this.inside || this.currentIdentifyT !== t || !xyChanged || this.outsideViewport(this.endX, this.endY))\r\n            return;\r\n        var loci = this.getLoci(this.id, this.position);\r\n        this.events.hover.next({ current: loci, buttons: this.buttons, button: this.button, modifiers: this.modifiers, page: Vec2.create(this.endX, this.endY), position: this.position });\r\n        this.prevLoci = loci;\r\n    };\r\n    Canvas3dInteractionHelper.prototype.tick = function (t) {\r\n        if (this.inside && t - this.prevT > 1000 / this.props.maxFps) {\r\n            this.prevT = t;\r\n            this.currentIdentifyT = t;\r\n            this.identify(this.isInteracting ? 2 /* Drag */ : 0 /* Move */, t);\r\n        }\r\n    };\r\n    Canvas3dInteractionHelper.prototype.leave = function () {\r\n        this.inside = false;\r\n        if (!Representation.Loci.isEmpty(this.prevLoci)) {\r\n            this.prevLoci = Representation.Loci.Empty;\r\n            this.events.hover.next({ current: this.prevLoci, buttons: this.buttons, button: this.button, modifiers: this.modifiers });\r\n        }\r\n    };\r\n    Canvas3dInteractionHelper.prototype.move = function (x, y, buttons, button, modifiers) {\r\n        this.inside = true;\r\n        this.buttons = buttons;\r\n        this.button = button;\r\n        this.modifiers = modifiers;\r\n        this.endX = x;\r\n        this.endY = y;\r\n    };\r\n    Canvas3dInteractionHelper.prototype.click = function (x, y, buttons, button, modifiers) {\r\n        this.endX = x;\r\n        this.endY = y;\r\n        this.buttons = buttons;\r\n        this.button = button;\r\n        this.modifiers = modifiers;\r\n        this.identify(1 /* Click */, 0);\r\n    };\r\n    Canvas3dInteractionHelper.prototype.drag = function (x, y, buttons, button, modifiers) {\r\n        this.endX = x;\r\n        this.endY = y;\r\n        this.buttons = buttons;\r\n        this.button = button;\r\n        this.modifiers = modifiers;\r\n        this.identify(2 /* Drag */, 0);\r\n    };\r\n    Canvas3dInteractionHelper.prototype.modify = function (modifiers) {\r\n        if (ModifiersKeys.areEqual(modifiers, this.modifiers))\r\n            return;\r\n        this.modifiers = modifiers;\r\n        this.events.hover.next({ current: this.prevLoci, buttons: this.buttons, button: this.button, modifiers: this.modifiers, page: Vec2.create(this.endX, this.endY), position: this.position });\r\n    };\r\n    Canvas3dInteractionHelper.prototype.outsideViewport = function (x, y) {\r\n        var _a = this, input = _a.input, viewport = _a.camera.viewport;\r\n        x *= input.pixelRatio;\r\n        y *= input.pixelRatio;\r\n        return (x > viewport.x + viewport.width ||\r\n            input.height - y > viewport.y + viewport.height ||\r\n            x < viewport.x ||\r\n            input.height - y < viewport.y);\r\n    };\r\n    Canvas3dInteractionHelper.prototype.getLoci = function (pickingId, position) {\r\n        var _a;\r\n        var _b = this.lociGetter(pickingId), repr = _b.repr, loci = _b.loci;\r\n        if (position && repr && Bond.isLoci(loci) && loci.bonds.length === 2) {\r\n            var _c = loci.bonds[0], aUnit = _c.aUnit, aIndex = _c.aIndex;\r\n            aUnit.conformation.position(aUnit.elements[aIndex], tmpPosA);\r\n            Vec3.sub(tmpNorm, this.camera.state.position, this.camera.state.target);\r\n            Vec3.projectPointOnPlane(tmpPos, position, tmpNorm, tmpPosA);\r\n            var pixelSize = this.camera.getPixelSize(tmpPos);\r\n            var radius = repr.theme.size.size(loci.bonds[0]) * ((_a = repr.props.sizeFactor) !== null && _a !== void 0 ? _a : 1);\r\n            if (repr.props.lineSizeAttenuation === false) {\r\n                // divide by two to get radius\r\n                radius *= pixelSize / 2;\r\n            }\r\n            radius += this.props.preferAtomPixelPadding * pixelSize;\r\n            if (Vec3.distance(tmpPos, tmpPosA) < radius) {\r\n                return { repr: repr, loci: Bond.toFirstStructureElementLoci(loci) };\r\n            }\r\n        }\r\n        return { repr: repr, loci: loci };\r\n    };\r\n    Canvas3dInteractionHelper.prototype.dispose = function () {\r\n        this.ev.dispose();\r\n    };\r\n    return Canvas3dInteractionHelper;\r\n}());\r\nexport { Canvas3dInteractionHelper };\r\n//# sourceMappingURL=interaction-events.js.map"]},"metadata":{},"sourceType":"module"}