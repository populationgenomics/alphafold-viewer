{"ast":null,"code":"/**\r\n * Copyright (c) 2018 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\nimport { StateTransformer } from '../transformer';\nimport { UUID } from '../../mol-util';\nimport { arraySetRemove } from '../../mol-util/array';\nimport { RxEventHelper } from '../../mol-util/rx-event-helper';\nexport { StateActionManager };\n\nvar StateActionManager =\n/** @class */\nfunction () {\n  function StateActionManager() {\n    this.ev = RxEventHelper.create();\n    this.actions = new Map();\n    this.fromTypeIndex = new Map();\n    this.events = {\n      added: this.ev(),\n      removed: this.ev()\n    };\n  }\n\n  StateActionManager.prototype.add = function (actionOrTransformer) {\n    var action = StateTransformer.is(actionOrTransformer) ? actionOrTransformer.toAction() : actionOrTransformer;\n    if (this.actions.has(action.id)) return this;\n    this.actions.set(action.id, action);\n\n    for (var _i = 0, _a = action.definition.from; _i < _a.length; _i++) {\n      var t = _a[_i];\n\n      if (this.fromTypeIndex.has(t.type)) {\n        this.fromTypeIndex.get(t.type).push(action);\n      } else {\n        this.fromTypeIndex.set(t.type, [action]);\n      }\n    }\n\n    this.events.added.next(void 0);\n    return this;\n  };\n\n  StateActionManager.prototype.remove = function (actionOrTransformer) {\n    var id = StateTransformer.is(actionOrTransformer) ? actionOrTransformer.toAction().id : UUID.is(actionOrTransformer) ? actionOrTransformer : actionOrTransformer.id;\n    var action = this.actions.get(id);\n    if (!action) return this;\n    this.actions.delete(id);\n\n    for (var _i = 0, _a = action.definition.from; _i < _a.length; _i++) {\n      var t = _a[_i];\n      var xs = this.fromTypeIndex.get(t.type);\n      if (!xs) continue;\n      arraySetRemove(xs, action);\n      if (xs.length === 0) this.fromTypeIndex.delete(t.type);\n    }\n\n    this.events.removed.next(void 0);\n    return this;\n  };\n\n  StateActionManager.prototype.fromCell = function (cell, ctx) {\n    var obj = cell.obj;\n    if (!obj) return [];\n    var actions = this.fromTypeIndex.get(obj.type);\n    if (!actions) return [];\n    var hasTest = false;\n\n    for (var _i = 0, actions_1 = actions; _i < actions_1.length; _i++) {\n      var a = actions_1[_i];\n\n      if (a.definition.isApplicable) {\n        hasTest = true;\n        break;\n      }\n    }\n\n    if (!hasTest) return actions;\n    var ret = [];\n\n    for (var _a = 0, actions_2 = actions; _a < actions_2.length; _a++) {\n      var a = actions_2[_a];\n\n      if (a.definition.isApplicable) {\n        if (a.definition.isApplicable(obj, cell.transform, ctx)) {\n          ret.push(a);\n        }\n      } else {\n        ret.push(a);\n      }\n    }\n\n    return ret;\n  };\n\n  StateActionManager.prototype.dispose = function () {\n    this.ev.dispose();\n  };\n\n  return StateActionManager;\n}();","map":{"version":3,"sources":["../../../src/mol-state/action/manager.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/**\r\n * Copyright (c) 2018 mol* contributors, licensed under MIT, See LICENSE file for more info.\r\n *\r\n * @author David Sehnal <david.sehnal@gmail.com>\r\n */\r\nimport { StateTransformer } from '../transformer';\r\nimport { UUID } from '../../mol-util';\r\nimport { arraySetRemove } from '../../mol-util/array';\r\nimport { RxEventHelper } from '../../mol-util/rx-event-helper';\r\nexport { StateActionManager };\r\nvar StateActionManager = /** @class */ (function () {\r\n    function StateActionManager() {\r\n        this.ev = RxEventHelper.create();\r\n        this.actions = new Map();\r\n        this.fromTypeIndex = new Map();\r\n        this.events = {\r\n            added: this.ev(),\r\n            removed: this.ev(),\r\n        };\r\n    }\r\n    StateActionManager.prototype.add = function (actionOrTransformer) {\r\n        var action = StateTransformer.is(actionOrTransformer) ? actionOrTransformer.toAction() : actionOrTransformer;\r\n        if (this.actions.has(action.id))\r\n            return this;\r\n        this.actions.set(action.id, action);\r\n        for (var _i = 0, _a = action.definition.from; _i < _a.length; _i++) {\r\n            var t = _a[_i];\r\n            if (this.fromTypeIndex.has(t.type)) {\r\n                this.fromTypeIndex.get(t.type).push(action);\r\n            }\r\n            else {\r\n                this.fromTypeIndex.set(t.type, [action]);\r\n            }\r\n        }\r\n        this.events.added.next(void 0);\r\n        return this;\r\n    };\r\n    StateActionManager.prototype.remove = function (actionOrTransformer) {\r\n        var id = StateTransformer.is(actionOrTransformer)\r\n            ? actionOrTransformer.toAction().id\r\n            : UUID.is(actionOrTransformer)\r\n                ? actionOrTransformer\r\n                : actionOrTransformer.id;\r\n        var action = this.actions.get(id);\r\n        if (!action)\r\n            return this;\r\n        this.actions.delete(id);\r\n        for (var _i = 0, _a = action.definition.from; _i < _a.length; _i++) {\r\n            var t = _a[_i];\r\n            var xs = this.fromTypeIndex.get(t.type);\r\n            if (!xs)\r\n                continue;\r\n            arraySetRemove(xs, action);\r\n            if (xs.length === 0)\r\n                this.fromTypeIndex.delete(t.type);\r\n        }\r\n        this.events.removed.next(void 0);\r\n        return this;\r\n    };\r\n    StateActionManager.prototype.fromCell = function (cell, ctx) {\r\n        var obj = cell.obj;\r\n        if (!obj)\r\n            return [];\r\n        var actions = this.fromTypeIndex.get(obj.type);\r\n        if (!actions)\r\n            return [];\r\n        var hasTest = false;\r\n        for (var _i = 0, actions_1 = actions; _i < actions_1.length; _i++) {\r\n            var a = actions_1[_i];\r\n            if (a.definition.isApplicable) {\r\n                hasTest = true;\r\n                break;\r\n            }\r\n        }\r\n        if (!hasTest)\r\n            return actions;\r\n        var ret = [];\r\n        for (var _a = 0, actions_2 = actions; _a < actions_2.length; _a++) {\r\n            var a = actions_2[_a];\r\n            if (a.definition.isApplicable) {\r\n                if (a.definition.isApplicable(obj, cell.transform, ctx)) {\r\n                    ret.push(a);\r\n                }\r\n            }\r\n            else {\r\n                ret.push(a);\r\n            }\r\n        }\r\n        return ret;\r\n    };\r\n    StateActionManager.prototype.dispose = function () {\r\n        this.ev.dispose();\r\n    };\r\n    return StateActionManager;\r\n}());\r\n//# sourceMappingURL=manager.js.map"]},"metadata":{},"sourceType":"module"}